"use strict";(self.webpackChunkCobrowseIO=self.webpackChunkCobrowseIO||[]).push([[660],{31475:(e,t,n)=>{t.loadElevenLabsWidget=async function(e,t){const n=function(e,t){const{dynamicVariables:n,url:i}=e.data(),r=y(t),o=document.createElement(p);let a;return o.style.zIndex="2147483647",o.setAttribute("class","__cbio_virtual_agent_ignored"),o.setAttribute("signed-url",i),t.customData.user_id&&o.setAttribute("user-id",t.customData.user_id),v(o,n,t),o.addEventListener("elevenlabs-convai:call",(e=>{var i;h("event(elevenlabs-convai:call)",e.detail),a=e.detail,e.detail.config.onMessage=e=>{let{source:n,message:i}=e;return b(n,i,t)},e.detail.config.onSendUserMessage=e=>b("user",e,t),e.detail.config.onDisconnect=e=>function(e,t,n,i){if(u("disconnect: %O",e),"user"===e.reason||"agent"===e.reason){var r;const e=y(i);e.removeItem(m),e.removeItem(f),v(t,n,i),null===(r=i.currentSession)||void 0===r||r.end()}}(e,o,n,t),r.setItem(f,{expanded:null===(i=r.getItem(f))||void 0===i?void 0:i.expanded,micMuted:e.detail.micMuted,textOnly:e.detail.config.textOnly})})),o.addEventListener("elevenlabs-convai:setMicMuted",(e=>{h("event(elevenlabs-convai:setMicMuted)",e.detail),r.setItem(f,l(l({},r.getItem(f)),{},{micMuted:e.detail.micMuted}))})),o.addEventListener("elevenlabs-convai:setExpanded",(e=>{h("event(elevenlabs-convai:setExpanded)",e.detail),r.setItem(f,l(l({},r.getItem(f)),{},{expanded:e.detail.expanded}))})),t.on("highlight.updated",(async e=>{let{target:t,visible:n}=e;if(u("CobrowseIO(highlight.updated)",{target:t,visible:n}),n){const e=o.shadowRoot.querySelector(".elevenlabs-widget-sheet");if(u("-> locating transcript",e),!e)return;await g.onceNotScrolling();const n=e.getBoundingClientRect(),i=t.getBoundingClientRect();if(u("-> checking collision",{target:i,transcript:n}),!function(e,t){const n=e.left,i=e.top,r=e.right,o=e.bottom,a=t.left,s=t.top,c=t.right,l=t.bottom;return!(r<=a||c<=n||o<=s||l<=i)}(n,i))return;u("-> collapsing widget"),a.setExpanded(!1)}else{var i,s,c;u("-> set expanded",null===(i=r.getItem(f))||void 0===i?void 0:i.expanded),a.setExpanded(null===(s=null===(c=r.getItem(f))||void 0===c?void 0:c.expanded)||void 0===s||s)}})),o}(e,t);document.body.append(n),(0,i.registerWidget)(p)},n(62953);var i=n(25460),r=s(n(51227)),o=s(n(86542)),a=n(30501);function s(e){return e&&e.__esModule?e:{default:e}}function c(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function l(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?c(Object(n),!0).forEach((function(t){d(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):c(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function d(e,t,n){return(t=function(e){var t=function(e){if("object"!=typeof e||!e)return e;var t=e[Symbol.toPrimitive];if(void 0!==t){var n=t.call(e,"string");if("object"!=typeof n)return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(e)}(e);return"symbol"==typeof t?t:t+""}(t))in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}const u=(0,r.default)("cbio.VirtualAgent.ElevenLabs"),h=(0,r.default)("cbio.VirtualAgent.ElevenLabs.widget"),p="elevenlabs-convai",m="_cobrowse_elevenlabs_transcript",f="_cobrowse_elevenlabs_config",g=(0,a.scrollState)();function v(e,t,n){var i,r;const o=n.deviceId(),a=null===(i=n.currentSession)||void 0===i?void 0:i.id(),s=y(n);t=l(l({},t),{},{cobrowse_device_id:"Cobrowse device ID: ".concat(o),cobrowse_session_id:a?"Cobrowse session ID: ".concat(a):"",url:document.location.toString()});const c=null!==(r=s.getItem(m))&&void 0!==r?r:[],d=JSON.stringify(c);if(c.length){var h,p;u("resuming with transcript",c);const n=null!==(h=s.getItem(f))&&void 0!==h?h:{};e.setAttribute("default-expanded",String(null===(p=n.expanded)||void 0===p||p)),e.setAttribute("override-first-message",""),e.setAttribute("auto-resume",JSON.stringify(n)),t.history="\n      You are resuming a conversation that has been taking place, and the user performed an action\n      that caused the page to reload. Here is the history of the conversation:\n      ".concat(d,"\n    ")}else e.removeAttribute("default-expanded"),e.removeAttribute("override-first-message"),e.removeAttribute("auto-resume");e.setAttribute("dynamic-variables",JSON.stringify(t)),e.setAttribute("transcript-entries",d)}function b(e,t,n){var i;u("%s: %s",e,t);const r=y(n),o=null!==(i=r.getItem(m))&&void 0!==i?i:[];r.setItem(m,[...o,{type:"message",role:"user"===e?"user":"ai",message:t,isText:!0,conversationIndex:o.length}])}function y(e){return(0,o.default)(e.license)}},30501:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.scrollState=function(){const e={onScrollCompleteHandlers:[],scrollHandle:void 0};function t(t){clearTimeout(e.scrollHandle),e.scrollHandle=void 0;try{e.onScrollCompleteHandlers.forEach((e=>e()))}finally{e.onScrollCompleteHandlers.length=0}}function n(n){clearTimeout(e.scrollHandle),e.scrollHandle=setTimeout(t,250)}function i(e){t()}return window.addEventListener("scroll",n,!0),window.addEventListener("scrollend",i,!0),{onceNotScrolling:async()=>new Promise((t=>{setTimeout((()=>{e.scrollHandle?e.onScrollCompleteHandlers.push(t):t()}),100)})),destroy(){window.removeEventListener("scrollend",i,!0),window.removeEventListener("scroll",n,!0),clearTimeout(e.scrollHandle)}}}},53921:(e,t,n)=>{var i=n(46518),r=n(72652),o=n(97040);i({target:"Object",stat:!0},{fromEntries:function(e){var t={};return r(e,(function(e,n){o(t,e,n)}),{AS_ENTRIES:!0}),t}})},25460:(e,t,n)=>{n.r(t),n.d(t,{registerWidget:()=>Mb});var i={};n.r(i),n.d(i,{Children:()=>M,Component:()=>r.Component,Fragment:()=>r.Fragment,PureComponent:()=>_,StrictMode:()=>ke,Suspense:()=>U,SuspenseList:()=>V,__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED:()=>le,cloneElement:()=>fe,createContext:()=>r.createContext,createElement:()=>r.createElement,createFactory:()=>ue,createPortal:()=>z,createRef:()=>r.createRef,default:()=>Ce,findDOMNode:()=>ve,flushSync:()=>ye,forwardRef:()=>O,hydrate:()=>Z,isElement:()=>we,isFragment:()=>pe,isMemo:()=>me,isValidElement:()=>he,lazy:()=>B,memo:()=>P,render:()=>Q,startTransition:()=>T,unmountComponentAtNode:()=>ge,unstable_batchedUpdates:()=>be,useCallback:()=>b.useCallback,useContext:()=>b.useContext,useDebugValue:()=>b.useDebugValue,useDeferredValue:()=>S,useEffect:()=>b.useEffect,useErrorBoundary:()=>b.useErrorBoundary,useId:()=>b.useId,useImperativeHandle:()=>b.useImperativeHandle,useInsertionEffect:()=>E,useLayoutEffect:()=>b.useLayoutEffect,useMemo:()=>b.useMemo,useReducer:()=>b.useReducer,useRef:()=>b.useRef,useState:()=>b.useState,useSyncExternalStore:()=>w,useTransition:()=>x,version:()=>de}),n(89463),n(94490),n(26910),n(54743),n(11745),n(53921),n(27495),n(25440),n(42762),n(34594),n(21489),n(75044),n(28845),n(373),n(62480),n(62953),n(3296),n(27208),n(48408);var r=n(50172);function o(){return o=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var i in n)Object.prototype.hasOwnProperty.call(n,i)&&(e[i]=n[i])}return e},o.apply(this,arguments)}function a(e,t){if(null==e)return{};var n,i,r={},o=Object.keys(e);for(i=0;i<o.length;i++)t.indexOf(n=o[i])>=0||(r[n]=e[n]);return r}var s=["context","children"],c=["useFragment"];function l(e,t,n,i){function r(){var t=Reflect.construct(HTMLElement,[],r);return t._vdomComponent=e,t._root=i&&i.shadow?t.attachShadow({mode:i.mode||"open"}):t,i&&i.adoptedStyleSheets&&(t._root.adoptedStyleSheets=i.adoptedStyleSheets),t}return(r.prototype=Object.create(HTMLElement.prototype)).constructor=r,r.prototype.connectedCallback=function(){u.call(this,i)},r.prototype.attributeChangedCallback=p,r.prototype.disconnectedCallback=m,n=n||e.observedAttributes||Object.keys(e.propTypes||{}),r.observedAttributes=n,e.formAssociated&&(r.formAssociated=!0),n.forEach((function(e){Object.defineProperty(r.prototype,e,{get:function(){return this._vdom?this._vdom.props[e]:this._props[e]},set:function(t){this._vdom?this.attributeChangedCallback(e,null,t):(this._props||(this._props={}),this._props[e]=t);var n=typeof t;null!=t&&"string"!==n&&"boolean"!==n&&"number"!==n||this.setAttribute(e,t)}})})),customElements.define(t||e.tagName||e.displayName||e.name,r),r}function d(e){this.getChildContext=function(){return e.context};var t=e.children,n=a(e,s);return(0,r.cloneElement)(t,n)}function u(e){var t=new CustomEvent("_preact",{detail:{},bubbles:!0,cancelable:!0});this.dispatchEvent(t),this._vdom=(0,r.h)(d,o({},this._props,{context:t.detail.context}),g(this,this._vdomComponent,e)),(this.hasAttribute("hydrate")?r.hydrate:r.render)(this._vdom,this._root)}function h(e){return e.replace(/-(\w)/g,(function(e,t){return t?t.toUpperCase():""}))}function p(e,t,n){if(this._vdom){var i={};i[e]=n=null==n?void 0:n,i[h(e)]=n,this._vdom=(0,r.cloneElement)(this._vdom,i),(0,r.render)(this._vdom,this._root)}}function m(){(0,r.render)(this._vdom=null,this._root)}function f(e,t){var n=this,i=e.useFragment,s=a(e,c);return(0,r.h)(i?r.Fragment:"slot",o({},s,{ref:function(e){e?(n.ref=e,n._listener||(n._listener=function(e){e.stopPropagation(),e.detail.context=t},e.addEventListener("_preact",n._listener))):n.ref.removeEventListener("_preact",n._listener)}}))}function g(e,t,n){if(3===e.nodeType)return e.data;if(1!==e.nodeType)return null;var i=[],o={},a=0,s=e.attributes,c=e.childNodes;for(a=s.length;a--;)"slot"!==s[a].name&&(o[s[a].name]=s[a].value,o[h(s[a].name)]=s[a].value);for(a=c.length;a--;){var l=g(c[a],null,n),d=c[a].slot;d?o[d]=(0,r.h)(f,{name:d},l):i[a]=l}var u=!(!n||!n.shadow),p=t?(0,r.h)(f,{useFragment:!u},i):i;return!u&&t&&(e.innerHTML=""),(0,r.h)(t||e.nodeName.toLowerCase(),o,p)}var v=n(10201),b=n(45994);function y(e,t){for(var n in t)e[n]=t[n];return e}function k(e,t){for(var n in e)if("__source"!==n&&!(n in t))return!0;for(var i in t)if("__source"!==i&&e[i]!==t[i])return!0;return!1}function w(e,t){var n=t(),i=(0,b.useState)({t:{__:n,u:t}}),r=i[0].t,o=i[1];return(0,b.useLayoutEffect)((function(){r.__=n,r.u=t,C(r)&&o({t:r})}),[e,n,t]),(0,b.useEffect)((function(){return C(r)&&o({t:r}),e((function(){C(r)&&o({t:r})}))}),[e]),n}function C(e){var t,n,i=e.u,r=e.__;try{var o=i();return!((t=r)===(n=o)&&(0!==t||1/t==1/n)||t!=t&&n!=n)}catch(e){return!0}}function T(e){e()}function S(e){return e}function x(){return[!1,T]}var E=b.useLayoutEffect;function _(e,t){this.props=e,this.context=t}function P(e,t){function n(e){var n=this.props.ref,i=n==e.ref;return!i&&n&&(n.call?n(null):n.current=null),t?!t(this.props,e)||!i:k(this.props,e)}function i(t){return this.shouldComponentUpdate=n,(0,r.createElement)(e,t)}return i.displayName="Memo("+(e.displayName||e.name)+")",i.prototype.isReactComponent=!0,i.__f=!0,i.type=e,i}(_.prototype=new r.Component).isPureReactComponent=!0,_.prototype.shouldComponentUpdate=function(e,t){return k(this.props,e)||k(this.state,t)};var R=r.options.__b;r.options.__b=function(e){e.type&&e.type.__f&&e.ref&&(e.props.ref=e.ref,e.ref=null),R&&R(e)};var I="undefined"!=typeof Symbol&&Symbol.for&&Symbol.for("react.forward_ref")||3911;function O(e){function t(t){var n=y({},t);return delete n.ref,e(n,t.ref||null)}return t.$$typeof=I,t.render=e,t.prototype.isReactComponent=t.__f=!0,t.displayName="ForwardRef("+(e.displayName||e.name)+")",t}var D=function(e,t){return null==e?null:(0,r.toChildArray)((0,r.toChildArray)(e).map(t))},M={map:D,forEach:D,count:function(e){return e?(0,r.toChildArray)(e).length:0},only:function(e){var t=(0,r.toChildArray)(e);if(1!==t.length)throw"Children.only";return t[0]},toArray:r.toChildArray},A=r.options.__e;r.options.__e=function(e,t,n,i){if(e.then)for(var r,o=t;o=o.__;)if((r=o.__c)&&r.__c)return null==t.__e&&(t.__e=n.__e,t.__k=n.__k),r.__c(e,t);A(e,t,n,i)};var N=r.options.unmount;function L(e,t,n){return e&&(e.__c&&e.__c.__H&&(e.__c.__H.__.forEach((function(e){"function"==typeof e.__c&&e.__c()})),e.__c.__H=null),null!=(e=y({},e)).__c&&(e.__c.__P===n&&(e.__c.__P=t),e.__c.__e=!0,e.__c=null),e.__k=e.__k&&e.__k.map((function(e){return L(e,t,n)}))),e}function j(e,t,n){return e&&n&&(e.__v=null,e.__k=e.__k&&e.__k.map((function(e){return j(e,t,n)})),e.__c&&e.__c.__P===t&&(e.__e&&n.appendChild(e.__e),e.__c.__e=!0,e.__c.__P=n)),e}function U(){this.__u=0,this.o=null,this.__b=null}function F(e){var t=e.__.__c;return t&&t.__a&&t.__a(e)}function B(e){var t,n,i;function o(o){if(t||(t=e()).then((function(e){n=e.default||e}),(function(e){i=e})),i)throw i;if(!n)throw t;return(0,r.createElement)(n,o)}return o.displayName="Lazy",o.__f=!0,o}function V(){this.i=null,this.l=null}r.options.unmount=function(e){var t=e.__c;t&&t.__R&&t.__R(),t&&32&e.__u&&(e.type=null),N&&N(e)},(U.prototype=new r.Component).__c=function(e,t){var n=t.__c,i=this;null==i.o&&(i.o=[]),i.o.push(n);var r=F(i.__v),o=!1,a=function(){o||(o=!0,n.__R=null,r?r(s):s())};n.__R=a;var s=function(){if(! --i.__u){if(i.state.__a){var e=i.state.__a;i.__v.__k[0]=j(e,e.__c.__P,e.__c.__O)}var t;for(i.setState({__a:i.__b=null});t=i.o.pop();)t.forceUpdate()}};i.__u++||32&t.__u||i.setState({__a:i.__b=i.__v.__k[0]}),e.then(a,a)},U.prototype.componentWillUnmount=function(){this.o=[]},U.prototype.render=function(e,t){if(this.__b){if(this.__v.__k){var n=document.createElement("div"),i=this.__v.__k[0].__c;this.__v.__k[0]=L(this.__b,n,i.__O=i.__P)}this.__b=null}var o=t.__a&&(0,r.createElement)(r.Fragment,null,e.fallback);return o&&(o.__u&=-33),[(0,r.createElement)(r.Fragment,null,t.__a?null:e.children),o]};var q=function(e,t,n){if(++n[1]===n[0]&&e.l.delete(t),e.props.revealOrder&&("t"!==e.props.revealOrder[0]||!e.l.size))for(n=e.i;n;){for(;n.length>3;)n.pop()();if(n[1]<n[0])break;e.i=n=n[2]}};function W(e){return this.getChildContext=function(){return e.context},e.children}function H(e){var t=this,n=e.h;if(t.componentWillUnmount=function(){(0,r.render)(null,t.v),t.v=null,t.h=null},t.h&&t.h!==n&&t.componentWillUnmount(),!t.v){for(var i=t.__v;null!==i&&!i.__m&&null!==i.__;)i=i.__;t.h=n,t.v={nodeType:1,parentNode:n,childNodes:[],__k:{__m:i.__m},contains:function(){return!0},insertBefore:function(e,n){this.childNodes.push(e),t.h.insertBefore(e,n)},removeChild:function(e){this.childNodes.splice(this.childNodes.indexOf(e)>>>1,1),t.h.removeChild(e)}}}(0,r.render)((0,r.createElement)(W,{context:t.context},e.__v),t.v)}function z(e,t){var n=(0,r.createElement)(H,{__v:e,h:t});return n.containerInfo=t,n}(V.prototype=new r.Component).__a=function(e){var t=this,n=F(t.__v),i=t.l.get(e);return i[0]++,function(r){var o=function(){t.props.revealOrder?(i.push(r),q(t,e,i)):r()};n?n(o):o()}},V.prototype.render=function(e){this.i=null,this.l=new Map;var t=(0,r.toChildArray)(e.children);e.revealOrder&&"b"===e.revealOrder[0]&&t.reverse();for(var n=t.length;n--;)this.l.set(t[n],this.i=[1,0,this.i]);return e.children},V.prototype.componentDidUpdate=V.prototype.componentDidMount=function(){var e=this;this.l.forEach((function(t,n){q(e,n,t)}))};var G="undefined"!=typeof Symbol&&Symbol.for&&Symbol.for("react.element")||60103,K=/^(?:accent|alignment|arabic|baseline|cap|clip(?!PathU)|color|dominant|fill|flood|font|glyph(?!R)|horiz|image(!S)|letter|lighting|marker(?!H|W|U)|overline|paint|pointer|shape|stop|strikethrough|stroke|text(?!L)|transform|underline|unicode|units|v|vector|vert|word|writing|x(?!C))[A-Z]/,J=/^on(Ani|Tra|Tou|BeforeInp|Compo)/,Y=/[A-Z0-9]/g,X="undefined"!=typeof document,$=function(e){return("undefined"!=typeof Symbol&&"symbol"==typeof Symbol()?/fil|che|rad/:/fil|che|ra/).test(e)};function Q(e,t,n){return null==t.__k&&(t.textContent=""),(0,r.render)(e,t),"function"==typeof n&&n(),e?e.__c:null}function Z(e,t,n){return(0,r.hydrate)(e,t),"function"==typeof n&&n(),e?e.__c:null}r.Component.prototype.isReactComponent={},["componentWillMount","componentWillReceiveProps","componentWillUpdate"].forEach((function(e){Object.defineProperty(r.Component.prototype,e,{configurable:!0,get:function(){return this["UNSAFE_"+e]},set:function(t){Object.defineProperty(this,e,{configurable:!0,writable:!0,value:t})}})}));var ee=r.options.event;function te(){}function ne(){return this.cancelBubble}function ie(){return this.defaultPrevented}r.options.event=function(e){return ee&&(e=ee(e)),e.persist=te,e.isPropagationStopped=ne,e.isDefaultPrevented=ie,e.nativeEvent=e};var re,oe={enumerable:!1,configurable:!0,get:function(){return this.class}},ae=r.options.vnode;r.options.vnode=function(e){"string"==typeof e.type&&function(e){var t=e.props,n=e.type,i={},o=-1===n.indexOf("-");for(var a in t){var s=t[a];if(!("value"===a&&"defaultValue"in t&&null==s||X&&"children"===a&&"noscript"===n||"class"===a||"className"===a)){var c=a.toLowerCase();"defaultValue"===a&&"value"in t&&null==t.value?a="value":"download"===a&&!0===s?s="":"translate"===c&&"no"===s?s=!1:"o"===c[0]&&"n"===c[1]?"ondoubleclick"===c?a="ondblclick":"onchange"!==c||"input"!==n&&"textarea"!==n||$(t.type)?"onfocus"===c?a="onfocusin":"onblur"===c?a="onfocusout":J.test(a)&&(a=c):c=a="oninput":o&&K.test(a)?a=a.replace(Y,"-$&").toLowerCase():null===s&&(s=void 0),"oninput"===c&&i[a=c]&&(a="oninputCapture"),i[a]=s}}"select"==n&&i.multiple&&Array.isArray(i.value)&&(i.value=(0,r.toChildArray)(t.children).forEach((function(e){e.props.selected=-1!=i.value.indexOf(e.props.value)}))),"select"==n&&null!=i.defaultValue&&(i.value=(0,r.toChildArray)(t.children).forEach((function(e){e.props.selected=i.multiple?-1!=i.defaultValue.indexOf(e.props.value):i.defaultValue==e.props.value}))),t.class&&!t.className?(i.class=t.class,Object.defineProperty(i,"className",oe)):(t.className&&!t.class||t.class&&t.className)&&(i.class=i.className=t.className),e.props=i}(e),e.$$typeof=G,ae&&ae(e)};var se=r.options.__r;r.options.__r=function(e){se&&se(e),re=e.__c};var ce=r.options.diffed;r.options.diffed=function(e){ce&&ce(e);var t=e.props,n=e.__e;null!=n&&"textarea"===e.type&&"value"in t&&t.value!==n.value&&(n.value=null==t.value?"":t.value),re=null};var le={ReactCurrentDispatcher:{current:{readContext:function(e){return re.__n[e.__c].props.value},useCallback:b.useCallback,useContext:b.useContext,useDebugValue:b.useDebugValue,useDeferredValue:S,useEffect:b.useEffect,useId:b.useId,useImperativeHandle:b.useImperativeHandle,useInsertionEffect:E,useLayoutEffect:b.useLayoutEffect,useMemo:b.useMemo,useReducer:b.useReducer,useRef:b.useRef,useState:b.useState,useSyncExternalStore:w,useTransition:x}}},de="18.3.1";function ue(e){return r.createElement.bind(null,e)}function he(e){return!!e&&e.$$typeof===G}function pe(e){return he(e)&&e.type===r.Fragment}function me(e){return!!e&&!!e.displayName&&("string"==typeof e.displayName||e.displayName instanceof String)&&e.displayName.startsWith("Memo(")}function fe(e){return he(e)?r.cloneElement.apply(null,arguments):e}function ge(e){return!!e.__k&&((0,r.render)(null,e),!0)}function ve(e){return e&&(e.base||1===e.nodeType&&e)||null}var be=function(e,t){return e(t)},ye=function(e,t){return e(t)},ke=r.Fragment,we=he,Ce={useState:b.useState,useId:b.useId,useReducer:b.useReducer,useEffect:b.useEffect,useLayoutEffect:b.useLayoutEffect,useInsertionEffect:E,useTransition:x,useDeferredValue:S,useSyncExternalStore:w,startTransition:T,useRef:b.useRef,useImperativeHandle:b.useImperativeHandle,useMemo:b.useMemo,useCallback:b.useCallback,useContext:b.useContext,useDebugValue:b.useDebugValue,version:"18.3.1",Children:M,render:Q,hydrate:Z,unmountComponentAtNode:ge,createPortal:z,createElement:r.createElement,createContext:r.createContext,createFactory:ue,cloneElement:fe,createRef:r.createRef,Fragment:r.Fragment,isValidElement:he,isElement:we,isFragment:pe,isMemo:me,findDOMNode:ve,Component:r.Component,PureComponent:_,memo:P,forwardRef:O,flushSync:ye,unstable_batchedUpdates:be,StrictMode:ke,Suspense:U,SuspenseList:V,lazy:B,__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED:le},Te=Symbol.for("preact-signals");function Se(){if(Re>1)Re--;else{for(var e,t=!1;void 0!==Pe;){var n=Pe;for(Pe=void 0,Ie++;void 0!==n;){var i=n.o;if(n.o=void 0,n.f&=-3,!(8&n.f)&&Ne(n))try{n.c()}catch(n){t||(e=n,t=!0)}n=i}}if(Ie=0,Re--,t)throw e}}function xe(e){if(Re>0)return e();Re++;try{return e()}finally{Se()}}var Ee=void 0;function _e(e){var t=Ee;Ee=void 0;try{return e()}finally{Ee=t}}var Pe=void 0,Re=0,Ie=0,Oe=0;function De(e){if(void 0!==Ee){var t=e.n;if(void 0===t||t.t!==Ee)return t={i:0,S:e,p:Ee.s,n:void 0,t:Ee,e:void 0,x:void 0,r:t},void 0!==Ee.s&&(Ee.s.n=t),Ee.s=t,e.n=t,32&Ee.f&&e.S(t),t;if(-1===t.i)return t.i=0,void 0!==t.n&&(t.n.p=t.p,void 0!==t.p&&(t.p.n=t.n),t.p=Ee.s,t.n=void 0,Ee.s.n=t,Ee.s=t),t}}function Me(e,t){this.v=e,this.i=0,this.n=void 0,this.t=void 0,this.W=null==t?void 0:t.watched,this.Z=null==t?void 0:t.unwatched,this.name=null==t?void 0:t.name}function Ae(e,t){return new Me(e,t)}function Ne(e){for(var t=e.s;void 0!==t;t=t.n)if(t.S.i!==t.i||!t.S.h()||t.S.i!==t.i)return!0;return!1}function Le(e){for(var t=e.s;void 0!==t;t=t.n){var n=t.S.n;if(void 0!==n&&(t.r=n),t.S.n=t,t.i=-1,void 0===t.n){e.s=t;break}}}function je(e){for(var t=e.s,n=void 0;void 0!==t;){var i=t.p;-1===t.i?(t.S.U(t),void 0!==i&&(i.n=t.n),void 0!==t.n&&(t.n.p=i)):n=t,t.S.n=t.r,void 0!==t.r&&(t.r=void 0),t=i}e.s=n}function Ue(e,t){Me.call(this,void 0),this.x=e,this.s=void 0,this.g=Oe-1,this.f=4,this.W=null==t?void 0:t.watched,this.Z=null==t?void 0:t.unwatched,this.name=null==t?void 0:t.name}function Fe(e,t){return new Ue(e,t)}function Be(e){var t=e.u;if(e.u=void 0,"function"==typeof t){Re++;var n=Ee;Ee=void 0;try{t()}catch(t){throw e.f&=-2,e.f|=8,Ve(e),t}finally{Ee=n,Se()}}}function Ve(e){for(var t=e.s;void 0!==t;t=t.n)t.S.U(t);e.x=void 0,e.s=void 0,Be(e)}function qe(e){if(Ee!==this)throw new Error("Out-of-order effect");je(this),Ee=e,this.f&=-2,8&this.f&&Ve(this),Se()}function We(e,t){this.x=e,this.u=void 0,this.s=void 0,this.o=void 0,this.f=32,this.name=null==t?void 0:t.name}function He(e,t){var n=new We(e,t);try{n.c()}catch(e){throw n.d(),e}var i=n.d.bind(n);return i[Symbol.dispose]=i,i}Me.prototype.brand=Te,Me.prototype.h=function(){return!0},Me.prototype.S=function(e){var t=this,n=this.t;n!==e&&void 0===e.e&&(e.x=n,this.t=e,void 0!==n?n.e=e:_e((function(){var e;null==(e=t.W)||e.call(t)})))},Me.prototype.U=function(e){var t=this;if(void 0!==this.t){var n=e.e,i=e.x;void 0!==n&&(n.x=i,e.e=void 0),void 0!==i&&(i.e=n,e.x=void 0),e===this.t&&(this.t=i,void 0===i&&_e((function(){var e;null==(e=t.Z)||e.call(t)})))}},Me.prototype.subscribe=function(e){var t=this;return He((function(){var n=t.value,i=Ee;Ee=void 0;try{e(n)}finally{Ee=i}}),{name:"sub"})},Me.prototype.valueOf=function(){return this.value},Me.prototype.toString=function(){return this.value+""},Me.prototype.toJSON=function(){return this.value},Me.prototype.peek=function(){var e=Ee;Ee=void 0;try{return this.value}finally{Ee=e}},Object.defineProperty(Me.prototype,"value",{get:function(){var e=De(this);return void 0!==e&&(e.i=this.i),this.v},set:function(e){if(e!==this.v){if(Ie>100)throw new Error("Cycle detected");this.v=e,this.i++,Oe++,Re++;try{for(var t=this.t;void 0!==t;t=t.x)t.t.N()}finally{Se()}}}}),Ue.prototype=new Me,Ue.prototype.h=function(){if(this.f&=-3,1&this.f)return!1;if(32==(36&this.f))return!0;if(this.f&=-5,this.g===Oe)return!0;if(this.g=Oe,this.f|=1,this.i>0&&!Ne(this))return this.f&=-2,!0;var e=Ee;try{Le(this),Ee=this;var t=this.x();(16&this.f||this.v!==t||0===this.i)&&(this.v=t,this.f&=-17,this.i++)}catch(e){this.v=e,this.f|=16,this.i++}return Ee=e,je(this),this.f&=-2,!0},Ue.prototype.S=function(e){if(void 0===this.t){this.f|=36;for(var t=this.s;void 0!==t;t=t.n)t.S.S(t)}Me.prototype.S.call(this,e)},Ue.prototype.U=function(e){if(void 0!==this.t&&(Me.prototype.U.call(this,e),void 0===this.t)){this.f&=-33;for(var t=this.s;void 0!==t;t=t.n)t.S.U(t)}},Ue.prototype.N=function(){if(!(2&this.f)){this.f|=6;for(var e=this.t;void 0!==e;e=e.x)e.t.N()}},Object.defineProperty(Ue.prototype,"value",{get:function(){if(1&this.f)throw new Error("Cycle detected");var e=De(this);if(this.h(),void 0!==e&&(e.i=this.i),16&this.f)throw this.v;return this.v}}),We.prototype.c=function(){var e=this.S();try{if(8&this.f)return;if(void 0===this.x)return;var t=this.x();"function"==typeof t&&(this.u=t)}finally{e()}},We.prototype.S=function(){if(1&this.f)throw new Error("Cycle detected");this.f|=1,this.f&=-9,Be(this),Le(this),Re++;var e=Ee;return Ee=this,qe.bind(this,e)},We.prototype.N=function(){2&this.f||(this.f|=2,this.o=Pe,Pe=this)},We.prototype.d=function(){this.f|=8,1&this.f||Ve(this)},We.prototype.dispose=function(){this.d()};var ze,Ge,Ke,Je=[],Ye=[];function Xe(e,t){r.options[e]=t.bind(null,r.options[e]||function(){})}function $e(e){Ke&&Ke(),Ke=e&&e.S()}function Qe(e){var t=this,n=e.data,i=et(n);i.value=n;var o=(0,b.useMemo)((function(){for(var e=t,n=t.__v;n=n.__;)if(n.__c){n.__c.__$f|=4;break}var o=Fe((function(){var e=i.value.value;return 0===e?0:!0===e?"":e||""})),a=Fe((function(){return!Array.isArray(o.value)&&!(0,r.isValidElement)(o.value)})),s=He((function(){if(this.N=st,a.value){var t=o.value;e.__v&&e.__v.__e&&3===e.__v.__e.nodeType&&(e.__v.__e.data=t)}})),c=t.__$u.d;return t.__$u.d=function(){s(),c.call(this)},[a,o]}),[]),a=o[0],s=o[1];return a.value?s.peek():s.value}function Ze(e,t,n,i){var r=t in e&&void 0===e.ownerSVGElement,o=Ae(n);return{o:function(e,t){o.value=e,i=t},d:He((function(){this.N=st;var n=o.value.value;i[t]!==n&&(i[t]=n,r?e[t]=n:n?e.setAttribute(t,n):e.removeAttribute(t))}))}}function et(e,t){return(0,b.useState)((function(){return Ae(e,t)}))[0]}function tt(e,t){var n=(0,b.useMemo)((function(){var n=Ae(e);return[n,Fe((function(){return n.value()}),t)]}),[]),i=n[0],r=n[1];return Ge.__$f|=4,i.value=e,r}He((function(){ze=this.N}))(),Qe.displayName="ReactiveTextNode",Object.defineProperties(Me.prototype,{constructor:{configurable:!0,value:void 0},type:{configurable:!0,value:Qe},props:{configurable:!0,get:function(){return{data:this}}},__b:{configurable:!0,value:1}}),Xe("__b",(function(e,t){if("function"==typeof t.type&&"undefined"!=typeof window&&window.__PREACT_SIGNALS_DEVTOOLS__&&window.__PREACT_SIGNALS_DEVTOOLS__.exitComponent(),"string"==typeof t.type){var n,i=t.props;for(var r in i)if("children"!==r){var o=i[r];o instanceof Me&&(n||(t.__np=n={}),n[r]=o,i[r]=o.peek())}}e(t)})),Xe("__r",(function(e,t){if("function"==typeof t.type&&"undefined"!=typeof window&&window.__PREACT_SIGNALS_DEVTOOLS__&&window.__PREACT_SIGNALS_DEVTOOLS__.enterComponent(t),t.type!==r.Fragment){$e();var n,i=t.__c;i&&(i.__$f&=-2,void 0===(n=i.__$u)&&(i.__$u=n=function(){var e;return He((function(){e=this})),e.c=function(){i.__$f|=1,i.setState({})},e}())),Ge=i,$e(n)}e(t)})),Xe("__e",(function(e,t,n,i){"undefined"!=typeof window&&window.__PREACT_SIGNALS_DEVTOOLS__&&window.__PREACT_SIGNALS_DEVTOOLS__.exitComponent(),$e(),Ge=void 0,e(t,n,i)})),Xe("diffed",(function(e,t){var n;if("function"==typeof t.type&&"undefined"!=typeof window&&window.__PREACT_SIGNALS_DEVTOOLS__&&window.__PREACT_SIGNALS_DEVTOOLS__.exitComponent(),$e(),Ge=void 0,"string"==typeof t.type&&(n=t.__e)){var i=t.__np,r=t.props;if(i){var o=n.U;if(o)for(var a in o){var s=o[a];void 0===s||a in i||(s.d(),o[a]=void 0)}else o={},n.U=o;for(var c in i){var l=o[c],d=i[c];void 0===l?(l=Ze(n,c,d,r),o[c]=l):l.o(d,r)}}}e(t)})),Xe("unmount",(function(e,t){if("string"==typeof t.type){var n=t.__e;if(n){var i=n.U;if(i)for(var r in n.U=void 0,i){var o=i[r];o&&o.d()}}}else{var a=t.__c;if(a){var s=a.__$u;s&&(a.__$u=void 0,s.d())}}e(t)})),Xe("__h",(function(e,t,n,i){(i<3||9===i)&&(t.__$f|=2),e(t,n,i)})),r.Component.prototype.shouldComponentUpdate=function(e,t){var n=this.__$u,i=n&&void 0!==n.s;for(var r in t)return!0;if(this.__f||"boolean"==typeof this.u&&!0===this.u){var o=2&this.__$f;if(!(i||o||4&this.__$f))return!0;if(1&this.__$f)return!0}else{if(!(i||4&this.__$f))return!0;if(3&this.__$f)return!0}for(var a in e)if("__source"!==a&&e[a]!==this.props[a])return!0;for(var s in this.props)if(!(s in e))return!0;return!1};var nt="undefined"==typeof requestAnimationFrame?setTimeout:function(e){var t=function(){clearTimeout(n),cancelAnimationFrame(i),e()},n=setTimeout(t,35),i=requestAnimationFrame(t)},it=function(e){queueMicrotask((function(){queueMicrotask(e)}))};function rt(){xe((function(){for(var e;e=Je.shift();)ze.call(e)}))}function ot(){1===Je.push(this)&&(r.options.requestAnimationFrame||nt)(rt)}function at(){xe((function(){for(var e;e=Ye.shift();)ze.call(e)}))}function st(){1===Ye.push(this)&&(r.options.requestAnimationFrame||it)(at)}function ct(e,t){var n=(0,b.useRef)(e);n.current=e,(0,b.useEffect)((function(){return He((function(){return this.N=ot,n.current()}),t)}),[])}function lt(e,t){return t.forEach((function(t){t&&"string"!=typeof t&&!Array.isArray(t)&&Object.keys(t).forEach((function(n){if("default"!==n&&!(n in e)){var i=Object.getOwnPropertyDescriptor(t,n);Object.defineProperty(e,n,i.get?i:{enumerable:!0,get:function(){return t[n]}})}}))})),Object.freeze(e)}var dt=Object.defineProperty,ut=(e,t,n)=>((e,t,n)=>t in e?dt(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n)(e,"symbol"!=typeof t?t+"":t,n);class ht{constructor(){ut(this,"_locking"),ut(this,"_locks"),this._locking=Promise.resolve(),this._locks=0}isLocked(){return this._locks>0}lock(){let e;this._locks+=1;const t=new Promise((t=>e=()=>{this._locks-=1,t()})),n=this._locking.then((()=>e));return this._locking=this._locking.then((()=>t)),n}}function pt(e,t){if(!e)throw new Error(t)}function mt(e){if("number"!=typeof e)throw new Error("invalid int 32: "+typeof e);if(!Number.isInteger(e)||e>2147483647||e<-2147483648)throw new Error("invalid int 32: "+e)}function ft(e){if("number"!=typeof e)throw new Error("invalid uint 32: "+typeof e);if(!Number.isInteger(e)||e>4294967295||e<0)throw new Error("invalid uint 32: "+e)}function gt(e){if("number"!=typeof e)throw new Error("invalid float 32: "+typeof e);if(Number.isFinite(e)&&(e>34028234663852886e22||e<-34028234663852886e22))throw new Error("invalid float 32: "+e)}const vt=Symbol("@bufbuild/protobuf/enum-type");function bt(e,t,n,i){e[vt]=yt(t,n.map((t=>({no:t.no,name:t.name,localName:e[t.no]}))))}function yt(e,t,n){const i=Object.create(null),r=Object.create(null),o=[];for(const e of t){const t=kt(e);o.push(t),i[e.name]=t,r[e.no]=t}return{typeName:e,values:o,findName:e=>i[e],findNumber:e=>r[e]}}function kt(e){return"localName"in e?e:Object.assign(Object.assign({},e),{localName:e.name})}class wt{equals(e){return this.getType().runtime.util.equals(this.getType(),this,e)}clone(){return this.getType().runtime.util.clone(this)}fromBinary(e,t){const n=this.getType().runtime.bin,i=n.makeReadOptions(t);return n.readMessage(this,i.readerFactory(e),e.byteLength,i),this}fromJson(e,t){const n=this.getType(),i=n.runtime.json,r=i.makeReadOptions(t);return i.readMessage(n,e,r,this),this}fromJsonString(e,t){let n;try{n=JSON.parse(e)}catch(e){throw new Error("cannot decode ".concat(this.getType().typeName," from JSON: ").concat(e instanceof Error?e.message:String(e)))}return this.fromJson(n,t)}toBinary(e){const t=this.getType().runtime.bin,n=t.makeWriteOptions(e),i=n.writerFactory();return t.writeMessage(this,i,n),i.finish()}toJson(e){const t=this.getType().runtime.json,n=t.makeWriteOptions(e);return t.writeMessage(this,n)}toJsonString(e){var t;const n=this.toJson(e);return JSON.stringify(n,null,null!==(t=null==e?void 0:e.prettySpaces)&&void 0!==t?t:0)}toJSON(){return this.toJson({emitDefaultValues:!0})}getType(){return Object.getPrototypeOf(this).constructor}}function Ct(){let e=0,t=0;for(let n=0;n<28;n+=7){let i=this.buf[this.pos++];if(e|=(127&i)<<n,!(128&i))return this.assertBounds(),[e,t]}let n=this.buf[this.pos++];if(e|=(15&n)<<28,t=(112&n)>>4,!(128&n))return this.assertBounds(),[e,t];for(let n=3;n<=31;n+=7){let i=this.buf[this.pos++];if(t|=(127&i)<<n,!(128&i))return this.assertBounds(),[e,t]}throw new Error("invalid varint")}function Tt(e,t,n){for(let i=0;i<28;i+=7){const r=e>>>i,o=!(r>>>7==0&&0==t),a=255&(o?128|r:r);if(n.push(a),!o)return}const i=e>>>28&15|(7&t)<<4,r=!!(t>>3);if(n.push(255&(r?128|i:i)),r){for(let e=3;e<31;e+=7){const i=t>>>e,r=!(i>>>7==0),o=255&(r?128|i:i);if(n.push(o),!r)return}n.push(t>>>31&1)}}const St=4294967296;function xt(e){const t="-"===e[0];t&&(e=e.slice(1));const n=1e6;let i=0,r=0;function o(t,o){const a=Number(e.slice(t,o));r*=n,i=i*n+a,i>=St&&(r+=i/St|0,i%=St)}return o(-24,-18),o(-18,-12),o(-12,-6),o(-6),t?Pt(i,r):_t(i,r)}function Et(e,t){if(({lo:e,hi:t}=function(e,t){return{lo:e>>>0,hi:t>>>0}}(e,t)),t<=2097151)return String(St*t+e);const n=16777215&(e>>>24|t<<8),i=t>>16&65535;let r=(16777215&e)+6777216*n+6710656*i,o=n+8147497*i,a=2*i;const s=1e7;return r>=s&&(o+=Math.floor(r/s),r%=s),o>=s&&(a+=Math.floor(o/s),o%=s),a.toString()+Rt(o)+Rt(r)}function _t(e,t){return{lo:0|e,hi:0|t}}function Pt(e,t){return t=~t,e?e=1+~e:t+=1,_t(e,t)}const Rt=e=>{const t=String(e);return"0000000".slice(t.length)+t};function It(e,t){if(e>=0){for(;e>127;)t.push(127&e|128),e>>>=7;t.push(e)}else{for(let n=0;n<9;n++)t.push(127&e|128),e>>=7;t.push(1)}}function Ot(){let e=this.buf[this.pos++],t=127&e;if(!(128&e))return this.assertBounds(),t;if(e=this.buf[this.pos++],t|=(127&e)<<7,!(128&e))return this.assertBounds(),t;if(e=this.buf[this.pos++],t|=(127&e)<<14,!(128&e))return this.assertBounds(),t;if(e=this.buf[this.pos++],t|=(127&e)<<21,!(128&e))return this.assertBounds(),t;e=this.buf[this.pos++],t|=(15&e)<<28;for(let t=5;128&e&&t<10;t++)e=this.buf[this.pos++];if(128&e)throw new Error("invalid varint");return this.assertBounds(),t>>>0}const Dt=function(){const e=new DataView(new ArrayBuffer(8));if("function"==typeof BigInt&&"function"==typeof e.getBigInt64&&"function"==typeof e.getBigUint64&&"function"==typeof e.setBigInt64&&"function"==typeof e.setBigUint64&&("object"!=typeof process||"object"!=typeof process.env||"1"!==process.env.BUF_BIGINT_DISABLE)){const t=BigInt("-9223372036854775808"),n=BigInt("9223372036854775807"),i=BigInt("0"),r=BigInt("18446744073709551615");return{zero:BigInt(0),supported:!0,parse(e){const i="bigint"==typeof e?e:BigInt(e);if(i>n||i<t)throw new Error("int64 invalid: ".concat(e));return i},uParse(e){const t="bigint"==typeof e?e:BigInt(e);if(t>r||t<i)throw new Error("uint64 invalid: ".concat(e));return t},enc(t){return e.setBigInt64(0,this.parse(t),!0),{lo:e.getInt32(0,!0),hi:e.getInt32(4,!0)}},uEnc(t){return e.setBigInt64(0,this.uParse(t),!0),{lo:e.getInt32(0,!0),hi:e.getInt32(4,!0)}},dec:(t,n)=>(e.setInt32(0,t,!0),e.setInt32(4,n,!0),e.getBigInt64(0,!0)),uDec:(t,n)=>(e.setInt32(0,t,!0),e.setInt32(4,n,!0),e.getBigUint64(0,!0))}}const t=e=>pt(/^-?[0-9]+$/.test(e),"int64 invalid: ".concat(e)),n=e=>pt(/^[0-9]+$/.test(e),"uint64 invalid: ".concat(e));return{zero:"0",supported:!1,parse:e=>("string"!=typeof e&&(e=e.toString()),t(e),e),uParse:e=>("string"!=typeof e&&(e=e.toString()),n(e),e),enc:e=>("string"!=typeof e&&(e=e.toString()),t(e),xt(e)),uEnc:e=>("string"!=typeof e&&(e=e.toString()),n(e),xt(e)),dec:(e,t)=>function(e,t){let n=_t(e,t);const i=2147483648&n.hi;i&&(n=Pt(n.lo,n.hi));const r=Et(n.lo,n.hi);return i?"-"+r:r}(e,t),uDec:(e,t)=>Et(e,t)}}();var Mt,At,Nt;function Lt(e,t,n){if(t===n)return!0;if(e==Mt.BYTES){if(!(t instanceof Uint8Array&&n instanceof Uint8Array))return!1;if(t.length!==n.length)return!1;for(let e=0;e<t.length;e++)if(t[e]!==n[e])return!1;return!0}switch(e){case Mt.UINT64:case Mt.FIXED64:case Mt.INT64:case Mt.SFIXED64:case Mt.SINT64:return t==n}return!1}function jt(e,t){switch(e){case Mt.BOOL:return!1;case Mt.UINT64:case Mt.FIXED64:case Mt.INT64:case Mt.SFIXED64:case Mt.SINT64:return 0==t?Dt.zero:"0";case Mt.DOUBLE:case Mt.FLOAT:return 0;case Mt.BYTES:return new Uint8Array(0);case Mt.STRING:return"";default:return 0}}function Ut(e,t){switch(e){case Mt.BOOL:return!1===t;case Mt.STRING:return""===t;case Mt.BYTES:return t instanceof Uint8Array&&!t.byteLength;default:return 0==t}}!function(e){e[e.DOUBLE=1]="DOUBLE",e[e.FLOAT=2]="FLOAT",e[e.INT64=3]="INT64",e[e.UINT64=4]="UINT64",e[e.INT32=5]="INT32",e[e.FIXED64=6]="FIXED64",e[e.FIXED32=7]="FIXED32",e[e.BOOL=8]="BOOL",e[e.STRING=9]="STRING",e[e.BYTES=12]="BYTES",e[e.UINT32=13]="UINT32",e[e.SFIXED32=15]="SFIXED32",e[e.SFIXED64=16]="SFIXED64",e[e.SINT32=17]="SINT32",e[e.SINT64=18]="SINT64"}(Mt||(Mt={})),function(e){e[e.BIGINT=0]="BIGINT",e[e.STRING=1]="STRING"}(At||(At={})),function(e){e[e.Varint=0]="Varint",e[e.Bit64=1]="Bit64",e[e.LengthDelimited=2]="LengthDelimited",e[e.StartGroup=3]="StartGroup",e[e.EndGroup=4]="EndGroup",e[e.Bit32=5]="Bit32"}(Nt||(Nt={}));class Ft{constructor(e){this.stack=[],this.textEncoder=null!=e?e:new TextEncoder,this.chunks=[],this.buf=[]}finish(){this.chunks.push(new Uint8Array(this.buf));let e=0;for(let t=0;t<this.chunks.length;t++)e+=this.chunks[t].length;let t=new Uint8Array(e),n=0;for(let e=0;e<this.chunks.length;e++)t.set(this.chunks[e],n),n+=this.chunks[e].length;return this.chunks=[],t}fork(){return this.stack.push({chunks:this.chunks,buf:this.buf}),this.chunks=[],this.buf=[],this}join(){let e=this.finish(),t=this.stack.pop();if(!t)throw new Error("invalid state, fork stack empty");return this.chunks=t.chunks,this.buf=t.buf,this.uint32(e.byteLength),this.raw(e)}tag(e,t){return this.uint32((e<<3|t)>>>0)}raw(e){return this.buf.length&&(this.chunks.push(new Uint8Array(this.buf)),this.buf=[]),this.chunks.push(e),this}uint32(e){for(ft(e);e>127;)this.buf.push(127&e|128),e>>>=7;return this.buf.push(e),this}int32(e){return mt(e),It(e,this.buf),this}bool(e){return this.buf.push(e?1:0),this}bytes(e){return this.uint32(e.byteLength),this.raw(e)}string(e){let t=this.textEncoder.encode(e);return this.uint32(t.byteLength),this.raw(t)}float(e){gt(e);let t=new Uint8Array(4);return new DataView(t.buffer).setFloat32(0,e,!0),this.raw(t)}double(e){let t=new Uint8Array(8);return new DataView(t.buffer).setFloat64(0,e,!0),this.raw(t)}fixed32(e){ft(e);let t=new Uint8Array(4);return new DataView(t.buffer).setUint32(0,e,!0),this.raw(t)}sfixed32(e){mt(e);let t=new Uint8Array(4);return new DataView(t.buffer).setInt32(0,e,!0),this.raw(t)}sint32(e){return mt(e),It(e=(e<<1^e>>31)>>>0,this.buf),this}sfixed64(e){let t=new Uint8Array(8),n=new DataView(t.buffer),i=Dt.enc(e);return n.setInt32(0,i.lo,!0),n.setInt32(4,i.hi,!0),this.raw(t)}fixed64(e){let t=new Uint8Array(8),n=new DataView(t.buffer),i=Dt.uEnc(e);return n.setInt32(0,i.lo,!0),n.setInt32(4,i.hi,!0),this.raw(t)}int64(e){let t=Dt.enc(e);return Tt(t.lo,t.hi,this.buf),this}sint64(e){let t=Dt.enc(e),n=t.hi>>31;return Tt(t.lo<<1^n,(t.hi<<1|t.lo>>>31)^n,this.buf),this}uint64(e){let t=Dt.uEnc(e);return Tt(t.lo,t.hi,this.buf),this}}class Bt{constructor(e,t){this.varint64=Ct,this.uint32=Ot,this.buf=e,this.len=e.length,this.pos=0,this.view=new DataView(e.buffer,e.byteOffset,e.byteLength),this.textDecoder=null!=t?t:new TextDecoder}tag(){let e=this.uint32(),t=e>>>3,n=7&e;if(t<=0||n<0||n>5)throw new Error("illegal tag: field no "+t+" wire type "+n);return[t,n]}skip(e,t){let n=this.pos;switch(e){case Nt.Varint:for(;128&this.buf[this.pos++];);break;case Nt.Bit64:this.pos+=4;case Nt.Bit32:this.pos+=4;break;case Nt.LengthDelimited:let n=this.uint32();this.pos+=n;break;case Nt.StartGroup:for(;;){const[e,n]=this.tag();if(n===Nt.EndGroup){if(void 0!==t&&e!==t)throw new Error("invalid end group tag");break}this.skip(n,e)}break;default:throw new Error("cant skip wire type "+e)}return this.assertBounds(),this.buf.subarray(n,this.pos)}assertBounds(){if(this.pos>this.len)throw new RangeError("premature EOF")}int32(){return 0|this.uint32()}sint32(){let e=this.uint32();return e>>>1^-(1&e)}int64(){return Dt.dec(...this.varint64())}uint64(){return Dt.uDec(...this.varint64())}sint64(){let[e,t]=this.varint64(),n=-(1&e);return e=(e>>>1|(1&t)<<31)^n,t=t>>>1^n,Dt.dec(e,t)}bool(){let[e,t]=this.varint64();return 0!==e||0!==t}fixed32(){return this.view.getUint32((this.pos+=4)-4,!0)}sfixed32(){return this.view.getInt32((this.pos+=4)-4,!0)}fixed64(){return Dt.uDec(this.sfixed32(),this.sfixed32())}sfixed64(){return Dt.dec(this.sfixed32(),this.sfixed32())}float(){return this.view.getFloat32((this.pos+=4)-4,!0)}double(){return this.view.getFloat64((this.pos+=8)-8,!0)}bytes(){let e=this.uint32(),t=this.pos;return this.pos+=e,this.assertBounds(),this.buf.subarray(t,t+e)}string(){return this.textDecoder.decode(this.bytes())}}function Vt(e){const t=e.field.localName,n=Object.create(null);return n[t]=function(e){const t=e.field;if(t.repeated)return[];if(void 0!==t.default)return t.default;switch(t.kind){case"enum":return t.T.values[0].no;case"scalar":return jt(t.T,t.L);case"message":const e=t.T,n=new e;return e.fieldWrapper?e.fieldWrapper.unwrapField(n):n;case"map":throw"map fields are not allowed to be extensions"}}(e),[n,()=>n[t]]}let qt="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/".split(""),Wt=[];for(let e=0;e<qt.length;e++)Wt[qt[e].charCodeAt(0)]=e;Wt["-".charCodeAt(0)]=qt.indexOf("+"),Wt["_".charCodeAt(0)]=qt.indexOf("/");const Ht={dec(e){let t=3*e.length/4;"="==e[e.length-2]?t-=2:"="==e[e.length-1]&&(t-=1);let n,i=new Uint8Array(t),r=0,o=0,a=0;for(let t=0;t<e.length;t++){if(n=Wt[e.charCodeAt(t)],void 0===n)switch(e[t]){case"=":o=0;case"\n":case"\r":case"\t":case" ":continue;default:throw Error("invalid base64 string.")}switch(o){case 0:a=n,o=1;break;case 1:i[r++]=a<<2|(48&n)>>4,a=n,o=2;break;case 2:i[r++]=(15&a)<<4|(60&n)>>2,a=n,o=3;break;case 3:i[r++]=(3&a)<<6|n,o=0}}if(1==o)throw Error("invalid base64 string.");return i.subarray(0,r)},enc(e){let t,n="",i=0,r=0;for(let o=0;o<e.length;o++)switch(t=e[o],i){case 0:n+=qt[t>>2],r=(3&t)<<4,i=1;break;case 1:n+=qt[r|t>>4],r=(15&t)<<2,i=2;break;case 2:n+=qt[r|t>>6],n+=qt[63&t],i=0}return i&&(n+=qt[r],n+="=",1==i&&(n+="=")),n}};function zt(e,t,n){Jt(t,e);const i=t.runtime.bin.makeReadOptions(n),r=function(e,t){if(!t.repeated&&("enum"==t.kind||"scalar"==t.kind)){for(let n=e.length-1;n>=0;--n)if(e[n].no==t.no)return[e[n]];return[]}return e.filter((e=>e.no===t.no))}(e.getType().runtime.bin.listUnknownFields(e),t.field),[o,a]=Vt(t);for(const e of r)t.runtime.bin.readField(o,i.readerFactory(e.data),t.field,e.wireType,i);return a()}function Gt(e,t,n,i){Jt(t,e);const r=t.runtime.bin.makeReadOptions(i),o=t.runtime.bin.makeWriteOptions(i);if(Kt(e,t)){const n=e.getType().runtime.bin.listUnknownFields(e).filter((e=>e.no!=t.field.no));e.getType().runtime.bin.discardUnknownFields(e);for(const t of n)e.getType().runtime.bin.onUnknownField(e,t.no,t.wireType,t.data)}const a=o.writerFactory();let s=t.field;s.opt||s.repeated||"enum"!=s.kind&&"scalar"!=s.kind||(s=Object.assign(Object.assign({},t.field),{opt:!0})),t.runtime.bin.writeField(s,n,a,o);const c=r.readerFactory(a.finish());for(;c.pos<c.len;){const[t,n]=c.tag(),i=c.skip(n,t);e.getType().runtime.bin.onUnknownField(e,t,n,i)}}function Kt(e,t){const n=e.getType();return t.extendee.typeName===n.typeName&&!!n.runtime.bin.listUnknownFields(e).find((e=>e.no==t.field.no))}function Jt(e,t){pt(e.extendee.typeName==t.getType().typeName,"extension ".concat(e.typeName," can only be applied to message ").concat(e.extendee.typeName))}function Yt(e,t){const n=e.localName;if(e.repeated)return t[n].length>0;if(e.oneof)return t[e.oneof.localName].case===n;switch(e.kind){case"enum":case"scalar":return e.opt||e.req?void 0!==t[n]:"enum"==e.kind?t[n]!==e.T.values[0].no:!Ut(e.T,t[n]);case"message":return void 0!==t[n];case"map":return Object.keys(t[n]).length>0}}function Xt(e,t){const n=e.localName,i=!e.opt&&!e.req;if(e.repeated)t[n]=[];else if(e.oneof)t[e.oneof.localName]={case:void 0};else switch(e.kind){case"map":t[n]={};break;case"enum":t[n]=i?e.T.values[0].no:void 0;break;case"scalar":t[n]=i?jt(e.T,e.L):void 0;break;case"message":t[n]=void 0}}function $t(e,t){if(null===e||"object"!=typeof e)return!1;if(!Object.getOwnPropertyNames(wt.prototype).every((t=>t in e&&"function"==typeof e[t])))return!1;const n=e.getType();return null!==n&&"function"==typeof n&&"typeName"in n&&"string"==typeof n.typeName&&(void 0===t||n.typeName==t.typeName)}function Qt(e,t){return $t(t)||!e.fieldWrapper?t:e.fieldWrapper.wrapField(t)}Mt.DOUBLE,Mt.FLOAT,Mt.INT64,Mt.UINT64,Mt.INT32,Mt.UINT32,Mt.BOOL,Mt.STRING,Mt.BYTES;const Zt={ignoreUnknownFields:!1},en={emitDefaultValues:!1,enumAsInteger:!1,useProtoFieldName:!1,prettySpaces:0};const tn=Symbol(),nn=Symbol();function rn(e){if(null===e)return"null";switch(typeof e){case"object":return Array.isArray(e)?"array":"object";case"string":return e.length>100?"string":'"'.concat(e.split('"').join('\\"'),'"');default:return String(e)}}function on(e,t,n,i,r){let o=n.localName;if(n.repeated){if(pt("map"!=n.kind),null===t)return;if(!Array.isArray(t))throw new Error("cannot decode field ".concat(r.typeName,".").concat(n.name," from JSON: ").concat(rn(t)));const a=e[o];for(const e of t){if(null===e)throw new Error("cannot decode field ".concat(r.typeName,".").concat(n.name," from JSON: ").concat(rn(e)));switch(n.kind){case"message":a.push(n.T.fromJson(e,i));break;case"enum":const t=cn(n.T,e,i.ignoreUnknownFields,!0);t!==nn&&a.push(t);break;case"scalar":try{a.push(sn(n.T,e,n.L,!0))}catch(t){let i="cannot decode field ".concat(r.typeName,".").concat(n.name," from JSON: ").concat(rn(e));throw t instanceof Error&&t.message.length>0&&(i+=": ".concat(t.message)),new Error(i)}}}}else if("map"==n.kind){if(null===t)return;if("object"!=typeof t||Array.isArray(t))throw new Error("cannot decode field ".concat(r.typeName,".").concat(n.name," from JSON: ").concat(rn(t)));const a=e[o];for(const[e,o]of Object.entries(t)){if(null===o)throw new Error("cannot decode field ".concat(r.typeName,".").concat(n.name," from JSON: map value null"));let s;try{s=an(n.K,e)}catch(e){let i="cannot decode map key for field ".concat(r.typeName,".").concat(n.name," from JSON: ").concat(rn(t));throw e instanceof Error&&e.message.length>0&&(i+=": ".concat(e.message)),new Error(i)}switch(n.V.kind){case"message":a[s]=n.V.T.fromJson(o,i);break;case"enum":const e=cn(n.V.T,o,i.ignoreUnknownFields,!0);e!==nn&&(a[s]=e);break;case"scalar":try{a[s]=sn(n.V.T,o,At.BIGINT,!0)}catch(e){let i="cannot decode map value for field ".concat(r.typeName,".").concat(n.name," from JSON: ").concat(rn(t));throw e instanceof Error&&e.message.length>0&&(i+=": ".concat(e.message)),new Error(i)}}}}else switch(n.oneof&&(e=e[n.oneof.localName]={case:o},o="value"),n.kind){case"message":const a=n.T;if(null===t&&"google.protobuf.Value"!=a.typeName)return;let s=e[o];$t(s)?s.fromJson(t,i):(e[o]=s=a.fromJson(t,i),a.fieldWrapper&&!n.oneof&&(e[o]=a.fieldWrapper.unwrapField(s)));break;case"enum":const c=cn(n.T,t,i.ignoreUnknownFields,!1);switch(c){case tn:Xt(n,e);break;case nn:break;default:e[o]=c}break;case"scalar":try{const i=sn(n.T,t,n.L,!1);i===tn?Xt(n,e):e[o]=i}catch(e){let i="cannot decode field ".concat(r.typeName,".").concat(n.name," from JSON: ").concat(rn(t));throw e instanceof Error&&e.message.length>0&&(i+=": ".concat(e.message)),new Error(i)}}}function an(e,t){if(e===Mt.BOOL)switch(t){case"true":t=!0;break;case"false":t=!1}return sn(e,t,At.BIGINT,!0).toString()}function sn(e,t,n,i){if(null===t)return i?jt(e,n):tn;switch(e){case Mt.DOUBLE:case Mt.FLOAT:if("NaN"===t)return Number.NaN;if("Infinity"===t)return Number.POSITIVE_INFINITY;if("-Infinity"===t)return Number.NEGATIVE_INFINITY;if(""===t)break;if("string"==typeof t&&t.trim().length!==t.length)break;if("string"!=typeof t&&"number"!=typeof t)break;const i=Number(t);if(Number.isNaN(i))break;if(!Number.isFinite(i))break;return e==Mt.FLOAT&&gt(i),i;case Mt.INT32:case Mt.FIXED32:case Mt.SFIXED32:case Mt.SINT32:case Mt.UINT32:let r;if("number"==typeof t?r=t:"string"==typeof t&&t.length>0&&t.trim().length===t.length&&(r=Number(t)),void 0===r)break;return e==Mt.UINT32||e==Mt.FIXED32?ft(r):mt(r),r;case Mt.INT64:case Mt.SFIXED64:case Mt.SINT64:if("number"!=typeof t&&"string"!=typeof t)break;const o=Dt.parse(t);return n?o.toString():o;case Mt.FIXED64:case Mt.UINT64:if("number"!=typeof t&&"string"!=typeof t)break;const a=Dt.uParse(t);return n?a.toString():a;case Mt.BOOL:if("boolean"!=typeof t)break;return t;case Mt.STRING:if("string"!=typeof t)break;try{encodeURIComponent(t)}catch(e){throw new Error("invalid UTF8")}return t;case Mt.BYTES:if(""===t)return new Uint8Array(0);if("string"!=typeof t)break;return Ht.dec(t)}throw new Error}function cn(e,t,n,i){if(null===t)return"google.protobuf.NullValue"==e.typeName?0:i?e.values[0].no:tn;switch(typeof t){case"number":if(Number.isInteger(t))return t;break;case"string":const i=e.findName(t);if(void 0!==i)return i.no;if(n)return nn}throw new Error("cannot decode enum ".concat(e.typeName," from JSON: ").concat(rn(t)))}function ln(e){return!(!e.repeated&&"map"!=e.kind&&(e.oneof||"message"==e.kind||e.opt||e.req))}function dn(e,t,n){if("map"==e.kind){pt("object"==typeof t&&null!=t);const i={},r=Object.entries(t);switch(e.V.kind){case"scalar":for(const[t,n]of r)i[t.toString()]=hn(e.V.T,n);break;case"message":for(const[e,t]of r)i[e.toString()]=t.toJson(n);break;case"enum":const t=e.V.T;for(const[e,o]of r)i[e.toString()]=un(t,o,n.enumAsInteger)}return n.emitDefaultValues||r.length>0?i:void 0}if(e.repeated){pt(Array.isArray(t));const i=[];switch(e.kind){case"scalar":for(let n=0;n<t.length;n++)i.push(hn(e.T,t[n]));break;case"enum":for(let r=0;r<t.length;r++)i.push(un(e.T,t[r],n.enumAsInteger));break;case"message":for(let e=0;e<t.length;e++)i.push(t[e].toJson(n))}return n.emitDefaultValues||i.length>0?i:void 0}switch(e.kind){case"scalar":return hn(e.T,t);case"enum":return un(e.T,t,n.enumAsInteger);case"message":return Qt(e.T,t).toJson(n)}}function un(e,t,n){var i;if(pt("number"==typeof t),"google.protobuf.NullValue"==e.typeName)return null;if(n)return t;const r=e.findNumber(t);return null!==(i=null==r?void 0:r.name)&&void 0!==i?i:t}function hn(e,t){switch(e){case Mt.INT32:case Mt.SFIXED32:case Mt.SINT32:case Mt.FIXED32:case Mt.UINT32:return pt("number"==typeof t),t;case Mt.FLOAT:case Mt.DOUBLE:return pt("number"==typeof t),Number.isNaN(t)?"NaN":t===Number.POSITIVE_INFINITY?"Infinity":t===Number.NEGATIVE_INFINITY?"-Infinity":t;case Mt.STRING:return pt("string"==typeof t),t;case Mt.BOOL:return pt("boolean"==typeof t),t;case Mt.UINT64:case Mt.FIXED64:case Mt.INT64:case Mt.SFIXED64:case Mt.SINT64:return pt("bigint"==typeof t||"string"==typeof t||"number"==typeof t),t.toString();case Mt.BYTES:return pt(t instanceof Uint8Array),Ht.enc(t)}}const pn=Symbol("@bufbuild/protobuf/unknown-fields"),mn={readUnknownFields:!0,readerFactory:e=>new Bt(e)},fn={writeUnknownFields:!0,writerFactory:()=>new Ft};function gn(e,t,n,i,r){let{repeated:o,localName:a}=n;switch(n.oneof&&((e=e[n.oneof.localName]).case!=a&&delete e.value,e.case=a,a="value"),n.kind){case"scalar":case"enum":const s="enum"==n.kind?Mt.INT32:n.T;let c=yn;if("scalar"==n.kind&&n.L>0&&(c=bn),o){let n=e[a];if(i==Nt.LengthDelimited&&s!=Mt.STRING&&s!=Mt.BYTES){let e=t.uint32()+t.pos;for(;t.pos<e;)n.push(c(t,s))}else n.push(c(t,s))}else e[a]=c(t,s);break;case"message":const l=n.T;o?e[a].push(vn(t,new l,r,n)):$t(e[a])?vn(t,e[a],r,n):(e[a]=vn(t,new l,r,n),!l.fieldWrapper||n.oneof||n.repeated||(e[a]=l.fieldWrapper.unwrapField(e[a])));break;case"map":let[d,u]=function(e,t,n){const i=t.uint32(),r=t.pos+i;let o,a;for(;t.pos<r;){const[i]=t.tag();switch(i){case 1:o=yn(t,e.K);break;case 2:switch(e.V.kind){case"scalar":a=yn(t,e.V.T);break;case"enum":a=t.int32();break;case"message":a=vn(t,new e.V.T,n,void 0)}}}if(void 0===o&&(o=jt(e.K,At.BIGINT)),"string"!=typeof o&&"number"!=typeof o&&(o=o.toString()),void 0===a)switch(e.V.kind){case"scalar":a=jt(e.V.T,At.BIGINT);break;case"enum":a=e.V.T.values[0].no;break;case"message":a=new e.V.T}return[o,a]}(n,t,r);e[a][d]=u}}function vn(e,t,n,i){const r=t.getType().runtime.bin,o=null==i?void 0:i.delimited;return r.readMessage(t,e,o?i.no:e.uint32(),n,o),t}function bn(e,t){const n=yn(e,t);return"bigint"==typeof n?n.toString():n}function yn(e,t){switch(t){case Mt.STRING:return e.string();case Mt.BOOL:return e.bool();case Mt.DOUBLE:return e.double();case Mt.FLOAT:return e.float();case Mt.INT32:return e.int32();case Mt.INT64:return e.int64();case Mt.UINT64:return e.uint64();case Mt.FIXED64:return e.fixed64();case Mt.BYTES:return e.bytes();case Mt.FIXED32:return e.fixed32();case Mt.SFIXED32:return e.sfixed32();case Mt.SFIXED64:return e.sfixed64();case Mt.SINT64:return e.sint64();case Mt.UINT32:return e.uint32();case Mt.SINT32:return e.sint32()}}function kn(e,t,n,i){pt(void 0!==t);const r=e.repeated;switch(e.kind){case"scalar":case"enum":let o="enum"==e.kind?Mt.INT32:e.T;if(r)if(pt(Array.isArray(t)),e.packed)!function(e,t,n,i){if(!i.length)return;e.tag(n,Nt.LengthDelimited).fork();let[,r]=Sn(t);for(let t=0;t<i.length;t++)e[r](i[t]);e.join()}(n,o,e.no,t);else for(const i of t)Tn(n,o,e.no,i);else Tn(n,o,e.no,t);break;case"message":if(r){pt(Array.isArray(t));for(const r of t)Cn(n,i,e,r)}else Cn(n,i,e,t);break;case"map":pt("object"==typeof t&&null!=t);for(const[r,o]of Object.entries(t))wn(n,i,e,r,o)}}function wn(e,t,n,i,r){e.tag(n.no,Nt.LengthDelimited),e.fork();let o=i;switch(n.K){case Mt.INT32:case Mt.FIXED32:case Mt.UINT32:case Mt.SFIXED32:case Mt.SINT32:o=Number.parseInt(i);break;case Mt.BOOL:pt("true"==i||"false"==i),o="true"==i}switch(Tn(e,n.K,1,o),n.V.kind){case"scalar":Tn(e,n.V.T,2,r);break;case"enum":Tn(e,Mt.INT32,2,r);break;case"message":pt(void 0!==r),e.tag(2,Nt.LengthDelimited).bytes(r.toBinary(t))}e.join()}function Cn(e,t,n,i){const r=Qt(n.T,i);n.delimited?e.tag(n.no,Nt.StartGroup).raw(r.toBinary(t)).tag(n.no,Nt.EndGroup):e.tag(n.no,Nt.LengthDelimited).bytes(r.toBinary(t))}function Tn(e,t,n,i){pt(void 0!==i);let[r,o]=Sn(t);e.tag(n,r)[o](i)}function Sn(e){let t=Nt.Varint;switch(e){case Mt.BYTES:case Mt.STRING:t=Nt.LengthDelimited;break;case Mt.DOUBLE:case Mt.FIXED64:case Mt.SFIXED64:t=Nt.Bit64;break;case Mt.FIXED32:case Mt.SFIXED32:case Mt.FLOAT:t=Nt.Bit32}return[t,Mt[e].toLowerCase()]}function xn(e){if(void 0===e)return e;if($t(e))return e.clone();if(e instanceof Uint8Array){const t=new Uint8Array(e.byteLength);return t.set(e),t}return e}function En(e){return e instanceof Uint8Array?e:new Uint8Array(e)}class _n{constructor(e,t){this._fields=e,this._normalizer=t}findJsonName(e){if(!this.jsonNames){const e={};for(const t of this.list())e[t.jsonName]=e[t.name]=t;this.jsonNames=e}return this.jsonNames[e]}find(e){if(!this.numbers){const e={};for(const t of this.list())e[t.no]=t;this.numbers=e}return this.numbers[e]}list(){return this.all||(this.all=this._normalizer(this._fields)),this.all}byNumber(){return this.numbersAsc||(this.numbersAsc=this.list().concat().sort(((e,t)=>e.no-t.no))),this.numbersAsc}byMember(){if(!this.members){this.members=[];const e=this.members;let t;for(const n of this.list())n.oneof?n.oneof!==t&&(t=n.oneof,e.push(t)):e.push(n)}return this.members}}function Pn(e,t){const n=In(e);return t?n:Nn(An(n))}const Rn=In;function In(e){let t=!1;const n=[];for(let i=0;i<e.length;i++){let r=e.charAt(i);switch(r){case"_":t=!0;break;case"0":case"1":case"2":case"3":case"4":case"5":case"6":case"7":case"8":case"9":n.push(r),t=!1;break;default:t&&(t=!1,r=r.toUpperCase()),n.push(r)}}return n.join("")}const On=new Set(["constructor","toString","toJSON","valueOf"]),Dn=new Set(["getType","clone","equals","fromBinary","fromJson","fromJsonString","toBinary","toJson","toJsonString","toObject"]),Mn=e=>"".concat(e,"$"),An=e=>Dn.has(e)?Mn(e):e,Nn=e=>On.has(e)?Mn(e):e;class Ln{constructor(e){this.kind="oneof",this.repeated=!1,this.packed=!1,this.opt=!1,this.req=!1,this.default=void 0,this.fields=[],this.name=e,this.localName=Pn(e,!1)}addField(e){pt(e.oneof===this,"field ".concat(e.name," not one of ").concat(this.name)),this.fields.push(e)}findField(e){if(!this._lookup){this._lookup=Object.create(null);for(let e=0;e<this.fields.length;e++)this._lookup[this.fields[e].localName]=this.fields[e]}return this._lookup[e]}}const jn=(Un=e=>new _n(e,(e=>function(e){var t,n,i,r,o,a;const s=[];let c;for(const l of"function"==typeof e?e():e){const e=l;if(e.localName=Pn(l.name,void 0!==l.oneof),e.jsonName=null!==(t=l.jsonName)&&void 0!==t?t:Rn(l.name),e.repeated=null!==(n=l.repeated)&&void 0!==n&&n,"scalar"==l.kind&&(e.L=null!==(i=l.L)&&void 0!==i?i:At.BIGINT),e.delimited=null!==(r=l.delimited)&&void 0!==r&&r,e.req=null!==(o=l.req)&&void 0!==o&&o,e.opt=null!==(a=l.opt)&&void 0!==a&&a,void 0===l.packed&&(e.packed="enum"==l.kind||"scalar"==l.kind&&l.T!=Mt.BYTES&&l.T!=Mt.STRING),void 0!==l.oneof){const t="string"==typeof l.oneof?l.oneof:l.oneof.name;c&&c.name==t||(c=new Ln(t)),e.oneof=c,c.addField(e)}s.push(e)}return s}(e))),Fn=e=>{for(const t of e.getType().fields.byMember()){if(t.opt)continue;const n=t.localName,i=e;if(t.repeated)i[n]=[];else switch(t.kind){case"oneof":i[n]={case:void 0};break;case"enum":i[n]=0;break;case"map":i[n]={};break;case"scalar":i[n]=jt(t.T,t.L)}}},{syntax:"proto3",json:{makeReadOptions:function(e){return e?Object.assign(Object.assign({},Zt),e):Zt},makeWriteOptions:function(e){return e?Object.assign(Object.assign({},en),e):en},readMessage(e,t,n,i){if(null==t||Array.isArray(t)||"object"!=typeof t)throw new Error("cannot decode message ".concat(e.typeName," from JSON: ").concat(rn(t)));i=null!=i?i:new e;const r=new Map,o=n.typeRegistry;for(const[a,s]of Object.entries(t)){const t=e.fields.findJsonName(a);if(t){if(t.oneof){if(null===s&&"scalar"==t.kind)continue;const n=r.get(t.oneof);if(void 0!==n)throw new Error("cannot decode message ".concat(e.typeName,' from JSON: multiple keys for oneof "').concat(t.oneof.name,'" present: "').concat(n,'", "').concat(a,'"'));r.set(t.oneof,a)}on(i,s,t,n,e)}else{let t=!1;if((null==o?void 0:o.findExtension)&&a.startsWith("[")&&a.endsWith("]")){const r=o.findExtension(a.substring(1,a.length-1));if(r&&r.extendee.typeName==e.typeName){t=!0;const[e,o]=Vt(r);on(e,s,r.field,n,r),Gt(i,r,o(),n)}}if(!t&&!n.ignoreUnknownFields)throw new Error("cannot decode message ".concat(e.typeName,' from JSON: key "').concat(a,'" is unknown'))}}return i},writeMessage(e,t){const n=e.getType(),i={};let r;try{for(r of n.fields.byNumber()){if(!Yt(r,e)){if(r.req)throw"required field not set";if(!t.emitDefaultValues)continue;if(!ln(r))continue}const n=dn(r,r.oneof?e[r.oneof.localName].value:e[r.localName],t);void 0!==n&&(i[t.useProtoFieldName?r.name:r.jsonName]=n)}const o=t.typeRegistry;if(null==o?void 0:o.findExtensionFor)for(const r of n.runtime.bin.listUnknownFields(e)){const a=o.findExtensionFor(n.typeName,r.no);if(a&&Kt(e,a)){const n=zt(e,a,t),r=dn(a.field,n,t);void 0!==r&&(i[a.field.jsonName]=r)}}}catch(e){const t=r?"cannot encode field ".concat(n.typeName,".").concat(r.name," to JSON"):"cannot encode message ".concat(n.typeName," to JSON"),i=e instanceof Error?e.message:String(e);throw new Error(t+(i.length>0?": ".concat(i):""))}return i},readScalar:(e,t,n)=>sn(e,t,null!=n?n:At.BIGINT,!0),writeScalar(e,t,n){if(void 0!==t)return n||Ut(e,t)?hn(e,t):void 0},debug:rn},bin:{makeReadOptions:function(e){return e?Object.assign(Object.assign({},mn),e):mn},makeWriteOptions:function(e){return e?Object.assign(Object.assign({},fn),e):fn},listUnknownFields(e){var t;return null!==(t=e[pn])&&void 0!==t?t:[]},discardUnknownFields(e){delete e[pn]},writeUnknownFields(e,t){const n=e[pn];if(n)for(const e of n)t.tag(e.no,e.wireType).raw(e.data)},onUnknownField(e,t,n,i){const r=e;Array.isArray(r[pn])||(r[pn]=[]),r[pn].push({no:t,wireType:n,data:i})},readMessage(e,t,n,i,r){const o=e.getType(),a=r?t.len:t.pos+n;let s,c;for(;t.pos<a&&([s,c]=t.tag(),!0!==r||c!=Nt.EndGroup);){const n=o.fields.find(s);if(n)gn(e,t,n,c,i);else{const n=t.skip(c,s);i.readUnknownFields&&this.onUnknownField(e,s,c,n)}}if(r&&(c!=Nt.EndGroup||s!==n))throw new Error("invalid end group tag")},readField:gn,writeMessage(e,t,n){const i=e.getType();for(const r of i.fields.byNumber())if(Yt(r,e))kn(r,r.oneof?e[r.oneof.localName].value:e[r.localName],t,n);else if(r.req)throw new Error("cannot encode field ".concat(i.typeName,".").concat(r.name," to binary: required field not set"));return n.writeUnknownFields&&this.writeUnknownFields(e,t),t},writeField(e,t,n,i){void 0!==t&&kn(e,t,n,i)}},util:Object.assign(Object.assign({},{setEnumType:bt,initPartial(e,t){if(void 0===e)return;const n=t.getType();for(const i of n.fields.byMember()){const n=i.localName,r=t,o=e;if(null!=o[n])switch(i.kind){case"oneof":const e=o[n].case;if(void 0===e)continue;const t=i.findField(e);let a=o[n].value;t&&"message"==t.kind&&!$t(a,t.T)?a=new t.T(a):t&&"scalar"===t.kind&&t.T===Mt.BYTES&&(a=En(a)),r[n]={case:e,value:a};break;case"scalar":case"enum":let s=o[n];i.T===Mt.BYTES&&(s=i.repeated?s.map(En):En(s)),r[n]=s;break;case"map":switch(i.V.kind){case"scalar":case"enum":if(i.V.T===Mt.BYTES)for(const[e,t]of Object.entries(o[n]))r[n][e]=En(t);else Object.assign(r[n],o[n]);break;case"message":const e=i.V.T;for(const t of Object.keys(o[n])){let i=o[n][t];e.fieldWrapper||(i=new e(i)),r[n][t]=i}}break;case"message":const c=i.T;if(i.repeated)r[n]=o[n].map((e=>$t(e,c)?e:new c(e)));else{const e=o[n];c.fieldWrapper?"google.protobuf.BytesValue"===c.typeName?r[n]=En(e):r[n]=e:r[n]=$t(e,c)?e:new c(e)}}}},equals:(e,t,n)=>t===n||!(!t||!n)&&e.fields.byMember().every((e=>{const i=t[e.localName],r=n[e.localName];if(e.repeated){if(i.length!==r.length)return!1;switch(e.kind){case"message":return i.every(((t,n)=>e.T.equals(t,r[n])));case"scalar":return i.every(((t,n)=>Lt(e.T,t,r[n])));case"enum":return i.every(((e,t)=>Lt(Mt.INT32,e,r[t])))}throw new Error("repeated cannot contain ".concat(e.kind))}switch(e.kind){case"message":let t=i,n=r;return e.T.fieldWrapper&&(void 0===t||$t(t)||(t=e.T.fieldWrapper.wrapField(t)),void 0===n||$t(n)||(n=e.T.fieldWrapper.wrapField(n))),e.T.equals(t,n);case"enum":return Lt(Mt.INT32,i,r);case"scalar":return Lt(e.T,i,r);case"oneof":if(i.case!==r.case)return!1;const o=e.findField(i.case);if(void 0===o)return!0;switch(o.kind){case"message":return o.T.equals(i.value,r.value);case"enum":return Lt(Mt.INT32,i.value,r.value);case"scalar":return Lt(o.T,i.value,r.value)}throw new Error("oneof cannot contain ".concat(o.kind));case"map":const a=Object.keys(i).concat(Object.keys(r));switch(e.V.kind){case"message":const t=e.V.T;return a.every((e=>t.equals(i[e],r[e])));case"enum":return a.every((e=>Lt(Mt.INT32,i[e],r[e])));case"scalar":const n=e.V.T;return a.every((e=>Lt(n,i[e],r[e])))}}})),clone(e){const t=e.getType(),n=new t,i=n;for(const n of t.fields.byMember()){const t=e[n.localName];let r;if(n.repeated)r=t.map(xn);else if("map"==n.kind){r=i[n.localName];for(const[e,n]of Object.entries(t))r[e]=xn(n)}else r="oneof"==n.kind?n.findField(t.case)?{case:t.case,value:xn(t.value)}:{case:void 0}:xn(t);i[n.localName]=r}for(const n of t.runtime.bin.listUnknownFields(e))t.runtime.bin.onUnknownField(i,n.no,n.wireType,n.data);return n}}),{newFieldList:Un,initFields:Fn}),makeMessageType(e,t,n){return function(e,t,n,i){var r;const o=null!==(r=null==i?void 0:i.localName)&&void 0!==r?r:t.substring(t.lastIndexOf(".")+1),a={[o]:function(t){e.util.initFields(this),e.util.initPartial(t,this)}}[o];return Object.setPrototypeOf(a.prototype,new wt),Object.assign(a,{runtime:e,typeName:t,fields:e.util.newFieldList(n),fromBinary:(e,t)=>(new a).fromBinary(e,t),fromJson:(e,t)=>(new a).fromJson(e,t),fromJsonString:(e,t)=>(new a).fromJsonString(e,t),equals:(t,n)=>e.util.equals(a,t,n)}),a}(this,e,t,n)},makeEnum:function(e,t,n){const i={};for(const e of t){const t=kt(e);i[t.localName]=t.no,i[t.no]=t.localName}return bt(i,e,t),i},makeEnumType:yt,getEnumType:function(e){const t=e[vt];return pt(t,"missing enum type on enum object"),t},makeExtension(e,t,n){return function(e,t,n,i){let r;return{typeName:t,extendee:n,get field(){if(!r){const n="function"==typeof i?i():i;n.name=t.split(".").pop(),n.jsonName="[".concat(t,"]"),r=e.util.newFieldList([n]).list()[0]}return r},runtime:e}}(this,e,t,n)}});var Un,Fn;class Bn extends wt{constructor(e){super(),this.seconds=Dt.zero,this.nanos=0,jn.util.initPartial(e,this)}fromJson(e,t){if("string"!=typeof e)throw new Error("cannot decode google.protobuf.Timestamp from JSON: ".concat(jn.json.debug(e)));const n=e.match(/^([0-9]{4})-([0-9]{2})-([0-9]{2})T([0-9]{2}):([0-9]{2}):([0-9]{2})(?:Z|\.([0-9]{3,9})Z|([+-][0-9][0-9]:[0-9][0-9]))$/);if(!n)throw new Error("cannot decode google.protobuf.Timestamp from JSON: invalid RFC 3339 string");const i=Date.parse(n[1]+"-"+n[2]+"-"+n[3]+"T"+n[4]+":"+n[5]+":"+n[6]+(n[8]?n[8]:"Z"));if(Number.isNaN(i))throw new Error("cannot decode google.protobuf.Timestamp from JSON: invalid RFC 3339 string");if(i<Date.parse("0001-01-01T00:00:00Z")||i>Date.parse("9999-12-31T23:59:59Z"))throw new Error("cannot decode message google.protobuf.Timestamp from JSON: must be from 0001-01-01T00:00:00Z to 9999-12-31T23:59:59Z inclusive");return this.seconds=Dt.parse(i/1e3),this.nanos=0,n[7]&&(this.nanos=parseInt("1"+n[7]+"0".repeat(9-n[7].length))-1e9),this}toJson(e){const t=1e3*Number(this.seconds);if(t<Date.parse("0001-01-01T00:00:00Z")||t>Date.parse("9999-12-31T23:59:59Z"))throw new Error("cannot encode google.protobuf.Timestamp to JSON: must be from 0001-01-01T00:00:00Z to 9999-12-31T23:59:59Z inclusive");if(this.nanos<0)throw new Error("cannot encode google.protobuf.Timestamp to JSON: nanos must not be negative");let n="Z";if(this.nanos>0){const e=(this.nanos+1e9).toString().substring(1);n="000000"===e.substring(3)?"."+e.substring(0,3)+"Z":"000"===e.substring(6)?"."+e.substring(0,6)+"Z":"."+e+"Z"}return new Date(t).toISOString().replace(".000Z",n)}toDate(){return new Date(1e3*Number(this.seconds)+Math.ceil(this.nanos/1e6))}static now(){return Bn.fromDate(new Date)}static fromDate(e){const t=e.getTime();return new Bn({seconds:Dt.parse(Math.floor(t/1e3)),nanos:t%1e3*1e6})}static fromBinary(e,t){return(new Bn).fromBinary(e,t)}static fromJson(e,t){return(new Bn).fromJson(e,t)}static fromJsonString(e,t){return(new Bn).fromJsonString(e,t)}static equals(e,t){return jn.util.equals(Bn,e,t)}}Bn.runtime=jn,Bn.typeName="google.protobuf.Timestamp",Bn.fields=jn.util.newFieldList((()=>[{no:1,name:"seconds",kind:"scalar",T:3},{no:2,name:"nanos",kind:"scalar",T:5}]));const Vn=jn.makeMessageType("livekit.MetricsBatch",(()=>[{no:1,name:"timestamp_ms",kind:"scalar",T:3},{no:2,name:"normalized_timestamp",kind:"message",T:Bn},{no:3,name:"str_data",kind:"scalar",T:9,repeated:!0},{no:4,name:"time_series",kind:"message",T:qn,repeated:!0},{no:5,name:"events",kind:"message",T:Hn,repeated:!0}])),qn=jn.makeMessageType("livekit.TimeSeriesMetric",(()=>[{no:1,name:"label",kind:"scalar",T:13},{no:2,name:"participant_identity",kind:"scalar",T:13},{no:3,name:"track_sid",kind:"scalar",T:13},{no:4,name:"samples",kind:"message",T:Wn,repeated:!0},{no:5,name:"rid",kind:"scalar",T:13}])),Wn=jn.makeMessageType("livekit.MetricSample",(()=>[{no:1,name:"timestamp_ms",kind:"scalar",T:3},{no:2,name:"normalized_timestamp",kind:"message",T:Bn},{no:3,name:"value",kind:"scalar",T:2}])),Hn=jn.makeMessageType("livekit.EventMetric",(()=>[{no:1,name:"label",kind:"scalar",T:13},{no:2,name:"participant_identity",kind:"scalar",T:13},{no:3,name:"track_sid",kind:"scalar",T:13},{no:4,name:"start_timestamp_ms",kind:"scalar",T:3},{no:5,name:"end_timestamp_ms",kind:"scalar",T:3,opt:!0},{no:6,name:"normalized_start_timestamp",kind:"message",T:Bn},{no:7,name:"normalized_end_timestamp",kind:"message",T:Bn,opt:!0},{no:8,name:"metadata",kind:"scalar",T:9},{no:9,name:"rid",kind:"scalar",T:13}])),zn=jn.makeEnum("livekit.BackupCodecPolicy",[{no:0,name:"PREFER_REGRESSION"},{no:1,name:"SIMULCAST"},{no:2,name:"REGRESSION"}]),Gn=jn.makeEnum("livekit.TrackType",[{no:0,name:"AUDIO"},{no:1,name:"VIDEO"},{no:2,name:"DATA"}]),Kn=jn.makeEnum("livekit.TrackSource",[{no:0,name:"UNKNOWN"},{no:1,name:"CAMERA"},{no:2,name:"MICROPHONE"},{no:3,name:"SCREEN_SHARE"},{no:4,name:"SCREEN_SHARE_AUDIO"}]),Jn=jn.makeEnum("livekit.VideoQuality",[{no:0,name:"LOW"},{no:1,name:"MEDIUM"},{no:2,name:"HIGH"},{no:3,name:"OFF"}]),Yn=jn.makeEnum("livekit.ConnectionQuality",[{no:0,name:"POOR"},{no:1,name:"GOOD"},{no:2,name:"EXCELLENT"},{no:3,name:"LOST"}]),Xn=jn.makeEnum("livekit.ClientConfigSetting",[{no:0,name:"UNSET"},{no:1,name:"DISABLED"},{no:2,name:"ENABLED"}]),$n=jn.makeEnum("livekit.DisconnectReason",[{no:0,name:"UNKNOWN_REASON"},{no:1,name:"CLIENT_INITIATED"},{no:2,name:"DUPLICATE_IDENTITY"},{no:3,name:"SERVER_SHUTDOWN"},{no:4,name:"PARTICIPANT_REMOVED"},{no:5,name:"ROOM_DELETED"},{no:6,name:"STATE_MISMATCH"},{no:7,name:"JOIN_FAILURE"},{no:8,name:"MIGRATION"},{no:9,name:"SIGNAL_CLOSE"},{no:10,name:"ROOM_CLOSED"},{no:11,name:"USER_UNAVAILABLE"},{no:12,name:"USER_REJECTED"},{no:13,name:"SIP_TRUNK_FAILURE"},{no:14,name:"CONNECTION_TIMEOUT"},{no:15,name:"MEDIA_FAILURE"}]),Qn=jn.makeEnum("livekit.ReconnectReason",[{no:0,name:"RR_UNKNOWN"},{no:1,name:"RR_SIGNAL_DISCONNECTED"},{no:2,name:"RR_PUBLISHER_FAILED"},{no:3,name:"RR_SUBSCRIBER_FAILED"},{no:4,name:"RR_SWITCH_CANDIDATE"}]),Zn=jn.makeEnum("livekit.SubscriptionError",[{no:0,name:"SE_UNKNOWN"},{no:1,name:"SE_CODEC_UNSUPPORTED"},{no:2,name:"SE_TRACK_NOTFOUND"}]),ei=jn.makeEnum("livekit.AudioTrackFeature",[{no:0,name:"TF_STEREO"},{no:1,name:"TF_NO_DTX"},{no:2,name:"TF_AUTO_GAIN_CONTROL"},{no:3,name:"TF_ECHO_CANCELLATION"},{no:4,name:"TF_NOISE_SUPPRESSION"},{no:5,name:"TF_ENHANCED_NOISE_CANCELLATION"},{no:6,name:"TF_PRECONNECT_BUFFER"}]),ti=jn.makeMessageType("livekit.Room",(()=>[{no:1,name:"sid",kind:"scalar",T:9},{no:2,name:"name",kind:"scalar",T:9},{no:3,name:"empty_timeout",kind:"scalar",T:13},{no:14,name:"departure_timeout",kind:"scalar",T:13},{no:4,name:"max_participants",kind:"scalar",T:13},{no:5,name:"creation_time",kind:"scalar",T:3},{no:15,name:"creation_time_ms",kind:"scalar",T:3},{no:6,name:"turn_password",kind:"scalar",T:9},{no:7,name:"enabled_codecs",kind:"message",T:ni,repeated:!0},{no:8,name:"metadata",kind:"scalar",T:9},{no:9,name:"num_participants",kind:"scalar",T:13},{no:11,name:"num_publishers",kind:"scalar",T:13},{no:10,name:"active_recording",kind:"scalar",T:8},{no:13,name:"version",kind:"message",T:Li}])),ni=jn.makeMessageType("livekit.Codec",(()=>[{no:1,name:"mime",kind:"scalar",T:9},{no:2,name:"fmtp_line",kind:"scalar",T:9}])),ii=jn.makeMessageType("livekit.ParticipantPermission",(()=>[{no:1,name:"can_subscribe",kind:"scalar",T:8},{no:2,name:"can_publish",kind:"scalar",T:8},{no:3,name:"can_publish_data",kind:"scalar",T:8},{no:9,name:"can_publish_sources",kind:"enum",T:jn.getEnumType(Kn),repeated:!0},{no:7,name:"hidden",kind:"scalar",T:8},{no:8,name:"recorder",kind:"scalar",T:8},{no:10,name:"can_update_metadata",kind:"scalar",T:8},{no:11,name:"agent",kind:"scalar",T:8},{no:12,name:"can_subscribe_metrics",kind:"scalar",T:8}])),ri=jn.makeMessageType("livekit.ParticipantInfo",(()=>[{no:1,name:"sid",kind:"scalar",T:9},{no:2,name:"identity",kind:"scalar",T:9},{no:3,name:"state",kind:"enum",T:jn.getEnumType(oi)},{no:4,name:"tracks",kind:"message",T:di,repeated:!0},{no:5,name:"metadata",kind:"scalar",T:9},{no:6,name:"joined_at",kind:"scalar",T:3},{no:17,name:"joined_at_ms",kind:"scalar",T:3},{no:9,name:"name",kind:"scalar",T:9},{no:10,name:"version",kind:"scalar",T:13},{no:11,name:"permission",kind:"message",T:ii},{no:12,name:"region",kind:"scalar",T:9},{no:13,name:"is_publisher",kind:"scalar",T:8},{no:14,name:"kind",kind:"enum",T:jn.getEnumType(ai)},{no:15,name:"attributes",kind:"map",K:9,V:{kind:"scalar",T:9}},{no:16,name:"disconnect_reason",kind:"enum",T:jn.getEnumType($n)},{no:18,name:"kind_details",kind:"enum",T:jn.getEnumType(si),repeated:!0}])),oi=jn.makeEnum("livekit.ParticipantInfo.State",[{no:0,name:"JOINING"},{no:1,name:"JOINED"},{no:2,name:"ACTIVE"},{no:3,name:"DISCONNECTED"}]),ai=jn.makeEnum("livekit.ParticipantInfo.Kind",[{no:0,name:"STANDARD"},{no:1,name:"INGRESS"},{no:2,name:"EGRESS"},{no:3,name:"SIP"},{no:4,name:"AGENT"},{no:7,name:"CONNECTOR"}]),si=jn.makeEnum("livekit.ParticipantInfo.KindDetail",[{no:0,name:"CLOUD_AGENT"},{no:1,name:"FORWARDED"}]),ci=jn.makeEnum("livekit.Encryption.Type",[{no:0,name:"NONE"},{no:1,name:"GCM"},{no:2,name:"CUSTOM"}]),li=jn.makeMessageType("livekit.SimulcastCodecInfo",(()=>[{no:1,name:"mime_type",kind:"scalar",T:9},{no:2,name:"mid",kind:"scalar",T:9},{no:3,name:"cid",kind:"scalar",T:9},{no:4,name:"layers",kind:"message",T:ui,repeated:!0},{no:5,name:"video_layer_mode",kind:"enum",T:jn.getEnumType(hi)},{no:6,name:"sdp_cid",kind:"scalar",T:9}])),di=jn.makeMessageType("livekit.TrackInfo",(()=>[{no:1,name:"sid",kind:"scalar",T:9},{no:2,name:"type",kind:"enum",T:jn.getEnumType(Gn)},{no:3,name:"name",kind:"scalar",T:9},{no:4,name:"muted",kind:"scalar",T:8},{no:5,name:"width",kind:"scalar",T:13},{no:6,name:"height",kind:"scalar",T:13},{no:7,name:"simulcast",kind:"scalar",T:8},{no:8,name:"disable_dtx",kind:"scalar",T:8},{no:9,name:"source",kind:"enum",T:jn.getEnumType(Kn)},{no:10,name:"layers",kind:"message",T:ui,repeated:!0},{no:11,name:"mime_type",kind:"scalar",T:9},{no:12,name:"mid",kind:"scalar",T:9},{no:13,name:"codecs",kind:"message",T:li,repeated:!0},{no:14,name:"stereo",kind:"scalar",T:8},{no:15,name:"disable_red",kind:"scalar",T:8},{no:16,name:"encryption",kind:"enum",T:jn.getEnumType(ci)},{no:17,name:"stream",kind:"scalar",T:9},{no:18,name:"version",kind:"message",T:Li},{no:19,name:"audio_features",kind:"enum",T:jn.getEnumType(ei),repeated:!0},{no:20,name:"backup_codec_policy",kind:"enum",T:jn.getEnumType(zn)}])),ui=jn.makeMessageType("livekit.VideoLayer",(()=>[{no:1,name:"quality",kind:"enum",T:jn.getEnumType(Jn)},{no:2,name:"width",kind:"scalar",T:13},{no:3,name:"height",kind:"scalar",T:13},{no:4,name:"bitrate",kind:"scalar",T:13},{no:5,name:"ssrc",kind:"scalar",T:13},{no:6,name:"spatial_layer",kind:"scalar",T:5},{no:7,name:"rid",kind:"scalar",T:9}])),hi=jn.makeEnum("livekit.VideoLayer.Mode",[{no:0,name:"MODE_UNUSED"},{no:1,name:"ONE_SPATIAL_LAYER_PER_STREAM"},{no:2,name:"MULTIPLE_SPATIAL_LAYERS_PER_STREAM"},{no:3,name:"ONE_SPATIAL_LAYER_PER_STREAM_INCOMPLETE_RTCP_SR"}]),pi=jn.makeMessageType("livekit.DataPacket",(()=>[{no:1,name:"kind",kind:"enum",T:jn.getEnumType(mi)},{no:4,name:"participant_identity",kind:"scalar",T:9},{no:5,name:"destination_identities",kind:"scalar",T:9,repeated:!0},{no:2,name:"user",kind:"message",T:yi,oneof:"value"},{no:3,name:"speaker",kind:"message",T:vi,oneof:"value"},{no:6,name:"sip_dtmf",kind:"message",T:ki,oneof:"value"},{no:7,name:"transcription",kind:"message",T:wi,oneof:"value"},{no:8,name:"metrics",kind:"message",T:Vn,oneof:"value"},{no:9,name:"chat_message",kind:"message",T:Ti,oneof:"value"},{no:10,name:"rpc_request",kind:"message",T:Si,oneof:"value"},{no:11,name:"rpc_ack",kind:"message",T:xi,oneof:"value"},{no:12,name:"rpc_response",kind:"message",T:Ei,oneof:"value"},{no:13,name:"stream_header",kind:"message",T:Bi,oneof:"value"},{no:14,name:"stream_chunk",kind:"message",T:Vi,oneof:"value"},{no:15,name:"stream_trailer",kind:"message",T:qi,oneof:"value"},{no:18,name:"encrypted_packet",kind:"message",T:fi,oneof:"value"},{no:16,name:"sequence",kind:"scalar",T:13},{no:17,name:"participant_sid",kind:"scalar",T:9}])),mi=jn.makeEnum("livekit.DataPacket.Kind",[{no:0,name:"RELIABLE"},{no:1,name:"LOSSY"}]),fi=jn.makeMessageType("livekit.EncryptedPacket",(()=>[{no:1,name:"encryption_type",kind:"enum",T:jn.getEnumType(ci)},{no:2,name:"iv",kind:"scalar",T:12},{no:3,name:"key_index",kind:"scalar",T:13},{no:4,name:"encrypted_value",kind:"scalar",T:12}])),gi=jn.makeMessageType("livekit.EncryptedPacketPayload",(()=>[{no:1,name:"user",kind:"message",T:yi,oneof:"value"},{no:3,name:"chat_message",kind:"message",T:Ti,oneof:"value"},{no:4,name:"rpc_request",kind:"message",T:Si,oneof:"value"},{no:5,name:"rpc_ack",kind:"message",T:xi,oneof:"value"},{no:6,name:"rpc_response",kind:"message",T:Ei,oneof:"value"},{no:7,name:"stream_header",kind:"message",T:Bi,oneof:"value"},{no:8,name:"stream_chunk",kind:"message",T:Vi,oneof:"value"},{no:9,name:"stream_trailer",kind:"message",T:qi,oneof:"value"}])),vi=jn.makeMessageType("livekit.ActiveSpeakerUpdate",(()=>[{no:1,name:"speakers",kind:"message",T:bi,repeated:!0}])),bi=jn.makeMessageType("livekit.SpeakerInfo",(()=>[{no:1,name:"sid",kind:"scalar",T:9},{no:2,name:"level",kind:"scalar",T:2},{no:3,name:"active",kind:"scalar",T:8}])),yi=jn.makeMessageType("livekit.UserPacket",(()=>[{no:1,name:"participant_sid",kind:"scalar",T:9},{no:5,name:"participant_identity",kind:"scalar",T:9},{no:2,name:"payload",kind:"scalar",T:12},{no:3,name:"destination_sids",kind:"scalar",T:9,repeated:!0},{no:6,name:"destination_identities",kind:"scalar",T:9,repeated:!0},{no:4,name:"topic",kind:"scalar",T:9,opt:!0},{no:8,name:"id",kind:"scalar",T:9,opt:!0},{no:9,name:"start_time",kind:"scalar",T:4,opt:!0},{no:10,name:"end_time",kind:"scalar",T:4,opt:!0},{no:11,name:"nonce",kind:"scalar",T:12}])),ki=jn.makeMessageType("livekit.SipDTMF",(()=>[{no:3,name:"code",kind:"scalar",T:13},{no:4,name:"digit",kind:"scalar",T:9}])),wi=jn.makeMessageType("livekit.Transcription",(()=>[{no:2,name:"transcribed_participant_identity",kind:"scalar",T:9},{no:3,name:"track_id",kind:"scalar",T:9},{no:4,name:"segments",kind:"message",T:Ci,repeated:!0}])),Ci=jn.makeMessageType("livekit.TranscriptionSegment",(()=>[{no:1,name:"id",kind:"scalar",T:9},{no:2,name:"text",kind:"scalar",T:9},{no:3,name:"start_time",kind:"scalar",T:4},{no:4,name:"end_time",kind:"scalar",T:4},{no:5,name:"final",kind:"scalar",T:8},{no:6,name:"language",kind:"scalar",T:9}])),Ti=jn.makeMessageType("livekit.ChatMessage",(()=>[{no:1,name:"id",kind:"scalar",T:9},{no:2,name:"timestamp",kind:"scalar",T:3},{no:3,name:"edit_timestamp",kind:"scalar",T:3,opt:!0},{no:4,name:"message",kind:"scalar",T:9},{no:5,name:"deleted",kind:"scalar",T:8},{no:6,name:"generated",kind:"scalar",T:8}])),Si=jn.makeMessageType("livekit.RpcRequest",(()=>[{no:1,name:"id",kind:"scalar",T:9},{no:2,name:"method",kind:"scalar",T:9},{no:3,name:"payload",kind:"scalar",T:9},{no:4,name:"response_timeout_ms",kind:"scalar",T:13},{no:5,name:"version",kind:"scalar",T:13}])),xi=jn.makeMessageType("livekit.RpcAck",(()=>[{no:1,name:"request_id",kind:"scalar",T:9}])),Ei=jn.makeMessageType("livekit.RpcResponse",(()=>[{no:1,name:"request_id",kind:"scalar",T:9},{no:2,name:"payload",kind:"scalar",T:9,oneof:"value"},{no:3,name:"error",kind:"message",T:_i,oneof:"value"}])),_i=jn.makeMessageType("livekit.RpcError",(()=>[{no:1,name:"code",kind:"scalar",T:13},{no:2,name:"message",kind:"scalar",T:9},{no:3,name:"data",kind:"scalar",T:9}])),Pi=jn.makeMessageType("livekit.ParticipantTracks",(()=>[{no:1,name:"participant_sid",kind:"scalar",T:9},{no:2,name:"track_sids",kind:"scalar",T:9,repeated:!0}])),Ri=jn.makeMessageType("livekit.ServerInfo",(()=>[{no:1,name:"edition",kind:"enum",T:jn.getEnumType(Ii)},{no:2,name:"version",kind:"scalar",T:9},{no:3,name:"protocol",kind:"scalar",T:5},{no:4,name:"region",kind:"scalar",T:9},{no:5,name:"node_id",kind:"scalar",T:9},{no:6,name:"debug_info",kind:"scalar",T:9},{no:7,name:"agent_protocol",kind:"scalar",T:5}])),Ii=jn.makeEnum("livekit.ServerInfo.Edition",[{no:0,name:"Standard"},{no:1,name:"Cloud"}]),Oi=jn.makeMessageType("livekit.ClientInfo",(()=>[{no:1,name:"sdk",kind:"enum",T:jn.getEnumType(Di)},{no:2,name:"version",kind:"scalar",T:9},{no:3,name:"protocol",kind:"scalar",T:5},{no:4,name:"os",kind:"scalar",T:9},{no:5,name:"os_version",kind:"scalar",T:9},{no:6,name:"device_model",kind:"scalar",T:9},{no:7,name:"browser",kind:"scalar",T:9},{no:8,name:"browser_version",kind:"scalar",T:9},{no:9,name:"address",kind:"scalar",T:9},{no:10,name:"network",kind:"scalar",T:9},{no:11,name:"other_sdks",kind:"scalar",T:9}])),Di=jn.makeEnum("livekit.ClientInfo.SDK",[{no:0,name:"UNKNOWN"},{no:1,name:"JS"},{no:2,name:"SWIFT"},{no:3,name:"ANDROID"},{no:4,name:"FLUTTER"},{no:5,name:"GO"},{no:6,name:"UNITY"},{no:7,name:"REACT_NATIVE"},{no:8,name:"RUST"},{no:9,name:"PYTHON"},{no:10,name:"CPP"},{no:11,name:"UNITY_WEB"},{no:12,name:"NODE"},{no:13,name:"UNREAL"},{no:14,name:"ESP32"}]),Mi=jn.makeMessageType("livekit.ClientConfiguration",(()=>[{no:1,name:"video",kind:"message",T:Ai},{no:2,name:"screen",kind:"message",T:Ai},{no:3,name:"resume_connection",kind:"enum",T:jn.getEnumType(Xn)},{no:4,name:"disabled_codecs",kind:"message",T:Ni},{no:5,name:"force_relay",kind:"enum",T:jn.getEnumType(Xn)}])),Ai=jn.makeMessageType("livekit.VideoConfiguration",(()=>[{no:1,name:"hardware_encoder",kind:"enum",T:jn.getEnumType(Xn)}])),Ni=jn.makeMessageType("livekit.DisabledCodecs",(()=>[{no:1,name:"codecs",kind:"message",T:ni,repeated:!0},{no:2,name:"publish",kind:"message",T:ni,repeated:!0}])),Li=jn.makeMessageType("livekit.TimedVersion",(()=>[{no:1,name:"unix_micro",kind:"scalar",T:3},{no:2,name:"ticks",kind:"scalar",T:5}])),ji=jn.makeEnum("livekit.DataStream.OperationType",[{no:0,name:"CREATE"},{no:1,name:"UPDATE"},{no:2,name:"DELETE"},{no:3,name:"REACTION"}]),Ui=jn.makeMessageType("livekit.DataStream.TextHeader",(()=>[{no:1,name:"operation_type",kind:"enum",T:jn.getEnumType(ji)},{no:2,name:"version",kind:"scalar",T:5},{no:3,name:"reply_to_stream_id",kind:"scalar",T:9},{no:4,name:"attached_stream_ids",kind:"scalar",T:9,repeated:!0},{no:5,name:"generated",kind:"scalar",T:8}]),{localName:"DataStream_TextHeader"}),Fi=jn.makeMessageType("livekit.DataStream.ByteHeader",(()=>[{no:1,name:"name",kind:"scalar",T:9}]),{localName:"DataStream_ByteHeader"}),Bi=jn.makeMessageType("livekit.DataStream.Header",(()=>[{no:1,name:"stream_id",kind:"scalar",T:9},{no:2,name:"timestamp",kind:"scalar",T:3},{no:3,name:"topic",kind:"scalar",T:9},{no:4,name:"mime_type",kind:"scalar",T:9},{no:5,name:"total_length",kind:"scalar",T:4,opt:!0},{no:7,name:"encryption_type",kind:"enum",T:jn.getEnumType(ci)},{no:8,name:"attributes",kind:"map",K:9,V:{kind:"scalar",T:9}},{no:9,name:"text_header",kind:"message",T:Ui,oneof:"content_header"},{no:10,name:"byte_header",kind:"message",T:Fi,oneof:"content_header"}]),{localName:"DataStream_Header"}),Vi=jn.makeMessageType("livekit.DataStream.Chunk",(()=>[{no:1,name:"stream_id",kind:"scalar",T:9},{no:2,name:"chunk_index",kind:"scalar",T:4},{no:3,name:"content",kind:"scalar",T:12},{no:4,name:"version",kind:"scalar",T:5},{no:5,name:"iv",kind:"scalar",T:12,opt:!0}]),{localName:"DataStream_Chunk"}),qi=jn.makeMessageType("livekit.DataStream.Trailer",(()=>[{no:1,name:"stream_id",kind:"scalar",T:9},{no:2,name:"reason",kind:"scalar",T:9},{no:3,name:"attributes",kind:"map",K:9,V:{kind:"scalar",T:9}}]),{localName:"DataStream_Trailer"}),Wi=jn.makeMessageType("livekit.SubscribedAudioCodec",(()=>[{no:1,name:"codec",kind:"scalar",T:9},{no:2,name:"enabled",kind:"scalar",T:8}])),Hi=jn.makeEnum("livekit.SignalTarget",[{no:0,name:"PUBLISHER"},{no:1,name:"SUBSCRIBER"}]),zi=jn.makeEnum("livekit.StreamState",[{no:0,name:"ACTIVE"},{no:1,name:"PAUSED"}]),Gi=jn.makeEnum("livekit.CandidateProtocol",[{no:0,name:"UDP"},{no:1,name:"TCP"},{no:2,name:"TLS"}]),Ki=jn.makeMessageType("livekit.SignalRequest",(()=>[{no:1,name:"offer",kind:"message",T:ir,oneof:"message"},{no:2,name:"answer",kind:"message",T:ir,oneof:"message"},{no:3,name:"trickle",kind:"message",T:$i,oneof:"message"},{no:4,name:"add_track",kind:"message",T:Xi,oneof:"message"},{no:5,name:"mute",kind:"message",T:Qi,oneof:"message"},{no:6,name:"subscription",kind:"message",T:or,oneof:"message"},{no:7,name:"track_setting",kind:"message",T:ar,oneof:"message"},{no:8,name:"leave",kind:"message",T:lr,oneof:"message"},{no:10,name:"update_layers",kind:"message",T:ur,oneof:"message"},{no:11,name:"subscription_permission",kind:"message",T:xr,oneof:"message"},{no:12,name:"sync_state",kind:"message",T:Pr,oneof:"message"},{no:13,name:"simulate",kind:"message",T:Or,oneof:"message"},{no:14,name:"ping",kind:"scalar",T:3,oneof:"message"},{no:15,name:"update_metadata",kind:"message",T:hr,oneof:"message"},{no:16,name:"ping_req",kind:"message",T:Dr,oneof:"message"},{no:17,name:"update_audio_track",kind:"message",T:sr,oneof:"message"},{no:18,name:"update_video_track",kind:"message",T:cr,oneof:"message"}])),Ji=jn.makeMessageType("livekit.SignalResponse",(()=>[{no:1,name:"join",kind:"message",T:Zi,oneof:"message"},{no:2,name:"answer",kind:"message",T:ir,oneof:"message"},{no:3,name:"offer",kind:"message",T:ir,oneof:"message"},{no:4,name:"trickle",kind:"message",T:$i,oneof:"message"},{no:5,name:"update",kind:"message",T:rr,oneof:"message"},{no:6,name:"track_published",kind:"message",T:tr,oneof:"message"},{no:8,name:"leave",kind:"message",T:lr,oneof:"message"},{no:9,name:"mute",kind:"message",T:Qi,oneof:"message"},{no:10,name:"speakers_changed",kind:"message",T:mr,oneof:"message"},{no:11,name:"room_update",kind:"message",T:fr,oneof:"message"},{no:12,name:"connection_quality",kind:"message",T:vr,oneof:"message"},{no:13,name:"stream_state_update",kind:"message",T:yr,oneof:"message"},{no:14,name:"subscribed_quality_update",kind:"message",T:Cr,oneof:"message"},{no:15,name:"subscription_permission_update",kind:"message",T:Er,oneof:"message"},{no:16,name:"refresh_token",kind:"scalar",T:9,oneof:"message"},{no:17,name:"track_unpublished",kind:"message",T:nr,oneof:"message"},{no:18,name:"pong",kind:"scalar",T:3,oneof:"message"},{no:19,name:"reconnect",kind:"message",T:er,oneof:"message"},{no:20,name:"pong_resp",kind:"message",T:Mr,oneof:"message"},{no:21,name:"subscription_response",kind:"message",T:Lr,oneof:"message"},{no:22,name:"request_response",kind:"message",T:jr,oneof:"message"},{no:23,name:"track_subscribed",kind:"message",T:Fr,oneof:"message"},{no:24,name:"room_moved",kind:"message",T:_r,oneof:"message"},{no:25,name:"media_sections_requirement",kind:"message",T:Hr,oneof:"message"},{no:26,name:"subscribed_audio_codec_update",kind:"message",T:Tr,oneof:"message"}])),Yi=jn.makeMessageType("livekit.SimulcastCodec",(()=>[{no:1,name:"codec",kind:"scalar",T:9},{no:2,name:"cid",kind:"scalar",T:9},{no:4,name:"layers",kind:"message",T:ui,repeated:!0},{no:5,name:"video_layer_mode",kind:"enum",T:jn.getEnumType(hi)}])),Xi=jn.makeMessageType("livekit.AddTrackRequest",(()=>[{no:1,name:"cid",kind:"scalar",T:9},{no:2,name:"name",kind:"scalar",T:9},{no:3,name:"type",kind:"enum",T:jn.getEnumType(Gn)},{no:4,name:"width",kind:"scalar",T:13},{no:5,name:"height",kind:"scalar",T:13},{no:6,name:"muted",kind:"scalar",T:8},{no:7,name:"disable_dtx",kind:"scalar",T:8},{no:8,name:"source",kind:"enum",T:jn.getEnumType(Kn)},{no:9,name:"layers",kind:"message",T:ui,repeated:!0},{no:10,name:"simulcast_codecs",kind:"message",T:Yi,repeated:!0},{no:11,name:"sid",kind:"scalar",T:9},{no:12,name:"stereo",kind:"scalar",T:8},{no:13,name:"disable_red",kind:"scalar",T:8},{no:14,name:"encryption",kind:"enum",T:jn.getEnumType(ci)},{no:15,name:"stream",kind:"scalar",T:9},{no:16,name:"backup_codec_policy",kind:"enum",T:jn.getEnumType(zn)},{no:17,name:"audio_features",kind:"enum",T:jn.getEnumType(ei),repeated:!0}])),$i=jn.makeMessageType("livekit.TrickleRequest",(()=>[{no:1,name:"candidateInit",kind:"scalar",T:9},{no:2,name:"target",kind:"enum",T:jn.getEnumType(Hi)},{no:3,name:"final",kind:"scalar",T:8}])),Qi=jn.makeMessageType("livekit.MuteTrackRequest",(()=>[{no:1,name:"sid",kind:"scalar",T:9},{no:2,name:"muted",kind:"scalar",T:8}])),Zi=jn.makeMessageType("livekit.JoinResponse",(()=>[{no:1,name:"room",kind:"message",T:ti},{no:2,name:"participant",kind:"message",T:ri},{no:3,name:"other_participants",kind:"message",T:ri,repeated:!0},{no:4,name:"server_version",kind:"scalar",T:9},{no:5,name:"ice_servers",kind:"message",T:pr,repeated:!0},{no:6,name:"subscriber_primary",kind:"scalar",T:8},{no:7,name:"alternative_url",kind:"scalar",T:9},{no:8,name:"client_configuration",kind:"message",T:Mi},{no:9,name:"server_region",kind:"scalar",T:9},{no:10,name:"ping_timeout",kind:"scalar",T:5},{no:11,name:"ping_interval",kind:"scalar",T:5},{no:12,name:"server_info",kind:"message",T:Ri},{no:13,name:"sif_trailer",kind:"scalar",T:12},{no:14,name:"enabled_publish_codecs",kind:"message",T:ni,repeated:!0},{no:15,name:"fast_publish",kind:"scalar",T:8}])),er=jn.makeMessageType("livekit.ReconnectResponse",(()=>[{no:1,name:"ice_servers",kind:"message",T:pr,repeated:!0},{no:2,name:"client_configuration",kind:"message",T:Mi},{no:3,name:"server_info",kind:"message",T:Ri},{no:4,name:"last_message_seq",kind:"scalar",T:13}])),tr=jn.makeMessageType("livekit.TrackPublishedResponse",(()=>[{no:1,name:"cid",kind:"scalar",T:9},{no:2,name:"track",kind:"message",T:di}])),nr=jn.makeMessageType("livekit.TrackUnpublishedResponse",(()=>[{no:1,name:"track_sid",kind:"scalar",T:9}])),ir=jn.makeMessageType("livekit.SessionDescription",(()=>[{no:1,name:"type",kind:"scalar",T:9},{no:2,name:"sdp",kind:"scalar",T:9},{no:3,name:"id",kind:"scalar",T:13},{no:4,name:"mid_to_track_id",kind:"map",K:9,V:{kind:"scalar",T:9}}])),rr=jn.makeMessageType("livekit.ParticipantUpdate",(()=>[{no:1,name:"participants",kind:"message",T:ri,repeated:!0}])),or=jn.makeMessageType("livekit.UpdateSubscription",(()=>[{no:1,name:"track_sids",kind:"scalar",T:9,repeated:!0},{no:2,name:"subscribe",kind:"scalar",T:8},{no:3,name:"participant_tracks",kind:"message",T:Pi,repeated:!0}])),ar=jn.makeMessageType("livekit.UpdateTrackSettings",(()=>[{no:1,name:"track_sids",kind:"scalar",T:9,repeated:!0},{no:3,name:"disabled",kind:"scalar",T:8},{no:4,name:"quality",kind:"enum",T:jn.getEnumType(Jn)},{no:5,name:"width",kind:"scalar",T:13},{no:6,name:"height",kind:"scalar",T:13},{no:7,name:"fps",kind:"scalar",T:13},{no:8,name:"priority",kind:"scalar",T:13}])),sr=jn.makeMessageType("livekit.UpdateLocalAudioTrack",(()=>[{no:1,name:"track_sid",kind:"scalar",T:9},{no:2,name:"features",kind:"enum",T:jn.getEnumType(ei),repeated:!0}])),cr=jn.makeMessageType("livekit.UpdateLocalVideoTrack",(()=>[{no:1,name:"track_sid",kind:"scalar",T:9},{no:2,name:"width",kind:"scalar",T:13},{no:3,name:"height",kind:"scalar",T:13}])),lr=jn.makeMessageType("livekit.LeaveRequest",(()=>[{no:1,name:"can_reconnect",kind:"scalar",T:8},{no:2,name:"reason",kind:"enum",T:jn.getEnumType($n)},{no:3,name:"action",kind:"enum",T:jn.getEnumType(dr)},{no:4,name:"regions",kind:"message",T:Ar}])),dr=jn.makeEnum("livekit.LeaveRequest.Action",[{no:0,name:"DISCONNECT"},{no:1,name:"RESUME"},{no:2,name:"RECONNECT"}]),ur=jn.makeMessageType("livekit.UpdateVideoLayers",(()=>[{no:1,name:"track_sid",kind:"scalar",T:9},{no:2,name:"layers",kind:"message",T:ui,repeated:!0}])),hr=jn.makeMessageType("livekit.UpdateParticipantMetadata",(()=>[{no:1,name:"metadata",kind:"scalar",T:9},{no:2,name:"name",kind:"scalar",T:9},{no:3,name:"attributes",kind:"map",K:9,V:{kind:"scalar",T:9}},{no:4,name:"request_id",kind:"scalar",T:13}])),pr=jn.makeMessageType("livekit.ICEServer",(()=>[{no:1,name:"urls",kind:"scalar",T:9,repeated:!0},{no:2,name:"username",kind:"scalar",T:9},{no:3,name:"credential",kind:"scalar",T:9}])),mr=jn.makeMessageType("livekit.SpeakersChanged",(()=>[{no:1,name:"speakers",kind:"message",T:bi,repeated:!0}])),fr=jn.makeMessageType("livekit.RoomUpdate",(()=>[{no:1,name:"room",kind:"message",T:ti}])),gr=jn.makeMessageType("livekit.ConnectionQualityInfo",(()=>[{no:1,name:"participant_sid",kind:"scalar",T:9},{no:2,name:"quality",kind:"enum",T:jn.getEnumType(Yn)},{no:3,name:"score",kind:"scalar",T:2}])),vr=jn.makeMessageType("livekit.ConnectionQualityUpdate",(()=>[{no:1,name:"updates",kind:"message",T:gr,repeated:!0}])),br=jn.makeMessageType("livekit.StreamStateInfo",(()=>[{no:1,name:"participant_sid",kind:"scalar",T:9},{no:2,name:"track_sid",kind:"scalar",T:9},{no:3,name:"state",kind:"enum",T:jn.getEnumType(zi)}])),yr=jn.makeMessageType("livekit.StreamStateUpdate",(()=>[{no:1,name:"stream_states",kind:"message",T:br,repeated:!0}])),kr=jn.makeMessageType("livekit.SubscribedQuality",(()=>[{no:1,name:"quality",kind:"enum",T:jn.getEnumType(Jn)},{no:2,name:"enabled",kind:"scalar",T:8}])),wr=jn.makeMessageType("livekit.SubscribedCodec",(()=>[{no:1,name:"codec",kind:"scalar",T:9},{no:2,name:"qualities",kind:"message",T:kr,repeated:!0}])),Cr=jn.makeMessageType("livekit.SubscribedQualityUpdate",(()=>[{no:1,name:"track_sid",kind:"scalar",T:9},{no:2,name:"subscribed_qualities",kind:"message",T:kr,repeated:!0},{no:3,name:"subscribed_codecs",kind:"message",T:wr,repeated:!0}])),Tr=jn.makeMessageType("livekit.SubscribedAudioCodecUpdate",(()=>[{no:1,name:"track_sid",kind:"scalar",T:9},{no:2,name:"subscribed_audio_codecs",kind:"message",T:Wi,repeated:!0}])),Sr=jn.makeMessageType("livekit.TrackPermission",(()=>[{no:1,name:"participant_sid",kind:"scalar",T:9},{no:2,name:"all_tracks",kind:"scalar",T:8},{no:3,name:"track_sids",kind:"scalar",T:9,repeated:!0},{no:4,name:"participant_identity",kind:"scalar",T:9}])),xr=jn.makeMessageType("livekit.SubscriptionPermission",(()=>[{no:1,name:"all_participants",kind:"scalar",T:8},{no:2,name:"track_permissions",kind:"message",T:Sr,repeated:!0}])),Er=jn.makeMessageType("livekit.SubscriptionPermissionUpdate",(()=>[{no:1,name:"participant_sid",kind:"scalar",T:9},{no:2,name:"track_sid",kind:"scalar",T:9},{no:3,name:"allowed",kind:"scalar",T:8}])),_r=jn.makeMessageType("livekit.RoomMovedResponse",(()=>[{no:1,name:"room",kind:"message",T:ti},{no:2,name:"token",kind:"scalar",T:9},{no:3,name:"participant",kind:"message",T:ri},{no:4,name:"other_participants",kind:"message",T:ri,repeated:!0}])),Pr=jn.makeMessageType("livekit.SyncState",(()=>[{no:1,name:"answer",kind:"message",T:ir},{no:2,name:"subscription",kind:"message",T:or},{no:3,name:"publish_tracks",kind:"message",T:tr,repeated:!0},{no:4,name:"data_channels",kind:"message",T:Ir,repeated:!0},{no:5,name:"offer",kind:"message",T:ir},{no:6,name:"track_sids_disabled",kind:"scalar",T:9,repeated:!0},{no:7,name:"datachannel_receive_states",kind:"message",T:Rr,repeated:!0}])),Rr=jn.makeMessageType("livekit.DataChannelReceiveState",(()=>[{no:1,name:"publisher_sid",kind:"scalar",T:9},{no:2,name:"last_seq",kind:"scalar",T:13}])),Ir=jn.makeMessageType("livekit.DataChannelInfo",(()=>[{no:1,name:"label",kind:"scalar",T:9},{no:2,name:"id",kind:"scalar",T:13},{no:3,name:"target",kind:"enum",T:jn.getEnumType(Hi)}])),Or=jn.makeMessageType("livekit.SimulateScenario",(()=>[{no:1,name:"speaker_update",kind:"scalar",T:5,oneof:"scenario"},{no:2,name:"node_failure",kind:"scalar",T:8,oneof:"scenario"},{no:3,name:"migration",kind:"scalar",T:8,oneof:"scenario"},{no:4,name:"server_leave",kind:"scalar",T:8,oneof:"scenario"},{no:5,name:"switch_candidate_protocol",kind:"enum",T:jn.getEnumType(Gi),oneof:"scenario"},{no:6,name:"subscriber_bandwidth",kind:"scalar",T:3,oneof:"scenario"},{no:7,name:"disconnect_signal_on_resume",kind:"scalar",T:8,oneof:"scenario"},{no:8,name:"disconnect_signal_on_resume_no_messages",kind:"scalar",T:8,oneof:"scenario"},{no:9,name:"leave_request_full_reconnect",kind:"scalar",T:8,oneof:"scenario"}])),Dr=jn.makeMessageType("livekit.Ping",(()=>[{no:1,name:"timestamp",kind:"scalar",T:3},{no:2,name:"rtt",kind:"scalar",T:3}])),Mr=jn.makeMessageType("livekit.Pong",(()=>[{no:1,name:"last_ping_timestamp",kind:"scalar",T:3},{no:2,name:"timestamp",kind:"scalar",T:3}])),Ar=jn.makeMessageType("livekit.RegionSettings",(()=>[{no:1,name:"regions",kind:"message",T:Nr,repeated:!0}])),Nr=jn.makeMessageType("livekit.RegionInfo",(()=>[{no:1,name:"region",kind:"scalar",T:9},{no:2,name:"url",kind:"scalar",T:9},{no:3,name:"distance",kind:"scalar",T:3}])),Lr=jn.makeMessageType("livekit.SubscriptionResponse",(()=>[{no:1,name:"track_sid",kind:"scalar",T:9},{no:2,name:"err",kind:"enum",T:jn.getEnumType(Zn)}])),jr=jn.makeMessageType("livekit.RequestResponse",(()=>[{no:1,name:"request_id",kind:"scalar",T:13},{no:2,name:"reason",kind:"enum",T:jn.getEnumType(Ur)},{no:3,name:"message",kind:"scalar",T:9},{no:4,name:"trickle",kind:"message",T:$i,oneof:"request"},{no:5,name:"add_track",kind:"message",T:Xi,oneof:"request"},{no:6,name:"mute",kind:"message",T:Qi,oneof:"request"},{no:7,name:"update_metadata",kind:"message",T:hr,oneof:"request"},{no:8,name:"update_audio_track",kind:"message",T:sr,oneof:"request"},{no:9,name:"update_video_track",kind:"message",T:cr,oneof:"request"}])),Ur=jn.makeEnum("livekit.RequestResponse.Reason",[{no:0,name:"OK"},{no:1,name:"NOT_FOUND"},{no:2,name:"NOT_ALLOWED"},{no:3,name:"LIMIT_EXCEEDED"},{no:4,name:"QUEUED"},{no:5,name:"UNSUPPORTED_TYPE"},{no:6,name:"UNCLASSIFIED_ERROR"}]),Fr=jn.makeMessageType("livekit.TrackSubscribed",(()=>[{no:1,name:"track_sid",kind:"scalar",T:9}])),Br=jn.makeMessageType("livekit.ConnectionSettings",(()=>[{no:1,name:"auto_subscribe",kind:"scalar",T:8},{no:2,name:"adaptive_stream",kind:"scalar",T:8},{no:3,name:"subscriber_allow_pause",kind:"scalar",T:8,opt:!0},{no:4,name:"disable_ice_lite",kind:"scalar",T:8}])),Vr=jn.makeMessageType("livekit.JoinRequest",(()=>[{no:1,name:"client_info",kind:"message",T:Oi},{no:2,name:"connection_settings",kind:"message",T:Br},{no:3,name:"metadata",kind:"scalar",T:9},{no:4,name:"participant_attributes",kind:"map",K:9,V:{kind:"scalar",T:9}},{no:5,name:"add_track_requests",kind:"message",T:Xi,repeated:!0},{no:6,name:"publisher_offer",kind:"message",T:ir},{no:7,name:"reconnect",kind:"scalar",T:8},{no:8,name:"reconnect_reason",kind:"enum",T:jn.getEnumType(Qn)},{no:9,name:"participant_sid",kind:"scalar",T:9},{no:10,name:"sync_state",kind:"message",T:Pr}])),qr=jn.makeMessageType("livekit.WrappedJoinRequest",(()=>[{no:1,name:"compression",kind:"enum",T:jn.getEnumType(Wr)},{no:2,name:"join_request",kind:"scalar",T:12}])),Wr=jn.makeEnum("livekit.WrappedJoinRequest.Compression",[{no:0,name:"NONE"},{no:1,name:"GZIP"}]),Hr=jn.makeMessageType("livekit.MediaSectionsRequirement",(()=>[{no:1,name:"num_audios",kind:"scalar",T:13},{no:2,name:"num_videos",kind:"scalar",T:13}]));function zr(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}var Gr,Kr,Jr,Yr,Xr,$r,Qr={exports:{}},Zr=(Gr||(Gr=1,Jr=Qr.exports,Yr=function(){var e=function(){},t="undefined",n=typeof window!==t&&typeof window.navigator!==t&&/Trident\/|MSIE /.test(window.navigator.userAgent),i=["trace","debug","info","warn","error"],r={},o=null;function a(e,t){var n=e[t];if("function"==typeof n.bind)return n.bind(e);try{return Function.prototype.bind.call(n,e)}catch(t){return function(){return Function.prototype.apply.apply(n,[e,arguments])}}}function s(){console.log&&(console.log.apply?console.log.apply(console,arguments):Function.prototype.apply.apply(console.log,[console,arguments])),console.trace&&console.trace()}function c(){for(var n=this.getLevel(),r=0;r<i.length;r++){var o=i[r];this[o]=r<n?e:this.methodFactory(o,n,this.name)}if(this.log=this.debug,typeof console===t&&n<this.levels.SILENT)return"No console available for logging"}function l(e){return function(){typeof console!==t&&(c.call(this),this[e].apply(this,arguments))}}function d(i,r,o){return function(i){return"debug"===i&&(i="log"),typeof console!==t&&("trace"===i&&n?s:void 0!==console[i]?a(console,i):void 0!==console.log?a(console,"log"):e)}(i)||l.apply(this,arguments)}function u(e,n){var a,s,l,u=this,h="loglevel";function p(){var e;if(typeof window!==t&&h){try{e=window.localStorage[h]}catch(e){}if(typeof e===t)try{var n=window.document.cookie,i=encodeURIComponent(h),r=n.indexOf(i+"=");-1!==r&&(e=/^([^;]+)/.exec(n.slice(r+i.length+1))[1])}catch(e){}return void 0===u.levels[e]&&(e=void 0),e}}function m(e){var t=e;if("string"==typeof t&&void 0!==u.levels[t.toUpperCase()]&&(t=u.levels[t.toUpperCase()]),"number"==typeof t&&t>=0&&t<=u.levels.SILENT)return t;throw new TypeError("log.setLevel() called with invalid level: "+e)}"string"==typeof e?h+=":"+e:"symbol"==typeof e&&(h=void 0),u.name=e,u.levels={TRACE:0,DEBUG:1,INFO:2,WARN:3,ERROR:4,SILENT:5},u.methodFactory=n||d,u.getLevel=function(){return null!=l?l:null!=s?s:a},u.setLevel=function(e,n){return l=m(e),!1!==n&&function(e){var n=(i[e]||"silent").toUpperCase();if(typeof window!==t&&h){try{return void(window.localStorage[h]=n)}catch(e){}try{window.document.cookie=encodeURIComponent(h)+"="+n+";"}catch(e){}}}(l),c.call(u)},u.setDefaultLevel=function(e){s=m(e),p()||u.setLevel(e,!1)},u.resetLevel=function(){l=null,function(){if(typeof window!==t&&h){try{window.localStorage.removeItem(h)}catch(e){}try{window.document.cookie=encodeURIComponent(h)+"=; expires=Thu, 01 Jan 1970 00:00:00 UTC"}catch(e){}}}(),c.call(u)},u.enableAll=function(e){u.setLevel(u.levels.TRACE,e)},u.disableAll=function(e){u.setLevel(u.levels.SILENT,e)},u.rebuild=function(){if(o!==u&&(a=m(o.getLevel())),c.call(u),o===u)for(var e in r)r[e].rebuild()},a=m(o?o.getLevel():"WARN");var f=p();null!=f&&(l=m(f)),c.call(u)}(o=new u).getLogger=function(e){if("symbol"!=typeof e&&"string"!=typeof e||""===e)throw new TypeError("You must supply a name when creating a logger.");var t=r[e];return t||(t=r[e]=new u(e,o.methodFactory)),t};var h=typeof window!==t?window.log:void 0;return o.noConflict=function(){return typeof window!==t&&window.log===o&&(window.log=h),o},o.getLoggers=function(){return r},o.default=o,o},(Kr=Qr).exports?Kr.exports=Yr():Jr.log=Yr()),Qr.exports);!function(e){e[e.trace=0]="trace",e[e.debug=1]="debug",e[e.info=2]="info",e[e.warn=3]="warn",e[e.error=4]="error",e[e.silent=5]="silent"}(Xr||(Xr={})),function(e){e.Default="livekit",e.Room="livekit-room",e.TokenSource="livekit-token-source",e.Participant="livekit-participant",e.Track="livekit-track",e.Publication="livekit-track-publication",e.Engine="livekit-engine",e.Signal="livekit-signal",e.PCManager="livekit-pc-manager",e.PCTransport="livekit-pc-transport",e.E2EE="lk-e2ee"}($r||($r={}));let eo=Zr.getLogger("livekit");function to(e){const t=Zr.getLogger(e);return t.setDefaultLevel(eo.getLevel()),t}Object.values($r).map((e=>Zr.getLogger(e))),eo.setDefaultLevel(Xr.info);const no=Zr.getLogger("lk-e2ee"),io=7e3,ro=[0,300,1200,2700,4800,io,io,io,io,io];function oo(e,t,n,i){return new(n||(n=Promise))((function(r,o){function a(e){try{c(i.next(e))}catch(e){o(e)}}function s(e){try{c(i.throw(e))}catch(e){o(e)}}function c(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(a,s)}c((i=i.apply(e,t||[])).next())}))}function ao(e){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var t,n=e[Symbol.asyncIterator];return n?n.call(e):(e=function(e){var t="function"==typeof Symbol&&Symbol.iterator,n=t&&e[t],i=0;if(n)return n.call(e);if(e&&"number"==typeof e.length)return{next:function(){return e&&i>=e.length&&(e=void 0),{value:e&&e[i++],done:!e}}};throw new TypeError(t?"Object is not iterable.":"Symbol.iterator is not defined.")}(e),t={},i("next"),i("throw"),i("return"),t[Symbol.asyncIterator]=function(){return this},t);function i(n){t[n]=e[n]&&function(t){return new Promise((function(i,r){!function(e,t,n,i){Promise.resolve(i).then((function(t){e({value:t,done:n})}),t)}(i,r,(t=e[n](t)).done,t.value)}))}}}"function"==typeof SuppressedError&&SuppressedError;var so,co={exports:{}},lo=function(){if(so)return co.exports;so=1;var e,t="object"==typeof Reflect?Reflect:null,n=t&&"function"==typeof t.apply?t.apply:function(e,t,n){return Function.prototype.apply.call(e,t,n)};e=t&&"function"==typeof t.ownKeys?t.ownKeys:Object.getOwnPropertySymbols?function(e){return Object.getOwnPropertyNames(e).concat(Object.getOwnPropertySymbols(e))}:function(e){return Object.getOwnPropertyNames(e)};var i=Number.isNaN||function(e){return e!=e};function r(){r.init.call(this)}co.exports=r,co.exports.once=function(e,t){return new Promise((function(n,i){function r(n){e.removeListener(t,o),i(n)}function o(){"function"==typeof e.removeListener&&e.removeListener("error",r),n([].slice.call(arguments))}m(e,t,o,{once:!0}),"error"!==t&&function(e,t){"function"==typeof e.on&&m(e,"error",t,{once:!0})}(e,r)}))},r.EventEmitter=r,r.prototype._events=void 0,r.prototype._eventsCount=0,r.prototype._maxListeners=void 0;var o=10;function a(e){if("function"!=typeof e)throw new TypeError('The "listener" argument must be of type Function. Received type '+typeof e)}function s(e){return void 0===e._maxListeners?r.defaultMaxListeners:e._maxListeners}function c(e,t,n,i){var r,o,c,l;if(a(n),void 0===(o=e._events)?(o=e._events=Object.create(null),e._eventsCount=0):(void 0!==o.newListener&&(e.emit("newListener",t,n.listener?n.listener:n),o=e._events),c=o[t]),void 0===c)c=o[t]=n,++e._eventsCount;else if("function"==typeof c?c=o[t]=i?[n,c]:[c,n]:i?c.unshift(n):c.push(n),(r=s(e))>0&&c.length>r&&!c.warned){c.warned=!0;var d=new Error("Possible EventEmitter memory leak detected. "+c.length+" "+String(t)+" listeners added. Use emitter.setMaxListeners() to increase limit");d.name="MaxListenersExceededWarning",d.emitter=e,d.type=t,d.count=c.length,l=d,console&&console.warn&&console.warn(l)}return e}function l(){if(!this.fired)return this.target.removeListener(this.type,this.wrapFn),this.fired=!0,0===arguments.length?this.listener.call(this.target):this.listener.apply(this.target,arguments)}function d(e,t,n){var i={fired:!1,wrapFn:void 0,target:e,type:t,listener:n},r=l.bind(i);return r.listener=n,i.wrapFn=r,r}function u(e,t,n){var i=e._events;if(void 0===i)return[];var r=i[t];return void 0===r?[]:"function"==typeof r?n?[r.listener||r]:[r]:n?function(e){for(var t=new Array(e.length),n=0;n<t.length;++n)t[n]=e[n].listener||e[n];return t}(r):p(r,r.length)}function h(e){var t=this._events;if(void 0!==t){var n=t[e];if("function"==typeof n)return 1;if(void 0!==n)return n.length}return 0}function p(e,t){for(var n=new Array(t),i=0;i<t;++i)n[i]=e[i];return n}function m(e,t,n,i){if("function"==typeof e.on)i.once?e.once(t,n):e.on(t,n);else{if("function"!=typeof e.addEventListener)throw new TypeError('The "emitter" argument must be of type EventEmitter. Received type '+typeof e);e.addEventListener(t,(function r(o){i.once&&e.removeEventListener(t,r),n(o)}))}}return Object.defineProperty(r,"defaultMaxListeners",{enumerable:!0,get:function(){return o},set:function(e){if("number"!=typeof e||e<0||i(e))throw new RangeError('The value of "defaultMaxListeners" is out of range. It must be a non-negative number. Received '+e+".");o=e}}),r.init=function(){void 0!==this._events&&this._events!==Object.getPrototypeOf(this)._events||(this._events=Object.create(null),this._eventsCount=0),this._maxListeners=this._maxListeners||void 0},r.prototype.setMaxListeners=function(e){if("number"!=typeof e||e<0||i(e))throw new RangeError('The value of "n" is out of range. It must be a non-negative number. Received '+e+".");return this._maxListeners=e,this},r.prototype.getMaxListeners=function(){return s(this)},r.prototype.emit=function(e){for(var t=[],i=1;i<arguments.length;i++)t.push(arguments[i]);var r="error"===e,o=this._events;if(void 0!==o)r=r&&void 0===o.error;else if(!r)return!1;if(r){var a;if(t.length>0&&(a=t[0]),a instanceof Error)throw a;var s=new Error("Unhandled error."+(a?" ("+a.message+")":""));throw s.context=a,s}var c=o[e];if(void 0===c)return!1;if("function"==typeof c)n(c,this,t);else{var l=c.length,d=p(c,l);for(i=0;i<l;++i)n(d[i],this,t)}return!0},r.prototype.addListener=function(e,t){return c(this,e,t,!1)},r.prototype.on=r.prototype.addListener,r.prototype.prependListener=function(e,t){return c(this,e,t,!0)},r.prototype.once=function(e,t){return a(t),this.on(e,d(this,e,t)),this},r.prototype.prependOnceListener=function(e,t){return a(t),this.prependListener(e,d(this,e,t)),this},r.prototype.removeListener=function(e,t){var n,i,r,o,s;if(a(t),void 0===(i=this._events))return this;if(void 0===(n=i[e]))return this;if(n===t||n.listener===t)0==--this._eventsCount?this._events=Object.create(null):(delete i[e],i.removeListener&&this.emit("removeListener",e,n.listener||t));else if("function"!=typeof n){for(r=-1,o=n.length-1;o>=0;o--)if(n[o]===t||n[o].listener===t){s=n[o].listener,r=o;break}if(r<0)return this;0===r?n.shift():function(e,t){for(;t+1<e.length;t++)e[t]=e[t+1];e.pop()}(n,r),1===n.length&&(i[e]=n[0]),void 0!==i.removeListener&&this.emit("removeListener",e,s||t)}return this},r.prototype.off=r.prototype.removeListener,r.prototype.removeAllListeners=function(e){var t,n,i;if(void 0===(n=this._events))return this;if(void 0===n.removeListener)return 0===arguments.length?(this._events=Object.create(null),this._eventsCount=0):void 0!==n[e]&&(0==--this._eventsCount?this._events=Object.create(null):delete n[e]),this;if(0===arguments.length){var r,o=Object.keys(n);for(i=0;i<o.length;++i)"removeListener"!==(r=o[i])&&this.removeAllListeners(r);return this.removeAllListeners("removeListener"),this._events=Object.create(null),this._eventsCount=0,this}if("function"==typeof(t=n[e]))this.removeListener(e,t);else if(void 0!==t)for(i=t.length-1;i>=0;i--)this.removeListener(e,t[i]);return this},r.prototype.listeners=function(e){return u(this,e,!0)},r.prototype.rawListeners=function(e){return u(this,e,!1)},r.listenerCount=function(e,t){return"function"==typeof e.listenerCount?e.listenerCount(t):h.call(e,t)},r.prototype.listenerCount=h,r.prototype.eventNames=function(){return this._eventsCount>0?e(this._events):[]},co.exports}();let uo=!0,ho=!0;function po(e,t,n){const i=e.match(t);return i&&i.length>=n&&parseFloat(i[n],10)}function mo(e,t,n){if(!e.RTCPeerConnection)return;const i=e.RTCPeerConnection.prototype,r=i.addEventListener;i.addEventListener=function(e,i){if(e!==t)return r.apply(this,arguments);const o=e=>{const t=n(e);t&&(i.handleEvent?i.handleEvent(t):i(t))};return this._eventMap=this._eventMap||{},this._eventMap[t]||(this._eventMap[t]=new Map),this._eventMap[t].set(i,o),r.apply(this,[e,o])};const o=i.removeEventListener;i.removeEventListener=function(e,n){if(e!==t||!this._eventMap||!this._eventMap[t])return o.apply(this,arguments);if(!this._eventMap[t].has(n))return o.apply(this,arguments);const i=this._eventMap[t].get(n);return this._eventMap[t].delete(n),0===this._eventMap[t].size&&delete this._eventMap[t],0===Object.keys(this._eventMap).length&&delete this._eventMap,o.apply(this,[e,i])},Object.defineProperty(i,"on"+t,{get(){return this["_on"+t]},set(e){this["_on"+t]&&(this.removeEventListener(t,this["_on"+t]),delete this["_on"+t]),e&&this.addEventListener(t,this["_on"+t]=e)},enumerable:!0,configurable:!0})}function fo(e){return"boolean"!=typeof e?new Error("Argument type: "+typeof e+". Please use a boolean."):(uo=e,e?"adapter.js logging disabled":"adapter.js logging enabled")}function go(e){return"boolean"!=typeof e?new Error("Argument type: "+typeof e+". Please use a boolean."):(ho=!e,"adapter.js deprecation warnings "+(e?"disabled":"enabled"))}function vo(){if("object"==typeof window){if(uo)return;"undefined"!=typeof console&&"function"==typeof console.log&&console.log.apply(console,arguments)}}function bo(e,t){ho&&console.warn(e+" is deprecated, please use "+t+" instead.")}function yo(e){return"[object Object]"===Object.prototype.toString.call(e)}function ko(e){return yo(e)?Object.keys(e).reduce((function(t,n){const i=yo(e[n]),r=i?ko(e[n]):e[n],o=i&&!Object.keys(r).length;return void 0===r||o?t:Object.assign(t,{[n]:r})}),{}):e}function wo(e,t,n){t&&!n.has(t.id)&&(n.set(t.id,t),Object.keys(t).forEach((i=>{i.endsWith("Id")?wo(e,e.get(t[i]),n):i.endsWith("Ids")&&t[i].forEach((t=>{wo(e,e.get(t),n)}))})))}function Co(e,t,n){const i=n?"outbound-rtp":"inbound-rtp",r=new Map;if(null===t)return r;const o=[];return e.forEach((e=>{"track"===e.type&&e.trackIdentifier===t.id&&o.push(e)})),o.forEach((t=>{e.forEach((n=>{n.type===i&&n.trackId===t.id&&wo(e,n,r)}))})),r}const To=vo;function So(e,t){const n=e&&e.navigator;if(!n.mediaDevices)return;const i=function(e){if("object"!=typeof e||e.mandatory||e.optional)return e;const t={};return Object.keys(e).forEach((n=>{if("require"===n||"advanced"===n||"mediaSource"===n)return;const i="object"==typeof e[n]?e[n]:{ideal:e[n]};void 0!==i.exact&&"number"==typeof i.exact&&(i.min=i.max=i.exact);const r=function(e,t){return e?e+t.charAt(0).toUpperCase()+t.slice(1):"deviceId"===t?"sourceId":t};if(void 0!==i.ideal){t.optional=t.optional||[];let e={};"number"==typeof i.ideal?(e[r("min",n)]=i.ideal,t.optional.push(e),e={},e[r("max",n)]=i.ideal,t.optional.push(e)):(e[r("",n)]=i.ideal,t.optional.push(e))}void 0!==i.exact&&"number"!=typeof i.exact?(t.mandatory=t.mandatory||{},t.mandatory[r("",n)]=i.exact):["min","max"].forEach((e=>{void 0!==i[e]&&(t.mandatory=t.mandatory||{},t.mandatory[r(e,n)]=i[e])}))})),e.advanced&&(t.optional=(t.optional||[]).concat(e.advanced)),t},r=function(e,r){if(t.version>=61)return r(e);if((e=JSON.parse(JSON.stringify(e)))&&"object"==typeof e.audio){const t=function(e,t,n){t in e&&!(n in e)&&(e[n]=e[t],delete e[t])};t((e=JSON.parse(JSON.stringify(e))).audio,"autoGainControl","googAutoGainControl"),t(e.audio,"noiseSuppression","googNoiseSuppression"),e.audio=i(e.audio)}if(e&&"object"==typeof e.video){let o=e.video.facingMode;o=o&&("object"==typeof o?o:{ideal:o});const a=t.version<66;if(o&&("user"===o.exact||"environment"===o.exact||"user"===o.ideal||"environment"===o.ideal)&&(!n.mediaDevices.getSupportedConstraints||!n.mediaDevices.getSupportedConstraints().facingMode||a)){let t;if(delete e.video.facingMode,"environment"===o.exact||"environment"===o.ideal?t=["back","rear"]:"user"!==o.exact&&"user"!==o.ideal||(t=["front"]),t)return n.mediaDevices.enumerateDevices().then((n=>{n=n.filter((e=>"videoinput"===e.kind));let a=n.find((e=>t.some((t=>e.label.toLowerCase().includes(t)))));return!a&&n.length&&t.includes("back")&&(a=n[n.length-1]),a&&(e.video.deviceId=o.exact?{exact:a.deviceId}:{ideal:a.deviceId}),e.video=i(e.video),To("chrome: "+JSON.stringify(e)),r(e)}))}e.video=i(e.video)}return To("chrome: "+JSON.stringify(e)),r(e)},o=function(e){return t.version>=64?e:{name:{PermissionDeniedError:"NotAllowedError",PermissionDismissedError:"NotAllowedError",InvalidStateError:"NotAllowedError",DevicesNotFoundError:"NotFoundError",ConstraintNotSatisfiedError:"OverconstrainedError",TrackStartError:"NotReadableError",MediaDeviceFailedDueToShutdown:"NotAllowedError",MediaDeviceKillSwitchOn:"NotAllowedError",TabCaptureError:"AbortError",ScreenCaptureError:"AbortError",DeviceCaptureError:"AbortError"}[e.name]||e.name,message:e.message,constraint:e.constraint||e.constraintName,toString(){return this.name+(this.message&&": ")+this.message}}};if(n.getUserMedia=function(e,t,i){r(e,(e=>{n.webkitGetUserMedia(e,t,(e=>{i&&i(o(e))}))}))}.bind(n),n.mediaDevices.getUserMedia){const e=n.mediaDevices.getUserMedia.bind(n.mediaDevices);n.mediaDevices.getUserMedia=function(t){return r(t,(t=>e(t).then((e=>{if(t.audio&&!e.getAudioTracks().length||t.video&&!e.getVideoTracks().length)throw e.getTracks().forEach((e=>{e.stop()})),new DOMException("","NotFoundError");return e}),(e=>Promise.reject(o(e))))))}}}function xo(e){e.MediaStream=e.MediaStream||e.webkitMediaStream}function Eo(e){if("object"==typeof e&&e.RTCPeerConnection&&!("ontrack"in e.RTCPeerConnection.prototype)){Object.defineProperty(e.RTCPeerConnection.prototype,"ontrack",{get(){return this._ontrack},set(e){this._ontrack&&this.removeEventListener("track",this._ontrack),this.addEventListener("track",this._ontrack=e)},enumerable:!0,configurable:!0});const t=e.RTCPeerConnection.prototype.setRemoteDescription;e.RTCPeerConnection.prototype.setRemoteDescription=function(){return this._ontrackpoly||(this._ontrackpoly=t=>{t.stream.addEventListener("addtrack",(n=>{let i;i=e.RTCPeerConnection.prototype.getReceivers?this.getReceivers().find((e=>e.track&&e.track.id===n.track.id)):{track:n.track};const r=new Event("track");r.track=n.track,r.receiver=i,r.transceiver={receiver:i},r.streams=[t.stream],this.dispatchEvent(r)})),t.stream.getTracks().forEach((n=>{let i;i=e.RTCPeerConnection.prototype.getReceivers?this.getReceivers().find((e=>e.track&&e.track.id===n.id)):{track:n};const r=new Event("track");r.track=n,r.receiver=i,r.transceiver={receiver:i},r.streams=[t.stream],this.dispatchEvent(r)}))},this.addEventListener("addstream",this._ontrackpoly)),t.apply(this,arguments)}}else mo(e,"track",(e=>(e.transceiver||Object.defineProperty(e,"transceiver",{value:{receiver:e.receiver}}),e)))}function _o(e){if("object"==typeof e&&e.RTCPeerConnection&&!("getSenders"in e.RTCPeerConnection.prototype)&&"createDTMFSender"in e.RTCPeerConnection.prototype){const t=function(e,t){return{track:t,get dtmf(){return void 0===this._dtmf&&("audio"===t.kind?this._dtmf=e.createDTMFSender(t):this._dtmf=null),this._dtmf},_pc:e}};if(!e.RTCPeerConnection.prototype.getSenders){e.RTCPeerConnection.prototype.getSenders=function(){return this._senders=this._senders||[],this._senders.slice()};const n=e.RTCPeerConnection.prototype.addTrack;e.RTCPeerConnection.prototype.addTrack=function(e,i){let r=n.apply(this,arguments);return r||(r=t(this,e),this._senders.push(r)),r};const i=e.RTCPeerConnection.prototype.removeTrack;e.RTCPeerConnection.prototype.removeTrack=function(e){i.apply(this,arguments);const t=this._senders.indexOf(e);-1!==t&&this._senders.splice(t,1)}}const n=e.RTCPeerConnection.prototype.addStream;e.RTCPeerConnection.prototype.addStream=function(e){this._senders=this._senders||[],n.apply(this,[e]),e.getTracks().forEach((e=>{this._senders.push(t(this,e))}))};const i=e.RTCPeerConnection.prototype.removeStream;e.RTCPeerConnection.prototype.removeStream=function(e){this._senders=this._senders||[],i.apply(this,[e]),e.getTracks().forEach((e=>{const t=this._senders.find((t=>t.track===e));t&&this._senders.splice(this._senders.indexOf(t),1)}))}}else if("object"==typeof e&&e.RTCPeerConnection&&"getSenders"in e.RTCPeerConnection.prototype&&"createDTMFSender"in e.RTCPeerConnection.prototype&&e.RTCRtpSender&&!("dtmf"in e.RTCRtpSender.prototype)){const t=e.RTCPeerConnection.prototype.getSenders;e.RTCPeerConnection.prototype.getSenders=function(){const e=t.apply(this,[]);return e.forEach((e=>e._pc=this)),e},Object.defineProperty(e.RTCRtpSender.prototype,"dtmf",{get(){return void 0===this._dtmf&&("audio"===this.track.kind?this._dtmf=this._pc.createDTMFSender(this.track):this._dtmf=null),this._dtmf}})}}function Po(e){if(!("object"==typeof e&&e.RTCPeerConnection&&e.RTCRtpSender&&e.RTCRtpReceiver))return;if(!("getStats"in e.RTCRtpSender.prototype)){const t=e.RTCPeerConnection.prototype.getSenders;t&&(e.RTCPeerConnection.prototype.getSenders=function(){const e=t.apply(this,[]);return e.forEach((e=>e._pc=this)),e});const n=e.RTCPeerConnection.prototype.addTrack;n&&(e.RTCPeerConnection.prototype.addTrack=function(){const e=n.apply(this,arguments);return e._pc=this,e}),e.RTCRtpSender.prototype.getStats=function(){const e=this;return this._pc.getStats().then((t=>Co(t,e.track,!0)))}}if(!("getStats"in e.RTCRtpReceiver.prototype)){const t=e.RTCPeerConnection.prototype.getReceivers;t&&(e.RTCPeerConnection.prototype.getReceivers=function(){const e=t.apply(this,[]);return e.forEach((e=>e._pc=this)),e}),mo(e,"track",(e=>(e.receiver._pc=e.srcElement,e))),e.RTCRtpReceiver.prototype.getStats=function(){const e=this;return this._pc.getStats().then((t=>Co(t,e.track,!1)))}}if(!("getStats"in e.RTCRtpSender.prototype)||!("getStats"in e.RTCRtpReceiver.prototype))return;const t=e.RTCPeerConnection.prototype.getStats;e.RTCPeerConnection.prototype.getStats=function(){if(arguments.length>0&&arguments[0]instanceof e.MediaStreamTrack){const e=arguments[0];let t,n,i;return this.getSenders().forEach((n=>{n.track===e&&(t?i=!0:t=n)})),this.getReceivers().forEach((t=>(t.track===e&&(n?i=!0:n=t),t.track===e))),i||t&&n?Promise.reject(new DOMException("There are more than one sender or receiver for the track.","InvalidAccessError")):t?t.getStats():n?n.getStats():Promise.reject(new DOMException("There is no sender or receiver for the track.","InvalidAccessError"))}return t.apply(this,arguments)}}function Ro(e){e.RTCPeerConnection.prototype.getLocalStreams=function(){return this._shimmedLocalStreams=this._shimmedLocalStreams||{},Object.keys(this._shimmedLocalStreams).map((e=>this._shimmedLocalStreams[e][0]))};const t=e.RTCPeerConnection.prototype.addTrack;e.RTCPeerConnection.prototype.addTrack=function(e,n){if(!n)return t.apply(this,arguments);this._shimmedLocalStreams=this._shimmedLocalStreams||{};const i=t.apply(this,arguments);return this._shimmedLocalStreams[n.id]?-1===this._shimmedLocalStreams[n.id].indexOf(i)&&this._shimmedLocalStreams[n.id].push(i):this._shimmedLocalStreams[n.id]=[n,i],i};const n=e.RTCPeerConnection.prototype.addStream;e.RTCPeerConnection.prototype.addStream=function(e){this._shimmedLocalStreams=this._shimmedLocalStreams||{},e.getTracks().forEach((e=>{const t=this.getSenders().find((t=>t.track===e));if(t)throw new DOMException("Track already exists.","InvalidAccessError")}));const t=this.getSenders();n.apply(this,arguments);const i=this.getSenders().filter((e=>-1===t.indexOf(e)));this._shimmedLocalStreams[e.id]=[e].concat(i)};const i=e.RTCPeerConnection.prototype.removeStream;e.RTCPeerConnection.prototype.removeStream=function(e){return this._shimmedLocalStreams=this._shimmedLocalStreams||{},delete this._shimmedLocalStreams[e.id],i.apply(this,arguments)};const r=e.RTCPeerConnection.prototype.removeTrack;e.RTCPeerConnection.prototype.removeTrack=function(e){return this._shimmedLocalStreams=this._shimmedLocalStreams||{},e&&Object.keys(this._shimmedLocalStreams).forEach((t=>{const n=this._shimmedLocalStreams[t].indexOf(e);-1!==n&&this._shimmedLocalStreams[t].splice(n,1),1===this._shimmedLocalStreams[t].length&&delete this._shimmedLocalStreams[t]})),r.apply(this,arguments)}}function Io(e,t){if(!e.RTCPeerConnection)return;if(e.RTCPeerConnection.prototype.addTrack&&t.version>=65)return Ro(e);const n=e.RTCPeerConnection.prototype.getLocalStreams;e.RTCPeerConnection.prototype.getLocalStreams=function(){const e=n.apply(this);return this._reverseStreams=this._reverseStreams||{},e.map((e=>this._reverseStreams[e.id]))};const i=e.RTCPeerConnection.prototype.addStream;e.RTCPeerConnection.prototype.addStream=function(t){if(this._streams=this._streams||{},this._reverseStreams=this._reverseStreams||{},t.getTracks().forEach((e=>{const t=this.getSenders().find((t=>t.track===e));if(t)throw new DOMException("Track already exists.","InvalidAccessError")})),!this._reverseStreams[t.id]){const n=new e.MediaStream(t.getTracks());this._streams[t.id]=n,this._reverseStreams[n.id]=t,t=n}i.apply(this,[t])};const r=e.RTCPeerConnection.prototype.removeStream;function o(e,t){let n=t.sdp;return Object.keys(e._reverseStreams||[]).forEach((t=>{const i=e._reverseStreams[t],r=e._streams[i.id];n=n.replace(new RegExp(r.id,"g"),i.id)})),new RTCSessionDescription({type:t.type,sdp:n})}e.RTCPeerConnection.prototype.removeStream=function(e){this._streams=this._streams||{},this._reverseStreams=this._reverseStreams||{},r.apply(this,[this._streams[e.id]||e]),delete this._reverseStreams[this._streams[e.id]?this._streams[e.id].id:e.id],delete this._streams[e.id]},e.RTCPeerConnection.prototype.addTrack=function(t,n){if("closed"===this.signalingState)throw new DOMException("The RTCPeerConnection's signalingState is 'closed'.","InvalidStateError");const i=[].slice.call(arguments,1);if(1!==i.length||!i[0].getTracks().find((e=>e===t)))throw new DOMException("The adapter.js addTrack polyfill only supports a single  stream which is associated with the specified track.","NotSupportedError");const r=this.getSenders().find((e=>e.track===t));if(r)throw new DOMException("Track already exists.","InvalidAccessError");this._streams=this._streams||{},this._reverseStreams=this._reverseStreams||{};const o=this._streams[n.id];if(o)o.addTrack(t),Promise.resolve().then((()=>{this.dispatchEvent(new Event("negotiationneeded"))}));else{const i=new e.MediaStream([t]);this._streams[n.id]=i,this._reverseStreams[i.id]=n,this.addStream(i)}return this.getSenders().find((e=>e.track===t))},["createOffer","createAnswer"].forEach((function(t){const n=e.RTCPeerConnection.prototype[t],i={[t](){const e=arguments;return arguments.length&&"function"==typeof arguments[0]?n.apply(this,[t=>{const n=o(this,t);e[0].apply(null,[n])},t=>{e[1]&&e[1].apply(null,t)},arguments[2]]):n.apply(this,arguments).then((e=>o(this,e)))}};e.RTCPeerConnection.prototype[t]=i[t]}));const a=e.RTCPeerConnection.prototype.setLocalDescription;e.RTCPeerConnection.prototype.setLocalDescription=function(){return arguments.length&&arguments[0].type?(arguments[0]=function(e,t){let n=t.sdp;return Object.keys(e._reverseStreams||[]).forEach((t=>{const i=e._reverseStreams[t],r=e._streams[i.id];n=n.replace(new RegExp(i.id,"g"),r.id)})),new RTCSessionDescription({type:t.type,sdp:n})}(this,arguments[0]),a.apply(this,arguments)):a.apply(this,arguments)};const s=Object.getOwnPropertyDescriptor(e.RTCPeerConnection.prototype,"localDescription");Object.defineProperty(e.RTCPeerConnection.prototype,"localDescription",{get(){const e=s.get.apply(this);return""===e.type?e:o(this,e)}}),e.RTCPeerConnection.prototype.removeTrack=function(e){if("closed"===this.signalingState)throw new DOMException("The RTCPeerConnection's signalingState is 'closed'.","InvalidStateError");if(!e._pc)throw new DOMException("Argument 1 of RTCPeerConnection.removeTrack does not implement interface RTCRtpSender.","TypeError");if(e._pc!==this)throw new DOMException("Sender was not created by this connection.","InvalidAccessError");let t;this._streams=this._streams||{},Object.keys(this._streams).forEach((n=>{this._streams[n].getTracks().find((t=>e.track===t))&&(t=this._streams[n])})),t&&(1===t.getTracks().length?this.removeStream(this._reverseStreams[t.id]):t.removeTrack(e.track),this.dispatchEvent(new Event("negotiationneeded")))}}function Oo(e,t){!e.RTCPeerConnection&&e.webkitRTCPeerConnection&&(e.RTCPeerConnection=e.webkitRTCPeerConnection),e.RTCPeerConnection&&t.version<53&&["setLocalDescription","setRemoteDescription","addIceCandidate"].forEach((function(t){const n=e.RTCPeerConnection.prototype[t],i={[t](){return arguments[0]=new("addIceCandidate"===t?e.RTCIceCandidate:e.RTCSessionDescription)(arguments[0]),n.apply(this,arguments)}};e.RTCPeerConnection.prototype[t]=i[t]}))}function Do(e,t){mo(e,"negotiationneeded",(e=>{const n=e.target;if(!(t.version<72||n.getConfiguration&&"plan-b"===n.getConfiguration().sdpSemantics)||"stable"===n.signalingState)return e}))}var Mo=Object.freeze({__proto__:null,fixNegotiationNeeded:Do,shimAddTrackRemoveTrack:Io,shimAddTrackRemoveTrackWithNative:Ro,shimGetSendersWithDtmf:_o,shimGetUserMedia:So,shimMediaStream:xo,shimOnTrack:Eo,shimPeerConnection:Oo,shimSenderReceiverGetStats:Po});function Ao(e,t){const n=e&&e.navigator,i=e&&e.MediaStreamTrack;if(n.getUserMedia=function(e,t,i){bo("navigator.getUserMedia","navigator.mediaDevices.getUserMedia"),n.mediaDevices.getUserMedia(e).then(t,i)},!(t.version>55&&"autoGainControl"in n.mediaDevices.getSupportedConstraints())){const e=function(e,t,n){t in e&&!(n in e)&&(e[n]=e[t],delete e[t])},t=n.mediaDevices.getUserMedia.bind(n.mediaDevices);if(n.mediaDevices.getUserMedia=function(n){return"object"==typeof n&&"object"==typeof n.audio&&(n=JSON.parse(JSON.stringify(n)),e(n.audio,"autoGainControl","mozAutoGainControl"),e(n.audio,"noiseSuppression","mozNoiseSuppression")),t(n)},i&&i.prototype.getSettings){const t=i.prototype.getSettings;i.prototype.getSettings=function(){const n=t.apply(this,arguments);return e(n,"mozAutoGainControl","autoGainControl"),e(n,"mozNoiseSuppression","noiseSuppression"),n}}if(i&&i.prototype.applyConstraints){const t=i.prototype.applyConstraints;i.prototype.applyConstraints=function(n){return"audio"===this.kind&&"object"==typeof n&&(n=JSON.parse(JSON.stringify(n)),e(n,"autoGainControl","mozAutoGainControl"),e(n,"noiseSuppression","mozNoiseSuppression")),t.apply(this,[n])}}}}function No(e){"object"==typeof e&&e.RTCTrackEvent&&"receiver"in e.RTCTrackEvent.prototype&&!("transceiver"in e.RTCTrackEvent.prototype)&&Object.defineProperty(e.RTCTrackEvent.prototype,"transceiver",{get(){return{receiver:this.receiver}}})}function Lo(e,t){if("object"!=typeof e||!e.RTCPeerConnection&&!e.mozRTCPeerConnection)return;!e.RTCPeerConnection&&e.mozRTCPeerConnection&&(e.RTCPeerConnection=e.mozRTCPeerConnection),t.version<53&&["setLocalDescription","setRemoteDescription","addIceCandidate"].forEach((function(t){const n=e.RTCPeerConnection.prototype[t],i={[t](){return arguments[0]=new("addIceCandidate"===t?e.RTCIceCandidate:e.RTCSessionDescription)(arguments[0]),n.apply(this,arguments)}};e.RTCPeerConnection.prototype[t]=i[t]}));const n={inboundrtp:"inbound-rtp",outboundrtp:"outbound-rtp",candidatepair:"candidate-pair",localcandidate:"local-candidate",remotecandidate:"remote-candidate"},i=e.RTCPeerConnection.prototype.getStats;e.RTCPeerConnection.prototype.getStats=function(){const[e,r,o]=arguments;return i.apply(this,[e||null]).then((e=>{if(t.version<53&&!r)try{e.forEach((e=>{e.type=n[e.type]||e.type}))}catch(t){if("TypeError"!==t.name)throw t;e.forEach(((t,i)=>{e.set(i,Object.assign({},t,{type:n[t.type]||t.type}))}))}return e})).then(r,o)}}function jo(e){if("object"!=typeof e||!e.RTCPeerConnection||!e.RTCRtpSender)return;if(e.RTCRtpSender&&"getStats"in e.RTCRtpSender.prototype)return;const t=e.RTCPeerConnection.prototype.getSenders;t&&(e.RTCPeerConnection.prototype.getSenders=function(){const e=t.apply(this,[]);return e.forEach((e=>e._pc=this)),e});const n=e.RTCPeerConnection.prototype.addTrack;n&&(e.RTCPeerConnection.prototype.addTrack=function(){const e=n.apply(this,arguments);return e._pc=this,e}),e.RTCRtpSender.prototype.getStats=function(){return this.track?this._pc.getStats(this.track):Promise.resolve(new Map)}}function Uo(e){if("object"!=typeof e||!e.RTCPeerConnection||!e.RTCRtpSender)return;if(e.RTCRtpSender&&"getStats"in e.RTCRtpReceiver.prototype)return;const t=e.RTCPeerConnection.prototype.getReceivers;t&&(e.RTCPeerConnection.prototype.getReceivers=function(){const e=t.apply(this,[]);return e.forEach((e=>e._pc=this)),e}),mo(e,"track",(e=>(e.receiver._pc=e.srcElement,e))),e.RTCRtpReceiver.prototype.getStats=function(){return this._pc.getStats(this.track)}}function Fo(e){e.RTCPeerConnection&&!("removeStream"in e.RTCPeerConnection.prototype)&&(e.RTCPeerConnection.prototype.removeStream=function(e){bo("removeStream","removeTrack"),this.getSenders().forEach((t=>{t.track&&e.getTracks().includes(t.track)&&this.removeTrack(t)}))})}function Bo(e){e.DataChannel&&!e.RTCDataChannel&&(e.RTCDataChannel=e.DataChannel)}function Vo(e){if("object"!=typeof e||!e.RTCPeerConnection)return;const t=e.RTCPeerConnection.prototype.addTransceiver;t&&(e.RTCPeerConnection.prototype.addTransceiver=function(){this.setParametersPromises=[];let e=arguments[1]&&arguments[1].sendEncodings;void 0===e&&(e=[]),e=[...e];const n=e.length>0;n&&e.forEach((e=>{if("rid"in e&&!/^[a-z0-9]{0,16}$/i.test(e.rid))throw new TypeError("Invalid RID value provided.");if("scaleResolutionDownBy"in e&&!(parseFloat(e.scaleResolutionDownBy)>=1))throw new RangeError("scale_resolution_down_by must be >= 1.0");if("maxFramerate"in e&&!(parseFloat(e.maxFramerate)>=0))throw new RangeError("max_framerate must be >= 0.0")}));const i=t.apply(this,arguments);if(n){const{sender:t}=i,n=t.getParameters();(!("encodings"in n)||1===n.encodings.length&&0===Object.keys(n.encodings[0]).length)&&(n.encodings=e,t.sendEncodings=e,this.setParametersPromises.push(t.setParameters(n).then((()=>{delete t.sendEncodings})).catch((()=>{delete t.sendEncodings}))))}return i})}function qo(e){if("object"!=typeof e||!e.RTCRtpSender)return;const t=e.RTCRtpSender.prototype.getParameters;t&&(e.RTCRtpSender.prototype.getParameters=function(){const e=t.apply(this,arguments);return"encodings"in e||(e.encodings=[].concat(this.sendEncodings||[{}])),e})}function Wo(e){if("object"!=typeof e||!e.RTCPeerConnection)return;const t=e.RTCPeerConnection.prototype.createOffer;e.RTCPeerConnection.prototype.createOffer=function(){return this.setParametersPromises&&this.setParametersPromises.length?Promise.all(this.setParametersPromises).then((()=>t.apply(this,arguments))).finally((()=>{this.setParametersPromises=[]})):t.apply(this,arguments)}}function Ho(e){if("object"!=typeof e||!e.RTCPeerConnection)return;const t=e.RTCPeerConnection.prototype.createAnswer;e.RTCPeerConnection.prototype.createAnswer=function(){return this.setParametersPromises&&this.setParametersPromises.length?Promise.all(this.setParametersPromises).then((()=>t.apply(this,arguments))).finally((()=>{this.setParametersPromises=[]})):t.apply(this,arguments)}}var zo=Object.freeze({__proto__:null,shimAddTransceiver:Vo,shimCreateAnswer:Ho,shimCreateOffer:Wo,shimGetDisplayMedia:function(e,t){e.navigator.mediaDevices&&"getDisplayMedia"in e.navigator.mediaDevices||e.navigator.mediaDevices&&(e.navigator.mediaDevices.getDisplayMedia=function(n){if(!n||!n.video){const e=new DOMException("getDisplayMedia without video constraints is undefined");return e.name="NotFoundError",e.code=8,Promise.reject(e)}return!0===n.video?n.video={mediaSource:t}:n.video.mediaSource=t,e.navigator.mediaDevices.getUserMedia(n)})},shimGetParameters:qo,shimGetUserMedia:Ao,shimOnTrack:No,shimPeerConnection:Lo,shimRTCDataChannel:Bo,shimReceiverGetStats:Uo,shimRemoveStream:Fo,shimSenderGetStats:jo});function Go(e){if("object"==typeof e&&e.RTCPeerConnection){if("getLocalStreams"in e.RTCPeerConnection.prototype||(e.RTCPeerConnection.prototype.getLocalStreams=function(){return this._localStreams||(this._localStreams=[]),this._localStreams}),!("addStream"in e.RTCPeerConnection.prototype)){const t=e.RTCPeerConnection.prototype.addTrack;e.RTCPeerConnection.prototype.addStream=function(e){this._localStreams||(this._localStreams=[]),this._localStreams.includes(e)||this._localStreams.push(e),e.getAudioTracks().forEach((n=>t.call(this,n,e))),e.getVideoTracks().forEach((n=>t.call(this,n,e)))},e.RTCPeerConnection.prototype.addTrack=function(e){for(var n=arguments.length,i=new Array(n>1?n-1:0),r=1;r<n;r++)i[r-1]=arguments[r];return i&&i.forEach((e=>{this._localStreams?this._localStreams.includes(e)||this._localStreams.push(e):this._localStreams=[e]})),t.apply(this,arguments)}}"removeStream"in e.RTCPeerConnection.prototype||(e.RTCPeerConnection.prototype.removeStream=function(e){this._localStreams||(this._localStreams=[]);const t=this._localStreams.indexOf(e);if(-1===t)return;this._localStreams.splice(t,1);const n=e.getTracks();this.getSenders().forEach((e=>{n.includes(e.track)&&this.removeTrack(e)}))})}}function Ko(e){if("object"==typeof e&&e.RTCPeerConnection&&("getRemoteStreams"in e.RTCPeerConnection.prototype||(e.RTCPeerConnection.prototype.getRemoteStreams=function(){return this._remoteStreams?this._remoteStreams:[]}),!("onaddstream"in e.RTCPeerConnection.prototype))){Object.defineProperty(e.RTCPeerConnection.prototype,"onaddstream",{get(){return this._onaddstream},set(e){this._onaddstream&&(this.removeEventListener("addstream",this._onaddstream),this.removeEventListener("track",this._onaddstreampoly)),this.addEventListener("addstream",this._onaddstream=e),this.addEventListener("track",this._onaddstreampoly=e=>{e.streams.forEach((e=>{if(this._remoteStreams||(this._remoteStreams=[]),this._remoteStreams.includes(e))return;this._remoteStreams.push(e);const t=new Event("addstream");t.stream=e,this.dispatchEvent(t)}))})}});const t=e.RTCPeerConnection.prototype.setRemoteDescription;e.RTCPeerConnection.prototype.setRemoteDescription=function(){const e=this;return this._onaddstreampoly||this.addEventListener("track",this._onaddstreampoly=function(t){t.streams.forEach((t=>{if(e._remoteStreams||(e._remoteStreams=[]),e._remoteStreams.indexOf(t)>=0)return;e._remoteStreams.push(t);const n=new Event("addstream");n.stream=t,e.dispatchEvent(n)}))}),t.apply(e,arguments)}}}function Jo(e){if("object"!=typeof e||!e.RTCPeerConnection)return;const t=e.RTCPeerConnection.prototype,n=t.createOffer,i=t.createAnswer,r=t.setLocalDescription,o=t.setRemoteDescription,a=t.addIceCandidate;t.createOffer=function(e,t){const i=arguments.length>=2?arguments[2]:arguments[0],r=n.apply(this,[i]);return t?(r.then(e,t),Promise.resolve()):r},t.createAnswer=function(e,t){const n=arguments.length>=2?arguments[2]:arguments[0],r=i.apply(this,[n]);return t?(r.then(e,t),Promise.resolve()):r};let s=function(e,t,n){const i=r.apply(this,[e]);return n?(i.then(t,n),Promise.resolve()):i};t.setLocalDescription=s,s=function(e,t,n){const i=o.apply(this,[e]);return n?(i.then(t,n),Promise.resolve()):i},t.setRemoteDescription=s,s=function(e,t,n){const i=a.apply(this,[e]);return n?(i.then(t,n),Promise.resolve()):i},t.addIceCandidate=s}function Yo(e){const t=e&&e.navigator;if(t.mediaDevices&&t.mediaDevices.getUserMedia){const e=t.mediaDevices,n=e.getUserMedia.bind(e);t.mediaDevices.getUserMedia=e=>n(Xo(e))}!t.getUserMedia&&t.mediaDevices&&t.mediaDevices.getUserMedia&&(t.getUserMedia=function(e,n,i){t.mediaDevices.getUserMedia(e).then(n,i)}.bind(t))}function Xo(e){return e&&void 0!==e.video?Object.assign({},e,{video:ko(e.video)}):e}function $o(e){if(!e.RTCPeerConnection)return;const t=e.RTCPeerConnection;e.RTCPeerConnection=function(e,n){if(e&&e.iceServers){const t=[];for(let n=0;n<e.iceServers.length;n++){let i=e.iceServers[n];void 0===i.urls&&i.url?(bo("RTCIceServer.url","RTCIceServer.urls"),i=JSON.parse(JSON.stringify(i)),i.urls=i.url,delete i.url,t.push(i)):t.push(e.iceServers[n])}e.iceServers=t}return new t(e,n)},e.RTCPeerConnection.prototype=t.prototype,"generateCertificate"in t&&Object.defineProperty(e.RTCPeerConnection,"generateCertificate",{get:()=>t.generateCertificate})}function Qo(e){"object"==typeof e&&e.RTCTrackEvent&&"receiver"in e.RTCTrackEvent.prototype&&!("transceiver"in e.RTCTrackEvent.prototype)&&Object.defineProperty(e.RTCTrackEvent.prototype,"transceiver",{get(){return{receiver:this.receiver}}})}function Zo(e){const t=e.RTCPeerConnection.prototype.createOffer;e.RTCPeerConnection.prototype.createOffer=function(e){if(e){void 0!==e.offerToReceiveAudio&&(e.offerToReceiveAudio=!!e.offerToReceiveAudio);const t=this.getTransceivers().find((e=>"audio"===e.receiver.track.kind));!1===e.offerToReceiveAudio&&t?"sendrecv"===t.direction?t.setDirection?t.setDirection("sendonly"):t.direction="sendonly":"recvonly"===t.direction&&(t.setDirection?t.setDirection("inactive"):t.direction="inactive"):!0!==e.offerToReceiveAudio||t||this.addTransceiver("audio",{direction:"recvonly"}),void 0!==e.offerToReceiveVideo&&(e.offerToReceiveVideo=!!e.offerToReceiveVideo);const n=this.getTransceivers().find((e=>"video"===e.receiver.track.kind));!1===e.offerToReceiveVideo&&n?"sendrecv"===n.direction?n.setDirection?n.setDirection("sendonly"):n.direction="sendonly":"recvonly"===n.direction&&(n.setDirection?n.setDirection("inactive"):n.direction="inactive"):!0!==e.offerToReceiveVideo||n||this.addTransceiver("video",{direction:"recvonly"})}return t.apply(this,arguments)}}function ea(e){"object"!=typeof e||e.AudioContext||(e.AudioContext=e.webkitAudioContext)}var ta,na=Object.freeze({__proto__:null,shimAudioContext:ea,shimCallbacksAPI:Jo,shimConstraints:Xo,shimCreateOfferLegacy:Zo,shimGetUserMedia:Yo,shimLocalStreamsAPI:Go,shimRTCIceServerUrls:$o,shimRemoteStreamsAPI:Ko,shimTrackEventTransceiver:Qo}),ia={exports:{}},ra=(ta||(ta=1,function(e){const t={generateIdentifier:function(){return Math.random().toString(36).substring(2,12)}};t.localCName=t.generateIdentifier(),t.splitLines=function(e){return e.trim().split("\n").map((e=>e.trim()))},t.splitSections=function(e){return e.split("\nm=").map(((e,t)=>(t>0?"m="+e:e).trim()+"\r\n"))},t.getDescription=function(e){const n=t.splitSections(e);return n&&n[0]},t.getMediaSections=function(e){const n=t.splitSections(e);return n.shift(),n},t.matchPrefix=function(e,n){return t.splitLines(e).filter((e=>0===e.indexOf(n)))},t.parseCandidate=function(e){let t;t=0===e.indexOf("a=candidate:")?e.substring(12).split(" "):e.substring(10).split(" ");const n={foundation:t[0],component:{1:"rtp",2:"rtcp"}[t[1]]||t[1],protocol:t[2].toLowerCase(),priority:parseInt(t[3],10),ip:t[4],address:t[4],port:parseInt(t[5],10),type:t[7]};for(let e=8;e<t.length;e+=2)switch(t[e]){case"raddr":n.relatedAddress=t[e+1];break;case"rport":n.relatedPort=parseInt(t[e+1],10);break;case"tcptype":n.tcpType=t[e+1];break;case"ufrag":n.ufrag=t[e+1],n.usernameFragment=t[e+1];break;default:void 0===n[t[e]]&&(n[t[e]]=t[e+1])}return n},t.writeCandidate=function(e){const t=[];t.push(e.foundation);const n=e.component;"rtp"===n?t.push(1):"rtcp"===n?t.push(2):t.push(n),t.push(e.protocol.toUpperCase()),t.push(e.priority),t.push(e.address||e.ip),t.push(e.port);const i=e.type;return t.push("typ"),t.push(i),"host"!==i&&e.relatedAddress&&e.relatedPort&&(t.push("raddr"),t.push(e.relatedAddress),t.push("rport"),t.push(e.relatedPort)),e.tcpType&&"tcp"===e.protocol.toLowerCase()&&(t.push("tcptype"),t.push(e.tcpType)),(e.usernameFragment||e.ufrag)&&(t.push("ufrag"),t.push(e.usernameFragment||e.ufrag)),"candidate:"+t.join(" ")},t.parseIceOptions=function(e){return e.substring(14).split(" ")},t.parseRtpMap=function(e){let t=e.substring(9).split(" ");const n={payloadType:parseInt(t.shift(),10)};return t=t[0].split("/"),n.name=t[0],n.clockRate=parseInt(t[1],10),n.channels=3===t.length?parseInt(t[2],10):1,n.numChannels=n.channels,n},t.writeRtpMap=function(e){let t=e.payloadType;void 0!==e.preferredPayloadType&&(t=e.preferredPayloadType);const n=e.channels||e.numChannels||1;return"a=rtpmap:"+t+" "+e.name+"/"+e.clockRate+(1!==n?"/"+n:"")+"\r\n"},t.parseExtmap=function(e){const t=e.substring(9).split(" ");return{id:parseInt(t[0],10),direction:t[0].indexOf("/")>0?t[0].split("/")[1]:"sendrecv",uri:t[1],attributes:t.slice(2).join(" ")}},t.writeExtmap=function(e){return"a=extmap:"+(e.id||e.preferredId)+(e.direction&&"sendrecv"!==e.direction?"/"+e.direction:"")+" "+e.uri+(e.attributes?" "+e.attributes:"")+"\r\n"},t.parseFmtp=function(e){const t={};let n;const i=e.substring(e.indexOf(" ")+1).split(";");for(let e=0;e<i.length;e++)n=i[e].trim().split("="),t[n[0].trim()]=n[1];return t},t.writeFmtp=function(e){let t="",n=e.payloadType;if(void 0!==e.preferredPayloadType&&(n=e.preferredPayloadType),e.parameters&&Object.keys(e.parameters).length){const i=[];Object.keys(e.parameters).forEach((t=>{void 0!==e.parameters[t]?i.push(t+"="+e.parameters[t]):i.push(t)})),t+="a=fmtp:"+n+" "+i.join(";")+"\r\n"}return t},t.parseRtcpFb=function(e){const t=e.substring(e.indexOf(" ")+1).split(" ");return{type:t.shift(),parameter:t.join(" ")}},t.writeRtcpFb=function(e){let t="",n=e.payloadType;return void 0!==e.preferredPayloadType&&(n=e.preferredPayloadType),e.rtcpFeedback&&e.rtcpFeedback.length&&e.rtcpFeedback.forEach((e=>{t+="a=rtcp-fb:"+n+" "+e.type+(e.parameter&&e.parameter.length?" "+e.parameter:"")+"\r\n"})),t},t.parseSsrcMedia=function(e){const t=e.indexOf(" "),n={ssrc:parseInt(e.substring(7,t),10)},i=e.indexOf(":",t);return i>-1?(n.attribute=e.substring(t+1,i),n.value=e.substring(i+1)):n.attribute=e.substring(t+1),n},t.parseSsrcGroup=function(e){const t=e.substring(13).split(" ");return{semantics:t.shift(),ssrcs:t.map((e=>parseInt(e,10)))}},t.getMid=function(e){const n=t.matchPrefix(e,"a=mid:")[0];if(n)return n.substring(6)},t.parseFingerprint=function(e){const t=e.substring(14).split(" ");return{algorithm:t[0].toLowerCase(),value:t[1].toUpperCase()}},t.getDtlsParameters=function(e,n){return{role:"auto",fingerprints:t.matchPrefix(e+n,"a=fingerprint:").map(t.parseFingerprint)}},t.writeDtlsParameters=function(e,t){let n="a=setup:"+t+"\r\n";return e.fingerprints.forEach((e=>{n+="a=fingerprint:"+e.algorithm+" "+e.value+"\r\n"})),n},t.parseCryptoLine=function(e){const t=e.substring(9).split(" ");return{tag:parseInt(t[0],10),cryptoSuite:t[1],keyParams:t[2],sessionParams:t.slice(3)}},t.writeCryptoLine=function(e){return"a=crypto:"+e.tag+" "+e.cryptoSuite+" "+("object"==typeof e.keyParams?t.writeCryptoKeyParams(e.keyParams):e.keyParams)+(e.sessionParams?" "+e.sessionParams.join(" "):"")+"\r\n"},t.parseCryptoKeyParams=function(e){if(0!==e.indexOf("inline:"))return null;const t=e.substring(7).split("|");return{keyMethod:"inline",keySalt:t[0],lifeTime:t[1],mkiValue:t[2]?t[2].split(":")[0]:void 0,mkiLength:t[2]?t[2].split(":")[1]:void 0}},t.writeCryptoKeyParams=function(e){return e.keyMethod+":"+e.keySalt+(e.lifeTime?"|"+e.lifeTime:"")+(e.mkiValue&&e.mkiLength?"|"+e.mkiValue+":"+e.mkiLength:"")},t.getCryptoParameters=function(e,n){return t.matchPrefix(e+n,"a=crypto:").map(t.parseCryptoLine)},t.getIceParameters=function(e,n){const i=t.matchPrefix(e+n,"a=ice-ufrag:")[0],r=t.matchPrefix(e+n,"a=ice-pwd:")[0];return i&&r?{usernameFragment:i.substring(12),password:r.substring(10)}:null},t.writeIceParameters=function(e){let t="a=ice-ufrag:"+e.usernameFragment+"\r\na=ice-pwd:"+e.password+"\r\n";return e.iceLite&&(t+="a=ice-lite\r\n"),t},t.parseRtpParameters=function(e){const n={codecs:[],headerExtensions:[],fecMechanisms:[],rtcp:[]},i=t.splitLines(e)[0].split(" ");n.profile=i[2];for(let r=3;r<i.length;r++){const o=i[r],a=t.matchPrefix(e,"a=rtpmap:"+o+" ")[0];if(a){const i=t.parseRtpMap(a),r=t.matchPrefix(e,"a=fmtp:"+o+" ");switch(i.parameters=r.length?t.parseFmtp(r[0]):{},i.rtcpFeedback=t.matchPrefix(e,"a=rtcp-fb:"+o+" ").map(t.parseRtcpFb),n.codecs.push(i),i.name.toUpperCase()){case"RED":case"ULPFEC":n.fecMechanisms.push(i.name.toUpperCase())}}}t.matchPrefix(e,"a=extmap:").forEach((e=>{n.headerExtensions.push(t.parseExtmap(e))}));const r=t.matchPrefix(e,"a=rtcp-fb:* ").map(t.parseRtcpFb);return n.codecs.forEach((e=>{r.forEach((t=>{e.rtcpFeedback.find((e=>e.type===t.type&&e.parameter===t.parameter))||e.rtcpFeedback.push(t)}))})),n},t.writeRtpDescription=function(e,n){let i="";i+="m="+e+" ",i+=n.codecs.length>0?"9":"0",i+=" "+(n.profile||"UDP/TLS/RTP/SAVPF")+" ",i+=n.codecs.map((e=>void 0!==e.preferredPayloadType?e.preferredPayloadType:e.payloadType)).join(" ")+"\r\n",i+="c=IN IP4 0.0.0.0\r\n",i+="a=rtcp:9 IN IP4 0.0.0.0\r\n",n.codecs.forEach((e=>{i+=t.writeRtpMap(e),i+=t.writeFmtp(e),i+=t.writeRtcpFb(e)}));let r=0;return n.codecs.forEach((e=>{e.maxptime>r&&(r=e.maxptime)})),r>0&&(i+="a=maxptime:"+r+"\r\n"),n.headerExtensions&&n.headerExtensions.forEach((e=>{i+=t.writeExtmap(e)})),i},t.parseRtpEncodingParameters=function(e){const n=[],i=t.parseRtpParameters(e),r=-1!==i.fecMechanisms.indexOf("RED"),o=-1!==i.fecMechanisms.indexOf("ULPFEC"),a=t.matchPrefix(e,"a=ssrc:").map((e=>t.parseSsrcMedia(e))).filter((e=>"cname"===e.attribute)),s=a.length>0&&a[0].ssrc;let c;const l=t.matchPrefix(e,"a=ssrc-group:FID").map((e=>e.substring(17).split(" ").map((e=>parseInt(e,10)))));l.length>0&&l[0].length>1&&l[0][0]===s&&(c=l[0][1]),i.codecs.forEach((e=>{if("RTX"===e.name.toUpperCase()&&e.parameters.apt){let t={ssrc:s,codecPayloadType:parseInt(e.parameters.apt,10)};s&&c&&(t.rtx={ssrc:c}),n.push(t),r&&(t=JSON.parse(JSON.stringify(t)),t.fec={ssrc:s,mechanism:o?"red+ulpfec":"red"},n.push(t))}})),0===n.length&&s&&n.push({ssrc:s});let d=t.matchPrefix(e,"b=");return d.length&&(d=0===d[0].indexOf("b=TIAS:")?parseInt(d[0].substring(7),10):0===d[0].indexOf("b=AS:")?1e3*parseInt(d[0].substring(5),10)*.95-16e3:void 0,n.forEach((e=>{e.maxBitrate=d}))),n},t.parseRtcpParameters=function(e){const n={},i=t.matchPrefix(e,"a=ssrc:").map((e=>t.parseSsrcMedia(e))).filter((e=>"cname"===e.attribute))[0];i&&(n.cname=i.value,n.ssrc=i.ssrc);const r=t.matchPrefix(e,"a=rtcp-rsize");n.reducedSize=r.length>0,n.compound=0===r.length;const o=t.matchPrefix(e,"a=rtcp-mux");return n.mux=o.length>0,n},t.writeRtcpParameters=function(e){let t="";return e.reducedSize&&(t+="a=rtcp-rsize\r\n"),e.mux&&(t+="a=rtcp-mux\r\n"),void 0!==e.ssrc&&e.cname&&(t+="a=ssrc:"+e.ssrc+" cname:"+e.cname+"\r\n"),t},t.parseMsid=function(e){let n;const i=t.matchPrefix(e,"a=msid:");if(1===i.length)return n=i[0].substring(7).split(" "),{stream:n[0],track:n[1]};const r=t.matchPrefix(e,"a=ssrc:").map((e=>t.parseSsrcMedia(e))).filter((e=>"msid"===e.attribute));return r.length>0?(n=r[0].value.split(" "),{stream:n[0],track:n[1]}):void 0},t.parseSctpDescription=function(e){const n=t.parseMLine(e),i=t.matchPrefix(e,"a=max-message-size:");let r;i.length>0&&(r=parseInt(i[0].substring(19),10)),isNaN(r)&&(r=65536);const o=t.matchPrefix(e,"a=sctp-port:");if(o.length>0)return{port:parseInt(o[0].substring(12),10),protocol:n.fmt,maxMessageSize:r};const a=t.matchPrefix(e,"a=sctpmap:");if(a.length>0){const e=a[0].substring(10).split(" ");return{port:parseInt(e[0],10),protocol:e[1],maxMessageSize:r}}},t.writeSctpDescription=function(e,t){let n=[];return n="DTLS/SCTP"!==e.protocol?["m="+e.kind+" 9 "+e.protocol+" "+t.protocol+"\r\n","c=IN IP4 0.0.0.0\r\n","a=sctp-port:"+t.port+"\r\n"]:["m="+e.kind+" 9 "+e.protocol+" "+t.port+"\r\n","c=IN IP4 0.0.0.0\r\n","a=sctpmap:"+t.port+" "+t.protocol+" 65535\r\n"],void 0!==t.maxMessageSize&&n.push("a=max-message-size:"+t.maxMessageSize+"\r\n"),n.join("")},t.generateSessionId=function(){return Math.random().toString().substr(2,22)},t.writeSessionBoilerplate=function(e,n,i){let r;const o=void 0!==n?n:2;return r=e||t.generateSessionId(),"v=0\r\no="+(i||"thisisadapterortc")+" "+r+" "+o+" IN IP4 127.0.0.1\r\ns=-\r\nt=0 0\r\n"},t.getDirection=function(e,n){const i=t.splitLines(e);for(let e=0;e<i.length;e++)switch(i[e]){case"a=sendrecv":case"a=sendonly":case"a=recvonly":case"a=inactive":return i[e].substring(2)}return n?t.getDirection(n):"sendrecv"},t.getKind=function(e){return t.splitLines(e)[0].split(" ")[0].substring(2)},t.isRejected=function(e){return"0"===e.split(" ",2)[1]},t.parseMLine=function(e){const n=t.splitLines(e)[0].substring(2).split(" ");return{kind:n[0],port:parseInt(n[1],10),protocol:n[2],fmt:n.slice(3).join(" ")}},t.parseOLine=function(e){const n=t.matchPrefix(e,"o=")[0].substring(2).split(" ");return{username:n[0],sessionId:n[1],sessionVersion:parseInt(n[2],10),netType:n[3],addressType:n[4],address:n[5]}},t.isValidSDP=function(e){if("string"!=typeof e||0===e.length)return!1;const n=t.splitLines(e);for(let e=0;e<n.length;e++)if(n[e].length<2||"="!==n[e].charAt(1))return!1;return!0},e.exports=t}(ia)),ia.exports),oa=zr(ra),aa=lt({__proto__:null,default:oa},[ra]);function sa(e){if(!e.RTCIceCandidate||e.RTCIceCandidate&&"foundation"in e.RTCIceCandidate.prototype)return;const t=e.RTCIceCandidate;e.RTCIceCandidate=function(e){if("object"==typeof e&&e.candidate&&0===e.candidate.indexOf("a=")&&((e=JSON.parse(JSON.stringify(e))).candidate=e.candidate.substring(2)),e.candidate&&e.candidate.length){const n=new t(e),i=oa.parseCandidate(e.candidate);for(const e in i)e in n||Object.defineProperty(n,e,{value:i[e]});return n.toJSON=function(){return{candidate:n.candidate,sdpMid:n.sdpMid,sdpMLineIndex:n.sdpMLineIndex,usernameFragment:n.usernameFragment}},n}return new t(e)},e.RTCIceCandidate.prototype=t.prototype,mo(e,"icecandidate",(t=>(t.candidate&&Object.defineProperty(t,"candidate",{value:new e.RTCIceCandidate(t.candidate),writable:"false"}),t)))}function ca(e){!e.RTCIceCandidate||e.RTCIceCandidate&&"relayProtocol"in e.RTCIceCandidate.prototype||mo(e,"icecandidate",(e=>{if(e.candidate){const t=oa.parseCandidate(e.candidate.candidate);"relay"===t.type&&(e.candidate.relayProtocol={0:"tls",1:"tcp",2:"udp"}[t.priority>>24])}return e}))}function la(e,t){if(!e.RTCPeerConnection)return;"sctp"in e.RTCPeerConnection.prototype||Object.defineProperty(e.RTCPeerConnection.prototype,"sctp",{get(){return void 0===this._sctp?null:this._sctp}});const n=e.RTCPeerConnection.prototype.setRemoteDescription;e.RTCPeerConnection.prototype.setRemoteDescription=function(){if(this._sctp=null,"chrome"===t.browser&&t.version>=76){const{sdpSemantics:e}=this.getConfiguration();"plan-b"===e&&Object.defineProperty(this,"sctp",{get(){return void 0===this._sctp?null:this._sctp},enumerable:!0,configurable:!0})}if(function(e){if(!e||!e.sdp)return!1;const t=oa.splitSections(e.sdp);return t.shift(),t.some((e=>{const t=oa.parseMLine(e);return t&&"application"===t.kind&&-1!==t.protocol.indexOf("SCTP")}))}(arguments[0])){const e=function(e){const t=e.sdp.match(/mozilla...THIS_IS_SDPARTA-(\d+)/);if(null===t||t.length<2)return-1;const n=parseInt(t[1],10);return n!=n?-1:n}(arguments[0]),n=function(e){let n=65536;return"firefox"===t.browser&&(n=t.version<57?-1===e?16384:2147483637:t.version<60?57===t.version?65535:65536:2147483637),n}(e),i=function(e,n){let i=65536;"firefox"===t.browser&&57===t.version&&(i=65535);const r=oa.matchPrefix(e.sdp,"a=max-message-size:");return r.length>0?i=parseInt(r[0].substring(19),10):"firefox"===t.browser&&-1!==n&&(i=2147483637),i}(arguments[0],e);let r;r=0===n&&0===i?Number.POSITIVE_INFINITY:0===n||0===i?Math.max(n,i):Math.min(n,i);const o={};Object.defineProperty(o,"maxMessageSize",{get:()=>r}),this._sctp=o}return n.apply(this,arguments)}}function da(e){if(!e.RTCPeerConnection||!("createDataChannel"in e.RTCPeerConnection.prototype))return;function t(e,t){const n=e.send;e.send=function(){const i=arguments[0],r=i.length||i.size||i.byteLength;if("open"===e.readyState&&t.sctp&&r>t.sctp.maxMessageSize)throw new TypeError("Message too large (can send a maximum of "+t.sctp.maxMessageSize+" bytes)");return n.apply(e,arguments)}}const n=e.RTCPeerConnection.prototype.createDataChannel;e.RTCPeerConnection.prototype.createDataChannel=function(){const e=n.apply(this,arguments);return t(e,this),e},mo(e,"datachannel",(e=>(t(e.channel,e.target),e)))}function ua(e){if(!e.RTCPeerConnection||"connectionState"in e.RTCPeerConnection.prototype)return;const t=e.RTCPeerConnection.prototype;Object.defineProperty(t,"connectionState",{get(){return{completed:"connected",checking:"connecting"}[this.iceConnectionState]||this.iceConnectionState},enumerable:!0,configurable:!0}),Object.defineProperty(t,"onconnectionstatechange",{get(){return this._onconnectionstatechange||null},set(e){this._onconnectionstatechange&&(this.removeEventListener("connectionstatechange",this._onconnectionstatechange),delete this._onconnectionstatechange),e&&this.addEventListener("connectionstatechange",this._onconnectionstatechange=e)},enumerable:!0,configurable:!0}),["setLocalDescription","setRemoteDescription"].forEach((e=>{const n=t[e];t[e]=function(){return this._connectionstatechangepoly||(this._connectionstatechangepoly=e=>{const t=e.target;if(t._lastConnectionState!==t.connectionState){t._lastConnectionState=t.connectionState;const n=new Event("connectionstatechange",e);t.dispatchEvent(n)}return e},this.addEventListener("iceconnectionstatechange",this._connectionstatechangepoly)),n.apply(this,arguments)}}))}function ha(e,t){if(!e.RTCPeerConnection)return;if("chrome"===t.browser&&t.version>=71)return;if("safari"===t.browser&&t._safariVersion>=13.1)return;const n=e.RTCPeerConnection.prototype.setRemoteDescription;e.RTCPeerConnection.prototype.setRemoteDescription=function(t){if(t&&t.sdp&&-1!==t.sdp.indexOf("\na=extmap-allow-mixed")){const n=t.sdp.split("\n").filter((e=>"a=extmap-allow-mixed"!==e.trim())).join("\n");e.RTCSessionDescription&&t instanceof e.RTCSessionDescription?arguments[0]=new e.RTCSessionDescription({type:t.type,sdp:n}):t.sdp=n}return n.apply(this,arguments)}}function pa(e,t){if(!e.RTCPeerConnection||!e.RTCPeerConnection.prototype)return;const n=e.RTCPeerConnection.prototype.addIceCandidate;n&&0!==n.length&&(e.RTCPeerConnection.prototype.addIceCandidate=function(){return arguments[0]?("chrome"===t.browser&&t.version<78||"firefox"===t.browser&&t.version<68||"safari"===t.browser)&&arguments[0]&&""===arguments[0].candidate?Promise.resolve():n.apply(this,arguments):(arguments[1]&&arguments[1].apply(null),Promise.resolve())})}function ma(e,t){if(!e.RTCPeerConnection||!e.RTCPeerConnection.prototype)return;const n=e.RTCPeerConnection.prototype.setLocalDescription;n&&0!==n.length&&(e.RTCPeerConnection.prototype.setLocalDescription=function(){let e=arguments[0]||{};if("object"!=typeof e||e.type&&e.sdp)return n.apply(this,arguments);if(e={type:e.type,sdp:e.sdp},!e.type)switch(this.signalingState){case"stable":case"have-local-offer":case"have-remote-pranswer":e.type="offer";break;default:e.type="answer"}return e.sdp||"offer"!==e.type&&"answer"!==e.type?n.apply(this,[e]):("offer"===e.type?this.createOffer:this.createAnswer).apply(this).then((e=>n.apply(this,[e])))})}var fa=Object.freeze({__proto__:null,removeExtmapAllowMixed:ha,shimAddIceCandidateNullOrEmpty:pa,shimConnectionState:ua,shimMaxMessageSize:la,shimParameterlessSetLocalDescription:ma,shimRTCIceCandidate:sa,shimRTCIceCandidateRelayProtocol:ca,shimSendThrowTypeError:da});!function(){let{window:e}=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{shimChrome:!0,shimFirefox:!0,shimSafari:!0};const n=vo,i=function(e){const t={browser:null,version:null};if(void 0===e||!e.navigator||!e.navigator.userAgent)return t.browser="Not a browser.",t;const{navigator:n}=e;if(n.userAgentData&&n.userAgentData.brands){const e=n.userAgentData.brands.find((e=>"Chromium"===e.brand));if(e)return{browser:"chrome",version:parseInt(e.version,10)}}if(n.mozGetUserMedia)t.browser="firefox",t.version=parseInt(po(n.userAgent,/Firefox\/(\d+)\./,1));else if(n.webkitGetUserMedia||!1===e.isSecureContext&&e.webkitRTCPeerConnection)t.browser="chrome",t.version=parseInt(po(n.userAgent,/Chrom(e|ium)\/(\d+)\./,2));else{if(!e.RTCPeerConnection||!n.userAgent.match(/AppleWebKit\/(\d+)\./))return t.browser="Not a supported browser.",t;t.browser="safari",t.version=parseInt(po(n.userAgent,/AppleWebKit\/(\d+)\./,1)),t.supportsUnifiedPlan=e.RTCRtpTransceiver&&"currentDirection"in e.RTCRtpTransceiver.prototype,t._safariVersion=po(n.userAgent,/Version\/(\d+(\.?\d+))/,1)}return t}(e),r={browserDetails:i,commonShim:fa,extractVersion:po,disableLog:fo,disableWarnings:go,sdp:aa};switch(i.browser){case"chrome":if(!Mo||!Oo||!t.shimChrome)return n("Chrome shim is not included in this adapter release."),r;if(null===i.version)return n("Chrome shim can not determine version, not shimming."),r;n("adapter.js shimming chrome."),r.browserShim=Mo,pa(e,i),ma(e),So(e,i),xo(e),Oo(e,i),Eo(e),Io(e,i),_o(e),Po(e),Do(e,i),sa(e),ca(e),ua(e),la(e,i),da(e),ha(e,i);break;case"firefox":if(!zo||!Lo||!t.shimFirefox)return n("Firefox shim is not included in this adapter release."),r;n("adapter.js shimming firefox."),r.browserShim=zo,pa(e,i),ma(e),Ao(e,i),Lo(e,i),No(e),Fo(e),jo(e),Uo(e),Bo(e),Vo(e),qo(e),Wo(e),Ho(e),sa(e),ua(e),la(e,i),da(e);break;case"safari":if(!na||!t.shimSafari)return n("Safari shim is not included in this adapter release."),r;n("adapter.js shimming safari."),r.browserShim=na,pa(e,i),ma(e),$o(e),Zo(e),Jo(e),Go(e),Ko(e),Qo(e),Yo(e),ea(e),sa(e),ca(e),la(e,i),da(e),ha(e,i);break;default:n("Unsupported browser!")}}({window:"undefined"==typeof window?void 0:window});const ga="lk_e2ee";var va,ba,ya,ka,wa,Ca,Ta,Sa,xa,Ea,_a,Pa;function Ra(){return void 0!==window.RTCRtpScriptTransform}!function(e){e.SetKey="setKey",e.RatchetRequest="ratchetRequest",e.KeyRatcheted="keyRatcheted"}(va||(va={})),function(e){e.KeyRatcheted="keyRatcheted"}(ba||(ba={})),function(e){e.ParticipantEncryptionStatusChanged="participantEncryptionStatusChanged",e.EncryptionError="encryptionError"}(ya||(ya={})),function(e){e.Error="cryptorError"}(ka||(ka={})),lo.EventEmitter;class Ia extends Error{constructor(e,t){super(t||"an error has occured"),this.name="LiveKitError",this.code=e}}!function(e){e[e.NotAllowed=0]="NotAllowed",e[e.ServerUnreachable=1]="ServerUnreachable",e[e.InternalError=2]="InternalError",e[e.Cancelled=3]="Cancelled",e[e.LeaveRequest=4]="LeaveRequest",e[e.Timeout=5]="Timeout"}(wa||(wa={}));class Oa extends Ia{constructor(e,t,n,i){super(1,e),this.name="ConnectionError",this.status=n,this.reason=t,this.context=i,this.reasonName=wa[t]}}class Da extends Ia{constructor(e){super(21,null!=e?e:"device is unsupported"),this.name="DeviceUnsupportedError"}}class Ma extends Ia{constructor(e){super(20,null!=e?e:"track is invalid"),this.name="TrackInvalidError"}}class Aa extends Ia{constructor(e){super(10,null!=e?e:"unsupported server"),this.name="UnsupportedServer"}}class Na extends Ia{constructor(e){super(12,null!=e?e:"unexpected connection state"),this.name="UnexpectedConnectionState"}}class La extends Ia{constructor(e){super(13,null!=e?e:"unable to negotiate"),this.name="NegotiationError"}}class ja extends Ia{constructor(e,t){super(15,e),this.name="PublishTrackError",this.status=t}}class Ua extends Ia{constructor(e,t){super(15,e),this.reason=t,this.reasonName="string"==typeof t?t:Ur[t]}}!function(e){e[e.AlreadyOpened=0]="AlreadyOpened",e[e.AbnormalEnd=1]="AbnormalEnd",e[e.DecodeFailed=2]="DecodeFailed",e[e.LengthExceeded=3]="LengthExceeded",e[e.Incomplete=4]="Incomplete",e[e.HandlerAlreadyRegistered=7]="HandlerAlreadyRegistered",e[e.EncryptionTypeMismatch=8]="EncryptionTypeMismatch"}(Ca||(Ca={}));class Fa extends Ia{constructor(e,t){super(16,e),this.name="DataStreamError",this.reason=t,this.reasonName=Ca[t]}}!function(e){e.PermissionDenied="PermissionDenied",e.NotFound="NotFound",e.DeviceInUse="DeviceInUse",e.Other="Other"}(Ta||(Ta={})),function(e){e.getFailure=function(t){if(t&&"name"in t)return"NotFoundError"===t.name||"DevicesNotFoundError"===t.name?e.NotFound:"NotAllowedError"===t.name||"PermissionDeniedError"===t.name?e.PermissionDenied:"NotReadableError"===t.name||"TrackStartError"===t.name?e.DeviceInUse:e.Other}}(Ta||(Ta={})),function(e){e[e.InvalidKey=0]="InvalidKey",e[e.MissingKey=1]="MissingKey",e[e.InternalError=2]="InternalError"}(Sa||(Sa={})),function(e){e.Connected="connected",e.Reconnecting="reconnecting",e.SignalReconnecting="signalReconnecting",e.Reconnected="reconnected",e.Disconnected="disconnected",e.ConnectionStateChanged="connectionStateChanged",e.Moved="moved",e.MediaDevicesChanged="mediaDevicesChanged",e.ParticipantConnected="participantConnected",e.ParticipantDisconnected="participantDisconnected",e.TrackPublished="trackPublished",e.TrackSubscribed="trackSubscribed",e.TrackSubscriptionFailed="trackSubscriptionFailed",e.TrackUnpublished="trackUnpublished",e.TrackUnsubscribed="trackUnsubscribed",e.TrackMuted="trackMuted",e.TrackUnmuted="trackUnmuted",e.LocalTrackPublished="localTrackPublished",e.LocalTrackUnpublished="localTrackUnpublished",e.LocalAudioSilenceDetected="localAudioSilenceDetected",e.ActiveSpeakersChanged="activeSpeakersChanged",e.ParticipantMetadataChanged="participantMetadataChanged",e.ParticipantNameChanged="participantNameChanged",e.ParticipantAttributesChanged="participantAttributesChanged",e.ParticipantActive="participantActive",e.RoomMetadataChanged="roomMetadataChanged",e.DataReceived="dataReceived",e.SipDTMFReceived="sipDTMFReceived",e.TranscriptionReceived="transcriptionReceived",e.ConnectionQualityChanged="connectionQualityChanged",e.TrackStreamStateChanged="trackStreamStateChanged",e.TrackSubscriptionPermissionChanged="trackSubscriptionPermissionChanged",e.TrackSubscriptionStatusChanged="trackSubscriptionStatusChanged",e.AudioPlaybackStatusChanged="audioPlaybackChanged",e.VideoPlaybackStatusChanged="videoPlaybackChanged",e.MediaDevicesError="mediaDevicesError",e.ParticipantPermissionsChanged="participantPermissionsChanged",e.SignalConnected="signalConnected",e.RecordingStatusChanged="recordingStatusChanged",e.ParticipantEncryptionStatusChanged="participantEncryptionStatusChanged",e.EncryptionError="encryptionError",e.DCBufferStatusChanged="dcBufferStatusChanged",e.ActiveDeviceChanged="activeDeviceChanged",e.ChatMessage="chatMessage",e.LocalTrackSubscribed="localTrackSubscribed",e.MetricsReceived="metricsReceived"}(xa||(xa={})),function(e){e.TrackPublished="trackPublished",e.TrackSubscribed="trackSubscribed",e.TrackSubscriptionFailed="trackSubscriptionFailed",e.TrackUnpublished="trackUnpublished",e.TrackUnsubscribed="trackUnsubscribed",e.TrackMuted="trackMuted",e.TrackUnmuted="trackUnmuted",e.LocalTrackPublished="localTrackPublished",e.LocalTrackUnpublished="localTrackUnpublished",e.LocalTrackCpuConstrained="localTrackCpuConstrained",e.LocalSenderCreated="localSenderCreated",e.ParticipantMetadataChanged="participantMetadataChanged",e.ParticipantNameChanged="participantNameChanged",e.DataReceived="dataReceived",e.SipDTMFReceived="sipDTMFReceived",e.TranscriptionReceived="transcriptionReceived",e.IsSpeakingChanged="isSpeakingChanged",e.ConnectionQualityChanged="connectionQualityChanged",e.TrackStreamStateChanged="trackStreamStateChanged",e.TrackSubscriptionPermissionChanged="trackSubscriptionPermissionChanged",e.TrackSubscriptionStatusChanged="trackSubscriptionStatusChanged",e.TrackCpuConstrained="trackCpuConstrained",e.MediaDevicesError="mediaDevicesError",e.AudioStreamAcquired="audioStreamAcquired",e.ParticipantPermissionsChanged="participantPermissionsChanged",e.PCTrackAdded="pcTrackAdded",e.AttributesChanged="attributesChanged",e.LocalTrackSubscribed="localTrackSubscribed",e.ChatMessage="chatMessage",e.Active="active"}(Ea||(Ea={})),function(e){e.TransportsCreated="transportsCreated",e.Connected="connected",e.Disconnected="disconnected",e.Resuming="resuming",e.Resumed="resumed",e.Restarting="restarting",e.Restarted="restarted",e.SignalResumed="signalResumed",e.SignalRestarted="signalRestarted",e.Closing="closing",e.MediaTrackAdded="mediaTrackAdded",e.ActiveSpeakersUpdate="activeSpeakersUpdate",e.DataPacketReceived="dataPacketReceived",e.RTPVideoMapUpdate="rtpVideoMapUpdate",e.DCBufferStatusChanged="dcBufferStatusChanged",e.ParticipantUpdate="participantUpdate",e.RoomUpdate="roomUpdate",e.SpeakersChanged="speakersChanged",e.StreamStateChanged="streamStateChanged",e.ConnectionQualityUpdate="connectionQualityUpdate",e.SubscriptionError="subscriptionError",e.SubscriptionPermissionUpdate="subscriptionPermissionUpdate",e.RemoteMute="remoteMute",e.SubscribedQualityUpdate="subscribedQualityUpdate",e.LocalTrackUnpublished="localTrackUnpublished",e.LocalTrackSubscribed="localTrackSubscribed",e.Offline="offline",e.SignalRequestResponse="signalRequestResponse",e.SignalConnected="signalConnected",e.RoomMoved="roomMoved"}(_a||(_a={})),function(e){e.Message="message",e.Muted="muted",e.Unmuted="unmuted",e.Restarted="restarted",e.Ended="ended",e.Subscribed="subscribed",e.Unsubscribed="unsubscribed",e.CpuConstrained="cpuConstrained",e.UpdateSettings="updateSettings",e.UpdateSubscription="updateSubscription",e.AudioPlaybackStarted="audioPlaybackStarted",e.AudioPlaybackFailed="audioPlaybackFailed",e.AudioSilenceDetected="audioSilenceDetected",e.VisibilityChanged="visibilityChanged",e.VideoDimensionsChanged="videoDimensionsChanged",e.VideoPlaybackStarted="videoPlaybackStarted",e.VideoPlaybackFailed="videoPlaybackFailed",e.ElementAttached="elementAttached",e.ElementDetached="elementDetached",e.UpstreamPaused="upstreamPaused",e.UpstreamResumed="upstreamResumed",e.SubscriptionPermissionChanged="subscriptionPermissionChanged",e.SubscriptionStatusChanged="subscriptionStatusChanged",e.SubscriptionFailed="subscriptionFailed",e.TrackProcessorUpdate="trackProcessorUpdate",e.AudioTrackFeatureUpdate="audioTrackFeatureUpdate",e.TranscriptionReceived="transcriptionReceived",e.TimeSyncUpdate="timeSyncUpdate",e.PreConnectBufferFlushed="preConnectBufferFlushed"}(Pa||(Pa={}));const Ba=/version\/(\d+(\.?_?\d+)+)/i;let Va;function qa(e){let t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];if(void 0===e&&"undefined"==typeof navigator)return;const n=(null!=e?e:navigator.userAgent).toLowerCase();if(void 0===Va||t){const e=Wa.find((e=>{let{test:t}=e;return t.test(n)}));Va=null==e?void 0:e.describe(n)}return Va}const Wa=[{test:/firefox|iceweasel|fxios/i,describe:e=>({name:"Firefox",version:Ha(/(?:firefox|iceweasel|fxios)[\s/](\d+(\.?_?\d+)+)/i,e),os:e.toLowerCase().includes("fxios")?"iOS":void 0,osVersion:za(e)})},{test:/chrom|crios|crmo/i,describe:e=>({name:"Chrome",version:Ha(/(?:chrome|chromium|crios|crmo)\/(\d+(\.?_?\d+)+)/i,e),os:e.toLowerCase().includes("crios")?"iOS":void 0,osVersion:za(e)})},{test:/safari|applewebkit/i,describe:e=>({name:"Safari",version:Ha(Ba,e),os:e.includes("mobile/")?"iOS":"macOS",osVersion:za(e)})}];function Ha(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1;const i=t.match(e);return i&&i.length>=n&&i[n]||""}function za(e){return e.includes("mac os")?Ha(/\(.+?(\d+_\d+(:?_\d+)?)/,e,1).replace(/_/g,"."):void 0}class Ga{}Ga.setTimeout=function(){return setTimeout(...arguments)},Ga.setInterval=function(){return setInterval(...arguments)},Ga.clearTimeout=function(){return clearTimeout(...arguments)},Ga.clearInterval=function(){return clearInterval(...arguments)};const Ka=[];var Ja;!function(e){e[e.LOW=0]="LOW",e[e.MEDIUM=1]="MEDIUM",e[e.HIGH=2]="HIGH"}(Ja||(Ja={}));class Ya extends lo.EventEmitter{get streamState(){return this._streamState}setStreamState(e){this._streamState=e}constructor(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};var i;super(),this.attachedElements=[],this.isMuted=!1,this._streamState=Ya.StreamState.Active,this.isInBackground=!1,this._currentBitrate=0,this.log=eo,this.appVisibilityChangedListener=()=>{this.backgroundTimeout&&clearTimeout(this.backgroundTimeout),"hidden"===document.visibilityState?this.backgroundTimeout=setTimeout((()=>this.handleAppVisibilityChanged()),5e3):this.handleAppVisibilityChanged()},this.log=to(null!==(i=n.loggerName)&&void 0!==i?i:$r.Track),this.loggerContextCb=n.loggerContextCb,this.setMaxListeners(100),this.kind=t,this._mediaStreamTrack=e,this._mediaStreamID=e.id,this.source=Ya.Source.Unknown}get logContext(){var e;return Object.assign(Object.assign({},null===(e=this.loggerContextCb)||void 0===e?void 0:e.call(this)),tc(this))}get currentBitrate(){return this._currentBitrate}get mediaStreamTrack(){return this._mediaStreamTrack}get mediaStreamID(){return this._mediaStreamID}attach(e){let t="audio";this.kind===Ya.Kind.Video&&(t="video"),0===this.attachedElements.length&&this.kind===Ya.Kind.Video&&this.addAppVisibilityListener(),e||("audio"===t&&(Ka.forEach((t=>{null!==t.parentElement||e||(e=t)})),e&&Ka.splice(Ka.indexOf(e),1)),e||(e=document.createElement(t))),this.attachedElements.includes(e)||this.attachedElements.push(e),Xa(this.mediaStreamTrack,e);const n=e.srcObject.getTracks(),i=n.some((e=>"audio"===e.kind));return e.play().then((()=>{this.emit(i?Pa.AudioPlaybackStarted:Pa.VideoPlaybackStarted)})).catch((t=>{"NotAllowedError"===t.name?this.emit(i?Pa.AudioPlaybackFailed:Pa.VideoPlaybackFailed,t):"AbortError"===t.name?eo.debug("".concat(i?"audio":"video"," playback aborted, likely due to new play request")):eo.warn("could not playback ".concat(i?"audio":"video"),t),i&&e&&n.some((e=>"video"===e.kind))&&"NotAllowedError"===t.name&&(e.muted=!0,e.play().catch((()=>{})))})),this.emit(Pa.ElementAttached,e),e}detach(e){try{if(e){$a(this.mediaStreamTrack,e);const t=this.attachedElements.indexOf(e);return t>=0&&(this.attachedElements.splice(t,1),this.recycleElement(e),this.emit(Pa.ElementDetached,e)),e}const t=[];return this.attachedElements.forEach((e=>{$a(this.mediaStreamTrack,e),t.push(e),this.recycleElement(e),this.emit(Pa.ElementDetached,e)})),this.attachedElements=[],t}finally{0===this.attachedElements.length&&this.removeAppVisibilityListener()}}stop(){this.stopMonitor(),this._mediaStreamTrack.stop()}enable(){this._mediaStreamTrack.enabled=!0}disable(){this._mediaStreamTrack.enabled=!1}stopMonitor(){this.monitorInterval&&clearInterval(this.monitorInterval),this.timeSyncHandle&&cancelAnimationFrame(this.timeSyncHandle)}updateLoggerOptions(e){e.loggerName&&(this.log=to(e.loggerName)),e.loggerContextCb&&(this.loggerContextCb=e.loggerContextCb)}recycleElement(e){if(e instanceof HTMLAudioElement){let t=!0;e.pause(),Ka.forEach((e=>{e.parentElement||(t=!1)})),t&&Ka.push(e)}}handleAppVisibilityChanged(){return oo(this,void 0,void 0,(function*(){this.isInBackground="hidden"===document.visibilityState,this.isInBackground||this.kind!==Ya.Kind.Video||setTimeout((()=>this.attachedElements.forEach((e=>e.play().catch((()=>{}))))),0)}))}addAppVisibilityListener(){vs()?(this.isInBackground="hidden"===document.visibilityState,document.addEventListener("visibilitychange",this.appVisibilityChangedListener)):this.isInBackground=!1}removeAppVisibilityListener(){vs()&&document.removeEventListener("visibilitychange",this.appVisibilityChangedListener)}}function Xa(e,t){let n,i;n=t.srcObject instanceof MediaStream?t.srcObject:new MediaStream,i="audio"===e.kind?n.getAudioTracks():n.getVideoTracks(),i.includes(e)||(i.forEach((e=>{n.removeTrack(e)})),n.addTrack(e)),ms()&&t instanceof HTMLVideoElement||(t.autoplay=!0),t.muted=0===n.getAudioTracks().length,t instanceof HTMLVideoElement&&(t.playsInline=!0),t.srcObject!==n&&(t.srcObject=n,(ms()||ps())&&t instanceof HTMLVideoElement&&setTimeout((()=>{t.srcObject=n,t.play().catch((()=>{}))}),0))}function $a(e,t){if(t.srcObject instanceof MediaStream){const n=t.srcObject;n.removeTrack(e),n.getTracks().length>0?t.srcObject=n:t.srcObject=null}}!function(e){let t,n,i;!function(e){e.Audio="audio",e.Video="video",e.Unknown="unknown"}(t=e.Kind||(e.Kind={})),function(e){e.Camera="camera",e.Microphone="microphone",e.ScreenShare="screen_share",e.ScreenShareAudio="screen_share_audio",e.Unknown="unknown"}(n=e.Source||(e.Source={})),function(e){e.Active="active",e.Paused="paused",e.Unknown="unknown"}(i=e.StreamState||(e.StreamState={})),e.kindToProto=function(e){switch(e){case t.Audio:return Gn.AUDIO;case t.Video:return Gn.VIDEO;default:return Gn.DATA}},e.kindFromProto=function(e){switch(e){case Gn.AUDIO:return t.Audio;case Gn.VIDEO:return t.Video;default:return t.Unknown}},e.sourceToProto=function(e){switch(e){case n.Camera:return Kn.CAMERA;case n.Microphone:return Kn.MICROPHONE;case n.ScreenShare:return Kn.SCREEN_SHARE;case n.ScreenShareAudio:return Kn.SCREEN_SHARE_AUDIO;default:return Kn.UNKNOWN}},e.sourceFromProto=function(e){switch(e){case Kn.CAMERA:return n.Camera;case Kn.MICROPHONE:return n.Microphone;case Kn.SCREEN_SHARE:return n.ScreenShare;case Kn.SCREEN_SHARE_AUDIO:return n.ScreenShareAudio;default:return n.Unknown}},e.streamStateFromProto=function(e){switch(e){case zi.ACTIVE:return i.Active;case zi.PAUSED:return i.Paused;default:return i.Unknown}}}(Ya||(Ya={}));class Qa{constructor(e,t,n,i,r){if("object"==typeof e)this.width=e.width,this.height=e.height,this.aspectRatio=e.aspectRatio,this.encoding={maxBitrate:e.maxBitrate,maxFramerate:e.maxFramerate,priority:e.priority};else{if(void 0===t||void 0===n)throw new TypeError("Unsupported options: provide at least width, height and maxBitrate");this.width=e,this.height=t,this.aspectRatio=e/t,this.encoding={maxBitrate:n,maxFramerate:i,priority:r}}}get resolution(){return{width:this.width,height:this.height,frameRate:this.encoding.maxFramerate,aspectRatio:this.aspectRatio}}}const Za=["vp8","h264"],es=["vp8","h264","vp9","av1","h265"],ts=function(e){return!!Za.find((t=>t===e))};var ns,is;!function(e){e[e.PREFER_REGRESSION=0]="PREFER_REGRESSION",e[e.SIMULCAST=1]="SIMULCAST",e[e.REGRESSION=2]="REGRESSION"}(ns||(ns={})),function(e){e.telephone={maxBitrate:12e3},e.speech={maxBitrate:24e3},e.music={maxBitrate:48e3},e.musicStereo={maxBitrate:64e3},e.musicHighQuality={maxBitrate:96e3},e.musicHighQualityStereo={maxBitrate:128e3}}(is||(is={}));const rs={h90:new Qa(160,90,9e4,20),h180:new Qa(320,180,16e4,20),h216:new Qa(384,216,18e4,20),h360:new Qa(640,360,45e4,20),h540:new Qa(960,540,8e5,25),h720:new Qa(1280,720,17e5,30),h1080:new Qa(1920,1080,3e6,30),h1440:new Qa(2560,1440,5e6,30),h2160:new Qa(3840,2160,8e6,30)},os={h120:new Qa(160,120,7e4,20),h180:new Qa(240,180,125e3,20),h240:new Qa(320,240,14e4,20),h360:new Qa(480,360,33e4,20),h480:new Qa(640,480,5e5,20),h540:new Qa(720,540,6e5,25),h720:new Qa(960,720,13e5,30),h1080:new Qa(1440,1080,23e5,30),h1440:new Qa(1920,1440,38e5,30)},as={h360fps3:new Qa(640,360,2e5,3,"medium"),h360fps15:new Qa(640,360,4e5,15,"medium"),h720fps5:new Qa(1280,720,8e5,5,"medium"),h720fps15:new Qa(1280,720,15e5,15,"medium"),h720fps30:new Qa(1280,720,2e6,30,"medium"),h1080fps15:new Qa(1920,1080,25e5,15,"medium"),h1080fps30:new Qa(1920,1080,5e6,30,"medium"),original:new Qa(0,0,7e6,30,"medium")},ss="https://aomediacodec.github.io/av1-rtp-spec/#dependency-descriptor-rtp-header-extension";function cs(e){return oo(this,void 0,void 0,(function*(){return new Promise((t=>Ga.setTimeout(t,e)))}))}function ls(){return"addTransceiver"in RTCPeerConnection.prototype}function ds(){return"addTrack"in RTCPeerConnection.prototype}function us(e){return"av1"===e||"vp9"===e}function hs(e){return!(!document||fs())&&(e||(e=document.createElement("audio")),"setSinkId"in e)}function ps(){var e;return"Firefox"===(null===(e=qa())||void 0===e?void 0:e.name)}function ms(){var e;return"Safari"===(null===(e=qa())||void 0===e?void 0:e.name)}function fs(){const e=qa();return"Safari"===(null==e?void 0:e.name)||"iOS"===(null==e?void 0:e.os)}function gs(){var e,t;return!!vs()&&(null!==(t=null===(e=navigator.userAgentData)||void 0===e?void 0:e.mobile)&&void 0!==t?t:/Tablet|iPad|Mobile|Android|BlackBerry/.test(navigator.userAgent))}function vs(){return"undefined"!=typeof document}function bs(){return"ReactNative"==navigator.product}function ys(e){return e.hostname.endsWith(".livekit.cloud")||e.hostname.endsWith(".livekit.run")}function ks(){if(global&&global.LiveKitReactNativeGlobal)return global.LiveKitReactNativeGlobal}function ws(){if(!bs())return;let e=ks();return e?e.platform:void 0}function Cs(){if(vs())return window.devicePixelRatio;if(bs()){let e=ks();if(e)return e.devicePixelRatio}return 1}function Ts(e,t){const n=e.split("."),i=t.split("."),r=Math.min(n.length,i.length);for(let e=0;e<r;++e){const t=parseInt(n[e],10),o=parseInt(i[e],10);if(t>o)return 1;if(t<o)return-1;if(e===r-1&&t===o)return 0}return""===e&&""!==t?-1:""===t?1:n.length==i.length?0:n.length<i.length?-1:1}function Ss(e){for(const t of e)t.target.handleResize(t)}function xs(e){for(const t of e)t.target.handleVisibilityChanged(t)}let Es=null;const _s=()=>(Es||(Es=new ResizeObserver(Ss)),Es);let Ps=null;const Rs=()=>(Ps||(Ps=new IntersectionObserver(xs,{root:null,rootMargin:"0px"})),Ps);let Is;function Os(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:16,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:16,n=arguments.length>2&&void 0!==arguments[2]&&arguments[2],i=arguments.length>3&&void 0!==arguments[3]&&arguments[3];const r=document.createElement("canvas");r.width=e,r.height=t;const o=r.getContext("2d");null==o||o.fillRect(0,0,r.width,r.height),i&&o&&(o.beginPath(),o.arc(e/2,t/2,50,0,2*Math.PI,!0),o.closePath(),o.fillStyle="grey",o.fill());const a=r.captureStream(),[s]=a.getTracks();if(!s)throw Error("Could not get empty media stream video track");return s.enabled=n,s}function Ds(){if(!Is){const e=new AudioContext,t=e.createOscillator(),n=e.createGain();n.gain.setValueAtTime(0,0);const i=e.createMediaStreamDestination();if(t.connect(n),n.connect(i),t.start(),[Is]=i.stream.getAudioTracks(),!Is)throw Error("Could not get empty media stream audio track");Is.enabled=!1}return Is.clone()}class Ms{get isResolved(){return this._isResolved}constructor(e,t){this._isResolved=!1,this.onFinally=t,this.promise=new Promise(((t,n)=>oo(this,void 0,void 0,(function*(){this.resolve=t,this.reject=n,e&&(yield e(t,n))})))).finally((()=>{var e;this._isResolved=!0,null===(e=this.onFinally)||void 0===e||e.call(this)}))}}function As(e){if("string"==typeof e||"number"==typeof e)return e;if(Array.isArray(e))return e[0];if(void 0!==e.exact)return Array.isArray(e.exact)?e.exact[0]:e.exact;if(void 0!==e.ideal)return Array.isArray(e.ideal)?e.ideal[0]:e.ideal;throw Error("could not unwrap constraint")}function Ns(e){return e.startsWith("ws")?e.replace(/^(ws)/,"http"):e}function Ls(e){switch(e.reason){case wa.LeaveRequest:return e.context;case wa.Cancelled:return $n.CLIENT_INITIATED;case wa.NotAllowed:return $n.USER_REJECTED;case wa.ServerUnreachable:return $n.JOIN_FAILURE;default:return $n.UNKNOWN_REASON}}function js(e){return void 0!==e?Number(e):void 0}function Us(e){return void 0!==e?BigInt(e):void 0}function Fs(e){return!!e&&!(e instanceof MediaStreamTrack)&&e.isLocal}function Bs(e){return!!e&&e.kind==Ya.Kind.Audio}function Vs(e){return!!e&&e.kind==Ya.Kind.Video}function qs(e){return Fs(e)&&Vs(e)}function Ws(e){return Fs(e)&&Bs(e)}function Hs(e){return!!e&&!e.isLocal}function zs(e){return!!e&&!e.isLocal}function Gs(e){return Hs(e)&&Vs(e)}function Ks(e,t,n){var i,r,o,a;const{optionsWithoutProcessor:s,audioProcessor:c,videoProcessor:l}=nc(null!=e?e:{}),d=null==t?void 0:t.processor,u=null==n?void 0:n.processor,h=null!=s?s:{};return!0===h.audio&&(h.audio={}),!0===h.video&&(h.video={}),h.audio&&(Js(h.audio,t),null!==(i=(o=h.audio).deviceId)&&void 0!==i||(o.deviceId={ideal:"default"}),(c||d)&&(h.audio.processor=null!=c?c:d)),h.video&&(Js(h.video,n),null!==(r=(a=h.video).deviceId)&&void 0!==r||(a.deviceId={ideal:"default"}),(l||u)&&(h.video.processor=null!=l?l:u)),h}function Js(e,t){return Object.keys(t).forEach((n=>{void 0===e[n]&&(e[n]=t[n])})),e}function Ys(e){var t,n,i,r;const o={};if(e.video)if("object"==typeof e.video){const n={},r=n,a=e.video;Object.keys(a).forEach((e=>{"resolution"===e?Js(r,a.resolution):r[e]=a[e]})),o.video=n,null!==(t=(i=o.video).deviceId)&&void 0!==t||(i.deviceId={ideal:"default"})}else o.video=!!e.video&&{deviceId:{ideal:"default"}};else o.video=!1;return e.audio?"object"==typeof e.audio?(o.audio=e.audio,null!==(n=(r=o.audio).deviceId)&&void 0!==n||(r.deviceId={ideal:"default"})):o.audio={deviceId:{ideal:"default"}}:o.audio=!1,o}function Xs(){var e;const t="undefined"!=typeof window&&(window.AudioContext||window.webkitAudioContext);if(t){const n=new t({latencyHint:"interactive"});if("suspended"===n.state&&"undefined"!=typeof window&&(null===(e=window.document)||void 0===e?void 0:e.body)){const e=()=>oo(this,void 0,void 0,(function*(){var t;try{"suspended"===n.state&&(yield n.resume())}catch(e){console.warn("Error trying to auto-resume audio context",e)}finally{null===(t=window.document.body)||void 0===t||t.removeEventListener("click",e)}}));n.addEventListener("statechange",(()=>{var t;"closed"===n.state&&(null===(t=window.document.body)||void 0===t||t.removeEventListener("click",e))})),window.document.body.addEventListener("click",e)}return n}}function $s(e){return"audioinput"===e?Ya.Source.Microphone:"videoinput"===e?Ya.Source.Camera:Ya.Source.Unknown}function Qs(e){return e===Ya.Source.Microphone?"audioinput":e===Ya.Source.Camera?"videoinput":void 0}function Zs(e){return e.split("/")[1].toLowerCase()}function ec(e){const t=[];return e.forEach((e=>{void 0!==e.track&&t.push(new tr({cid:e.track.mediaStreamID,track:e.trackInfo}))})),t}function tc(e){return"mediaStreamTrack"in e?{trackID:e.sid,source:e.source,muted:e.isMuted,enabled:e.mediaStreamTrack.enabled,kind:e.kind,streamID:e.mediaStreamID,streamTrackID:e.mediaStreamTrack.id}:{trackID:e.trackSid,enabled:e.isEnabled,muted:e.isMuted,trackInfo:Object.assign({mimeType:e.mimeType,name:e.trackName,encrypted:e.isEncrypted,kind:e.kind,source:e.source},e.track?tc(e.track):{})}}function nc(e){const t=Object.assign({},e);let n,i;return"object"==typeof t.audio&&t.audio.processor&&(n=t.audio.processor,t.audio=Object.assign(Object.assign({},t.audio),{processor:void 0})),"object"==typeof t.video&&t.video.processor&&(i=t.video.processor,t.video=Object.assign(Object.assign({},t.video),{processor:void 0})),{audioProcessor:n,videoProcessor:i,optionsWithoutProcessor:(r=t,void 0===r?r:"function"==typeof structuredClone?"object"==typeof r&&null!==r?structuredClone(Object.assign({},r)):structuredClone(r):JSON.parse(JSON.stringify(r)))};var r}function ic(e,t){return e.width*e.height<t.width*t.height}class rc extends lo.EventEmitter{constructor(e,t){super(),this.decryptDataRequests=new Map,this.encryptDataRequests=new Map,this.onWorkerMessage=e=>{var t,n;const{kind:i,data:r}=e.data;switch(i){case"error":eo.error(r.error.message),this.emit(ya.EncryptionError,r.error);break;case"initAck":r.enabled&&this.keyProvider.getKeys().forEach((e=>{this.postKey(e)}));break;case"enable":if(r.enabled&&this.keyProvider.getKeys().forEach((e=>{this.postKey(e)})),this.encryptionEnabled!==r.enabled&&r.participantIdentity===(null===(t=this.room)||void 0===t?void 0:t.localParticipant.identity))this.emit(ya.ParticipantEncryptionStatusChanged,r.enabled,this.room.localParticipant),this.encryptionEnabled=r.enabled;else if(r.participantIdentity){const e=null===(n=this.room)||void 0===n?void 0:n.getParticipantByIdentity(r.participantIdentity);if(!e)throw TypeError("couldn't set encryption status, participant not found".concat(r.participantIdentity));this.emit(ya.ParticipantEncryptionStatusChanged,r.enabled,e)}break;case"ratchetKey":this.keyProvider.emit(va.KeyRatcheted,r.ratchetResult,r.participantIdentity,r.keyIndex);break;case"decryptDataResponse":const e=this.decryptDataRequests.get(r.uuid);(null==e?void 0:e.resolve)&&e.resolve(r);break;case"encryptDataResponse":const i=this.encryptDataRequests.get(r.uuid);(null==i?void 0:i.resolve)&&i.resolve(r)}},this.onWorkerError=e=>{eo.error("e2ee worker encountered an error:",{error:e.error}),this.emit(ya.EncryptionError,e.error)},this.keyProvider=e.keyProvider,this.worker=e.worker,this.encryptionEnabled=!1,this.dataChannelEncryptionEnabled=t}get isEnabled(){return this.encryptionEnabled}get isDataChannelEncryptionEnabled(){return this.isEnabled&&this.dataChannelEncryptionEnabled}setup(e){if(!(void 0!==window.RTCRtpSender&&void 0!==window.RTCRtpSender.prototype.createEncodedStreams||Ra()))throw new Da("tried to setup end-to-end encryption on an unsupported browser");if(eo.info("setting up e2ee"),e!==this.room){this.room=e,this.setupEventListeners(e,this.keyProvider);const t={kind:"init",data:{keyProviderOptions:this.keyProvider.getOptions(),loglevel:no.getLevel()}};this.worker&&(eo.info("initializing worker",{worker:this.worker}),this.worker.onmessage=this.onWorkerMessage,this.worker.onerror=this.onWorkerError,this.worker.postMessage(t))}}setParticipantCryptorEnabled(e,t){eo.debug("set e2ee to ".concat(e," for participant ").concat(t)),this.postEnable(e,t)}setSifTrailer(e){e&&0!==e.length?this.postSifTrailer(e):eo.warn("ignoring server sent trailer as it's empty")}setupEngine(e){e.on(_a.RTPVideoMapUpdate,(e=>{this.postRTPMap(e)}))}setupEventListeners(e,t){e.on(xa.TrackPublished,((e,t)=>this.setParticipantCryptorEnabled(e.trackInfo.encryption!==ci.NONE,t.identity))),e.on(xa.ConnectionStateChanged,(t=>{t===Tl.Connected&&e.remoteParticipants.forEach((e=>{e.trackPublications.forEach((t=>{this.setParticipantCryptorEnabled(t.trackInfo.encryption!==ci.NONE,e.identity)}))}))})).on(xa.TrackUnsubscribed,((e,t,n)=>{var i;const r={kind:"removeTransform",data:{participantIdentity:n.identity,trackId:e.mediaStreamID}};null===(i=this.worker)||void 0===i||i.postMessage(r)})).on(xa.TrackSubscribed,((e,t,n)=>{this.setupE2EEReceiver(e,n.identity,t.trackInfo)})).on(xa.SignalConnected,(()=>{if(!this.room)throw new TypeError("expected room to be present on signal connect");t.getKeys().forEach((e=>{this.postKey(e)})),this.setParticipantCryptorEnabled(this.room.localParticipant.isE2EEEnabled,this.room.localParticipant.identity)})),e.localParticipant.on(Ea.LocalSenderCreated,((e,t)=>oo(this,void 0,void 0,(function*(){this.setupE2EESender(t,e)})))),e.localParticipant.on(Ea.LocalTrackPublished,(e=>{if(!Vs(e.track)||!fs())return;const t={kind:"updateCodec",data:{trackId:e.track.mediaStreamID,codec:Zs(e.trackInfo.codecs[0].mimeType),participantIdentity:this.room.localParticipant.identity}};this.worker.postMessage(t)})),t.on(va.SetKey,(e=>this.postKey(e))).on(va.RatchetRequest,((e,t)=>this.postRatchetRequest(e,t)))}encryptData(e){return oo(this,void 0,void 0,(function*(){if(!this.worker)throw Error("could not encrypt data, worker is missing");const t=crypto.randomUUID(),n={kind:"encryptDataRequest",data:{uuid:t,payload:e,participantIdentity:this.room.localParticipant.identity}},i=new Ms;return i.onFinally=()=>{this.encryptDataRequests.delete(t)},this.encryptDataRequests.set(t,i),this.worker.postMessage(n),i.promise}))}handleEncryptedData(e,t,n,i){if(!this.worker)throw Error("could not handle encrypted data, worker is missing");const r=crypto.randomUUID(),o={kind:"decryptDataRequest",data:{uuid:r,payload:e,iv:t,participantIdentity:n,keyIndex:i}},a=new Ms;return a.onFinally=()=>{this.decryptDataRequests.delete(r)},this.decryptDataRequests.set(r,a),this.worker.postMessage(o),a.promise}postRatchetRequest(e,t){if(!this.worker)throw Error("could not ratchet key, worker is missing");const n={kind:"ratchetRequest",data:{participantIdentity:e,keyIndex:t}};this.worker.postMessage(n)}postKey(e){let{key:t,participantIdentity:n,keyIndex:i}=e;var r;if(!this.worker)throw Error("could not set key, worker is missing");const o={kind:"setKey",data:{participantIdentity:n,isPublisher:n===(null===(r=this.room)||void 0===r?void 0:r.localParticipant.identity),key:t,keyIndex:i}};this.worker.postMessage(o)}postEnable(e,t){if(!this.worker)throw new ReferenceError("failed to enable e2ee, worker is not ready");{const n={kind:"enable",data:{enabled:e,participantIdentity:t}};this.worker.postMessage(n)}}postRTPMap(e){var t;if(!this.worker)throw TypeError("could not post rtp map, worker is missing");if(!(null===(t=this.room)||void 0===t?void 0:t.localParticipant.identity))throw TypeError("could not post rtp map, local participant identity is missing");const n={kind:"setRTPMap",data:{map:e,participantIdentity:this.room.localParticipant.identity}};this.worker.postMessage(n)}postSifTrailer(e){if(!this.worker)throw Error("could not post SIF trailer, worker is missing");const t={kind:"setSifTrailer",data:{trailer:e}};this.worker.postMessage(t)}setupE2EEReceiver(e,t,n){if(e.receiver){if(!(null==n?void 0:n.mimeType)||""===n.mimeType)throw new TypeError("MimeType missing from trackInfo, cannot set up E2EE cryptor");this.handleReceiver(e.receiver,e.mediaStreamID,t,"video"===e.kind?Zs(n.mimeType):void 0)}}setupE2EESender(e,t){Fs(e)&&t?this.handleSender(t,e.mediaStreamID,void 0):t||eo.warn("early return because sender is not ready")}handleReceiver(e,t,n,i){return oo(this,void 0,void 0,(function*(){if(this.worker){if(Ra()){const r={kind:"decode",participantIdentity:n,trackId:t,codec:i};e.transform=new RTCRtpScriptTransform(this.worker,r)}else{if(ga in e&&i){const e={kind:"updateCodec",data:{trackId:t,codec:i,participantIdentity:n}};return void this.worker.postMessage(e)}let r=e.writableStream,o=e.readableStream;if(!r||!o){const t=e.createEncodedStreams();e.writableStream=t.writable,r=t.writable,e.readableStream=t.readable,o=t.readable}const a={kind:"decode",data:{readableStream:o,writableStream:r,trackId:t,codec:i,participantIdentity:n,isReuse:ga in e}};this.worker.postMessage(a,[o,r])}e[ga]=!0}}))}handleSender(e,t,n){var i;if(!(ga in e)&&this.worker){if(!(null===(i=this.room)||void 0===i?void 0:i.localParticipant.identity)||""===this.room.localParticipant.identity)throw TypeError("local identity needs to be known in order to set up encrypted sender");if(Ra()){eo.info("initialize script transform");const i={kind:"encode",participantIdentity:this.room.localParticipant.identity,trackId:t,codec:n};e.transform=new RTCRtpScriptTransform(this.worker,i)}else{eo.info("initialize encoded streams");const i=e.createEncodedStreams(),r={kind:"encode",data:{readableStream:i.readable,writableStream:i.writable,codec:n,trackId:t,participantIdentity:this.room.localParticipant.identity,isReuse:!1}};this.worker.postMessage(r,[i.readable,i.writable])}e[ga]=!0}}}const oc="default";class ac{constructor(){this._previousDevices=[]}static getInstance(){return void 0===this.instance&&(this.instance=new ac),this.instance}get previousDevices(){return this._previousDevices}getDevices(e){return oo(this,arguments,void 0,(function(e){var t=this;let n=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];return function*(){var i;if((null===(i=ac.userMediaPromiseMap)||void 0===i?void 0:i.size)>0){eo.debug("awaiting getUserMedia promise");try{e?yield ac.userMediaPromiseMap.get(e):yield Promise.all(ac.userMediaPromiseMap.values())}catch(e){eo.warn("error waiting for media permissons")}}let r=yield navigator.mediaDevices.enumerateDevices();if(n&&(!ms()||!t.hasDeviceInUse(e))){const t=0===r.filter((t=>t.kind===e)).length||r.some((t=>{const n=""===t.label,i=!e||t.kind===e;return n&&i}));if(t){const t={video:"audioinput"!==e&&"audiooutput"!==e,audio:"videoinput"!==e&&{deviceId:{ideal:"default"}}},n=yield navigator.mediaDevices.getUserMedia(t);r=yield navigator.mediaDevices.enumerateDevices(),n.getTracks().forEach((e=>{e.stop()}))}}return t._previousDevices=r,e&&(r=r.filter((t=>t.kind===e))),r}()}))}normalizeDeviceId(e,t,n){return oo(this,void 0,void 0,(function*(){if(t!==oc)return t;const i=yield this.getDevices(e),r=i.find((e=>e.deviceId===oc));if(!r)return void eo.warn("could not reliably determine default device");const o=i.find((e=>e.deviceId!==oc&&e.groupId===(null!=n?n:r.groupId)));if(o)return null==o?void 0:o.deviceId;eo.warn("could not reliably determine default device")}))}hasDeviceInUse(e){return e?ac.userMediaPromiseMap.has(e):ac.userMediaPromiseMap.size>0}}var sc;ac.mediaDeviceKinds=["audioinput","audiooutput","videoinput"],ac.userMediaPromiseMap=new Map,function(e){e[e.WAITING=0]="WAITING",e[e.RUNNING=1]="RUNNING",e[e.COMPLETED=2]="COMPLETED"}(sc||(sc={}));class cc{constructor(){this.pendingTasks=new Map,this.taskMutex=new ht,this.nextTaskIndex=0}run(e){return oo(this,void 0,void 0,(function*(){const t={id:this.nextTaskIndex++,enqueuedAt:Date.now(),status:sc.WAITING};this.pendingTasks.set(t.id,t);const n=yield this.taskMutex.lock();try{return t.executedAt=Date.now(),t.status=sc.RUNNING,yield e()}finally{t.status=sc.COMPLETED,this.pendingTasks.delete(t.id),n()}}))}flush(){return oo(this,void 0,void 0,(function*(){return this.run((()=>oo(this,void 0,void 0,(function*(){}))))}))}snapshot(){return Array.from(this.pendingTasks.values())}}class lc{get readyState(){return this.ws.readyState}constructor(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};var n,i;if(null===(n=t.signal)||void 0===n?void 0:n.aborted)throw new DOMException("This operation was aborted","AbortError");this.url=e;const r=new WebSocket(e,null!==(i=t.protocols)&&void 0!==i?i:[]);r.binaryType="arraybuffer",this.ws=r;const o=function(){let{closeCode:e,reason:t}=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return r.close(e,t)};this.opened=new Promise(((e,t)=>{r.onopen=()=>{e({readable:new ReadableStream({start(e){r.onmessage=t=>{let{data:n}=t;return e.enqueue(n)},r.onerror=t=>e.error(t)},cancel:o}),writable:new WritableStream({write(e){r.send(e)},abort(){r.close()},close:o}),protocol:r.protocol,extensions:r.extensions}),r.removeEventListener("error",t)},r.addEventListener("error",t)})),this.closed=new Promise(((e,t)=>{const n=()=>oo(this,void 0,void 0,(function*(){const n=new Promise((e=>{r.readyState!==WebSocket.CLOSED&&r.addEventListener("close",(t=>{e(t)}),{once:!0})})),i=yield Promise.race([cs(250),n]);i?e(i):t(new Error("Encountered unspecified websocket error without a timely close event"))}));r.onclose=t=>{let{code:i,reason:o}=t;e({closeCode:i,reason:o}),r.removeEventListener("error",n)},r.addEventListener("error",n)})),t.signal&&(t.signal.onabort=()=>r.close()),this.close=o}}function dc(e,t){return e.pathname="".concat(function(e){return e.endsWith("/")?e:"".concat(e,"/")}(e.pathname)).concat(t),e.toString()}function uc(e){if("string"==typeof e)return Ji.fromJson(JSON.parse(e),{ignoreUnknownFields:!0});if(e instanceof ArrayBuffer)return Ji.fromBinary(new Uint8Array(e));throw new Error("could not decode websocket message: ".concat(typeof e))}const hc=["syncState","trickle","offer","answer","simulate","leave"];var pc;!function(e){e[e.CONNECTING=0]="CONNECTING",e[e.CONNECTED=1]="CONNECTED",e[e.RECONNECTING=2]="RECONNECTING",e[e.DISCONNECTING=3]="DISCONNECTING",e[e.DISCONNECTED=4]="DISCONNECTED"}(pc||(pc={}));class mc{get currentState(){return this.state}get isDisconnected(){return this.state===pc.DISCONNECTING||this.state===pc.DISCONNECTED}get isEstablishingConnection(){return this.state===pc.CONNECTING||this.state===pc.RECONNECTING}getNextRequestId(){return this._requestId+=1,this._requestId}constructor(){let e=arguments.length>0&&void 0!==arguments[0]&&arguments[0],t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};var n;this.rtt=0,this.state=pc.DISCONNECTED,this.log=eo,this._requestId=0,this.resetCallbacks=()=>{this.onAnswer=void 0,this.onLeave=void 0,this.onLocalTrackPublished=void 0,this.onLocalTrackUnpublished=void 0,this.onNegotiateRequested=void 0,this.onOffer=void 0,this.onRemoteMuteChanged=void 0,this.onSubscribedQualityUpdate=void 0,this.onTokenRefresh=void 0,this.onTrickle=void 0,this.onClose=void 0,this.onMediaSectionsRequirement=void 0},this.log=to(null!==(n=t.loggerName)&&void 0!==n?n:$r.Signal),this.loggerContextCb=t.loggerContextCb,this.useJSON=e,this.requestQueue=new cc,this.queuedRequests=[],this.closingLock=new ht,this.connectionLock=new ht,this.state=pc.DISCONNECTED}get logContext(){var e,t;return null!==(t=null===(e=this.loggerContextCb)||void 0===e?void 0:e.call(this))&&void 0!==t?t:{}}join(e,t,n,i){return oo(this,void 0,void 0,(function*(){return this.state=pc.CONNECTING,this.options=n,yield this.connect(e,t,n,i)}))}reconnect(e,t,n,i){return oo(this,void 0,void 0,(function*(){if(this.options)return this.state=pc.RECONNECTING,this.clearPingInterval(),yield this.connect(e,t,Object.assign(Object.assign({},this.options),{reconnect:!0,sid:n,reconnectReason:i}));this.log.warn("attempted to reconnect without signal options being set, ignoring",this.logContext)}))}connect(e,t,n,i){return oo(this,void 0,void 0,(function*(){const r=yield this.connectionLock.lock();this.connectOptions=n;const o=function(){var e;const t=new Oi({sdk:Di.JS,protocol:16,version:"2.15.11"});return bs()&&(t.os=null!==(e=ws())&&void 0!==e?e:""),t}(),a=n.singlePeerConnection?function(e,t,n){const i=new URLSearchParams;i.set("access_token",e);const r=new Vr({clientInfo:t,connectionSettings:new Br({autoSubscribe:!!n.autoSubscribe,adaptiveStream:!!n.adaptiveStream}),reconnect:!!n.reconnect,participantSid:n.sid?n.sid:void 0});n.reconnectReason&&(r.reconnectReason=n.reconnectReason);const o=new qr({joinRequest:r.toBinary()});return i.set("join_request",btoa(new TextDecoder("utf-8").decode(o.toBinary()))),i}(t,o,n):function(e,t,n){var i;const r=new URLSearchParams;return r.set("access_token",e),n.reconnect&&(r.set("reconnect","1"),n.sid&&r.set("sid",n.sid)),r.set("auto_subscribe",n.autoSubscribe?"1":"0"),r.set("sdk",bs()?"reactnative":"js"),r.set("version",t.version),r.set("protocol",t.protocol.toString()),t.deviceModel&&r.set("device_model",t.deviceModel),t.os&&r.set("os",t.os),t.osVersion&&r.set("os_version",t.osVersion),t.browser&&r.set("browser",t.browser),t.browserVersion&&r.set("browser_version",t.browserVersion),n.adaptiveStream&&r.set("adaptive_stream","1"),n.reconnectReason&&r.set("reconnect_reason",n.reconnectReason.toString()),(null===(i=navigator.connection)||void 0===i?void 0:i.type)&&r.set("network",navigator.connection.type),r}(t,o,n),s=function(e,t){const n=new URL(function(e){return e.startsWith("http")?e.replace(/^(http)/,"ws"):e}(e));return t.forEach(((e,t)=>{n.searchParams.set(t,e)})),dc(n,"rtc")}(e,a),c=dc(new URL(Ns(s)),"validate");return new Promise(((e,t)=>oo(this,void 0,void 0,(function*(){var o,a;try{const r=new AbortController,l=i?[r.signal,i]:[r.signal],d=AbortSignal.any(l),u=e=>oo(this,void 0,void 0,(function*(){const n=e.currentTarget,i=function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"Unknown reason";if(!(e instanceof AbortSignal))return t;const n=e.reason;switch(typeof n){case"string":return n;case"object":return n instanceof Error?n.message:t;default:return"toString"in n?n.toString():t}}(n,"Abort handler called");this.streamWriter&&!this.isDisconnected?this.sendLeave().then((()=>this.close(i))).catch((e=>{this.log.error(e),this.close()})):this.close(),clearTimeout(h),t(n instanceof AbortSignal?n.reason:n)}));d.addEventListener("abort",u);const h=setTimeout((()=>{r.abort(new Oa("room connection has timed out (signal)",wa.ServerUnreachable))}),n.websocketTimeout),p=(e,t)=>{this.handleSignalConnected(e,h,t)},m=new URL(s);m.searchParams.has("access_token")&&m.searchParams.set("access_token","<redacted>"),this.log.debug("connecting to ".concat(m),Object.assign({reconnect:n.reconnect,reconnectReason:n.reconnectReason},this.logContext)),this.ws&&(yield this.close(!1)),this.ws=new lc(s);try{this.ws.closed.then((e=>{this.isEstablishingConnection&&t(new Oa("Websocket got closed during a (re)connection attempt: ".concat(e.reason),wa.InternalError)),1e3!==e.closeCode&&this.log.warn("websocket closed",Object.assign(Object.assign({},this.logContext),{reason:e.reason,code:e.closeCode,wasClean:1e3===e.closeCode,state:this.state}))})).catch((e=>{this.isEstablishingConnection&&t(new Oa("Websocket error during a (re)connection attempt: ".concat(e),wa.InternalError))}));const i=yield this.ws.opened.catch((e=>oo(this,void 0,void 0,(function*(){if(this.state===pc.CONNECTED)this.handleWSError(e),t(e);else{this.state=pc.DISCONNECTED,clearTimeout(h);const n=yield this.handleConnectionError(e,c);t(n)}}))));if(clearTimeout(h),!i)return;const r=i.readable.getReader();this.streamWriter=i.writable.getWriter();const s=yield r.read();if(r.releaseLock(),!s.value)throw new Oa("no message received as first message",wa.InternalError);const l=uc(s.value),d=this.validateFirstMessage(l,null!==(o=n.reconnect)&&void 0!==o&&o);if(!d.isValid)return void t(d.error);"join"===(null===(a=l.message)||void 0===a?void 0:a.case)&&(this.pingTimeoutDuration=l.message.value.pingTimeout,this.pingIntervalDuration=l.message.value.pingInterval,this.pingTimeoutDuration&&this.pingTimeoutDuration>0&&this.log.debug("ping config",Object.assign(Object.assign({},this.logContext),{timeout:this.pingTimeoutDuration,interval:this.pingIntervalDuration}))),p(i,d.shouldProcessFirstMessage?l:void 0),e(d.response)}catch(e){clearTimeout(h),t(e)}}finally{r()}}))))}))}startReadingLoop(e,t){return oo(this,void 0,void 0,(function*(){for(t&&this.handleSignalResponse(t);;){this.signalLatency&&(yield cs(this.signalLatency));const{done:t,value:n}=yield e.read();if(t)break;const i=uc(n);this.handleSignalResponse(i)}}))}close(){return oo(this,arguments,void 0,(function(){var e=this;let t=!(arguments.length>0&&void 0!==arguments[0])||arguments[0],n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"Close method called on signal client";return function*(){const i=yield e.closingLock.lock();try{if(e.clearPingInterval(),t&&(e.state=pc.DISCONNECTING),e.ws){e.ws.close({closeCode:1e3,reason:n});const t=e.ws.closed;e.ws=void 0,e.streamWriter=void 0,yield Promise.race([t,cs(250)])}}catch(t){e.log.debug("websocket error while closing",Object.assign(Object.assign({},e.logContext),{error:t}))}finally{t&&(e.state=pc.DISCONNECTED),i()}}()}))}sendOffer(e,t){this.log.debug("sending offer",Object.assign(Object.assign({},this.logContext),{offerSdp:e.sdp})),this.sendRequest({case:"offer",value:gc(e,t)})}sendAnswer(e,t){return this.log.debug("sending answer",Object.assign(Object.assign({},this.logContext),{answerSdp:e.sdp})),this.sendRequest({case:"answer",value:gc(e,t)})}sendIceCandidate(e,t){return this.log.debug("sending ice candidate",Object.assign(Object.assign({},this.logContext),{candidate:e})),this.sendRequest({case:"trickle",value:new $i({candidateInit:JSON.stringify(e),target:t})})}sendMuteTrack(e,t){return this.sendRequest({case:"mute",value:new Qi({sid:e,muted:t})})}sendAddTrack(e){return this.sendRequest({case:"addTrack",value:e})}sendUpdateLocalMetadata(e,t){return oo(this,arguments,void 0,(function(e,t){var n=this;let i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};return function*(){const r=n.getNextRequestId();return yield n.sendRequest({case:"updateMetadata",value:new hr({requestId:r,metadata:e,name:t,attributes:i})}),r}()}))}sendUpdateTrackSettings(e){this.sendRequest({case:"trackSetting",value:e})}sendUpdateSubscription(e){return this.sendRequest({case:"subscription",value:e})}sendSyncState(e){return this.sendRequest({case:"syncState",value:e})}sendUpdateVideoLayers(e,t){return this.sendRequest({case:"updateLayers",value:new ur({trackSid:e,layers:t})})}sendUpdateSubscriptionPermissions(e,t){return this.sendRequest({case:"subscriptionPermission",value:new xr({allParticipants:e,trackPermissions:t})})}sendSimulateScenario(e){return this.sendRequest({case:"simulate",value:e})}sendPing(){return Promise.all([this.sendRequest({case:"ping",value:Dt.parse(Date.now())}),this.sendRequest({case:"pingReq",value:new Dr({timestamp:Dt.parse(Date.now()),rtt:Dt.parse(this.rtt)})})])}sendUpdateLocalAudioTrack(e,t){return this.sendRequest({case:"updateAudioTrack",value:new sr({trackSid:e,features:t})})}sendLeave(){return this.sendRequest({case:"leave",value:new lr({reason:$n.CLIENT_INITIATED,action:dr.DISCONNECT})})}sendRequest(e){return oo(this,arguments,void 0,(function(e){var t=this;let n=arguments.length>1&&void 0!==arguments[1]&&arguments[1];return function*(){const i=!n&&!function(e){const t=hc.indexOf(e.case)>=0;return eo.trace("request allowed to bypass queue:",{canPass:t,req:e}),t}(e);if(i&&t.state===pc.RECONNECTING)return void t.queuedRequests.push((()=>oo(t,void 0,void 0,(function*(){yield this.sendRequest(e,!0)}))));if(n||(yield t.requestQueue.flush()),t.signalLatency&&(yield cs(t.signalLatency)),t.isDisconnected)return void t.log.debug("skipping signal request (type: ".concat(e.case,") - SignalClient disconnected"));if(!t.streamWriter)return void t.log.error("cannot send signal request before connected, type: ".concat(null==e?void 0:e.case),t.logContext);const r=new Ki({message:e});try{t.useJSON?yield t.streamWriter.write(r.toJsonString()):yield t.streamWriter.write(r.toBinary())}catch(e){t.log.error("error sending signal message",Object.assign(Object.assign({},t.logContext),{error:e}))}}()}))}handleSignalResponse(e){var t,n;const i=e.message;if(null==i)return void this.log.debug("received unsupported message",this.logContext);let r=!1;if("answer"===i.case){const e=fc(i.value);this.onAnswer&&this.onAnswer(e,i.value.id,i.value.midToTrackId)}else if("offer"===i.case){const e=fc(i.value);this.onOffer&&this.onOffer(e,i.value.id,i.value.midToTrackId)}else if("trickle"===i.case){const e=JSON.parse(i.value.candidateInit);this.onTrickle&&this.onTrickle(e,i.value.target)}else"update"===i.case?this.onParticipantUpdate&&this.onParticipantUpdate(null!==(t=i.value.participants)&&void 0!==t?t:[]):"trackPublished"===i.case?this.onLocalTrackPublished&&this.onLocalTrackPublished(i.value):"speakersChanged"===i.case?this.onSpeakersChanged&&this.onSpeakersChanged(null!==(n=i.value.speakers)&&void 0!==n?n:[]):"leave"===i.case?this.onLeave&&this.onLeave(i.value):"mute"===i.case?this.onRemoteMuteChanged&&this.onRemoteMuteChanged(i.value.sid,i.value.muted):"roomUpdate"===i.case?this.onRoomUpdate&&i.value.room&&this.onRoomUpdate(i.value.room):"connectionQuality"===i.case?this.onConnectionQuality&&this.onConnectionQuality(i.value):"streamStateUpdate"===i.case?this.onStreamStateUpdate&&this.onStreamStateUpdate(i.value):"subscribedQualityUpdate"===i.case?this.onSubscribedQualityUpdate&&this.onSubscribedQualityUpdate(i.value):"subscriptionPermissionUpdate"===i.case?this.onSubscriptionPermissionUpdate&&this.onSubscriptionPermissionUpdate(i.value):"refreshToken"===i.case?this.onTokenRefresh&&this.onTokenRefresh(i.value):"trackUnpublished"===i.case?this.onLocalTrackUnpublished&&this.onLocalTrackUnpublished(i.value):"subscriptionResponse"===i.case?this.onSubscriptionError&&this.onSubscriptionError(i.value):"pong"===i.case||("pongResp"===i.case?(this.rtt=Date.now()-Number.parseInt(i.value.lastPingTimestamp.toString()),this.resetPingTimeout(),r=!0):"requestResponse"===i.case?this.onRequestResponse&&this.onRequestResponse(i.value):"trackSubscribed"===i.case?this.onLocalTrackSubscribed&&this.onLocalTrackSubscribed(i.value.trackSid):"roomMoved"===i.case?(this.onTokenRefresh&&this.onTokenRefresh(i.value.token),this.onRoomMoved&&this.onRoomMoved(i.value)):"mediaSectionsRequirement"===i.case?this.onMediaSectionsRequirement&&this.onMediaSectionsRequirement(i.value):this.log.debug("unsupported message",Object.assign(Object.assign({},this.logContext),{msgCase:i.case})));r||this.resetPingTimeout()}setReconnected(){for(;this.queuedRequests.length>0;){const e=this.queuedRequests.shift();e&&this.requestQueue.run(e)}}handleOnClose(e){return oo(this,void 0,void 0,(function*(){if(this.state===pc.DISCONNECTED)return;const t=this.onClose;yield this.close(void 0,e),this.log.debug("websocket connection closed: ".concat(e),Object.assign(Object.assign({},this.logContext),{reason:e})),t&&t(e)}))}handleWSError(e){this.log.error("websocket error",Object.assign(Object.assign({},this.logContext),{error:e}))}resetPingTimeout(){this.clearPingTimeout(),this.pingTimeoutDuration?this.pingTimeout=Ga.setTimeout((()=>{this.log.warn("ping timeout triggered. last pong received at: ".concat(new Date(Date.now()-1e3*this.pingTimeoutDuration).toUTCString()),this.logContext),this.handleOnClose("ping timeout")}),1e3*this.pingTimeoutDuration):this.log.warn("ping timeout duration not set",this.logContext)}clearPingTimeout(){this.pingTimeout&&Ga.clearTimeout(this.pingTimeout)}startPingInterval(){this.clearPingInterval(),this.resetPingTimeout(),this.pingIntervalDuration?(this.log.debug("start ping interval",this.logContext),this.pingInterval=Ga.setInterval((()=>{this.sendPing()}),1e3*this.pingIntervalDuration)):this.log.warn("ping interval duration not set",this.logContext)}clearPingInterval(){this.log.debug("clearing ping interval",this.logContext),this.clearPingTimeout(),this.pingInterval&&Ga.clearInterval(this.pingInterval)}handleSignalConnected(e,t,n){this.state=pc.CONNECTED,clearTimeout(t),this.startPingInterval(),this.startReadingLoop(e.readable.getReader(),n)}validateFirstMessage(e,t){var n,i,r,o,a;return"join"===(null===(n=e.message)||void 0===n?void 0:n.case)?{isValid:!0,response:e.message.value}:this.state===pc.RECONNECTING&&"leave"!==(null===(i=e.message)||void 0===i?void 0:i.case)?"reconnect"===(null===(r=e.message)||void 0===r?void 0:r.case)?{isValid:!0,response:e.message.value}:(this.log.debug("declaring signal reconnected without reconnect response received",this.logContext),{isValid:!0,response:void 0,shouldProcessFirstMessage:!0}):this.isEstablishingConnection&&"leave"===(null===(o=e.message)||void 0===o?void 0:o.case)?{isValid:!1,error:new Oa("Received leave request while trying to (re)connect",wa.LeaveRequest,void 0,e.message.value.reason)}:t?{isValid:!1,error:new Oa("Unexpected first message",wa.InternalError)}:{isValid:!1,error:new Oa("did not receive join response, got ".concat(null===(a=e.message)||void 0===a?void 0:a.case," instead"),wa.InternalError)}}handleConnectionError(e,t){return oo(this,void 0,void 0,(function*(){try{const n=yield fetch(t);if(n.status.toFixed(0).startsWith("4")){const e=yield n.text();return new Oa(e,wa.NotAllowed,n.status)}return e instanceof Oa?e:new Oa("Encountered unknown websocket error during connection: ".concat(e),wa.InternalError,n.status)}catch(e){return e instanceof Oa?e:new Oa(e instanceof Error?e.message:"server was not reachable",wa.ServerUnreachable)}}))}}function fc(e){const t={type:"offer",sdp:e.sdp};switch(e.type){case"answer":case"offer":case"pranswer":case"rollback":t.type=e.type}return t}function gc(e,t){return new ir({sdp:e.sdp,type:e.type,id:t})}class vc{constructor(){this.buffer=[],this._totalSize=0}push(e){this.buffer.push(e),this._totalSize+=e.data.byteLength}pop(){const e=this.buffer.shift();return e&&(this._totalSize-=e.data.byteLength),e}getAll(){return this.buffer.slice()}popToSequence(e){for(;this.buffer.length>0&&this.buffer[0].sequence<=e;)this.pop()}alignBufferedAmount(e){for(;this.buffer.length>0;){const t=this.buffer[0];if(this._totalSize-t.data.byteLength<=e)break;this.pop()}}get length(){return this.buffer.length}}class bc{constructor(e){this._map=new Map,this._lastCleanup=0,this.ttl=e}set(e,t){const n=Date.now();n-this._lastCleanup>this.ttl/2&&this.cleanup();const i=n+this.ttl;return this._map.set(e,{value:t,expiresAt:i}),this}get(e){const t=this._map.get(e);if(t){if(!(t.expiresAt<Date.now()))return t.value;this._map.delete(e)}}has(e){const t=this._map.get(e);return!(!t||t.expiresAt<Date.now()&&(this._map.delete(e),1))}delete(e){return this._map.delete(e)}clear(){this._map.clear()}cleanup(){const e=Date.now();for(const[t,n]of this._map.entries())n.expiresAt<e&&this._map.delete(t);this._lastCleanup=e}get size(){return this.cleanup(),this._map.size}forEach(e){this.cleanup();for(const[t,n]of this._map.entries())n.expiresAt>=Date.now()&&e(n.value,t,this.asValueMap())}map(e){this.cleanup();const t=[],n=this.asValueMap();for(const[i,r]of n.entries())t.push(e(r,i,n));return t}asValueMap(){const e=new Map;for(const[t,n]of this._map.entries())n.expiresAt>=Date.now()&&e.set(t,n.value);return e}}var yc,kc,wc,Cc,Tc,Sc={},xc={},Ec={exports:{}};function _c(){if(yc)return Ec.exports;yc=1;var e=Ec.exports={v:[{name:"version",reg:/^(\d*)$/}],o:[{name:"origin",reg:/^(\S*) (\d*) (\d*) (\S*) IP(\d) (\S*)/,names:["username","sessionId","sessionVersion","netType","ipVer","address"],format:"%s %s %d %s IP%d %s"}],s:[{name:"name"}],i:[{name:"description"}],u:[{name:"uri"}],e:[{name:"email"}],p:[{name:"phone"}],z:[{name:"timezones"}],r:[{name:"repeats"}],t:[{name:"timing",reg:/^(\d*) (\d*)/,names:["start","stop"],format:"%d %d"}],c:[{name:"connection",reg:/^IN IP(\d) (\S*)/,names:["version","ip"],format:"IN IP%d %s"}],b:[{push:"bandwidth",reg:/^(TIAS|AS|CT|RR|RS):(\d*)/,names:["type","limit"],format:"%s:%s"}],m:[{reg:/^(\w*) (\d*) ([\w/]*)(?: (.*))?/,names:["type","port","protocol","payloads"],format:"%s %d %s %s"}],a:[{push:"rtp",reg:/^rtpmap:(\d*) ([\w\-.]*)(?:\s*\/(\d*)(?:\s*\/(\S*))?)?/,names:["payload","codec","rate","encoding"],format:function(e){return e.encoding?"rtpmap:%d %s/%s/%s":e.rate?"rtpmap:%d %s/%s":"rtpmap:%d %s"}},{push:"fmtp",reg:/^fmtp:(\d*) ([\S| ]*)/,names:["payload","config"],format:"fmtp:%d %s"},{name:"control",reg:/^control:(.*)/,format:"control:%s"},{name:"rtcp",reg:/^rtcp:(\d*)(?: (\S*) IP(\d) (\S*))?/,names:["port","netType","ipVer","address"],format:function(e){return null!=e.address?"rtcp:%d %s IP%d %s":"rtcp:%d"}},{push:"rtcpFbTrrInt",reg:/^rtcp-fb:(\*|\d*) trr-int (\d*)/,names:["payload","value"],format:"rtcp-fb:%s trr-int %d"},{push:"rtcpFb",reg:/^rtcp-fb:(\*|\d*) ([\w-_]*)(?: ([\w-_]*))?/,names:["payload","type","subtype"],format:function(e){return null!=e.subtype?"rtcp-fb:%s %s %s":"rtcp-fb:%s %s"}},{push:"ext",reg:/^extmap:(\d+)(?:\/(\w+))?(?: (urn:ietf:params:rtp-hdrext:encrypt))? (\S*)(?: (\S*))?/,names:["value","direction","encrypt-uri","uri","config"],format:function(e){return"extmap:%d"+(e.direction?"/%s":"%v")+(e["encrypt-uri"]?" %s":"%v")+" %s"+(e.config?" %s":"")}},{name:"extmapAllowMixed",reg:/^(extmap-allow-mixed)/},{push:"crypto",reg:/^crypto:(\d*) ([\w_]*) (\S*)(?: (\S*))?/,names:["id","suite","config","sessionConfig"],format:function(e){return null!=e.sessionConfig?"crypto:%d %s %s %s":"crypto:%d %s %s"}},{name:"setup",reg:/^setup:(\w*)/,format:"setup:%s"},{name:"connectionType",reg:/^connection:(new|existing)/,format:"connection:%s"},{name:"mid",reg:/^mid:([^\s]*)/,format:"mid:%s"},{name:"msid",reg:/^msid:(.*)/,format:"msid:%s"},{name:"ptime",reg:/^ptime:(\d*(?:\.\d*)*)/,format:"ptime:%d"},{name:"maxptime",reg:/^maxptime:(\d*(?:\.\d*)*)/,format:"maxptime:%d"},{name:"direction",reg:/^(sendrecv|recvonly|sendonly|inactive)/},{name:"icelite",reg:/^(ice-lite)/},{name:"iceUfrag",reg:/^ice-ufrag:(\S*)/,format:"ice-ufrag:%s"},{name:"icePwd",reg:/^ice-pwd:(\S*)/,format:"ice-pwd:%s"},{name:"fingerprint",reg:/^fingerprint:(\S*) (\S*)/,names:["type","hash"],format:"fingerprint:%s %s"},{push:"candidates",reg:/^candidate:(\S*) (\d*) (\S*) (\d*) (\S*) (\d*) typ (\S*)(?: raddr (\S*) rport (\d*))?(?: tcptype (\S*))?(?: generation (\d*))?(?: network-id (\d*))?(?: network-cost (\d*))?/,names:["foundation","component","transport","priority","ip","port","type","raddr","rport","tcptype","generation","network-id","network-cost"],format:function(e){var t="candidate:%s %d %s %d %s %d typ %s";return t+=null!=e.raddr?" raddr %s rport %d":"%v%v",t+=null!=e.tcptype?" tcptype %s":"%v",null!=e.generation&&(t+=" generation %d"),(t+=null!=e["network-id"]?" network-id %d":"%v")+(null!=e["network-cost"]?" network-cost %d":"%v")}},{name:"endOfCandidates",reg:/^(end-of-candidates)/},{name:"remoteCandidates",reg:/^remote-candidates:(.*)/,format:"remote-candidates:%s"},{name:"iceOptions",reg:/^ice-options:(\S*)/,format:"ice-options:%s"},{push:"ssrcs",reg:/^ssrc:(\d*) ([\w_-]*)(?::(.*))?/,names:["id","attribute","value"],format:function(e){var t="ssrc:%d";return null!=e.attribute&&(t+=" %s",null!=e.value&&(t+=":%s")),t}},{push:"ssrcGroups",reg:/^ssrc-group:([\x21\x23\x24\x25\x26\x27\x2A\x2B\x2D\x2E\w]*) (.*)/,names:["semantics","ssrcs"],format:"ssrc-group:%s %s"},{name:"msidSemantic",reg:/^msid-semantic:\s?(\w*) (\S*)/,names:["semantic","token"],format:"msid-semantic: %s %s"},{push:"groups",reg:/^group:(\w*) (.*)/,names:["type","mids"],format:"group:%s %s"},{name:"rtcpMux",reg:/^(rtcp-mux)/},{name:"rtcpRsize",reg:/^(rtcp-rsize)/},{name:"sctpmap",reg:/^sctpmap:([\w_/]*) (\S*)(?: (\S*))?/,names:["sctpmapNumber","app","maxMessageSize"],format:function(e){return null!=e.maxMessageSize?"sctpmap:%s %s %s":"sctpmap:%s %s"}},{name:"xGoogleFlag",reg:/^x-google-flag:([^\s]*)/,format:"x-google-flag:%s"},{push:"rids",reg:/^rid:([\d\w]+) (\w+)(?: ([\S| ]*))?/,names:["id","direction","params"],format:function(e){return e.params?"rid:%s %s %s":"rid:%s %s"}},{push:"imageattrs",reg:new RegExp("^imageattr:(\\d+|\\*)[\\s\\t]+(send|recv)[\\s\\t]+(\\*|\\[\\S+\\](?:[\\s\\t]+\\[\\S+\\])*)(?:[\\s\\t]+(recv|send)[\\s\\t]+(\\*|\\[\\S+\\](?:[\\s\\t]+\\[\\S+\\])*))?"),names:["pt","dir1","attrs1","dir2","attrs2"],format:function(e){return"imageattr:%s %s %s"+(e.dir2?" %s %s":"")}},{name:"simulcast",reg:new RegExp("^simulcast:(send|recv) ([a-zA-Z0-9\\-_~;,]+)(?:\\s?(send|recv) ([a-zA-Z0-9\\-_~;,]+))?$"),names:["dir1","list1","dir2","list2"],format:function(e){return"simulcast:%s %s"+(e.dir2?" %s %s":"")}},{name:"simulcast_03",reg:/^simulcast:[\s\t]+([\S+\s\t]+)$/,names:["value"],format:"simulcast: %s"},{name:"framerate",reg:/^framerate:(\d+(?:$|\.\d+))/,format:"framerate:%s"},{name:"sourceFilter",reg:/^source-filter: *(excl|incl) (\S*) (IP4|IP6|\*) (\S*) (.*)/,names:["filterMode","netType","addressTypes","destAddress","srcList"],format:"source-filter: %s %s %s %s %s"},{name:"bundleOnly",reg:/^(bundle-only)/},{name:"label",reg:/^label:(.+)/,format:"label:%s"},{name:"sctpPort",reg:/^sctp-port:(\d+)$/,format:"sctp-port:%s"},{name:"maxMessageSize",reg:/^max-message-size:(\d+)$/,format:"max-message-size:%s"},{push:"tsRefClocks",reg:/^ts-refclk:([^\s=]*)(?:=(\S*))?/,names:["clksrc","clksrcExt"],format:function(e){return"ts-refclk:%s"+(null!=e.clksrcExt?"=%s":"")}},{name:"mediaClk",reg:/^mediaclk:(?:id=(\S*))? *([^\s=]*)(?:=(\S*))?(?: *rate=(\d+)\/(\d+))?/,names:["id","mediaClockName","mediaClockValue","rateNumerator","rateDenominator"],format:function(e){var t="mediaclk:";return t+=null!=e.id?"id=%s %s":"%v%s",t+=null!=e.mediaClockValue?"=%s":"",(t+=null!=e.rateNumerator?" rate=%s":"")+(null!=e.rateDenominator?"/%s":"")}},{name:"keywords",reg:/^keywds:(.+)$/,format:"keywds:%s"},{name:"content",reg:/^content:(.+)/,format:"content:%s"},{name:"bfcpFloorCtrl",reg:/^floorctrl:(c-only|s-only|c-s)/,format:"floorctrl:%s"},{name:"bfcpConfId",reg:/^confid:(\d+)/,format:"confid:%s"},{name:"bfcpUserId",reg:/^userid:(\d+)/,format:"userid:%s"},{name:"bfcpFloorId",reg:/^floorid:(.+) (?:m-stream|mstrm):(.+)/,names:["id","mStream"],format:"floorid:%s mstrm:%s"},{push:"invalid",names:["value"]}]};return Object.keys(e).forEach((function(t){e[t].forEach((function(e){e.reg||(e.reg=/(.*)/),e.format||(e.format="%s")}))})),Ec.exports}function Pc(){return kc||(kc=1,function(e){var t=function(e){return String(Number(e))===e?Number(e):e},n=function(e,n,i){var r=e.name&&e.names;e.push&&!n[e.push]?n[e.push]=[]:r&&!n[e.name]&&(n[e.name]={});var o=e.push?{}:r?n[e.name]:n;!function(e,n,i,r){if(r&&!i)n[r]=t(e[1]);else for(var o=0;o<i.length;o+=1)null!=e[o+1]&&(n[i[o]]=t(e[o+1]))}(i.match(e.reg),o,e.names,e.name),e.push&&n[e.push].push(o)},i=_c(),r=RegExp.prototype.test.bind(/^([a-z])=(.*)/);e.parse=function(e){var t={},o=[],a=t;return e.split(/(\r\n|\r|\n)/).filter(r).forEach((function(e){var t=e[0],r=e.slice(2);"m"===t&&(o.push({rtp:[],fmtp:[]}),a=o[o.length-1]);for(var s=0;s<(i[t]||[]).length;s+=1){var c=i[t][s];if(c.reg.test(r))return n(c,a,r)}})),t.media=o,t};var o=function(e,n){var i=n.split(/=(.+)/,2);return 2===i.length?e[i[0]]=t(i[1]):1===i.length&&n.length>1&&(e[i[0]]=void 0),e};e.parseParams=function(e){return e.split(/;\s?/).reduce(o,{})},e.parseFmtpConfig=e.parseParams,e.parsePayloads=function(e){return e.toString().split(" ").map(Number)},e.parseRemoteCandidates=function(e){for(var n=[],i=e.split(" ").map(t),r=0;r<i.length;r+=3)n.push({component:i[r],ip:i[r+1],port:i[r+2]});return n},e.parseImageAttributes=function(e){return e.split(" ").map((function(e){return e.substring(1,e.length-1).split(",").reduce(o,{})}))},e.parseSimulcastStreamList=function(e){return e.split(";").map((function(e){return e.split(",").map((function(e){var n,i=!1;return"~"!==e[0]?n=t(e):(n=t(e.substring(1,e.length)),i=!0),{scid:n,paused:i}}))}))}}(xc)),xc}function Rc(){if(Cc)return wc;Cc=1;var e=_c(),t=/%[sdv%]/g,n=function(e){var n=1,i=arguments,r=i.length;return e.replace(t,(function(e){if(n>=r)return e;var t=i[n];switch(n+=1,e){case"%%":return"%";case"%s":return String(t);case"%d":return Number(t);case"%v":return""}}))},i=function(e,t,i){var r=[e+"="+(t.format instanceof Function?t.format(t.push?i:i[t.name]):t.format)];if(t.names)for(var o=0;o<t.names.length;o+=1){var a=t.names[o];t.name?r.push(i[t.name][a]):r.push(i[t.names[o]])}else r.push(i[t.name]);return n.apply(null,r)},r=["v","o","s","i","u","e","p","c","b","t","r","z","a"],o=["i","c","b","a"];return wc=function(t,n){n=n||{},null==t.version&&(t.version=0),null==t.name&&(t.name=" "),t.media.forEach((function(e){null==e.payloads&&(e.payloads="")}));var a=n.outerOrder||r,s=n.innerOrder||o,c=[];return a.forEach((function(n){e[n].forEach((function(e){e.name in t&&null!=t[e.name]?c.push(i(n,e,t)):e.push in t&&null!=t[e.push]&&t[e.push].forEach((function(t){c.push(i(n,e,t))}))}))})),t.media.forEach((function(t){c.push(i("m",e.m[0],t)),s.forEach((function(n){e[n].forEach((function(e){e.name in t&&null!=t[e.name]?c.push(i(n,e,t)):e.push in t&&null!=t[e.push]&&t[e.push].forEach((function(t){c.push(i(n,e,t))}))}))}))})),c.join("\r\n")+"\r\n"},wc}var Ic=function(){if(Tc)return Sc;Tc=1;var e=Pc(),t=Rc(),n=_c();return Sc.grammar=n,Sc.write=t,Sc.parse=e.parse,Sc.parseParams=e.parseParams,Sc.parseFmtpConfig=e.parseFmtpConfig,Sc.parsePayloads=e.parsePayloads,Sc.parseRemoteCandidates=e.parseRemoteCandidates,Sc.parseImageAttributes=e.parseImageAttributes,Sc.parseSimulcastStreamList=e.parseSimulcastStreamList,Sc}();function Oc(e,t,n){var i,r,o;void 0===t&&(t=50),void 0===n&&(n={});var a=null!=(i=n.isImmediate)&&i,s=null!=(r=n.callback)&&r,c=n.maxWait,l=Date.now(),d=[];function u(){if(void 0!==c){var e=Date.now()-l;if(e+t>=c)return c-e}return t}var h=function(){var t=[].slice.call(arguments),n=this;return new Promise((function(i,r){var c=a&&void 0===o;if(void 0!==o&&clearTimeout(o),o=setTimeout((function(){if(o=void 0,l=Date.now(),!a){var i=e.apply(n,t);s&&s(i),d.forEach((function(e){return(0,e.resolve)(i)})),d=[]}}),u()),c){var h=e.apply(n,t);return s&&s(h),i(h)}d.push({resolve:i,reject:r})}))};return h.cancel=function(e){void 0!==o&&clearTimeout(o),d.forEach((function(t){return(0,t.reject)(e)})),d=[]},h}const Dc="negotiationStarted",Mc="negotiationComplete",Ac="rtpVideoPayloadTypes";class Nc extends lo.EventEmitter{get pc(){return this._pc||(this._pc=this.createPC()),this._pc}constructor(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};var n;super(),this.log=eo,this.ddExtID=0,this.latestOfferId=0,this.pendingCandidates=[],this.restartingIce=!1,this.renegotiate=!1,this.trackBitrates=[],this.remoteStereoMids=[],this.remoteNackMids=[],this.negotiate=Oc((e=>oo(this,void 0,void 0,(function*(){this.emit(Dc);try{yield this.createAndSendOffer()}catch(t){if(!e)throw t;e(t)}}))),20),this.close=()=>{this._pc&&(this._pc.close(),this._pc.onconnectionstatechange=null,this._pc.oniceconnectionstatechange=null,this._pc.onicegatheringstatechange=null,this._pc.ondatachannel=null,this._pc.onnegotiationneeded=null,this._pc.onsignalingstatechange=null,this._pc.onicecandidate=null,this._pc.ondatachannel=null,this._pc.ontrack=null,this._pc.onconnectionstatechange=null,this._pc.oniceconnectionstatechange=null,this._pc=null)},this.log=to(null!==(n=t.loggerName)&&void 0!==n?n:$r.PCTransport),this.loggerOptions=t,this.config=e,this._pc=this.createPC(),this.offerLock=new ht}createPC(){const e=new RTCPeerConnection(this.config);return e.onicecandidate=e=>{var t;e.candidate&&(null===(t=this.onIceCandidate)||void 0===t||t.call(this,e.candidate))},e.onicecandidateerror=e=>{var t;null===(t=this.onIceCandidateError)||void 0===t||t.call(this,e)},e.oniceconnectionstatechange=()=>{var t;null===(t=this.onIceConnectionStateChange)||void 0===t||t.call(this,e.iceConnectionState)},e.onsignalingstatechange=()=>{var t;null===(t=this.onSignalingStatechange)||void 0===t||t.call(this,e.signalingState)},e.onconnectionstatechange=()=>{var t;null===(t=this.onConnectionStateChange)||void 0===t||t.call(this,e.connectionState)},e.ondatachannel=e=>{var t;null===(t=this.onDataChannel)||void 0===t||t.call(this,e)},e.ontrack=e=>{var t;null===(t=this.onTrack)||void 0===t||t.call(this,e)},e}get logContext(){var e,t;return Object.assign({},null===(t=(e=this.loggerOptions).loggerContextCb)||void 0===t?void 0:t.call(e))}get isICEConnected(){return null!==this._pc&&("connected"===this.pc.iceConnectionState||"completed"===this.pc.iceConnectionState)}addIceCandidate(e){return oo(this,void 0,void 0,(function*(){if(this.pc.remoteDescription&&!this.restartingIce)return this.pc.addIceCandidate(e);this.pendingCandidates.push(e)}))}setRemoteDescription(e,t){return oo(this,void 0,void 0,(function*(){var n;if("answer"===e.type&&this.latestOfferId>0&&t>0&&t!==this.latestOfferId)return this.log.warn("ignoring answer for old offer",Object.assign(Object.assign({},this.logContext),{offerId:t,latestOfferId:this.latestOfferId})),!1;let i;if("offer"===e.type){let{stereoMids:t,nackMids:n}=function(e){var t;const n=[],i=[],r=Ic.parse(null!==(t=e.sdp)&&void 0!==t?t:"");let o=0;return r.media.forEach((e=>{var t;const r=Uc(e.mid);"audio"===e.type&&(e.rtp.some((e=>"opus"===e.codec&&(o=e.payload,!0))),(null===(t=e.rtcpFb)||void 0===t?void 0:t.some((e=>e.payload===o&&"nack"===e.type)))&&i.push(r),e.fmtp.some((e=>e.payload===o&&(e.config.includes("sprop-stereo=1")&&n.push(r),!0))))})),{stereoMids:n,nackMids:i}}(e);this.remoteStereoMids=t,this.remoteNackMids=n}else if("answer"===e.type){const t=Ic.parse(null!==(n=e.sdp)&&void 0!==n?n:"");t.media.forEach((e=>{const t=Uc(e.mid);"audio"===e.type&&this.trackBitrates.some((n=>{if(!n.transceiver||t!=n.transceiver.mid)return!1;let i=0;if(e.rtp.some((e=>e.codec.toUpperCase()===n.codec.toUpperCase()&&(i=e.payload,!0))),0===i)return!0;let r=!1;for(const t of e.fmtp)if(t.payload===i){t.config=t.config.split(";").filter((e=>!e.includes("maxaveragebitrate"))).join(";"),n.maxbr>0&&(t.config+=";maxaveragebitrate=".concat(1e3*n.maxbr)),r=!0;break}return r||n.maxbr>0&&e.fmtp.push({payload:i,config:"maxaveragebitrate=".concat(1e3*n.maxbr)}),!0}))})),i=Ic.write(t)}return yield this.setMungedSDP(e,i,!0),this.pendingCandidates.forEach((e=>{this.pc.addIceCandidate(e)})),this.pendingCandidates=[],this.restartingIce=!1,this.renegotiate?(this.renegotiate=!1,yield this.createAndSendOffer()):"answer"===e.type&&(this.emit(Mc),e.sdp)&&Ic.parse(e.sdp).media.forEach((e=>{"video"===e.type&&this.emit(Ac,e.rtp)})),!0}))}createAndSendOffer(e){return oo(this,void 0,void 0,(function*(){var t;const n=yield this.offerLock.lock();try{if(void 0===this.onOffer)return;if((null==e?void 0:e.iceRestart)&&(this.log.debug("restarting ICE",this.logContext),this.restartingIce=!0),this._pc&&"have-local-offer"===this._pc.signalingState){const t=this._pc.remoteDescription;if(!(null==e?void 0:e.iceRestart)||!t)return void(this.renegotiate=!0);yield this._pc.setRemoteDescription(t)}else if(!this._pc||"closed"===this._pc.signalingState)return void this.log.warn("could not createOffer with closed peer connection",this.logContext);this.log.debug("starting to negotiate",this.logContext);const n=this.latestOfferId+1;this.latestOfferId=n;const i=yield this.pc.createOffer(e);this.log.debug("original offer",Object.assign({sdp:i.sdp},this.logContext));const r=Ic.parse(null!==(t=i.sdp)&&void 0!==t?t:"");if(r.media.forEach((e=>{jc(e),"audio"===e.type?Lc(e,["all"],[]):"video"===e.type&&this.trackBitrates.some((t=>{if(!e.msid||!t.cid||!e.msid.includes(t.cid))return!1;let n=0;if(e.rtp.some((e=>e.codec.toUpperCase()===t.codec.toUpperCase()&&(n=e.payload,!0))),0===n)return!0;if(us(t.codec)&&!ms()&&this.ensureVideoDDExtensionForSVC(e,r),"av1"!==t.codec)return!0;const i=Math.round(.7*t.maxbr);for(const t of e.fmtp)if(t.payload===n){t.config.includes("x-google-start-bitrate")||(t.config+=";x-google-start-bitrate=".concat(i));break}return!0}))})),this.latestOfferId>n)return void this.log.warn("latestOfferId mismatch",Object.assign(Object.assign({},this.logContext),{latestOfferId:this.latestOfferId,offerId:n}));yield this.setMungedSDP(i,Ic.write(r)),this.onOffer(i,this.latestOfferId)}finally{n()}}))}createAndSetAnswer(){return oo(this,void 0,void 0,(function*(){var e;const t=yield this.pc.createAnswer(),n=Ic.parse(null!==(e=t.sdp)&&void 0!==e?e:"");return n.media.forEach((e=>{jc(e),"audio"===e.type&&Lc(e,this.remoteStereoMids,this.remoteNackMids)})),yield this.setMungedSDP(t,Ic.write(n)),t}))}createDataChannel(e,t){return this.pc.createDataChannel(e,t)}addTransceiver(e,t){return this.pc.addTransceiver(e,t)}addTransceiverOfKind(e,t){return this.pc.addTransceiver(e,t)}addTrack(e){if(!this._pc)throw new Na("PC closed, cannot add track");return this._pc.addTrack(e)}setTrackCodecBitrate(e){this.trackBitrates.push(e)}setConfiguration(e){var t;if(!this._pc)throw new Na("PC closed, cannot configure");return null===(t=this._pc)||void 0===t?void 0:t.setConfiguration(e)}canRemoveTrack(){var e;return!!(null===(e=this._pc)||void 0===e?void 0:e.removeTrack)}removeTrack(e){var t;return null===(t=this._pc)||void 0===t?void 0:t.removeTrack(e)}getConnectionState(){var e,t;return null!==(t=null===(e=this._pc)||void 0===e?void 0:e.connectionState)&&void 0!==t?t:"closed"}getICEConnectionState(){var e,t;return null!==(t=null===(e=this._pc)||void 0===e?void 0:e.iceConnectionState)&&void 0!==t?t:"closed"}getSignallingState(){var e,t;return null!==(t=null===(e=this._pc)||void 0===e?void 0:e.signalingState)&&void 0!==t?t:"closed"}getTransceivers(){var e,t;return null!==(t=null===(e=this._pc)||void 0===e?void 0:e.getTransceivers())&&void 0!==t?t:[]}getSenders(){var e,t;return null!==(t=null===(e=this._pc)||void 0===e?void 0:e.getSenders())&&void 0!==t?t:[]}getLocalDescription(){var e;return null===(e=this._pc)||void 0===e?void 0:e.localDescription}getRemoteDescription(){var e;return null===(e=this.pc)||void 0===e?void 0:e.remoteDescription}getStats(){return this.pc.getStats()}getConnectedAddress(){return oo(this,void 0,void 0,(function*(){var e;if(!this._pc)return;let t="";const n=new Map,i=new Map;if((yield this._pc.getStats()).forEach((e=>{switch(e.type){case"transport":t=e.selectedCandidatePairId;break;case"candidate-pair":""===t&&e.selected&&(t=e.id),n.set(e.id,e);break;case"remote-candidate":i.set(e.id,"".concat(e.address,":").concat(e.port))}})),""===t)return;const r=null===(e=n.get(t))||void 0===e?void 0:e.remoteCandidateId;return void 0!==r?i.get(r):void 0}))}setMungedSDP(e,t,n){return oo(this,void 0,void 0,(function*(){if(t){const i=e.sdp;e.sdp=t;try{return this.log.debug("setting munged ".concat(n?"remote":"local"," description"),this.logContext),void(n?yield this.pc.setRemoteDescription(e):yield this.pc.setLocalDescription(e))}catch(n){this.log.warn("not able to set ".concat(e.type,", falling back to unmodified sdp"),Object.assign(Object.assign({},this.logContext),{error:n,sdp:t})),e.sdp=i}}try{n?yield this.pc.setRemoteDescription(e):yield this.pc.setLocalDescription(e)}catch(t){let i="unknown error";t instanceof Error?i=t.message:"string"==typeof t&&(i=t);const r={error:i,sdp:e.sdp};throw!n&&this.pc.remoteDescription&&(r.remoteSdp=this.pc.remoteDescription),this.log.error("unable to set ".concat(e.type),Object.assign(Object.assign({},this.logContext),{fields:r})),new La(i)}}))}ensureVideoDDExtensionForSVC(e,t){var n,i;if(!(null===(n=e.ext)||void 0===n?void 0:n.some((e=>e.uri===ss)))){if(0===this.ddExtID){let e=0;t.media.forEach((t=>{var n;"video"===t.type&&(null===(n=t.ext)||void 0===n||n.forEach((t=>{t.value>e&&(e=t.value)})))})),this.ddExtID=e+1}null===(i=e.ext)||void 0===i||i.push({value:this.ddExtID,uri:ss})}}}function Lc(e,t,n){const i=Uc(e.mid);let r=0;e.rtp.some((e=>"opus"===e.codec&&(r=e.payload,!0))),r>0&&(e.rtcpFb||(e.rtcpFb=[]),n.includes(i)&&!e.rtcpFb.some((e=>e.payload===r&&"nack"===e.type))&&e.rtcpFb.push({payload:r,type:"nack"}),(t.includes(i)||1===t.length&&"all"===t[0])&&e.fmtp.some((e=>e.payload===r&&(e.config.includes("stereo=1")||(e.config+=";stereo=1"),!0))))}function jc(e){if(e.connection){const t=e.connection.ip.indexOf(":")>=0;(4===e.connection.version&&t||6===e.connection.version&&!t)&&(e.connection.ip="0.0.0.0",e.connection.version=4)}}function Uc(e){return"number"==typeof e?e.toFixed(0):e}const Fc="vp8",Bc={audioPreset:is.music,dtx:!0,red:!0,forceStereo:!1,simulcast:!0,screenShareEncoding:as.h1080fps15.encoding,stopMicTrackOnMute:!1,videoCodec:Fc,backupCodec:!0,preConnectBuffer:!1},Vc={deviceId:{ideal:"default"},autoGainControl:!0,echoCancellation:!0,noiseSuppression:!0,voiceIsolation:!0},qc={deviceId:{ideal:"default"},resolution:rs.h720.resolution},Wc={adaptiveStream:!1,dynacast:!1,stopLocalTrackOnUnpublish:!0,reconnectPolicy:new class{constructor(e){this._retryDelays=void 0!==e?[...e]:ro}nextRetryDelayInMs(e){if(e.retryCount>=this._retryDelays.length)return null;const t=this._retryDelays[e.retryCount];return e.retryCount<=1?t:t+1e3*Math.random()}},disconnectOnPageLeave:!0,webAudioMix:!1,singlePeerConnection:!1},Hc={autoSubscribe:!0,maxRetries:1,peerConnectionTimeout:15e3,websocketTimeout:15e3};var zc;!function(e){e[e.NEW=0]="NEW",e[e.CONNECTING=1]="CONNECTING",e[e.CONNECTED=2]="CONNECTED",e[e.FAILED=3]="FAILED",e[e.CLOSING=4]="CLOSING",e[e.CLOSED=5]="CLOSED"}(zc||(zc={}));class Gc{get needsPublisher(){return this.isPublisherConnectionRequired}get needsSubscriber(){return this.isSubscriberConnectionRequired}get currentState(){return this.state}constructor(e,t,n){var i;this.peerConnectionTimeout=Hc.peerConnectionTimeout,this.log=eo,this.updateState=()=>{var e,t;const n=this.state,i=this.requiredTransports.map((e=>e.getConnectionState()));i.every((e=>"connected"===e))?this.state=zc.CONNECTED:i.some((e=>"failed"===e))?this.state=zc.FAILED:i.some((e=>"connecting"===e))?this.state=zc.CONNECTING:i.every((e=>"closed"===e))?this.state=zc.CLOSED:i.some((e=>"closed"===e))?this.state=zc.CLOSING:i.every((e=>"new"===e))&&(this.state=zc.NEW),n!==this.state&&(this.log.debug("pc state change: from ".concat(zc[n]," to ").concat(zc[this.state]),this.logContext),null===(e=this.onStateChange)||void 0===e||e.call(this,this.state,this.publisher.getConnectionState(),null===(t=this.subscriber)||void 0===t?void 0:t.getConnectionState()))},this.log=to(null!==(i=n.loggerName)&&void 0!==i?i:$r.PCManager),this.loggerOptions=n,this.isPublisherConnectionRequired="subscriber-primary"!==t,this.isSubscriberConnectionRequired="subscriber-primary"===t,this.publisher=new Nc(e,n),"publisher-only"!==t&&(this.subscriber=new Nc(e,n),this.subscriber.onConnectionStateChange=this.updateState,this.subscriber.onIceConnectionStateChange=this.updateState,this.subscriber.onSignalingStatechange=this.updateState,this.subscriber.onIceCandidate=e=>{var t;null===(t=this.onIceCandidate)||void 0===t||t.call(this,e,Hi.SUBSCRIBER)},this.subscriber.onDataChannel=e=>{var t;null===(t=this.onDataChannel)||void 0===t||t.call(this,e)},this.subscriber.onTrack=e=>{var t;null===(t=this.onTrack)||void 0===t||t.call(this,e)}),this.publisher.onConnectionStateChange=this.updateState,this.publisher.onIceConnectionStateChange=this.updateState,this.publisher.onSignalingStatechange=this.updateState,this.publisher.onIceCandidate=e=>{var t;null===(t=this.onIceCandidate)||void 0===t||t.call(this,e,Hi.PUBLISHER)},this.publisher.onTrack=e=>{var t;null===(t=this.onTrack)||void 0===t||t.call(this,e)},this.publisher.onOffer=(e,t)=>{var n;null===(n=this.onPublisherOffer)||void 0===n||n.call(this,e,t)},this.state=zc.NEW,this.connectionLock=new ht,this.remoteOfferLock=new ht}get logContext(){var e,t;return Object.assign({},null===(t=(e=this.loggerOptions).loggerContextCb)||void 0===t?void 0:t.call(e))}requirePublisher(){let e=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];this.isPublisherConnectionRequired=e,this.updateState()}createAndSendPublisherOffer(e){return this.publisher.createAndSendOffer(e)}setPublisherAnswer(e,t){return this.publisher.setRemoteDescription(e,t)}removeTrack(e){return this.publisher.removeTrack(e)}close(){return oo(this,void 0,void 0,(function*(){var e;if(this.publisher&&"closed"!==this.publisher.getSignallingState()){const e=this.publisher;for(const t of e.getSenders())try{e.canRemoveTrack()&&e.removeTrack(t)}catch(e){this.log.warn("could not removeTrack",Object.assign(Object.assign({},this.logContext),{error:e}))}}yield Promise.all([this.publisher.close(),null===(e=this.subscriber)||void 0===e?void 0:e.close()]),this.updateState()}))}triggerIceRestart(){return oo(this,void 0,void 0,(function*(){this.subscriber&&(this.subscriber.restartingIce=!0),this.needsPublisher&&(yield this.createAndSendPublisherOffer({iceRestart:!0}))}))}addIceCandidate(e,t){return oo(this,void 0,void 0,(function*(){var n;t===Hi.PUBLISHER?yield this.publisher.addIceCandidate(e):yield null===(n=this.subscriber)||void 0===n?void 0:n.addIceCandidate(e)}))}createSubscriberAnswerFromOffer(e,t){return oo(this,void 0,void 0,(function*(){var n,i,r;this.log.debug("received server offer",Object.assign(Object.assign({},this.logContext),{RTCSdpType:e.type,sdp:e.sdp,signalingState:null===(n=this.subscriber)||void 0===n?void 0:n.getSignallingState().toString()}));const o=yield this.remoteOfferLock.lock();try{if(!(yield null===(i=this.subscriber)||void 0===i?void 0:i.setRemoteDescription(e,t)))return;return yield null===(r=this.subscriber)||void 0===r?void 0:r.createAndSetAnswer()}finally{o()}}))}updateConfiguration(e,t){var n;this.publisher.setConfiguration(e),null===(n=this.subscriber)||void 0===n||n.setConfiguration(e),t&&this.triggerIceRestart()}ensurePCTransportConnection(e,t){return oo(this,void 0,void 0,(function*(){var n;const i=yield this.connectionLock.lock();try{this.isPublisherConnectionRequired&&"connected"!==this.publisher.getConnectionState()&&"connecting"!==this.publisher.getConnectionState()&&(this.log.debug("negotiation required, start negotiating",this.logContext),this.publisher.negotiate()),yield Promise.all(null===(n=this.requiredTransports)||void 0===n?void 0:n.map((n=>this.ensureTransportConnected(n,e,t))))}finally{i()}}))}negotiate(e){return oo(this,void 0,void 0,(function*(){return new Promise(((t,n)=>oo(this,void 0,void 0,(function*(){const i=setTimeout((()=>{n("negotiation timed out")}),this.peerConnectionTimeout);e.signal.addEventListener("abort",(()=>{clearTimeout(i),n("negotiation aborted")})),this.publisher.once(Dc,(()=>{e.signal.aborted||this.publisher.once(Mc,(()=>{clearTimeout(i),t()}))})),yield this.publisher.negotiate((e=>{clearTimeout(i),n(e)}))}))))}))}addPublisherTransceiver(e,t){return this.publisher.addTransceiver(e,t)}addPublisherTransceiverOfKind(e,t){return this.publisher.addTransceiverOfKind(e,t)}getMidForReceiver(e){const t=(this.subscriber?this.subscriber.getTransceivers():this.publisher.getTransceivers()).find((t=>t.receiver===e));return null==t?void 0:t.mid}addPublisherTrack(e){return this.publisher.addTrack(e)}createPublisherDataChannel(e,t){return this.publisher.createDataChannel(e,t)}getConnectedAddress(e){return e===Hi.PUBLISHER||e===Hi.SUBSCRIBER?this.publisher.getConnectedAddress():this.requiredTransports[0].getConnectedAddress()}get requiredTransports(){const e=[];return this.isPublisherConnectionRequired&&e.push(this.publisher),this.isSubscriberConnectionRequired&&this.subscriber&&e.push(this.subscriber),e}ensureTransportConnected(e,t){return oo(this,arguments,void 0,(function(e,t){var n=this;let i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:this.peerConnectionTimeout;return function*(){if("connected"!==e.getConnectionState())return new Promise(((e,r)=>oo(n,void 0,void 0,(function*(){const n=()=>{this.log.warn("abort transport connection",this.logContext),Ga.clearTimeout(o),r(new Oa("room connection has been cancelled",wa.Cancelled))};(null==t?void 0:t.signal.aborted)&&n(),null==t||t.signal.addEventListener("abort",n);const o=Ga.setTimeout((()=>{null==t||t.signal.removeEventListener("abort",n),r(new Oa("could not establish pc connection",wa.InternalError))}),i);for(;this.state!==zc.CONNECTED;)if(yield cs(50),null==t?void 0:t.signal.aborted)return void r(new Oa("room connection has been cancelled",wa.Cancelled));Ga.clearTimeout(o),null==t||t.signal.removeEventListener("abort",n),e()}))))}()}))}}class Kc extends Error{constructor(e,t,n){super(t),this.code=e,this.message=Yc(t,Kc.MAX_MESSAGE_BYTES),this.data=n?Yc(n,Kc.MAX_DATA_BYTES):void 0}static fromProto(e){return new Kc(e.code,e.message,e.data)}toProto(){return new _i({code:this.code,message:this.message,data:this.data})}static builtIn(e,t){return new Kc(Kc.ErrorCode[e],Kc.ErrorMessage[e],t)}}function Jc(e){return(new TextEncoder).encode(e).length}function Yc(e,t){if(Jc(e)<=t)return e;let n=0,i=e.length;const r=new TextEncoder;for(;n<i;){const o=Math.floor((n+i+1)/2);r.encode(e.slice(0,o)).length<=t?n=o:i=o-1}return e.slice(0,n)}Kc.MAX_MESSAGE_BYTES=256,Kc.MAX_DATA_BYTES=15360,Kc.ErrorCode={APPLICATION_ERROR:1500,CONNECTION_TIMEOUT:1501,RESPONSE_TIMEOUT:1502,RECIPIENT_DISCONNECTED:1503,RESPONSE_PAYLOAD_TOO_LARGE:1504,SEND_FAILED:1505,UNSUPPORTED_METHOD:1400,RECIPIENT_NOT_FOUND:1401,REQUEST_PAYLOAD_TOO_LARGE:1402,UNSUPPORTED_SERVER:1403,UNSUPPORTED_VERSION:1404},Kc.ErrorMessage={APPLICATION_ERROR:"Application error in method handler",CONNECTION_TIMEOUT:"Connection timeout",RESPONSE_TIMEOUT:"Response timeout",RECIPIENT_DISCONNECTED:"Recipient disconnected",RESPONSE_PAYLOAD_TOO_LARGE:"Response payload too large",SEND_FAILED:"Failed to send",UNSUPPORTED_METHOD:"Method not supported at destination",RECIPIENT_NOT_FOUND:"Recipient not found",REQUEST_PAYLOAD_TOO_LARGE:"Request payload too large",UNSUPPORTED_SERVER:"RPC not supported by server",UNSUPPORTED_VERSION:"Unsupported RPC version"};const Xc=2e3;function $c(e,t){if(!t)return 0;let n,i;return"bytesReceived"in e?(n=e.bytesReceived,i=t.bytesReceived):"bytesSent"in e&&(n=e.bytesSent,i=t.bytesSent),void 0===n||void 0===i||void 0===e.timestamp||void 0===t.timestamp?0:8*(n-i)*1e3/(e.timestamp-t.timestamp)}const Qc="undefined"!=typeof MediaRecorder,Zc=Qc?MediaRecorder:class{constructor(){throw new Error("MediaRecorder is not available in this environment")}};class el extends Zc{constructor(e,t){if(!Qc)throw new Error("MediaRecorder is not available in this environment");let n,i;super(new MediaStream([e.mediaStreamTrack]),t);const r=()=>{this.removeEventListener("dataavailable",n),this.removeEventListener("stop",r),this.removeEventListener("error",o),null==i||i.close(),i=void 0},o=e=>{null==i||i.error(e),this.removeEventListener("dataavailable",n),this.removeEventListener("stop",r),this.removeEventListener("error",o),i=void 0};this.byteStream=new ReadableStream({start:e=>{i=e,n=t=>oo(this,void 0,void 0,(function*(){let n;if(t.data.arrayBuffer){const e=yield t.data.arrayBuffer();n=new Uint8Array(e)}else{if(!t.data.byteArray)throw new Error("no data available!");n=t.data.byteArray}void 0!==i&&e.enqueue(n)})),this.addEventListener("dataavailable",n)},cancel:()=>{r()}}),this.addEventListener("stop",r),this.addEventListener("error",o)}}class tl extends Ya{get sender(){return this._sender}set sender(e){this._sender=e}get constraints(){return this._constraints}get hasPreConnectBuffer(){return!!this.localTrackRecorder}constructor(e,t,n){let i=arguments.length>3&&void 0!==arguments[3]&&arguments[3];super(e,t,arguments.length>4?arguments[4]:void 0),this.manuallyStopped=!1,this._isUpstreamPaused=!1,this.handleTrackMuteEvent=()=>this.debouncedTrackMuteHandler().catch((()=>this.log.debug("track mute bounce got cancelled by an unmute event",this.logContext))),this.debouncedTrackMuteHandler=Oc((()=>oo(this,void 0,void 0,(function*(){yield this.pauseUpstream()}))),5e3),this.handleTrackUnmuteEvent=()=>oo(this,void 0,void 0,(function*(){this.debouncedTrackMuteHandler.cancel("unmute"),yield this.resumeUpstream()})),this.handleEnded=()=>{this.isInBackground&&(this.reacquireTrack=!0),this._mediaStreamTrack.removeEventListener("mute",this.handleTrackMuteEvent),this._mediaStreamTrack.removeEventListener("unmute",this.handleTrackUnmuteEvent),this.emit(Pa.Ended,this)},this.reacquireTrack=!1,this.providedByUser=i,this.muteLock=new ht,this.pauseUpstreamLock=new ht,this.trackChangeLock=new ht,this.trackChangeLock.lock().then((t=>oo(this,void 0,void 0,(function*(){try{yield this.setMediaStreamTrack(e,!0)}finally{t()}})))),this._constraints=e.getConstraints(),n&&(this._constraints=n)}get id(){return this._mediaStreamTrack.id}get dimensions(){if(this.kind!==Ya.Kind.Video)return;const{width:e,height:t}=this._mediaStreamTrack.getSettings();return e&&t?{width:e,height:t}:void 0}get isUpstreamPaused(){return this._isUpstreamPaused}get isUserProvided(){return this.providedByUser}get mediaStreamTrack(){var e,t;return null!==(t=null===(e=this.processor)||void 0===e?void 0:e.processedTrack)&&void 0!==t?t:this._mediaStreamTrack}get isLocal(){return!0}getSourceTrackSettings(){return this._mediaStreamTrack.getSettings()}setMediaStreamTrack(e,t){return oo(this,void 0,void 0,(function*(){var n;if(e===this._mediaStreamTrack&&!t)return;let i;if(this._mediaStreamTrack&&(this.attachedElements.forEach((e=>{$a(this._mediaStreamTrack,e)})),this.debouncedTrackMuteHandler.cancel("new-track"),this._mediaStreamTrack.removeEventListener("ended",this.handleEnded),this._mediaStreamTrack.removeEventListener("mute",this.handleTrackMuteEvent),this._mediaStreamTrack.removeEventListener("unmute",this.handleTrackUnmuteEvent)),this.mediaStream=new MediaStream([e]),e&&(e.addEventListener("ended",this.handleEnded),e.addEventListener("mute",this.handleTrackMuteEvent),e.addEventListener("unmute",this.handleTrackUnmuteEvent),this._constraints=e.getConstraints()),this.processor&&e){if(this.log.debug("restarting processor",this.logContext),"unknown"===this.kind)throw TypeError("cannot set processor on track of unknown kind");this.processorElement&&(Xa(e,this.processorElement),this.processorElement.muted=!0),yield this.processor.restart({track:e,kind:this.kind,element:this.processorElement}),i=this.processor.processedTrack}this.sender&&"closed"!==(null===(n=this.sender.transport)||void 0===n?void 0:n.state)&&(yield this.sender.replaceTrack(null!=i?i:e)),this.providedByUser||this._mediaStreamTrack===e||this._mediaStreamTrack.stop(),this._mediaStreamTrack=e,e&&(this._mediaStreamTrack.enabled=!this.isMuted,yield this.resumeUpstream(),this.attachedElements.forEach((t=>{Xa(null!=i?i:e,t)})))}))}waitForDimensions(){return oo(this,arguments,void 0,(function(){var e=this;let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1e3;return function*(){var n;if(e.kind===Ya.Kind.Audio)throw new Error("cannot get dimensions for audio tracks");"iOS"===(null===(n=qa())||void 0===n?void 0:n.os)&&(yield cs(10));const i=Date.now();for(;Date.now()-i<t;){const t=e.dimensions;if(t)return t;yield cs(50)}throw new Ma("unable to get track dimensions after timeout")}()}))}setDeviceId(e){return oo(this,void 0,void 0,(function*(){return this._constraints.deviceId===e&&this._mediaStreamTrack.getSettings().deviceId===As(e)||(this._constraints.deviceId=e,!!this.isMuted||(yield this.restartTrack(),As(e)===this._mediaStreamTrack.getSettings().deviceId))}))}getDeviceId(){return oo(this,arguments,void 0,(function(){var e=this;let t=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];return function*(){if(e.source===Ya.Source.ScreenShare)return;const{deviceId:n,groupId:i}=e._mediaStreamTrack.getSettings(),r=e.kind===Ya.Kind.Audio?"audioinput":"videoinput";return t?ac.getInstance().normalizeDeviceId(r,n,i):n}()}))}mute(){return oo(this,void 0,void 0,(function*(){return this.setTrackMuted(!0),this}))}unmute(){return oo(this,void 0,void 0,(function*(){return this.setTrackMuted(!1),this}))}replaceTrack(e,t){return oo(this,void 0,void 0,(function*(){const n=yield this.trackChangeLock.lock();try{if(!this.sender)throw new Ma("unable to replace an unpublished track");let n,i;return"boolean"==typeof t?n=t:void 0!==t&&(n=t.userProvidedTrack,i=t.stopProcessor),this.providedByUser=null==n||n,this.log.debug("replace MediaStreamTrack",this.logContext),yield this.setMediaStreamTrack(e),i&&this.processor&&(yield this.internalStopProcessor()),this}finally{n()}}))}restart(e){return oo(this,void 0,void 0,(function*(){this.manuallyStopped=!1;const t=yield this.trackChangeLock.lock();try{e||(e=this._constraints);const{deviceId:t,facingMode:n}=e,i=function(e,t){var n={};for(var i in e)Object.prototype.hasOwnProperty.call(e,i)&&t.indexOf(i)<0&&(n[i]=e[i]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var r=0;for(i=Object.getOwnPropertySymbols(e);r<i.length;r++)t.indexOf(i[r])<0&&Object.prototype.propertyIsEnumerable.call(e,i[r])&&(n[i[r]]=e[i[r]])}return n}(e,["deviceId","facingMode"]);this.log.debug("restarting track with constraints",Object.assign(Object.assign({},this.logContext),{constraints:e}));const r={audio:!1,video:!1};this.kind===Ya.Kind.Video?r.video=!t&&!n||{deviceId:t,facingMode:n}:r.audio=!t||Object.assign({deviceId:t},i),this.attachedElements.forEach((e=>{$a(this.mediaStreamTrack,e)})),this._mediaStreamTrack.removeEventListener("ended",this.handleEnded),this._mediaStreamTrack.stop();const o=(yield navigator.mediaDevices.getUserMedia(r)).getTracks()[0];return this.kind===Ya.Kind.Video&&(yield o.applyConstraints(i)),o.addEventListener("ended",this.handleEnded),this.log.debug("re-acquired MediaStreamTrack",this.logContext),yield this.setMediaStreamTrack(o),this._constraints=e,this.emit(Pa.Restarted,this),this.manuallyStopped&&(this.log.warn("track was stopped during a restart, stopping restarted track",this.logContext),this.stop()),this}finally{t()}}))}setTrackMuted(e){this.log.debug("setting ".concat(this.kind," track ").concat(e?"muted":"unmuted"),this.logContext),this.isMuted===e&&this._mediaStreamTrack.enabled!==e||(this.isMuted=e,this._mediaStreamTrack.enabled=!e,this.emit(e?Pa.Muted:Pa.Unmuted,this))}get needsReAcquisition(){return"live"!==this._mediaStreamTrack.readyState||this._mediaStreamTrack.muted||!this._mediaStreamTrack.enabled||this.reacquireTrack}handleAppVisibilityChanged(){const e=Object.create(null,{handleAppVisibilityChanged:{get:()=>super.handleAppVisibilityChanged}});return oo(this,void 0,void 0,(function*(){yield e.handleAppVisibilityChanged.call(this),gs()&&(this.log.debug("visibility changed, is in Background: ".concat(this.isInBackground),this.logContext),this.isInBackground||!this.needsReAcquisition||this.isUserProvided||this.isMuted||(this.log.debug("track needs to be reacquired, restarting ".concat(this.source),this.logContext),yield this.restart(),this.reacquireTrack=!1))}))}stop(){var e;this.manuallyStopped=!0,super.stop(),this._mediaStreamTrack.removeEventListener("ended",this.handleEnded),this._mediaStreamTrack.removeEventListener("mute",this.handleTrackMuteEvent),this._mediaStreamTrack.removeEventListener("unmute",this.handleTrackUnmuteEvent),null===(e=this.processor)||void 0===e||e.destroy(),this.processor=void 0}pauseUpstream(){return oo(this,void 0,void 0,(function*(){var e;const t=yield this.pauseUpstreamLock.lock();try{if(!0===this._isUpstreamPaused)return;if(!this.sender)return void this.log.warn("unable to pause upstream for an unpublished track",this.logContext);this._isUpstreamPaused=!0,this.emit(Pa.UpstreamPaused,this);const t=qa();if("Safari"===(null==t?void 0:t.name)&&Ts(t.version,"12.0")<0)throw new Da("pauseUpstream is not supported on Safari < 12.");"closed"!==(null===(e=this.sender.transport)||void 0===e?void 0:e.state)&&(yield this.sender.replaceTrack(null))}finally{t()}}))}resumeUpstream(){return oo(this,void 0,void 0,(function*(){var e;const t=yield this.pauseUpstreamLock.lock();try{if(!1===this._isUpstreamPaused)return;if(!this.sender)return void this.log.warn("unable to resume upstream for an unpublished track",this.logContext);this._isUpstreamPaused=!1,this.emit(Pa.UpstreamResumed,this),"closed"!==(null===(e=this.sender.transport)||void 0===e?void 0:e.state)&&(yield this.sender.replaceTrack(this.mediaStreamTrack))}finally{t()}}))}getRTCStatsReport(){return oo(this,void 0,void 0,(function*(){var e;if(null===(e=this.sender)||void 0===e?void 0:e.getStats)return yield this.sender.getStats()}))}setProcessor(e){return oo(this,arguments,void 0,(function(e){var t=this;let n=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];return function*(){var i;const r=yield t.trackChangeLock.lock();try{t.log.debug("setting up processor",t.logContext);const r=document.createElement(t.kind),o={kind:t.kind,track:t._mediaStreamTrack,element:r,audioContext:t.audioContext};if(yield e.init(o),t.log.debug("processor initialized",t.logContext),t.processor&&(yield t.internalStopProcessor()),"unknown"===t.kind)throw TypeError("cannot set processor on track of unknown kind");if(Xa(t._mediaStreamTrack,r),r.muted=!0,r.play().catch((e=>{e instanceof DOMException&&"AbortError"===e.name?(t.log.warn("failed to play processor element, retrying",Object.assign(Object.assign({},t.logContext),{error:e})),setTimeout((()=>{r.play().catch((e=>{t.log.error("failed to play processor element",Object.assign(Object.assign({},t.logContext),{err:e}))}))}),100)):t.log.error("failed to play processor element",Object.assign(Object.assign({},t.logContext),{error:e}))})),t.processor=e,t.processorElement=r,t.processor.processedTrack){for(const e of t.attachedElements)e!==t.processorElement&&n&&($a(t._mediaStreamTrack,e),Xa(t.processor.processedTrack,e));yield null===(i=t.sender)||void 0===i?void 0:i.replaceTrack(t.processor.processedTrack)}t.emit(Pa.TrackProcessorUpdate,t.processor)}finally{r()}}()}))}getProcessor(){return this.processor}stopProcessor(){return oo(this,arguments,void 0,(function(){var e=this;let t=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];return function*(){const n=yield e.trackChangeLock.lock();try{yield e.internalStopProcessor(t)}finally{n()}}()}))}internalStopProcessor(){return oo(this,arguments,void 0,(function(){var e=this;let t=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];return function*(){var n,i;e.processor&&(e.log.debug("stopping processor",e.logContext),null===(n=e.processor.processedTrack)||void 0===n||n.stop(),yield e.processor.destroy(),e.processor=void 0,t||(null===(i=e.processorElement)||void 0===i||i.remove(),e.processorElement=void 0),yield e._mediaStreamTrack.applyConstraints(e._constraints),yield e.setMediaStreamTrack(e._mediaStreamTrack,!0),e.emit(Pa.TrackProcessorUpdate))}()}))}startPreConnectBuffer(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:100;if(Qc)if(this.localTrackRecorder)this.log.warn("preconnect buffer already started");else{{let e="audio/webm;codecs=opus";MediaRecorder.isTypeSupported(e)||(e="video/mp4"),this.localTrackRecorder=new el(this,{mimeType:e})}this.localTrackRecorder.start(e),this.autoStopPreConnectBuffer=setTimeout((()=>{this.log.warn("preconnect buffer timed out, stopping recording automatically",this.logContext),this.stopPreConnectBuffer()}),1e4)}else this.log.warn("MediaRecorder is not available, cannot start preconnect buffer",this.logContext)}stopPreConnectBuffer(){clearTimeout(this.autoStopPreConnectBuffer),this.localTrackRecorder&&(this.localTrackRecorder.stop(),this.localTrackRecorder=void 0)}getPreConnectBuffer(){var e;return null===(e=this.localTrackRecorder)||void 0===e?void 0:e.byteStream}getPreConnectBufferMimeType(){var e;return null===(e=this.localTrackRecorder)||void 0===e?void 0:e.mimeType}}class nl extends tl{get enhancedNoiseCancellation(){return this.isKrispNoiseFilterEnabled}constructor(e,t){let n=!(arguments.length>2&&void 0!==arguments[2])||arguments[2],i=arguments.length>3?arguments[3]:void 0,r=arguments.length>4?arguments[4]:void 0;super(e,Ya.Kind.Audio,t,n,r),this.stopOnMute=!1,this.isKrispNoiseFilterEnabled=!1,this.monitorSender=()=>oo(this,void 0,void 0,(function*(){if(!this.sender)return void(this._currentBitrate=0);let e;try{e=yield this.getSenderStats()}catch(e){return void this.log.error("could not get audio sender stats",Object.assign(Object.assign({},this.logContext),{error:e}))}e&&this.prevStats&&(this._currentBitrate=$c(e,this.prevStats)),this.prevStats=e})),this.handleKrispNoiseFilterEnable=()=>{this.isKrispNoiseFilterEnabled=!0,this.log.debug("Krisp noise filter enabled",this.logContext),this.emit(Pa.AudioTrackFeatureUpdate,this,ei.TF_ENHANCED_NOISE_CANCELLATION,!0)},this.handleKrispNoiseFilterDisable=()=>{this.isKrispNoiseFilterEnabled=!1,this.log.debug("Krisp noise filter disabled",this.logContext),this.emit(Pa.AudioTrackFeatureUpdate,this,ei.TF_ENHANCED_NOISE_CANCELLATION,!1)},this.audioContext=i,this.checkForSilence()}mute(){const e=Object.create(null,{mute:{get:()=>super.mute}});return oo(this,void 0,void 0,(function*(){const t=yield this.muteLock.lock();try{return this.isMuted?(this.log.debug("Track already muted",this.logContext),this):(this.source===Ya.Source.Microphone&&this.stopOnMute&&!this.isUserProvided&&(this.log.debug("stopping mic track",this.logContext),this._mediaStreamTrack.stop()),yield e.mute.call(this),this)}finally{t()}}))}unmute(){const e=Object.create(null,{unmute:{get:()=>super.unmute}});return oo(this,void 0,void 0,(function*(){const t=yield this.muteLock.lock();try{if(!this.isMuted)return this.log.debug("Track already unmuted",this.logContext),this;const t=this._constraints.deviceId&&this._mediaStreamTrack.getSettings().deviceId!==As(this._constraints.deviceId);return this.source!==Ya.Source.Microphone||!this.stopOnMute&&"ended"!==this._mediaStreamTrack.readyState&&!t||this.isUserProvided||(this.log.debug("reacquiring mic track",this.logContext),yield this.restartTrack()),yield e.unmute.call(this),this}finally{t()}}))}restartTrack(e){return oo(this,void 0,void 0,(function*(){let t;if(e){const n=Ys({audio:e});"boolean"!=typeof n.audio&&(t=n.audio)}yield this.restart(t)}))}restart(e){const t=Object.create(null,{restart:{get:()=>super.restart}});return oo(this,void 0,void 0,(function*(){const n=yield t.restart.call(this,e);return this.checkForSilence(),n}))}startMonitor(){vs()&&(this.monitorInterval||(this.monitorInterval=setInterval((()=>{this.monitorSender()}),Xc)))}setProcessor(e){return oo(this,void 0,void 0,(function*(){var t;const n=yield this.trackChangeLock.lock();try{if(!bs()&&!this.audioContext)throw Error("Audio context needs to be set on LocalAudioTrack in order to enable processors");this.processor&&(yield this.internalStopProcessor());const n={kind:this.kind,track:this._mediaStreamTrack,audioContext:this.audioContext};this.log.debug("setting up audio processor ".concat(e.name),this.logContext),yield e.init(n),this.processor=e,this.processor.processedTrack&&(yield null===(t=this.sender)||void 0===t?void 0:t.replaceTrack(this.processor.processedTrack),this.processor.processedTrack.addEventListener("enable-lk-krisp-noise-filter",this.handleKrispNoiseFilterEnable),this.processor.processedTrack.addEventListener("disable-lk-krisp-noise-filter",this.handleKrispNoiseFilterDisable)),this.emit(Pa.TrackProcessorUpdate,this.processor)}finally{n()}}))}setAudioContext(e){this.audioContext=e}getSenderStats(){return oo(this,void 0,void 0,(function*(){var e;if(!(null===(e=this.sender)||void 0===e?void 0:e.getStats))return;let t;return(yield this.sender.getStats()).forEach((e=>{"outbound-rtp"===e.type&&(t={type:"audio",streamId:e.id,packetsSent:e.packetsSent,packetsLost:e.packetsLost,bytesSent:e.bytesSent,timestamp:e.timestamp,roundTripTime:e.roundTripTime,jitter:e.jitter})})),t}))}checkForSilence(){return oo(this,void 0,void 0,(function*(){const e=yield function(e){return oo(this,arguments,void 0,(function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:200;return function*(){const n=Xs();if(n){const i=n.createAnalyser();i.fftSize=2048;const r=i.frequencyBinCount,o=new Uint8Array(r);n.createMediaStreamSource(new MediaStream([e.mediaStreamTrack])).connect(i),yield cs(t),i.getByteTimeDomainData(o);const a=o.some((e=>128!==e&&0!==e));return n.close(),!a}return!1}()}))}(this);return e&&(this.isMuted||this.log.debug("silence detected on local audio track",this.logContext),this.emit(Pa.AudioSilenceDetected)),e}))}}const il=Object.values(rs),rl=Object.values(os),ol=Object.values(as),al=[rs.h180,rs.h360],sl=[os.h180,os.h360],cl=["q","h","f"];function ll(e,t,n,i){var r,o;let a=null==i?void 0:i.videoEncoding;e&&(a=null==i?void 0:i.screenShareEncoding);const s=null==i?void 0:i.simulcast,c=null==i?void 0:i.scalabilityMode,l=null==i?void 0:i.videoCodec;if(!a&&!s&&!c||!t||!n)return[{}];a||(a=function(e,t,n,i){const r=function(e,t,n){if(e)return ol;const i=t>n?t/n:n/t;return Math.abs(i-16/9)<Math.abs(i-4/3)?il:rl}(e,t,n);let{encoding:o}=r[0];const a=Math.max(t,n);for(let e=0;e<r.length;e+=1){const t=r[e];if(o=t.encoding,t.width>=a)break}if(i)switch(i){case"av1":case"h265":o=Object.assign({},o),o.maxBitrate=.7*o.maxBitrate;break;case"vp9":o=Object.assign({},o),o.maxBitrate=.85*o.maxBitrate}return o}(e,t,n,l),eo.debug("using video encoding",a));const d=a.maxFramerate,u=new Qa(t,n,a.maxBitrate,a.maxFramerate,a.priority);if(c&&us(l)){const e=new pl(c),t=[];if(e.spatial>3)throw new Error("unsupported scalabilityMode: ".concat(c));const n=qa();if(fs()||bs()||"Chrome"===(null==n?void 0:n.name)&&Ts(null==n?void 0:n.version,"113")<0){const i="h"==e.suffix?2:3,r=function(e){return e||(e=qa()),"Safari"===(null==e?void 0:e.name)&&Ts(e.version,"18.3")>0||"iOS"===(null==e?void 0:e.os)&&!!(null==e?void 0:e.osVersion)&&Ts(e.osVersion,"18.3")>0}(n);for(let n=0;n<e.spatial;n+=1)t.push({rid:cl[2-n],maxBitrate:a.maxBitrate/Math.pow(i,n),maxFramerate:u.encoding.maxFramerate,scaleResolutionDownBy:r?Math.pow(2,n):void 0});t[0].scalabilityMode=c}else t.push({maxBitrate:a.maxBitrate,maxFramerate:u.encoding.maxFramerate,scalabilityMode:c});return u.encoding.priority&&(t[0].priority=u.encoding.priority,t[0].networkPriority=u.encoding.priority),eo.debug("using svc encoding",{encodings:t}),t}if(!s)return[a];let h,p=[];if(p=e?null!==(r=hl(null==i?void 0:i.screenShareSimulcastLayers))&&void 0!==r?r:dl(e,u):null!==(o=hl(null==i?void 0:i.videoSimulcastLayers))&&void 0!==o?o:dl(e,u),p.length>0){const e=p[0];p.length>1&&([,h]=p);const i=Math.max(t,n);if(i>=960&&h)return ul(t,n,[e,h,u],d);if(i>=480)return ul(t,n,[e,u],d)}return ul(t,n,[u])}function dl(e,t){if(e)return[{scaleResolutionDownBy:2,fps:(n=t).encoding.maxFramerate}].map((e=>{var t,i;return new Qa(Math.floor(n.width/e.scaleResolutionDownBy),Math.floor(n.height/e.scaleResolutionDownBy),Math.max(15e4,Math.floor(n.encoding.maxBitrate/(Math.pow(e.scaleResolutionDownBy,2)*((null!==(t=n.encoding.maxFramerate)&&void 0!==t?t:30)/(null!==(i=e.fps)&&void 0!==i?i:30))))),e.fps,n.encoding.priority)}));var n;const{width:i,height:r}=t,o=i>r?i/r:r/i;return Math.abs(o-16/9)<Math.abs(o-4/3)?al:sl}function ul(e,t,n,i){const r=[];if(n.forEach(((n,o)=>{if(o>=cl.length)return;const a=Math.min(e,t),s={rid:cl[o],scaleResolutionDownBy:Math.max(1,a/Math.min(n.width,n.height)),maxBitrate:n.encoding.maxBitrate},c=i&&n.encoding.maxFramerate?Math.min(i,n.encoding.maxFramerate):n.encoding.maxFramerate;c&&(s.maxFramerate=c);const l=ps()||0===o;n.encoding.priority&&l&&(s.priority=n.encoding.priority,s.networkPriority=n.encoding.priority),r.push(s)})),bs()&&"ios"===ws()){let e;r.forEach((t=>{e?t.maxFramerate&&t.maxFramerate>e&&(e=t.maxFramerate):e=t.maxFramerate}));let t=!0;r.forEach((n=>{var i;n.maxFramerate!=e&&(t&&(t=!1,eo.info("Simulcast on iOS React-Native requires all encodings to share the same framerate.")),eo.info('Setting framerate of encoding "'.concat(null!==(i=n.rid)&&void 0!==i?i:"",'" to ').concat(e)),n.maxFramerate=e)}))}return r}function hl(e){if(e)return e.sort(((e,t)=>{const{encoding:n}=e,{encoding:i}=t;return n.maxBitrate>i.maxBitrate?1:n.maxBitrate<i.maxBitrate?-1:n.maxBitrate===i.maxBitrate&&n.maxFramerate&&i.maxFramerate?n.maxFramerate>i.maxFramerate?1:-1:0}))}class pl{constructor(e){const t=e.match(/^L(\d)T(\d)(h|_KEY|_KEY_SHIFT){0,1}$/);if(!t)throw new Error("invalid scalability mode");if(this.spatial=parseInt(t[1]),this.temporal=parseInt(t[2]),t.length>3)switch(t[3]){case"h":case"_KEY":case"_KEY_SHIFT":this.suffix=t[3]}}toString(){var e;return"L".concat(this.spatial,"T").concat(this.temporal).concat(null!==(e=this.suffix)&&void 0!==e?e:"")}}class ml extends tl{get sender(){return this._sender}set sender(e){this._sender=e,this.degradationPreference&&this.setDegradationPreference(this.degradationPreference)}constructor(e,t){let n=!(arguments.length>2&&void 0!==arguments[2])||arguments[2],i=arguments.length>3?arguments[3]:void 0;super(e,Ya.Kind.Video,t,n,i),this.simulcastCodecs=new Map,this.degradationPreference="balanced",this.isCpuConstrained=!1,this.optimizeForPerformance=!1,this.monitorSender=()=>oo(this,void 0,void 0,(function*(){if(!this.sender)return void(this._currentBitrate=0);let e;try{e=yield this.getSenderStats()}catch(e){return void this.log.error("could not get video sender stats",Object.assign(Object.assign({},this.logContext),{error:e}))}const t=new Map(e.map((e=>[e.rid,e]))),n=e.some((e=>"cpu"===e.qualityLimitationReason));if(n!==this.isCpuConstrained&&(this.isCpuConstrained=n,this.isCpuConstrained&&this.emit(Pa.CpuConstrained)),this.prevStats){let e=0;t.forEach(((t,n)=>{var i;const r=null===(i=this.prevStats)||void 0===i?void 0:i.get(n);e+=$c(t,r)})),this._currentBitrate=e}this.prevStats=t})),this.senderLock=new ht}get isSimulcast(){return!!(this.sender&&this.sender.getParameters().encodings.length>1)}startMonitor(e){var t;if(this.signalClient=e,!vs())return;const n=null===(t=this.sender)||void 0===t?void 0:t.getParameters();n&&(this.encodings=n.encodings),this.monitorInterval||(this.monitorInterval=setInterval((()=>{this.monitorSender()}),Xc))}stop(){this._mediaStreamTrack.getConstraints(),this.simulcastCodecs.forEach((e=>{e.mediaStreamTrack.stop()})),super.stop()}pauseUpstream(){const e=Object.create(null,{pauseUpstream:{get:()=>super.pauseUpstream}});return oo(this,void 0,void 0,(function*(){var t,n,i,r,o;yield e.pauseUpstream.call(this);try{for(var a,s=!0,c=ao(this.simulcastCodecs.values());!(t=(a=yield c.next()).done);s=!0){r=a.value,s=!1;const e=r;yield null===(o=e.sender)||void 0===o?void 0:o.replaceTrack(null)}}catch(e){n={error:e}}finally{try{s||t||!(i=c.return)||(yield i.call(c))}finally{if(n)throw n.error}}}))}resumeUpstream(){const e=Object.create(null,{resumeUpstream:{get:()=>super.resumeUpstream}});return oo(this,void 0,void 0,(function*(){var t,n,i,r,o;yield e.resumeUpstream.call(this);try{for(var a,s=!0,c=ao(this.simulcastCodecs.values());!(t=(a=yield c.next()).done);s=!0){r=a.value,s=!1;const e=r;yield null===(o=e.sender)||void 0===o?void 0:o.replaceTrack(e.mediaStreamTrack)}}catch(e){n={error:e}}finally{try{s||t||!(i=c.return)||(yield i.call(c))}finally{if(n)throw n.error}}}))}mute(){const e=Object.create(null,{mute:{get:()=>super.mute}});return oo(this,void 0,void 0,(function*(){const t=yield this.muteLock.lock();try{return this.isMuted?(this.log.debug("Track already muted",this.logContext),this):(this.source!==Ya.Source.Camera||this.isUserProvided||(this.log.debug("stopping camera track",this.logContext),this._mediaStreamTrack.stop()),yield e.mute.call(this),this)}finally{t()}}))}unmute(){const e=Object.create(null,{unmute:{get:()=>super.unmute}});return oo(this,void 0,void 0,(function*(){const t=yield this.muteLock.lock();try{return this.isMuted?(this.source!==Ya.Source.Camera||this.isUserProvided||(this.log.debug("reacquiring camera track",this.logContext),yield this.restartTrack()),yield e.unmute.call(this),this):(this.log.debug("Track already unmuted",this.logContext),this)}finally{t()}}))}setTrackMuted(e){super.setTrackMuted(e);for(const t of this.simulcastCodecs.values())t.mediaStreamTrack.enabled=!e}getSenderStats(){return oo(this,void 0,void 0,(function*(){var e;if(!(null===(e=this.sender)||void 0===e?void 0:e.getStats))return[];const t=[],n=yield this.sender.getStats();return n.forEach((e=>{var i;if("outbound-rtp"===e.type){const r={type:"video",streamId:e.id,frameHeight:e.frameHeight,frameWidth:e.frameWidth,framesPerSecond:e.framesPerSecond,framesSent:e.framesSent,firCount:e.firCount,pliCount:e.pliCount,nackCount:e.nackCount,packetsSent:e.packetsSent,bytesSent:e.bytesSent,qualityLimitationReason:e.qualityLimitationReason,qualityLimitationDurations:e.qualityLimitationDurations,qualityLimitationResolutionChanges:e.qualityLimitationResolutionChanges,rid:null!==(i=e.rid)&&void 0!==i?i:e.id,retransmittedPacketsSent:e.retransmittedPacketsSent,targetBitrate:e.targetBitrate,timestamp:e.timestamp},o=n.get(e.remoteId);o&&(r.jitter=o.jitter,r.packetsLost=o.packetsLost,r.roundTripTime=o.roundTripTime),t.push(r)}})),t.sort(((e,t)=>{var n,i;return(null!==(n=t.frameWidth)&&void 0!==n?n:0)-(null!==(i=e.frameWidth)&&void 0!==i?i:0)})),t}))}setPublishingQuality(e){const t=[];for(let n=Ja.LOW;n<=Ja.HIGH;n+=1)t.push(new kr({quality:n,enabled:n<=e}));this.log.debug("setting publishing quality. max quality ".concat(e),this.logContext),this.setPublishingLayers(us(this.codec),t)}restartTrack(e){return oo(this,void 0,void 0,(function*(){var t,n,i,r,o;let a;if(e){const t=Ys({video:e});"boolean"!=typeof t.video&&(a=t.video)}yield this.restart(a),this.isCpuConstrained=!1;try{for(var s,c=!0,l=ao(this.simulcastCodecs.values());!(t=(s=yield l.next()).done);c=!0){r=s.value,c=!1;const e=r;e.sender&&"closed"!==(null===(o=e.sender.transport)||void 0===o?void 0:o.state)&&(e.mediaStreamTrack=this.mediaStreamTrack.clone(),yield e.sender.replaceTrack(e.mediaStreamTrack))}}catch(e){n={error:e}}finally{try{c||t||!(i=l.return)||(yield i.call(l))}finally{if(n)throw n.error}}}))}setProcessor(e){const t=Object.create(null,{setProcessor:{get:()=>super.setProcessor}});return oo(this,arguments,void 0,(function(e){var n=this;let i=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];return function*(){var r,o,a,s,c,l;if(yield t.setProcessor.call(n,e,i),null===(c=n.processor)||void 0===c?void 0:c.processedTrack)try{for(var d,u=!0,h=ao(n.simulcastCodecs.values());!(r=(d=yield h.next()).done);u=!0){s=d.value,u=!1;const e=s;yield null===(l=e.sender)||void 0===l?void 0:l.replaceTrack(n.processor.processedTrack)}}catch(e){o={error:e}}finally{try{u||r||!(a=h.return)||(yield a.call(h))}finally{if(o)throw o.error}}}()}))}setDegradationPreference(e){return oo(this,void 0,void 0,(function*(){if(this.degradationPreference=e,this.sender)try{this.log.debug("setting degradationPreference to ".concat(e),this.logContext);const t=this.sender.getParameters();t.degradationPreference=e,this.sender.setParameters(t)}catch(e){this.log.warn("failed to set degradationPreference",Object.assign({error:e},this.logContext))}}))}addSimulcastTrack(e,t){if(this.simulcastCodecs.has(e))return void this.log.error("".concat(e," already added, skipping adding simulcast codec"),this.logContext);const n={codec:e,mediaStreamTrack:this.mediaStreamTrack.clone(),sender:void 0,encodings:t};return this.simulcastCodecs.set(e,n),n}setSimulcastTrackSender(e,t){const n=this.simulcastCodecs.get(e);n&&(n.sender=t,setTimeout((()=>{this.subscribedCodecs&&this.setPublishingCodecs(this.subscribedCodecs)}),5e3))}setPublishingCodecs(e){return oo(this,void 0,void 0,(function*(){var t,n,i,r,o,a,s;if(this.log.debug("setting publishing codecs",Object.assign(Object.assign({},this.logContext),{codecs:e,currentCodec:this.codec})),!this.codec&&e.length>0)return yield this.setPublishingLayers(us(e[0].codec),e[0].qualities),[];this.subscribedCodecs=e;const c=[];try{for(t=!0,n=ao(e);!(r=(i=yield n.next()).done);t=!0){s=i.value,t=!1;const e=s;if(this.codec&&this.codec!==e.codec){const t=this.simulcastCodecs.get(e.codec);if(this.log.debug("try setPublishingCodec for ".concat(e.codec),Object.assign(Object.assign({},this.logContext),{simulcastCodecInfo:t})),t&&t.sender)t.encodings&&(this.log.debug("try setPublishingLayersForSender ".concat(e.codec),this.logContext),yield fl(t.sender,t.encodings,e.qualities,this.senderLock,us(e.codec),this.log,this.logContext));else for(const t of e.qualities)if(t.enabled){c.push(e.codec);break}}else yield this.setPublishingLayers(us(e.codec),e.qualities)}}catch(e){o={error:e}}finally{try{t||r||!(a=n.return)||(yield a.call(n))}finally{if(o)throw o.error}}return c}))}setPublishingLayers(e,t){return oo(this,void 0,void 0,(function*(){this.optimizeForPerformance?this.log.info("skipping setPublishingLayers due to optimized publishing performance",Object.assign(Object.assign({},this.logContext),{qualities:t})):(this.log.debug("setting publishing layers",Object.assign(Object.assign({},this.logContext),{qualities:t})),this.sender&&this.encodings&&(yield fl(this.sender,this.encodings,t,this.senderLock,e,this.log,this.logContext)))}))}prioritizePerformance(){return oo(this,void 0,void 0,(function*(){if(!this.sender)throw new Error("sender not found");const e=yield this.senderLock.lock();try{this.optimizeForPerformance=!0;const e=this.sender.getParameters();e.encodings=e.encodings.map(((e,t)=>{var n;return Object.assign(Object.assign({},e),{active:0===t,scaleResolutionDownBy:Math.max(1,Math.ceil((null!==(n=this.mediaStreamTrack.getSettings().height)&&void 0!==n?n:360)/360)),scalabilityMode:0===t&&us(this.codec)?"L1T3":void 0,maxFramerate:0===t?15:0,maxBitrate:0===t?e.maxBitrate:0})})),this.log.debug("setting performance optimised encodings",Object.assign(Object.assign({},this.logContext),{encodings:e.encodings})),this.encodings=e.encodings,yield this.sender.setParameters(e)}catch(e){this.log.error("failed to set performance optimised encodings",Object.assign(Object.assign({},this.logContext),{error:e})),this.optimizeForPerformance=!1}finally{e()}}))}handleAppVisibilityChanged(){const e=Object.create(null,{handleAppVisibilityChanged:{get:()=>super.handleAppVisibilityChanged}});return oo(this,void 0,void 0,(function*(){yield e.handleAppVisibilityChanged.call(this),gs()&&this.isInBackground&&this.source===Ya.Source.Camera&&(this._mediaStreamTrack.enabled=!1)}))}}function fl(e,t,n,i,r,o,a){return oo(this,void 0,void 0,(function*(){const s=yield i.lock();o.debug("setPublishingLayersForSender",Object.assign(Object.assign({},a),{sender:e,qualities:n,senderEncodings:t}));try{const i=e.getParameters(),{encodings:s}=i;if(!s)return;if(s.length!==t.length)return void o.warn("cannot set publishing layers, encodings mismatch",Object.assign(Object.assign({},a),{encodings:s,senderEncodings:t}));let c=!1;if(r){const e=n.some((e=>e.enabled));e&&n.forEach((e=>e.enabled=!0))}s.forEach(((e,i)=>{var r;let s=null!==(r=e.rid)&&void 0!==r?r:"";""===s&&(s="q");const l=gl(s),d=n.find((e=>e.quality===l));d&&e.active!==d.enabled&&(c=!0,e.active=d.enabled,o.debug("setting layer ".concat(d.quality," to ").concat(e.active?"enabled":"disabled"),a),ps()&&(d.enabled?(e.scaleResolutionDownBy=t[i].scaleResolutionDownBy,e.maxBitrate=t[i].maxBitrate,e.maxFrameRate=t[i].maxFrameRate):(e.scaleResolutionDownBy=4,e.maxBitrate=10,e.maxFrameRate=2)))})),c&&(i.encodings=s,o.debug("setting encodings",Object.assign(Object.assign({},a),{encodings:i.encodings})),yield e.setParameters(i))}finally{s()}}))}function gl(e){switch(e){case"f":default:return Ja.HIGH;case"h":return Ja.MEDIUM;case"q":return Ja.LOW}}function vl(e,t,n,i){if(!n)return[new ui({quality:Ja.HIGH,width:e,height:t,bitrate:0,ssrc:0})];if(i){const i=n[0].scalabilityMode,r=new pl(i),o=[],a="h"==r.suffix?1.5:2,s="h"==r.suffix?2:3;for(let i=0;i<r.spatial;i+=1)o.push(new ui({quality:Math.min(Ja.HIGH,r.spatial-1)-i,width:Math.ceil(e/Math.pow(a,i)),height:Math.ceil(t/Math.pow(a,i)),bitrate:n[0].maxBitrate?Math.ceil(n[0].maxBitrate/Math.pow(s,i)):0,ssrc:0}));return o}return n.map((n=>{var i,r,o;const a=null!==(i=n.scaleResolutionDownBy)&&void 0!==i?i:1;let s=gl(null!==(r=n.rid)&&void 0!==r?r:"");return new ui({quality:s,width:Math.ceil(e/a),height:Math.ceil(t/a),bitrate:null!==(o=n.maxBitrate)&&void 0!==o?o:0,ssrc:0})}))}const bl="_lossy",yl="_reliable",kl="leave-reconnect";var wl,Cl,Tl,Sl;!function(e){e[e.New=0]="New",e[e.Connected=1]="Connected",e[e.Disconnected=2]="Disconnected",e[e.Reconnecting=3]="Reconnecting",e[e.Closed=4]="Closed"}(wl||(wl={}));class xl extends lo.EventEmitter{get isClosed(){return this._isClosed}get pendingReconnect(){return!!this.reconnectTimeout}constructor(e){var t;super(),this.options=e,this.rtcConfig={},this.peerConnectionTimeout=Hc.peerConnectionTimeout,this.fullReconnectOnNext=!1,this.latestRemoteOfferId=0,this.subscriberPrimary=!1,this.pcState=wl.New,this._isClosed=!0,this.pendingTrackResolvers={},this.reconnectAttempts=0,this.reconnectStart=0,this.attemptingReconnect=!1,this.joinAttempts=0,this.maxJoinAttempts=1,this.shouldFailNext=!1,this.log=eo,this.reliableDataSequence=1,this.reliableMessageBuffer=new vc,this.reliableReceivedState=new bc(3e4),this.midToTrackId={},this.handleDataChannel=e=>oo(this,[e],void 0,(function(e){var t=this;let{channel:n}=e;return function*(){if(n){if(n.label===yl)t.reliableDCSub=n;else{if(n.label!==bl)return;t.lossyDCSub=n}t.log.debug("on data channel ".concat(n.id,", ").concat(n.label),t.logContext),n.onmessage=t.handleDataMessage}}()})),this.handleDataMessage=e=>oo(this,void 0,void 0,(function*(){var t,n,i,r,o;const a=yield this.dataProcessLock.lock();try{let a;if(e.data instanceof ArrayBuffer)a=e.data;else{if(!(e.data instanceof Blob))return void this.log.error("unsupported data type",Object.assign(Object.assign({},this.logContext),{data:e.data}));a=yield e.data.arrayBuffer()}const s=pi.fromBinary(new Uint8Array(a));if(s.sequence>0&&""!==s.participantSid){const e=this.reliableReceivedState.get(s.participantSid);if(e&&s.sequence<=e)return;this.reliableReceivedState.set(s.participantSid,s.sequence)}if("speaker"===(null===(t=s.value)||void 0===t?void 0:t.case))this.emit(_a.ActiveSpeakersUpdate,s.value.value.speakers);else if("encryptedPacket"===(null===(n=s.value)||void 0===n?void 0:n.case)){if(!this.e2eeManager)return void this.log.error("Received encrypted packet but E2EE not set up",this.logContext);const e=yield null===(i=this.e2eeManager)||void 0===i?void 0:i.handleEncryptedData(s.value.value.encryptedValue,s.value.value.iv,s.participantIdentity,s.value.value.keyIndex),t=gi.fromBinary(e.payload),n=new pi({value:t.value,participantIdentity:s.participantIdentity,participantSid:s.participantSid});"user"===(null===(r=n.value)||void 0===r?void 0:r.case)&&_l(n,n.value.value),this.emit(_a.DataPacketReceived,n,s.value.value.encryptionType)}else"user"===(null===(o=s.value)||void 0===o?void 0:o.case)&&_l(s,s.value.value),this.emit(_a.DataPacketReceived,s,ci.NONE)}finally{a()}})),this.handleDataError=e=>{const t=0===e.currentTarget.maxRetransmits?"lossy":"reliable";if(e instanceof ErrorEvent&&e.error){const{error:n}=e.error;this.log.error("DataChannel error on ".concat(t,": ").concat(e.message),Object.assign(Object.assign({},this.logContext),{error:n}))}else this.log.error("Unknown DataChannel error on ".concat(t),Object.assign(Object.assign({},this.logContext),{event:e}))},this.handleBufferedAmountLow=e=>{const t=0===e.currentTarget.maxRetransmits?mi.LOSSY:mi.RELIABLE;this.updateAndEmitDCBufferStatus(t)},this.handleDisconnect=(e,t)=>{if(this._isClosed)return;this.log.warn("".concat(e," disconnected"),this.logContext),0===this.reconnectAttempts&&(this.reconnectStart=Date.now());const n=Date.now()-this.reconnectStart;let i=this.getNextRetryDelay({elapsedMs:n,retryCount:this.reconnectAttempts});null!==i?(e===kl&&(i=0),this.log.debug("reconnecting in ".concat(i,"ms"),this.logContext),this.clearReconnectTimeout(),this.token&&this.regionUrlProvider&&this.regionUrlProvider.updateToken(this.token),this.reconnectTimeout=Ga.setTimeout((()=>this.attemptReconnect(t).finally((()=>this.reconnectTimeout=void 0))),i)):(e=>{this.log.warn("could not recover connection after ".concat(this.reconnectAttempts," attempts, ").concat(e,"ms. giving up"),this.logContext),this.emit(_a.Disconnected),this.close()})(n)},this.waitForRestarted=()=>new Promise(((e,t)=>{this.pcState===wl.Connected&&e();const n=()=>{this.off(_a.Disconnected,i),e()},i=()=>{this.off(_a.Restarted,n),t()};this.once(_a.Restarted,n),this.once(_a.Disconnected,i)})),this.updateAndEmitDCBufferStatus=e=>{const t=this.isBufferStatusLow(e);void 0!==t&&t!==this.dcBufferStatus.get(e)&&(this.dcBufferStatus.set(e,t),this.emit(_a.DCBufferStatusChanged,t,e))},this.isBufferStatusLow=e=>{const t=this.dataChannelForKind(e);if(t)return e===mi.RELIABLE&&this.reliableMessageBuffer.alignBufferedAmount(t.bufferedAmount),t.bufferedAmount<=t.bufferedAmountLowThreshold},this.handleBrowserOnLine=()=>{this.client.currentState===pc.RECONNECTING&&(this.clearReconnectTimeout(),this.attemptReconnect(Qn.RR_SIGNAL_DISCONNECTED))},this.log=to(null!==(t=e.loggerName)&&void 0!==t?t:$r.Engine),this.loggerOptions={loggerName:e.loggerName,loggerContextCb:()=>this.logContext},this.client=new mc(void 0,this.loggerOptions),this.client.signalLatency=this.options.expSignalLatency,this.reconnectPolicy=this.options.reconnectPolicy,this.closingLock=new ht,this.dataProcessLock=new ht,this.dcBufferStatus=new Map([[mi.LOSSY,!0],[mi.RELIABLE,!0]]),this.client.onParticipantUpdate=e=>this.emit(_a.ParticipantUpdate,e),this.client.onConnectionQuality=e=>this.emit(_a.ConnectionQualityUpdate,e),this.client.onRoomUpdate=e=>this.emit(_a.RoomUpdate,e),this.client.onSubscriptionError=e=>this.emit(_a.SubscriptionError,e),this.client.onSubscriptionPermissionUpdate=e=>this.emit(_a.SubscriptionPermissionUpdate,e),this.client.onSpeakersChanged=e=>this.emit(_a.SpeakersChanged,e),this.client.onStreamStateUpdate=e=>this.emit(_a.StreamStateChanged,e),this.client.onRequestResponse=e=>this.emit(_a.SignalRequestResponse,e)}get logContext(){var e,t,n,i,r,o;return{room:null===(t=null===(e=this.latestJoinResponse)||void 0===e?void 0:e.room)||void 0===t?void 0:t.name,roomID:null===(i=null===(n=this.latestJoinResponse)||void 0===n?void 0:n.room)||void 0===i?void 0:i.sid,participant:null===(o=null===(r=this.latestJoinResponse)||void 0===r?void 0:r.participant)||void 0===o?void 0:o.identity,pID:this.participantSid}}join(e,t,n,i){return oo(this,void 0,void 0,(function*(){this.url=e,this.token=t,this.signalOpts=n,this.maxJoinAttempts=n.maxRetries;try{this.joinAttempts+=1,this.setupSignalClientCallbacks();const r=yield this.client.join(e,t,n,i);return this._isClosed=!1,this.latestJoinResponse=r,this.subscriberPrimary=r.subscriberPrimary,this.pcManager||(yield this.configure(r)),this.subscriberPrimary&&!r.fastPublish||this.negotiate().catch((e=>{eo.error(e,this.logContext)})),this.registerOnLineListener(),this.clientConfiguration=r.clientConfiguration,this.emit(_a.SignalConnected,r),r}catch(r){if(r instanceof Oa&&r.reason===wa.ServerUnreachable&&(this.log.warn("Couldn't connect to server, attempt ".concat(this.joinAttempts," of ").concat(this.maxJoinAttempts),this.logContext),this.joinAttempts<this.maxJoinAttempts))return this.join(e,t,n,i);throw r}}))}close(){return oo(this,void 0,void 0,(function*(){const e=yield this.closingLock.lock();if(this.isClosed)e();else try{this._isClosed=!0,this.joinAttempts=0,this.emit(_a.Closing),this.removeAllListeners(),this.deregisterOnLineListener(),this.clearPendingReconnect(),yield this.cleanupPeerConnections(),yield this.cleanupClient()}finally{e()}}))}cleanupPeerConnections(){return oo(this,void 0,void 0,(function*(){var e;yield null===(e=this.pcManager)||void 0===e?void 0:e.close(),this.pcManager=void 0;const t=e=>{e&&(e.close(),e.onbufferedamountlow=null,e.onclose=null,e.onclosing=null,e.onerror=null,e.onmessage=null,e.onopen=null)};t(this.lossyDC),t(this.lossyDCSub),t(this.reliableDC),t(this.reliableDCSub),this.lossyDC=void 0,this.lossyDCSub=void 0,this.reliableDC=void 0,this.reliableDCSub=void 0,this.reliableMessageBuffer=new vc,this.reliableDataSequence=1,this.reliableReceivedState.clear()}))}cleanupClient(){return oo(this,void 0,void 0,(function*(){yield this.client.close(),this.client.resetCallbacks()}))}addTrack(e){if(this.pendingTrackResolvers[e.cid])throw new Ma("a track with the same ID has already been published");return new Promise(((t,n)=>{const i=setTimeout((()=>{delete this.pendingTrackResolvers[e.cid],n(new Oa("publication of local track timed out, no response from server",wa.Timeout))}),1e4);this.pendingTrackResolvers[e.cid]={resolve:e=>{clearTimeout(i),t(e)},reject:()=>{clearTimeout(i),n(new Error("Cancelled publication by calling unpublish"))}},this.client.sendAddTrack(e)}))}removeTrack(e){if(e.track&&this.pendingTrackResolvers[e.track.id]){const{reject:t}=this.pendingTrackResolvers[e.track.id];t&&t(),delete this.pendingTrackResolvers[e.track.id]}try{return this.pcManager.removeTrack(e),!0}catch(e){this.log.warn("failed to remove track",Object.assign(Object.assign({},this.logContext),{error:e}))}return!1}updateMuteStatus(e,t){this.client.sendMuteTrack(e,t)}get dataSubscriberReadyState(){var e;return null===(e=this.reliableDCSub)||void 0===e?void 0:e.readyState}getConnectedServerAddress(){return oo(this,void 0,void 0,(function*(){var e;return null===(e=this.pcManager)||void 0===e?void 0:e.getConnectedAddress()}))}setRegionUrlProvider(e){this.regionUrlProvider=e}configure(e){return oo(this,void 0,void 0,(function*(){var t,n;if(this.pcManager&&this.pcManager.currentState!==zc.NEW)return;this.participantSid=null===(t=e.participant)||void 0===t?void 0:t.sid;const i=this.makeRTCConfiguration(e);var r;this.pcManager=new Gc(i,this.options.singlePeerConnection?"publisher-only":e.subscriberPrimary?"subscriber-primary":"publisher-primary",this.loggerOptions),this.emit(_a.TransportsCreated,this.pcManager.publisher,this.pcManager.subscriber),this.pcManager.onIceCandidate=(e,t)=>{this.client.sendIceCandidate(e,t)},this.pcManager.onPublisherOffer=(e,t)=>{this.client.sendOffer(e,t)},this.pcManager.onDataChannel=this.handleDataChannel,this.pcManager.onStateChange=(t,n,i)=>oo(this,void 0,void 0,(function*(){if(this.log.debug("primary PC state changed ".concat(t),this.logContext),["closed","disconnected","failed"].includes(n)&&(this.publisherConnectionPromise=void 0),t===zc.CONNECTED){const t=this.pcState===wl.New;this.pcState=wl.Connected,t&&this.emit(_a.Connected,e)}else t===zc.FAILED&&(this.pcState!==wl.Connected&&this.pcState!==wl.Reconnecting||(this.pcState=wl.Disconnected,this.handleDisconnect("peerconnection failed","failed"===i?Qn.RR_SUBSCRIBER_FAILED:Qn.RR_PUBLISHER_FAILED)));const r=this.client.isDisconnected||this.client.currentState===pc.RECONNECTING,o=[zc.FAILED,zc.CLOSING,zc.CLOSED].includes(t);r&&o&&!this._isClosed&&this.emit(_a.Offline)})),this.pcManager.onTrack=e=>{0!==e.streams.length&&this.emit(_a.MediaTrackAdded,e.track,e.streams[0],e.receiver)},void 0!==(r=null===(n=e.serverInfo)||void 0===n?void 0:n.protocol)&&r>13||this.createDataChannels()}))}setupSignalClientCallbacks(){this.client.onAnswer=(e,t,n)=>oo(this,void 0,void 0,(function*(){this.pcManager&&(this.log.debug("received server answer",Object.assign(Object.assign({},this.logContext),{RTCSdpType:e.type,sdp:e.sdp,midToTrackId:n})),this.midToTrackId=n,yield this.pcManager.setPublisherAnswer(e,t))})),this.client.onTrickle=(e,t)=>{this.pcManager&&(this.log.debug("got ICE candidate from peer",Object.assign(Object.assign({},this.logContext),{candidate:e,target:t})),this.pcManager.addIceCandidate(e,t))},this.client.onOffer=(e,t,n)=>oo(this,void 0,void 0,(function*(){if(this.latestRemoteOfferId=t,!this.pcManager)return;this.midToTrackId=n;const i=yield this.pcManager.createSubscriberAnswerFromOffer(e,t);i&&this.client.sendAnswer(i,t)})),this.client.onLocalTrackPublished=e=>{var t;if(this.log.debug("received trackPublishedResponse",Object.assign(Object.assign({},this.logContext),{cid:e.cid,track:null===(t=e.track)||void 0===t?void 0:t.sid})),!this.pendingTrackResolvers[e.cid])return void this.log.error("missing track resolver for ".concat(e.cid),Object.assign(Object.assign({},this.logContext),{cid:e.cid}));const{resolve:n}=this.pendingTrackResolvers[e.cid];delete this.pendingTrackResolvers[e.cid],n(e.track)},this.client.onLocalTrackUnpublished=e=>{this.emit(_a.LocalTrackUnpublished,e)},this.client.onLocalTrackSubscribed=e=>{this.emit(_a.LocalTrackSubscribed,e)},this.client.onTokenRefresh=e=>{this.token=e},this.client.onRemoteMuteChanged=(e,t)=>{this.emit(_a.RemoteMute,e,t)},this.client.onSubscribedQualityUpdate=e=>{this.emit(_a.SubscribedQualityUpdate,e)},this.client.onRoomMoved=e=>{var t;this.participantSid=null===(t=e.participant)||void 0===t?void 0:t.sid,this.latestJoinResponse&&(this.latestJoinResponse.room=e.room),this.emit(_a.RoomMoved,e)},this.client.onMediaSectionsRequirement=e=>{var t,n;const i={direction:"recvonly"};for(let n=0;n<e.numAudios;n++)null===(t=this.pcManager)||void 0===t||t.addPublisherTransceiverOfKind("audio",i);for(let t=0;t<e.numVideos;t++)null===(n=this.pcManager)||void 0===n||n.addPublisherTransceiverOfKind("video",i);this.negotiate()},this.client.onClose=()=>{this.handleDisconnect("signal",Qn.RR_SIGNAL_DISCONNECTED)},this.client.onLeave=e=>{switch(this.log.debug("client leave request",Object.assign(Object.assign({},this.logContext),{reason:null==e?void 0:e.reason})),e.regions&&this.regionUrlProvider&&(this.log.debug("updating regions",this.logContext),this.regionUrlProvider.setServerReportedRegions(e.regions)),e.action){case dr.DISCONNECT:this.emit(_a.Disconnected,null==e?void 0:e.reason),this.close();break;case dr.RECONNECT:this.fullReconnectOnNext=!0,this.handleDisconnect(kl);break;case dr.RESUME:this.handleDisconnect(kl)}}}makeRTCConfiguration(e){var t;const n=Object.assign({},this.rtcConfig);if((null===(t=this.signalOpts)||void 0===t?void 0:t.e2eeEnabled)&&(this.log.debug("E2EE - setting up transports with insertable streams",this.logContext),n.encodedInsertableStreams=!0),e.iceServers&&!n.iceServers){const t=[];e.iceServers.forEach((e=>{const n={urls:e.urls};e.username&&(n.username=e.username),e.credential&&(n.credential=e.credential),t.push(n)})),n.iceServers=t}return e.clientConfiguration&&e.clientConfiguration.forceRelay===Xn.ENABLED&&(n.iceTransportPolicy="relay"),n.sdpSemantics="unified-plan",n.continualGatheringPolicy="gather_continually",n}createDataChannels(){this.pcManager&&(this.lossyDC&&(this.lossyDC.onmessage=null,this.lossyDC.onerror=null),this.reliableDC&&(this.reliableDC.onmessage=null,this.reliableDC.onerror=null),this.lossyDC=this.pcManager.createPublisherDataChannel(bl,{ordered:!1,maxRetransmits:0}),this.reliableDC=this.pcManager.createPublisherDataChannel(yl,{ordered:!0}),this.lossyDC.onmessage=this.handleDataMessage,this.reliableDC.onmessage=this.handleDataMessage,this.lossyDC.onerror=this.handleDataError,this.reliableDC.onerror=this.handleDataError,this.lossyDC.bufferedAmountLowThreshold=65535,this.reliableDC.bufferedAmountLowThreshold=65535,this.lossyDC.onbufferedamountlow=this.handleBufferedAmountLow,this.reliableDC.onbufferedamountlow=this.handleBufferedAmountLow)}createSender(e,t,n){return oo(this,void 0,void 0,(function*(){if(ls())return yield this.createTransceiverRTCRtpSender(e,t,n);if(ds())return this.log.warn("using add-track fallback",this.logContext),yield this.createRTCRtpSender(e.mediaStreamTrack);throw new Na("Required webRTC APIs not supported on this device")}))}createSimulcastSender(e,t,n,i){return oo(this,void 0,void 0,(function*(){if(ls())return this.createSimulcastTransceiverSender(e,t,n,i);if(ds())return this.log.debug("using add-track fallback",this.logContext),this.createRTCRtpSender(e.mediaStreamTrack);throw new Na("Cannot stream on this device")}))}createTransceiverRTCRtpSender(e,t,n){return oo(this,void 0,void 0,(function*(){if(!this.pcManager)throw new Na("publisher is closed");const i=[];e.mediaStream&&i.push(e.mediaStream),Vs(e)&&(e.codec=t.videoCodec);const r={direction:"sendonly",streams:i};return n&&(r.sendEncodings=n),(yield this.pcManager.addPublisherTransceiver(e.mediaStreamTrack,r)).sender}))}createSimulcastTransceiverSender(e,t,n,i){return oo(this,void 0,void 0,(function*(){if(!this.pcManager)throw new Na("publisher is closed");const r={direction:"sendonly"};i&&(r.sendEncodings=i);const o=yield this.pcManager.addPublisherTransceiver(t.mediaStreamTrack,r);if(n.videoCodec)return e.setSimulcastTrackSender(n.videoCodec,o.sender),o.sender}))}createRTCRtpSender(e){return oo(this,void 0,void 0,(function*(){if(!this.pcManager)throw new Na("publisher is closed");return this.pcManager.addPublisherTrack(e)}))}attemptReconnect(e){return oo(this,void 0,void 0,(function*(){var t,n,i;if(!this._isClosed)if(this.attemptingReconnect)eo.warn("already attempting reconnect, returning early",this.logContext);else{(null===(t=this.clientConfiguration)||void 0===t?void 0:t.resumeConnection)!==Xn.DISABLED&&(null!==(i=null===(n=this.pcManager)||void 0===n?void 0:n.currentState)&&void 0!==i?i:zc.NEW)!==zc.NEW||(this.fullReconnectOnNext=!0);try{this.attemptingReconnect=!0,this.fullReconnectOnNext?yield this.restartConnection():yield this.resumeConnection(e),this.clearPendingReconnect(),this.fullReconnectOnNext=!1}catch(e){this.reconnectAttempts+=1;let t=!0;e instanceof Na?(this.log.debug("received unrecoverable error",Object.assign(Object.assign({},this.logContext),{error:e})),t=!1):e instanceof El||(this.fullReconnectOnNext=!0),t?this.handleDisconnect("reconnect",Qn.RR_UNKNOWN):(this.log.info("could not recover connection after ".concat(this.reconnectAttempts," attempts, ").concat(Date.now()-this.reconnectStart,"ms. giving up"),this.logContext),this.emit(_a.Disconnected),yield this.close())}finally{this.attemptingReconnect=!1}}}))}getNextRetryDelay(e){try{return this.reconnectPolicy.nextRetryDelayInMs(e)}catch(e){this.log.warn("encountered error in reconnect policy",Object.assign(Object.assign({},this.logContext),{error:e}))}return null}restartConnection(e){return oo(this,void 0,void 0,(function*(){var t,n,i;try{if(!this.url||!this.token)throw new Na("could not reconnect, url or token not saved");let n;this.log.info("reconnecting, attempt: ".concat(this.reconnectAttempts),this.logContext),this.emit(_a.Restarting),this.client.isDisconnected||(yield this.client.sendLeave()),yield this.cleanupPeerConnections(),yield this.cleanupClient();try{if(!this.signalOpts)throw this.log.warn("attempted connection restart, without signal options present",this.logContext),new El;n=yield this.join(null!=e?e:this.url,this.token,this.signalOpts)}catch(e){if(e instanceof Oa&&e.reason===wa.NotAllowed)throw new Na("could not reconnect, token might be expired");throw new El}if(this.shouldFailNext)throw this.shouldFailNext=!1,new Error("simulated failure");if(this.client.setReconnected(),this.emit(_a.SignalRestarted,n),yield this.waitForPCReconnected(),this.client.currentState!==pc.CONNECTED)throw new El("Signal connection got severed during reconnect");null===(t=this.regionUrlProvider)||void 0===t||t.resetAttempts(),this.emit(_a.Restarted)}catch(e){const t=yield null===(n=this.regionUrlProvider)||void 0===n?void 0:n.getNextBestRegionUrl();if(t)return void(yield this.restartConnection(t));throw null===(i=this.regionUrlProvider)||void 0===i||i.resetAttempts(),e}}))}resumeConnection(e){return oo(this,void 0,void 0,(function*(){var t;if(!this.url||!this.token)throw new Na("could not reconnect, url or token not saved");if(!this.pcManager)throw new Na("publisher and subscriber connections unset");let n;this.log.info("resuming signal connection, attempt ".concat(this.reconnectAttempts),this.logContext),this.emit(_a.Resuming);try{this.setupSignalClientCallbacks(),n=yield this.client.reconnect(this.url,this.token,this.participantSid,e)}catch(e){let t="";if(e instanceof Error&&(t=e.message,this.log.error(e.message,Object.assign(Object.assign({},this.logContext),{error:e}))),e instanceof Oa&&e.reason===wa.NotAllowed)throw new Na("could not reconnect, token might be expired");if(e instanceof Oa&&e.reason===wa.LeaveRequest)throw e;throw new El(t)}if(this.emit(_a.SignalResumed),n){const e=this.makeRTCConfiguration(n);this.pcManager.updateConfiguration(e),this.latestJoinResponse&&(this.latestJoinResponse.serverInfo=n.serverInfo)}else this.log.warn("Did not receive reconnect response",this.logContext);if(this.shouldFailNext)throw this.shouldFailNext=!1,new Error("simulated failure");if(yield this.pcManager.triggerIceRestart(),yield this.waitForPCReconnected(),this.client.currentState!==pc.CONNECTED)throw new El("Signal connection got severed during reconnect");this.client.setReconnected(),"open"===(null===(t=this.reliableDC)||void 0===t?void 0:t.readyState)&&null===this.reliableDC.id&&this.createDataChannels(),(null==n?void 0:n.lastMessageSeq)&&this.resendReliableMessagesForResume(n.lastMessageSeq),this.emit(_a.Resumed)}))}waitForPCInitialConnection(e,t){return oo(this,void 0,void 0,(function*(){if(!this.pcManager)throw new Na("PC manager is closed");yield this.pcManager.ensurePCTransportConnection(t,e)}))}waitForPCReconnected(){return oo(this,void 0,void 0,(function*(){this.pcState=wl.Reconnecting,this.log.debug("waiting for peer connection to reconnect",this.logContext);try{if(yield cs(2e3),!this.pcManager)throw new Na("PC manager is closed");yield this.pcManager.ensurePCTransportConnection(void 0,this.peerConnectionTimeout),this.pcState=wl.Connected}catch(e){throw this.pcState=wl.Disconnected,new Oa("could not establish PC connection, ".concat(e.message),wa.InternalError)}}))}publishRpcResponse(e,t,n,i){return oo(this,void 0,void 0,(function*(){const r=new pi({destinationIdentities:[e],kind:mi.RELIABLE,value:{case:"rpcResponse",value:new Ei({requestId:t,value:i?{case:"error",value:i.toProto()}:{case:"payload",value:null!=n?n:""}})}});yield this.sendDataPacket(r,mi.RELIABLE)}))}publishRpcAck(e,t){return oo(this,void 0,void 0,(function*(){const n=new pi({destinationIdentities:[e],kind:mi.RELIABLE,value:{case:"rpcAck",value:new xi({requestId:t})}});yield this.sendDataPacket(n,mi.RELIABLE)}))}sendDataPacket(e,t){return oo(this,void 0,void 0,(function*(){if(yield this.ensurePublisherConnected(t),this.e2eeManager&&this.e2eeManager.isDataChannelEncryptionEnabled){const t=function(e){var t,n,i,r,o;if("sipDtmf"!==(null===(t=e.value)||void 0===t?void 0:t.case)&&"metrics"!==(null===(n=e.value)||void 0===n?void 0:n.case)&&"speaker"!==(null===(i=e.value)||void 0===i?void 0:i.case)&&"transcription"!==(null===(r=e.value)||void 0===r?void 0:r.case)&&"encryptedPacket"!==(null===(o=e.value)||void 0===o?void 0:o.case))return new gi({value:e.value})}(e);if(t){const n=yield this.e2eeManager.encryptData(t.toBinary());e.value={case:"encryptedPacket",value:new fi({encryptedValue:n.payload,iv:n.iv,keyIndex:n.keyIndex})}}}t===mi.RELIABLE&&(e.sequence=this.reliableDataSequence,this.reliableDataSequence+=1);const n=e.toBinary(),i=this.dataChannelForKind(t);if(i){if(t===mi.RELIABLE&&this.reliableMessageBuffer.push({data:n,sequence:e.sequence}),this.attemptingReconnect)return;i.send(n)}this.updateAndEmitDCBufferStatus(t)}))}resendReliableMessagesForResume(e){return oo(this,void 0,void 0,(function*(){yield this.ensurePublisherConnected(mi.RELIABLE);const t=this.dataChannelForKind(mi.RELIABLE);t&&(this.reliableMessageBuffer.popToSequence(e),this.reliableMessageBuffer.getAll().forEach((e=>{t.send(e.data)}))),this.updateAndEmitDCBufferStatus(mi.RELIABLE)}))}waitForBufferStatusLow(e){return new Promise(((t,n)=>oo(this,void 0,void 0,(function*(){if(this.isBufferStatusLow(e))t();else{const i=()=>n("Engine closed");for(this.once(_a.Closing,i);!this.dcBufferStatus.get(e);)yield cs(10);this.off(_a.Closing,i),t()}}))))}ensureDataTransportConnected(e){return oo(this,arguments,void 0,(function(e){var t=this;let n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:this.subscriberPrimary;return function*(){var i;if(!t.pcManager)throw new Na("PC manager is closed");const r=n?t.pcManager.subscriber:t.pcManager.publisher,o=n?"Subscriber":"Publisher";if(!r)throw new Oa("".concat(o," connection not set"),wa.InternalError);let a=!1;n||t.dataChannelForKind(e,n)||(t.createDataChannels(),a=!0),a||n||t.pcManager.publisher.isICEConnected||"checking"===t.pcManager.publisher.getICEConnectionState()||(a=!0),a&&t.negotiate().catch((e=>{eo.error(e,t.logContext)}));const s=t.dataChannelForKind(e,n);if("open"===(null==s?void 0:s.readyState))return;const c=(new Date).getTime()+t.peerConnectionTimeout;for(;(new Date).getTime()<c;){if(r.isICEConnected&&"open"===(null===(i=t.dataChannelForKind(e,n))||void 0===i?void 0:i.readyState))return;yield cs(50)}throw new Oa("could not establish ".concat(o," connection, state: ").concat(r.getICEConnectionState()),wa.InternalError)}()}))}ensurePublisherConnected(e){return oo(this,void 0,void 0,(function*(){this.publisherConnectionPromise||(this.publisherConnectionPromise=this.ensureDataTransportConnected(e,!1)),yield this.publisherConnectionPromise}))}verifyTransport(){return!!this.pcManager&&this.pcManager.currentState===zc.CONNECTED&&!(!this.client.ws||this.client.ws.readyState===WebSocket.CLOSED)}negotiate(){return oo(this,void 0,void 0,(function*(){return new Promise(((e,t)=>oo(this,void 0,void 0,(function*(){if(!this.pcManager)return void t(new La("PC manager is closed"));this.pcManager.requirePublisher(),0!=this.pcManager.publisher.getTransceivers().length||this.lossyDC||this.reliableDC||this.createDataChannels();const n=new AbortController,i=()=>{n.abort(),this.log.debug("engine disconnected while negotiation was ongoing",this.logContext),e()};this.isClosed&&t("cannot negotiate on closed engine"),this.on(_a.Closing,i),this.pcManager.publisher.once(Ac,(e=>{const t=new Map;e.forEach((e=>{const n=e.codec.toLowerCase();var i;i=n,es.includes(i)&&t.set(e.payload,n)})),this.emit(_a.RTPVideoMapUpdate,t)}));try{yield this.pcManager.negotiate(n),e()}catch(e){e instanceof La&&(this.fullReconnectOnNext=!0),this.handleDisconnect("negotiation",Qn.RR_UNKNOWN),t(e)}finally{this.off(_a.Closing,i)}}))))}))}dataChannelForKind(e,t){if(t){if(e===mi.LOSSY)return this.lossyDCSub;if(e===mi.RELIABLE)return this.reliableDCSub}else{if(e===mi.LOSSY)return this.lossyDC;if(e===mi.RELIABLE)return this.reliableDC}}sendSyncState(e,t){var n,i,r,o;if(!this.pcManager)return void this.log.warn("sync state cannot be sent without peer connection setup",this.logContext);const a=this.pcManager.publisher.getLocalDescription(),s=this.pcManager.publisher.getRemoteDescription(),c=null===(n=this.pcManager.subscriber)||void 0===n?void 0:n.getRemoteDescription(),l=null===(i=this.pcManager.subscriber)||void 0===i?void 0:i.getLocalDescription(),d=null===(o=null===(r=this.signalOpts)||void 0===r?void 0:r.autoSubscribe)||void 0===o||o,u=new Array,h=new Array;e.forEach((e=>{e.isDesired!==d&&u.push(e.trackSid),e.isEnabled||h.push(e.trackSid)})),this.client.sendSyncState(new Pr({answer:this.options.singlePeerConnection?s?gc({sdp:s.sdp,type:s.type}):void 0:l?gc({sdp:l.sdp,type:l.type}):void 0,offer:this.options.singlePeerConnection?a?gc({sdp:a.sdp,type:a.type}):void 0:c?gc({sdp:c.sdp,type:c.type}):void 0,subscription:new or({trackSids:u,subscribe:!d,participantTracks:[]}),publishTracks:ec(t),dataChannels:this.dataChannelsInfo(),trackSidsDisabled:h,datachannelReceiveStates:this.reliableReceivedState.map(((e,t)=>new Rr({publisherSid:t,lastSeq:e})))}))}failNext(){this.shouldFailNext=!0}dataChannelsInfo(){const e=[],t=(t,n)=>{void 0!==(null==t?void 0:t.id)&&null!==t.id&&e.push(new Ir({label:t.label,id:t.id,target:n}))};return t(this.dataChannelForKind(mi.LOSSY),Hi.PUBLISHER),t(this.dataChannelForKind(mi.RELIABLE),Hi.PUBLISHER),t(this.dataChannelForKind(mi.LOSSY,!0),Hi.SUBSCRIBER),t(this.dataChannelForKind(mi.RELIABLE,!0),Hi.SUBSCRIBER),e}clearReconnectTimeout(){this.reconnectTimeout&&Ga.clearTimeout(this.reconnectTimeout)}clearPendingReconnect(){this.clearReconnectTimeout(),this.reconnectAttempts=0}registerOnLineListener(){vs()&&window.addEventListener("online",this.handleBrowserOnLine)}deregisterOnLineListener(){vs()&&window.removeEventListener("online",this.handleBrowserOnLine)}getTrackIdForReceiver(e){var t;const n=null===(t=this.pcManager)||void 0===t?void 0:t.getMidForReceiver(e);if(n){const e=Object.entries(this.midToTrackId).find((e=>{let[t]=e;return t===n}));if(e)return e[1]}}}class El extends Error{}function _l(e,t){const n=e.participantIdentity?e.participantIdentity:t.participantIdentity;e.participantIdentity=n,t.participantIdentity=n;const i=0!==e.destinationIdentities.length?e.destinationIdentities:t.destinationIdentities;e.destinationIdentities=i,t.destinationIdentities=i}class Pl{constructor(e,t){this.lastUpdateAt=0,this.settingsCacheTime=3e3,this.attemptedRegions=[],this.serverUrl=new URL(e),this.token=t}updateToken(e){this.token=e}isCloud(){return ys(this.serverUrl)}getServerUrl(){return this.serverUrl}getNextBestRegionUrl(e){return oo(this,void 0,void 0,(function*(){if(!this.isCloud())throw Error("region availability is only supported for LiveKit Cloud domains");(!this.regionSettings||Date.now()-this.lastUpdateAt>this.settingsCacheTime)&&(this.regionSettings=yield this.fetchRegionSettings(e));const t=this.regionSettings.regions.filter((e=>!this.attemptedRegions.find((t=>t.url===e.url))));if(t.length>0){const e=t[0];return this.attemptedRegions.push(e),eo.debug("next region: ".concat(e.region)),e.url}return null}))}resetAttempts(){this.attemptedRegions=[]}fetchRegionSettings(e){return oo(this,void 0,void 0,(function*(){const t=yield fetch("".concat((n=this.serverUrl,"".concat(n.protocol.replace("ws","http"),"//").concat(n.host,"/settings")),"/regions"),{headers:{authorization:"Bearer ".concat(this.token)},signal:e});var n;if(t.ok){const e=yield t.json();return this.lastUpdateAt=Date.now(),e}throw new Oa("Could not fetch region settings: ".concat(t.statusText),401===t.status?wa.NotAllowed:wa.InternalError,t.status)}))}setServerReportedRegions(e){this.regionSettings=e,this.lastUpdateAt=Date.now()}}class Rl{get info(){return this._info}validateBytesReceived(){let e=arguments.length>0&&void 0!==arguments[0]&&arguments[0];if("number"==typeof this.totalByteSize&&0!==this.totalByteSize){if(e&&this.bytesReceived<this.totalByteSize)throw new Fa("Not enough chunk(s) received - expected ".concat(this.totalByteSize," bytes of data total, only received ").concat(this.bytesReceived," bytes"),Ca.Incomplete);if(this.bytesReceived>this.totalByteSize)throw new Fa("Extra chunk(s) received - expected ".concat(this.totalByteSize," bytes of data total, received ").concat(this.bytesReceived," bytes"),Ca.LengthExceeded)}}constructor(e,t,n,i){this.reader=t,this.totalByteSize=n,this._info=e,this.bytesReceived=0,this.outOfBandFailureRejectingFuture=i}}class Il extends Rl{handleChunkReceived(e){var t;this.bytesReceived+=e.content.byteLength,this.validateBytesReceived();const n=this.totalByteSize?this.bytesReceived/this.totalByteSize:void 0;null===(t=this.onProgress)||void 0===t||t.call(this,n)}[Symbol.asyncIterator](){const e=this.reader.getReader();let t=new Ms,n=null,i=null;if(this.signal){const e=this.signal;i=()=>{var n;null===(n=t.reject)||void 0===n||n.call(t,e.reason)},e.addEventListener("abort",i),n=e}const r=()=>{e.releaseLock(),n&&i&&n.removeEventListener("abort",i),this.signal=void 0};return{next:()=>oo(this,void 0,void 0,(function*(){var n,i;try{const{done:r,value:o}=yield Promise.race([e.read(),t.promise,null!==(i=null===(n=this.outOfBandFailureRejectingFuture)||void 0===n?void 0:n.promise)&&void 0!==i?i:new Promise((()=>{}))]);return r?(this.validateBytesReceived(!0),{done:!0,value:void 0}):(this.handleChunkReceived(o),{done:!1,value:o.content})}catch(e){throw r(),e}})),return(){return oo(this,void 0,void 0,(function*(){return r(),{done:!0,value:void 0}}))}}}withAbortSignal(e){return this.signal=e,this}readAll(){return oo(this,arguments,void 0,(function(){var e=this;let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return function*(){var n,i,r,o;let a=new Set;const s=t.signal?e.withAbortSignal(t.signal):e;try{for(var c,l=!0,d=ao(s);!(n=(c=yield d.next()).done);l=!0){o=c.value,l=!1;const e=o;a.add(e)}}catch(e){i={error:e}}finally{try{l||n||!(r=d.return)||(yield r.call(d))}finally{if(i)throw i.error}}return Array.from(a)}()}))}}class Ol extends Rl{constructor(e,t,n,i){super(e,t,n,i),this.receivedChunks=new Map}handleChunkReceived(e){var t;const n=js(e.chunkIndex),i=this.receivedChunks.get(n);if(i&&i.version>e.version)return;this.receivedChunks.set(n,e),this.bytesReceived+=e.content.byteLength,this.validateBytesReceived();const r=this.totalByteSize?this.bytesReceived/this.totalByteSize:void 0;null===(t=this.onProgress)||void 0===t||t.call(this,r)}[Symbol.asyncIterator](){const e=this.reader.getReader(),t=new TextDecoder("utf-8",{fatal:!0});let n=new Ms,i=null,r=null;if(this.signal){const e=this.signal;r=()=>{var t;null===(t=n.reject)||void 0===t||t.call(n,e.reason)},e.addEventListener("abort",r),i=e}const o=()=>{e.releaseLock(),i&&r&&i.removeEventListener("abort",r),this.signal=void 0};return{next:()=>oo(this,void 0,void 0,(function*(){var i,r;try{const{done:o,value:a}=yield Promise.race([e.read(),n.promise,null!==(r=null===(i=this.outOfBandFailureRejectingFuture)||void 0===i?void 0:i.promise)&&void 0!==r?r:new Promise((()=>{}))]);if(o)return this.validateBytesReceived(!0),{done:!0,value:void 0};{let e;this.handleChunkReceived(a);try{e=t.decode(a.content)}catch(e){throw new Fa("Cannot decode datastream chunk ".concat(a.chunkIndex," as text: ").concat(e),Ca.DecodeFailed)}return{done:!1,value:e}}}catch(e){throw o(),e}})),return(){return oo(this,void 0,void 0,(function*(){return o(),{done:!0,value:void 0}}))}}}withAbortSignal(e){return this.signal=e,this}readAll(){return oo(this,arguments,void 0,(function(){var e=this;let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return function*(){var n,i,r,o;let a="";const s=t.signal?e.withAbortSignal(t.signal):e;try{for(var c,l=!0,d=ao(s);!(n=(c=yield d.next()).done);l=!0)o=c.value,l=!1,a+=o}catch(e){i={error:e}}finally{try{l||n||!(r=d.return)||(yield r.call(d))}finally{if(i)throw i.error}}return a}()}))}}class Dl{constructor(){this.log=eo,this.byteStreamControllers=new Map,this.textStreamControllers=new Map,this.byteStreamHandlers=new Map,this.textStreamHandlers=new Map}registerTextStreamHandler(e,t){if(this.textStreamHandlers.has(e))throw new Fa('A text stream handler for topic "'.concat(e,'" has already been set.'),Ca.HandlerAlreadyRegistered);this.textStreamHandlers.set(e,t)}unregisterTextStreamHandler(e){this.textStreamHandlers.delete(e)}registerByteStreamHandler(e,t){if(this.byteStreamHandlers.has(e))throw new Fa('A byte stream handler for topic "'.concat(e,'" has already been set.'),Ca.HandlerAlreadyRegistered);this.byteStreamHandlers.set(e,t)}unregisterByteStreamHandler(e){this.byteStreamHandlers.delete(e)}clearHandlersAndControllers(){this.byteStreamControllers.clear(),this.textStreamControllers.clear(),this.byteStreamHandlers.clear(),this.textStreamHandlers.clear()}validateParticipantHasNoActiveDataStreams(e){var t,n,i,r;const o=Array.from(this.textStreamControllers.entries()).filter((t=>t[1].sendingParticipantIdentity===e)),a=Array.from(this.byteStreamControllers.entries()).filter((t=>t[1].sendingParticipantIdentity===e));if(o.length>0||a.length>0){const s=new Fa("Participant ".concat(e," unexpectedly disconnected in the middle of sending data"),Ca.AbnormalEnd);for(const[e,i]of a)null===(n=(t=i.outOfBandFailureRejectingFuture).reject)||void 0===n||n.call(t,s),this.byteStreamControllers.delete(e);for(const[e,t]of o)null===(r=(i=t.outOfBandFailureRejectingFuture).reject)||void 0===r||r.call(i,s),this.textStreamControllers.delete(e)}}handleDataStreamPacket(e,t){return oo(this,void 0,void 0,(function*(){switch(e.value.case){case"streamHeader":return this.handleStreamHeader(e.value.value,e.participantIdentity,t);case"streamChunk":return this.handleStreamChunk(e.value.value,t);case"streamTrailer":return this.handleStreamTrailer(e.value.value,t);default:throw new Error('DataPacket of value "'.concat(e.value.case,'" is not data stream related!'))}}))}handleStreamHeader(e,t,n){return oo(this,void 0,void 0,(function*(){var i;if("byteHeader"===e.contentHeader.case){const r=this.byteStreamHandlers.get(e.topic);if(!r)return void this.log.debug("ignoring incoming byte stream due to no handler for topic",e.topic);let o;const a=new Ms;a.promise.catch((e=>{this.log.error(e)}));const s={id:e.streamId,name:null!==(i=e.contentHeader.value.name)&&void 0!==i?i:"unknown",mimeType:e.mimeType,size:e.totalLength?Number(e.totalLength):void 0,topic:e.topic,timestamp:js(e.timestamp),attributes:e.attributes,encryptionType:n},c=new ReadableStream({start:n=>{if(o=n,this.textStreamControllers.has(e.streamId))throw new Fa("A data stream read is already in progress for a stream with id ".concat(e.streamId,"."),Ca.AlreadyOpened);this.byteStreamControllers.set(e.streamId,{info:s,controller:o,startTime:Date.now(),sendingParticipantIdentity:t,outOfBandFailureRejectingFuture:a})}});r(new Il(s,c,js(e.totalLength),a),{identity:t})}else if("textHeader"===e.contentHeader.case){const i=this.textStreamHandlers.get(e.topic);if(!i)return void this.log.debug("ignoring incoming text stream due to no handler for topic",e.topic);let r;const o=new Ms;o.promise.catch((e=>{this.log.error(e)}));const a={id:e.streamId,mimeType:e.mimeType,size:e.totalLength?Number(e.totalLength):void 0,topic:e.topic,timestamp:Number(e.timestamp),attributes:e.attributes,encryptionType:n},s=new ReadableStream({start:n=>{if(r=n,this.textStreamControllers.has(e.streamId))throw new Fa("A data stream read is already in progress for a stream with id ".concat(e.streamId,"."),Ca.AlreadyOpened);this.textStreamControllers.set(e.streamId,{info:a,controller:r,startTime:Date.now(),sendingParticipantIdentity:t,outOfBandFailureRejectingFuture:o})}});i(new Ol(a,s,js(e.totalLength),o),{identity:t})}}))}handleStreamChunk(e,t){const n=this.byteStreamControllers.get(e.streamId);n&&(n.info.encryptionType!==t?(n.controller.error(new Fa("Encryption type mismatch for stream ".concat(e.streamId,". Expected ").concat(t,", got ").concat(n.info.encryptionType),Ca.EncryptionTypeMismatch)),this.byteStreamControllers.delete(e.streamId)):e.content.length>0&&n.controller.enqueue(e));const i=this.textStreamControllers.get(e.streamId);i&&(i.info.encryptionType!==t?(i.controller.error(new Fa("Encryption type mismatch for stream ".concat(e.streamId,". Expected ").concat(t,", got ").concat(i.info.encryptionType),Ca.EncryptionTypeMismatch)),this.textStreamControllers.delete(e.streamId)):e.content.length>0&&i.controller.enqueue(e))}handleStreamTrailer(e,t){const n=this.textStreamControllers.get(e.streamId);n&&(n.info.encryptionType!==t?n.controller.error(new Fa("Encryption type mismatch for stream ".concat(e.streamId,". Expected ").concat(t,", got ").concat(n.info.encryptionType),Ca.EncryptionTypeMismatch)):(n.info.attributes=Object.assign(Object.assign({},n.info.attributes),e.attributes),n.controller.close(),this.textStreamControllers.delete(e.streamId)));const i=this.byteStreamControllers.get(e.streamId);i&&(i.info.encryptionType!==t?i.controller.error(new Fa("Encryption type mismatch for stream ".concat(e.streamId,". Expected ").concat(t,", got ").concat(i.info.encryptionType),Ca.EncryptionTypeMismatch)):(i.info.attributes=Object.assign(Object.assign({},i.info.attributes),e.attributes),i.controller.close()),this.byteStreamControllers.delete(e.streamId))}}class Ml{constructor(e,t,n){this.writableStream=e,this.defaultWriter=e.getWriter(),this.onClose=n,this.info=t}write(e){return this.defaultWriter.write(e)}close(){return oo(this,void 0,void 0,(function*(){var e;yield this.defaultWriter.close(),this.defaultWriter.releaseLock(),null===(e=this.onClose)||void 0===e||e.call(this)}))}}class Al extends Ml{}class Nl extends Ml{}class Ll{constructor(e,t){this.engine=e,this.log=t}setupEngine(e){this.engine=e}sendText(e,t){return oo(this,void 0,void 0,(function*(){var n;const i=crypto.randomUUID(),r=(new TextEncoder).encode(e).byteLength,o=null===(n=null==t?void 0:t.attachments)||void 0===n?void 0:n.map((()=>crypto.randomUUID())),a=new Array(o?o.length+1:1).fill(0),s=(e,n)=>{var i;a[n]=e;const r=a.reduce(((e,t)=>e+t),0);null===(i=null==t?void 0:t.onProgress)||void 0===i||i.call(t,r)},c=yield this.streamText({streamId:i,totalSize:r,destinationIdentities:null==t?void 0:t.destinationIdentities,topic:null==t?void 0:t.topic,attachedStreamIds:o,attributes:null==t?void 0:t.attributes});return yield c.write(e),s(1,0),yield c.close(),(null==t?void 0:t.attachments)&&o&&(yield Promise.all(t.attachments.map(((e,n)=>oo(this,void 0,void 0,(function*(){return this._sendFile(o[n],e,{topic:t.topic,mimeType:e.type,onProgress:e=>{s(e,n+1)}})})))))),c.info}))}streamText(e){return oo(this,void 0,void 0,(function*(){var t,n,i;const r=null!==(t=null==e?void 0:e.streamId)&&void 0!==t?t:crypto.randomUUID(),o={id:r,mimeType:"text/plain",timestamp:Date.now(),topic:null!==(n=null==e?void 0:e.topic)&&void 0!==n?n:"",size:null==e?void 0:e.totalSize,attributes:null==e?void 0:e.attributes,encryptionType:(null===(i=this.engine.e2eeManager)||void 0===i?void 0:i.isDataChannelEncryptionEnabled)?ci.GCM:ci.NONE},a=new Bi({streamId:r,mimeType:o.mimeType,topic:o.topic,timestamp:Us(o.timestamp),totalLength:Us(null==e?void 0:e.totalSize),attributes:o.attributes,contentHeader:{case:"textHeader",value:new Ui({version:null==e?void 0:e.version,attachedStreamIds:null==e?void 0:e.attachedStreamIds,replyToStreamId:null==e?void 0:e.replyToStreamId,operationType:"update"===(null==e?void 0:e.type)?ji.UPDATE:ji.CREATE})}}),s=null==e?void 0:e.destinationIdentities,c=new pi({destinationIdentities:s,value:{case:"streamHeader",value:a}});yield this.engine.sendDataPacket(c,mi.RELIABLE);let l=0;const d=this.engine,u=new WritableStream({write(e){return oo(this,void 0,void 0,(function*(){for(const t of function(e){const t=[];let n=(new TextEncoder).encode(e);for(;n.length>15e3;){let e=15e3;for(;e>0;){const t=n[e];if(void 0!==t&&128!=(192&t))break;e--}t.push(n.slice(0,e)),n=n.slice(e)}return n.length>0&&t.push(n),t}(e)){yield d.waitForBufferStatusLow(mi.RELIABLE);const e=new Vi({content:t,streamId:r,chunkIndex:Us(l)}),n=new pi({destinationIdentities:s,value:{case:"streamChunk",value:e}});yield d.sendDataPacket(n,mi.RELIABLE),l+=1}}))},close(){return oo(this,void 0,void 0,(function*(){const e=new qi({streamId:r}),t=new pi({destinationIdentities:s,value:{case:"streamTrailer",value:e}});yield d.sendDataPacket(t,mi.RELIABLE)}))},abort(e){console.log("Sink error:",e)}});let h=()=>oo(this,void 0,void 0,(function*(){yield p.close()}));d.once(_a.Closing,h);const p=new Al(u,o,(()=>this.engine.off(_a.Closing,h)));return p}))}sendFile(e,t){return oo(this,void 0,void 0,(function*(){const n=crypto.randomUUID();return yield this._sendFile(n,e,t),{id:n}}))}_sendFile(e,t,n){return oo(this,void 0,void 0,(function*(){var i;const r=yield this.streamBytes({streamId:e,totalSize:t.size,name:t.name,mimeType:null!==(i=null==n?void 0:n.mimeType)&&void 0!==i?i:t.type,topic:null==n?void 0:n.topic,destinationIdentities:null==n?void 0:n.destinationIdentities}),o=t.stream().getReader();for(;;){const{done:e,value:t}=yield o.read();if(e)break;yield r.write(t)}return yield r.close(),r.info}))}streamBytes(e){return oo(this,void 0,void 0,(function*(){var t,n,i,r,o,a;const s=null!==(t=null==e?void 0:e.streamId)&&void 0!==t?t:crypto.randomUUID(),c=null==e?void 0:e.destinationIdentities,l={id:s,mimeType:null!==(n=null==e?void 0:e.mimeType)&&void 0!==n?n:"application/octet-stream",topic:null!==(i=null==e?void 0:e.topic)&&void 0!==i?i:"",timestamp:Date.now(),attributes:null==e?void 0:e.attributes,size:null==e?void 0:e.totalSize,name:null!==(r=null==e?void 0:e.name)&&void 0!==r?r:"unknown",encryptionType:(null===(o=this.engine.e2eeManager)||void 0===o?void 0:o.isDataChannelEncryptionEnabled)?ci.GCM:ci.NONE},d=new Bi({totalLength:Us(null!==(a=l.size)&&void 0!==a?a:0),mimeType:l.mimeType,streamId:s,topic:l.topic,timestamp:Us(Date.now()),attributes:l.attributes,contentHeader:{case:"byteHeader",value:new Fi({name:l.name})}}),u=new pi({destinationIdentities:c,value:{case:"streamHeader",value:d}});yield this.engine.sendDataPacket(u,mi.RELIABLE);let h=0;const p=new ht,m=this.engine,f=this.log,g=new WritableStream({write(e){return oo(this,void 0,void 0,(function*(){const t=yield p.lock();let n=0;try{for(;n<e.byteLength;){const t=e.slice(n,n+15e3);yield m.waitForBufferStatusLow(mi.RELIABLE);const i=new pi({destinationIdentities:c,value:{case:"streamChunk",value:new Vi({content:t,streamId:s,chunkIndex:Us(h)})}});yield m.sendDataPacket(i,mi.RELIABLE),h+=1,n+=t.byteLength}}finally{t()}}))},close(){return oo(this,void 0,void 0,(function*(){const e=new qi({streamId:s}),t=new pi({destinationIdentities:c,value:{case:"streamTrailer",value:e}});yield m.sendDataPacket(t,mi.RELIABLE)}))},abort(e){f.error("Sink error:",e)}});return new Nl(g,l)}))}}class jl extends Ya{constructor(e,t,n,i,r){super(e,n,r),this.sid=t,this.receiver=i}get isLocal(){return!1}setMuted(e){this.isMuted!==e&&(this.isMuted=e,this._mediaStreamTrack.enabled=!e,this.emit(e?Pa.Muted:Pa.Unmuted,this))}setMediaStream(e){this.mediaStream=e;const t=n=>{n.track===this._mediaStreamTrack&&(e.removeEventListener("removetrack",t),this.receiver&&"playoutDelayHint"in this.receiver&&(this.receiver.playoutDelayHint=void 0),this.receiver=void 0,this._currentBitrate=0,this.emit(Pa.Ended,this))};e.addEventListener("removetrack",t)}start(){this.startMonitor(),super.enable()}stop(){this.stopMonitor(),super.disable()}getRTCStatsReport(){return oo(this,void 0,void 0,(function*(){var e;if(null===(e=this.receiver)||void 0===e?void 0:e.getStats)return yield this.receiver.getStats()}))}setPlayoutDelay(e){this.receiver?"playoutDelayHint"in this.receiver?this.receiver.playoutDelayHint=e:this.log.warn("Playout delay not supported in this browser"):this.log.warn("Cannot set playout delay, track already ended")}getPlayoutDelay(){if(this.receiver){if("playoutDelayHint"in this.receiver)return this.receiver.playoutDelayHint;this.log.warn("Playout delay not supported in this browser")}else this.log.warn("Cannot get playout delay, track already ended");return 0}startMonitor(){this.monitorInterval||(this.monitorInterval=setInterval((()=>this.monitorReceiver()),Xc)),"undefined"!=typeof RTCRtpReceiver&&"getSynchronizationSources"in RTCRtpReceiver&&this.registerTimeSyncUpdate()}registerTimeSyncUpdate(){const e=()=>{var t;this.timeSyncHandle=requestAnimationFrame((()=>e()));const n=null===(t=this.receiver)||void 0===t?void 0:t.getSynchronizationSources()[0];if(n){const{timestamp:e,rtpTimestamp:t}=n;t&&this.rtpTimestamp!==t&&(this.emit(Pa.TimeSyncUpdate,{timestamp:e,rtpTimestamp:t}),this.rtpTimestamp=t)}};e()}}class Ul extends jl{constructor(e,t,n,i,r,o){super(e,t,Ya.Kind.Audio,n,o),this.monitorReceiver=()=>oo(this,void 0,void 0,(function*(){if(!this.receiver)return void(this._currentBitrate=0);const e=yield this.getReceiverStats();e&&this.prevStats&&this.receiver&&(this._currentBitrate=$c(e,this.prevStats)),this.prevStats=e})),this.audioContext=i,this.webAudioPluginNodes=[],r&&(this.sinkId=r.deviceId)}setVolume(e){var t;for(const n of this.attachedElements)this.audioContext?null===(t=this.gainNode)||void 0===t||t.gain.setTargetAtTime(e,0,.1):n.volume=e;bs()&&this._mediaStreamTrack._setVolume(e),this.elementVolume=e}getVolume(){if(this.elementVolume)return this.elementVolume;if(bs())return 1;let e=0;return this.attachedElements.forEach((t=>{t.volume>e&&(e=t.volume)})),e}setSinkId(e){return oo(this,void 0,void 0,(function*(){this.sinkId=e,yield Promise.all(this.attachedElements.map((t=>{if(hs(t))return t.setSinkId(e)})))}))}attach(e){const t=0===this.attachedElements.length;return e?super.attach(e):e=super.attach(),this.sinkId&&hs(e)&&e.setSinkId(this.sinkId).catch((e=>{this.log.error("Failed to set sink id on remote audio track",e,this.logContext)})),this.audioContext&&t&&(this.log.debug("using audio context mapping",this.logContext),this.connectWebAudio(this.audioContext,e),e.volume=0,e.muted=!0),this.elementVolume&&this.setVolume(this.elementVolume),e}detach(e){let t;return e?(t=super.detach(e),this.audioContext&&(this.attachedElements.length>0?this.connectWebAudio(this.audioContext,this.attachedElements[0]):this.disconnectWebAudio())):(t=super.detach(),this.disconnectWebAudio()),t}setAudioContext(e){this.audioContext=e,e&&this.attachedElements.length>0?this.connectWebAudio(e,this.attachedElements[0]):e||this.disconnectWebAudio()}setWebAudioPlugins(e){this.webAudioPluginNodes=e,this.attachedElements.length>0&&this.audioContext&&this.connectWebAudio(this.audioContext,this.attachedElements[0])}connectWebAudio(e,t){this.disconnectWebAudio(),this.sourceNode=e.createMediaStreamSource(t.srcObject);let n=this.sourceNode;this.webAudioPluginNodes.forEach((e=>{n.connect(e),n=e})),this.gainNode=e.createGain(),n.connect(this.gainNode),this.gainNode.connect(e.destination),this.elementVolume&&this.gainNode.gain.setTargetAtTime(this.elementVolume,0,.1),"running"!==e.state&&e.resume().then((()=>{"running"!==e.state&&this.emit(Pa.AudioPlaybackFailed,new Error("Audio Context couldn't be started automatically"))})).catch((e=>{this.emit(Pa.AudioPlaybackFailed,e)}))}disconnectWebAudio(){var e,t;null===(e=this.gainNode)||void 0===e||e.disconnect(),null===(t=this.sourceNode)||void 0===t||t.disconnect(),this.gainNode=void 0,this.sourceNode=void 0}getReceiverStats(){return oo(this,void 0,void 0,(function*(){if(!this.receiver||!this.receiver.getStats)return;let e;return(yield this.receiver.getStats()).forEach((t=>{"inbound-rtp"===t.type&&(e={type:"audio",streamId:t.id,timestamp:t.timestamp,jitter:t.jitter,bytesReceived:t.bytesReceived,concealedSamples:t.concealedSamples,concealmentEvents:t.concealmentEvents,silentConcealedSamples:t.silentConcealedSamples,silentConcealmentEvents:t.silentConcealmentEvents,totalAudioEnergy:t.totalAudioEnergy,totalSamplesDuration:t.totalSamplesDuration})})),e}))}}class Fl extends jl{constructor(e,t,n,i,r){super(e,t,Ya.Kind.Video,n,r),this.elementInfos=[],this.monitorReceiver=()=>oo(this,void 0,void 0,(function*(){if(!this.receiver)return void(this._currentBitrate=0);const e=yield this.getReceiverStats();e&&this.prevStats&&this.receiver&&(this._currentBitrate=$c(e,this.prevStats)),this.prevStats=e})),this.debouncedHandleResize=Oc((()=>{this.updateDimensions()}),100),this.adaptiveStreamSettings=i}get isAdaptiveStream(){return void 0!==this.adaptiveStreamSettings}setStreamState(e){super.setStreamState(e),console.log("setStreamState",e),e===Ya.StreamState.Active&&this.updateVisibility()}get mediaStreamTrack(){return this._mediaStreamTrack}setMuted(e){super.setMuted(e),this.attachedElements.forEach((t=>{e?$a(this._mediaStreamTrack,t):Xa(this._mediaStreamTrack,t)}))}attach(e){if(e?super.attach(e):e=super.attach(),this.adaptiveStreamSettings&&void 0===this.elementInfos.find((t=>t.element===e))){const t=new Bl(e);this.observeElementInfo(t)}return e}observeElementInfo(e){this.adaptiveStreamSettings&&void 0===this.elementInfos.find((t=>t===e))?(e.handleResize=()=>{this.debouncedHandleResize()},e.handleVisibilityChanged=()=>{this.updateVisibility()},this.elementInfos.push(e),e.observe(),this.debouncedHandleResize(),this.updateVisibility()):this.log.warn("visibility resize observer not triggered",this.logContext)}stopObservingElementInfo(e){if(!this.isAdaptiveStream)return void this.log.warn("stopObservingElementInfo ignored",this.logContext);const t=this.elementInfos.filter((t=>t===e));for(const e of t)e.stopObserving();this.elementInfos=this.elementInfos.filter((t=>t!==e)),this.updateVisibility(),this.debouncedHandleResize()}detach(e){let t=[];if(e)return this.stopObservingElement(e),super.detach(e);t=super.detach();for(const e of t)this.stopObservingElement(e);return t}getDecoderImplementation(){var e;return null===(e=this.prevStats)||void 0===e?void 0:e.decoderImplementation}getReceiverStats(){return oo(this,void 0,void 0,(function*(){if(!this.receiver||!this.receiver.getStats)return;const e=yield this.receiver.getStats();let t,n="",i=new Map;return e.forEach((e=>{"inbound-rtp"===e.type?(n=e.codecId,t={type:"video",streamId:e.id,framesDecoded:e.framesDecoded,framesDropped:e.framesDropped,framesReceived:e.framesReceived,packetsReceived:e.packetsReceived,packetsLost:e.packetsLost,frameWidth:e.frameWidth,frameHeight:e.frameHeight,pliCount:e.pliCount,firCount:e.firCount,nackCount:e.nackCount,jitter:e.jitter,timestamp:e.timestamp,bytesReceived:e.bytesReceived,decoderImplementation:e.decoderImplementation}):"codec"===e.type&&i.set(e.id,e)})),t&&""!==n&&i.get(n)&&(t.mimeType=i.get(n).mimeType),t}))}stopObservingElement(e){const t=this.elementInfos.filter((t=>t.element===e));for(const e of t)this.stopObservingElementInfo(e)}handleAppVisibilityChanged(){const e=Object.create(null,{handleAppVisibilityChanged:{get:()=>super.handleAppVisibilityChanged}});return oo(this,void 0,void 0,(function*(){yield e.handleAppVisibilityChanged.call(this),this.isAdaptiveStream&&this.updateVisibility()}))}updateVisibility(e){var t,n;const i=this.elementInfos.reduce(((e,t)=>Math.max(e,t.visibilityChangedAt||0)),0),r=!(null!==(n=null===(t=this.adaptiveStreamSettings)||void 0===t?void 0:t.pauseVideoInBackground)&&void 0!==n&&!n)&&this.isInBackground,o=this.elementInfos.some((e=>e.pictureInPicture)),a=this.elementInfos.some((e=>e.visible))&&!r||o;(this.lastVisible!==a||e)&&(!a&&Date.now()-i<100?Ga.setTimeout((()=>{this.updateVisibility()}),100):(this.lastVisible=a,this.emit(Pa.VisibilityChanged,a,this)))}updateDimensions(){var e,t;let n=0,i=0;const r=this.getPixelDensity();for(const e of this.elementInfos){const t=e.width()*r,o=e.height()*r;t+o>n+i&&(n=t,i=o)}(null===(e=this.lastDimensions)||void 0===e?void 0:e.width)===n&&(null===(t=this.lastDimensions)||void 0===t?void 0:t.height)===i||(this.lastDimensions={width:n,height:i},this.emit(Pa.VideoDimensionsChanged,this.lastDimensions,this))}getPixelDensity(){var e;const t=null===(e=this.adaptiveStreamSettings)||void 0===e?void 0:e.pixelDensity;return"screen"===t?Cs():t||(Cs()>2?2:1)}}class Bl{get visible(){return this.isPiP||this.isIntersecting}get pictureInPicture(){return this.isPiP}constructor(e,t){this.onVisibilityChanged=e=>{var t;const{target:n,isIntersecting:i}=e;n===this.element&&(this.isIntersecting=i,this.isPiP=Vl(this.element),this.visibilityChangedAt=Date.now(),null===(t=this.handleVisibilityChanged)||void 0===t||t.call(this))},this.onEnterPiP=()=>{var e,t,n;null===(t=null===(e=window.documentPictureInPicture)||void 0===e?void 0:e.window)||void 0===t||t.addEventListener("pagehide",this.onLeavePiP),this.isPiP=Vl(this.element),null===(n=this.handleVisibilityChanged)||void 0===n||n.call(this)},this.onLeavePiP=()=>{var e;this.isPiP=Vl(this.element),null===(e=this.handleVisibilityChanged)||void 0===e||e.call(this)},this.element=e,this.isIntersecting=null!=t?t:ql(e),this.isPiP=vs()&&Vl(e),this.visibilityChangedAt=0}width(){return this.element.clientWidth}height(){return this.element.clientHeight}observe(){var e,t,n;this.isIntersecting=ql(this.element),this.isPiP=Vl(this.element),this.element.handleResize=()=>{var e;null===(e=this.handleResize)||void 0===e||e.call(this)},this.element.handleVisibilityChanged=this.onVisibilityChanged,Rs().observe(this.element),_s().observe(this.element),this.element.addEventListener("enterpictureinpicture",this.onEnterPiP),this.element.addEventListener("leavepictureinpicture",this.onLeavePiP),null===(e=window.documentPictureInPicture)||void 0===e||e.addEventListener("enter",this.onEnterPiP),null===(n=null===(t=window.documentPictureInPicture)||void 0===t?void 0:t.window)||void 0===n||n.addEventListener("pagehide",this.onLeavePiP)}stopObserving(){var e,t,n,i,r;null===(e=Rs())||void 0===e||e.unobserve(this.element),null===(t=_s())||void 0===t||t.unobserve(this.element),this.element.removeEventListener("enterpictureinpicture",this.onEnterPiP),this.element.removeEventListener("leavepictureinpicture",this.onLeavePiP),null===(n=window.documentPictureInPicture)||void 0===n||n.removeEventListener("enter",this.onEnterPiP),null===(r=null===(i=window.documentPictureInPicture)||void 0===i?void 0:i.window)||void 0===r||r.removeEventListener("pagehide",this.onLeavePiP)}}function Vl(e){var t,n;return document.pictureInPictureElement===e||!!(null===(t=window.documentPictureInPicture)||void 0===t?void 0:t.window)&&ql(e,null===(n=window.documentPictureInPicture)||void 0===n?void 0:n.window)}function ql(e,t){const n=t||window;let i=e.offsetTop,r=e.offsetLeft;const o=e.offsetWidth,a=e.offsetHeight,{hidden:s}=e,{display:c}=getComputedStyle(e);for(;e.offsetParent;)i+=(e=e.offsetParent).offsetTop,r+=e.offsetLeft;return i<n.pageYOffset+n.innerHeight&&r<n.pageXOffset+n.innerWidth&&i+a>n.pageYOffset&&r+o>n.pageXOffset&&!s&&"none"!==c}class Wl extends lo.EventEmitter{constructor(e,t,n,i){var r;super(),this.metadataMuted=!1,this.encryption=ci.NONE,this.log=eo,this.handleMuted=()=>{this.emit(Pa.Muted)},this.handleUnmuted=()=>{this.emit(Pa.Unmuted)},this.log=to(null!==(r=null==i?void 0:i.loggerName)&&void 0!==r?r:$r.Publication),this.loggerContextCb=this.loggerContextCb,this.setMaxListeners(100),this.kind=e,this.trackSid=t,this.trackName=n,this.source=Ya.Source.Unknown}setTrack(e){this.track&&(this.track.off(Pa.Muted,this.handleMuted),this.track.off(Pa.Unmuted,this.handleUnmuted)),this.track=e,e&&(e.on(Pa.Muted,this.handleMuted),e.on(Pa.Unmuted,this.handleUnmuted))}get logContext(){var e;return Object.assign(Object.assign({},null===(e=this.loggerContextCb)||void 0===e?void 0:e.call(this)),tc(this))}get isMuted(){return this.metadataMuted}get isEnabled(){return!0}get isSubscribed(){return void 0!==this.track}get isEncrypted(){return this.encryption!==ci.NONE}get audioTrack(){if(Bs(this.track))return this.track}get videoTrack(){if(Vs(this.track))return this.track}updateInfo(e){this.trackSid=e.sid,this.trackName=e.name,this.source=Ya.sourceFromProto(e.source),this.mimeType=e.mimeType,this.kind===Ya.Kind.Video&&e.width>0&&(this.dimensions={width:e.width,height:e.height},this.simulcasted=e.simulcast),this.encryption=e.encryption,this.trackInfo=e,this.log.debug("update publication info",Object.assign(Object.assign({},this.logContext),{info:e}))}}!function(e){var t,n;(t=e.SubscriptionStatus||(e.SubscriptionStatus={})).Desired="desired",t.Subscribed="subscribed",t.Unsubscribed="unsubscribed",(n=e.PermissionStatus||(e.PermissionStatus={})).Allowed="allowed",n.NotAllowed="not_allowed"}(Wl||(Wl={}));class Hl extends Wl{get isUpstreamPaused(){var e;return null===(e=this.track)||void 0===e?void 0:e.isUpstreamPaused}constructor(e,t,n,i){super(e,t.sid,t.name,i),this.track=void 0,this.handleTrackEnded=()=>{this.emit(Pa.Ended)},this.handleCpuConstrained=()=>{this.track&&Vs(this.track)&&this.emit(Pa.CpuConstrained,this.track)},this.updateInfo(t),this.setTrack(n)}setTrack(e){this.track&&(this.track.off(Pa.Ended,this.handleTrackEnded),this.track.off(Pa.CpuConstrained,this.handleCpuConstrained)),super.setTrack(e),e&&(e.on(Pa.Ended,this.handleTrackEnded),e.on(Pa.CpuConstrained,this.handleCpuConstrained))}get isMuted(){return this.track?this.track.isMuted:super.isMuted}get audioTrack(){return super.audioTrack}get videoTrack(){return super.videoTrack}get isLocal(){return!0}mute(){return oo(this,void 0,void 0,(function*(){var e;return null===(e=this.track)||void 0===e?void 0:e.mute()}))}unmute(){return oo(this,void 0,void 0,(function*(){var e;return null===(e=this.track)||void 0===e?void 0:e.unmute()}))}pauseUpstream(){return oo(this,void 0,void 0,(function*(){var e;yield null===(e=this.track)||void 0===e?void 0:e.pauseUpstream()}))}resumeUpstream(){return oo(this,void 0,void 0,(function*(){var e;yield null===(e=this.track)||void 0===e?void 0:e.resumeUpstream()}))}getTrackFeatures(){var e;if(Bs(this.track)){const t=this.track.getSourceTrackSettings(),n=new Set;return t.autoGainControl&&n.add(ei.TF_AUTO_GAIN_CONTROL),t.echoCancellation&&n.add(ei.TF_ECHO_CANCELLATION),t.noiseSuppression&&n.add(ei.TF_NOISE_SUPPRESSION),t.channelCount&&t.channelCount>1&&n.add(ei.TF_STEREO),(null===(e=this.options)||void 0===e?void 0:e.dtx)||n.add(ei.TF_NO_DTX),this.track.enhancedNoiseCancellation&&n.add(ei.TF_ENHANCED_NOISE_CANCELLATION),Array.from(n.values())}return[]}}function zl(e,t){return oo(this,void 0,void 0,(function*(){null!=e||(e={});let n=!1;const{audioProcessor:i,videoProcessor:r,optionsWithoutProcessor:o}=nc(e);let a=o.audio,s=o.video;if(i&&"object"==typeof o.audio&&(o.audio.processor=i),r&&"object"==typeof o.video&&(o.video.processor=r),e.audio&&"object"==typeof o.audio&&"string"==typeof o.audio.deviceId){const e=o.audio.deviceId;o.audio.deviceId={exact:e},n=!0,a=Object.assign(Object.assign({},o.audio),{deviceId:{ideal:e}})}if(o.video&&"object"==typeof o.video&&"string"==typeof o.video.deviceId){const e=o.video.deviceId;o.video.deviceId={exact:e},n=!0,s=Object.assign(Object.assign({},o.video),{deviceId:{ideal:e}})}(!0===o.audio||"object"==typeof o.audio&&!o.audio.deviceId)&&(o.audio={deviceId:"default"}),!0===o.video?o.video={deviceId:"default"}:"object"!=typeof o.video||o.video.deviceId||(o.video.deviceId="default");const c=Ks(o,Vc,qc),l=Ys(c),d=navigator.mediaDevices.getUserMedia(l);o.audio&&(ac.userMediaPromiseMap.set("audioinput",d),d.catch((()=>ac.userMediaPromiseMap.delete("audioinput")))),o.video&&(ac.userMediaPromiseMap.set("videoinput",d),d.catch((()=>ac.userMediaPromiseMap.delete("videoinput"))));try{const e=yield d;return yield Promise.all(e.getTracks().map((n=>oo(this,void 0,void 0,(function*(){const o="audio"===n.kind;let a,s=o?c.audio:c.video;"boolean"!=typeof s&&s||(s={});const d=o?l.audio:l.video;"boolean"!=typeof d&&(a=d);const u=n.getSettings().deviceId;(null==a?void 0:a.deviceId)&&As(a.deviceId)!==u?a.deviceId=u:a||(a={deviceId:u});const h=function(e,t,n){switch(e.kind){case"audio":return new nl(e,t,!1,void 0,n);case"video":return new ml(e,t,!1,n);default:throw new Ma("unsupported track type: ".concat(e.kind))}}(n,a,t);return h.kind===Ya.Kind.Video?h.source=Ya.Source.Camera:h.kind===Ya.Kind.Audio&&(h.source=Ya.Source.Microphone),h.mediaStream=e,Bs(h)&&i?yield h.setProcessor(i):Vs(h)&&r&&(yield h.setProcessor(r)),h})))))}catch(i){if(!n)throw i;return zl(Object.assign(Object.assign({},e),{audio:a,video:s}),t)}}))}!function(e){e.Excellent="excellent",e.Good="good",e.Poor="poor",e.Lost="lost",e.Unknown="unknown"}(Cl||(Cl={}));class Gl extends lo.EventEmitter{get logContext(){var e,t;return Object.assign({},null===(t=null===(e=this.loggerOptions)||void 0===e?void 0:e.loggerContextCb)||void 0===t?void 0:t.call(e))}get isEncrypted(){return this.trackPublications.size>0&&Array.from(this.trackPublications.values()).every((e=>e.isEncrypted))}get isAgent(){var e;return(null===(e=this.permissions)||void 0===e?void 0:e.agent)||this.kind===ai.AGENT}get isActive(){var e;return(null===(e=this.participantInfo)||void 0===e?void 0:e.state)===oi.ACTIVE}get kind(){return this._kind}get attributes(){return Object.freeze(Object.assign({},this._attributes))}constructor(e,t,n,i,r,o){let a=arguments.length>6&&void 0!==arguments[6]?arguments[6]:ai.STANDARD;var s;super(),this.audioLevel=0,this.isSpeaking=!1,this._connectionQuality=Cl.Unknown,this.log=eo,this.log=to(null!==(s=null==o?void 0:o.loggerName)&&void 0!==s?s:$r.Participant),this.loggerOptions=o,this.setMaxListeners(100),this.sid=e,this.identity=t,this.name=n,this.metadata=i,this.audioTrackPublications=new Map,this.videoTrackPublications=new Map,this.trackPublications=new Map,this._kind=a,this._attributes=null!=r?r:{}}getTrackPublications(){return Array.from(this.trackPublications.values())}getTrackPublication(e){for(const[,t]of this.trackPublications)if(t.source===e)return t}getTrackPublicationByName(e){for(const[,t]of this.trackPublications)if(t.trackName===e)return t}waitUntilActive(){return this.isActive?Promise.resolve():(this.activeFuture||(this.activeFuture=new Ms,this.once(Ea.Active,(()=>{var e,t;null===(t=null===(e=this.activeFuture)||void 0===e?void 0:e.resolve)||void 0===t||t.call(e),this.activeFuture=void 0}))),this.activeFuture.promise)}get connectionQuality(){return this._connectionQuality}get isCameraEnabled(){var e;const t=this.getTrackPublication(Ya.Source.Camera);return!(null===(e=null==t?void 0:t.isMuted)||void 0===e||e)}get isMicrophoneEnabled(){var e;const t=this.getTrackPublication(Ya.Source.Microphone);return!(null===(e=null==t?void 0:t.isMuted)||void 0===e||e)}get isScreenShareEnabled(){return!!this.getTrackPublication(Ya.Source.ScreenShare)}get isLocal(){return!1}get joinedAt(){return this.participantInfo?new Date(1e3*Number.parseInt(this.participantInfo.joinedAt.toString())):new Date}updateInfo(e){var t;return!(this.participantInfo&&this.participantInfo.sid===e.sid&&this.participantInfo.version>e.version||(this.identity=e.identity,this.sid=e.sid,this._setName(e.name),this._setMetadata(e.metadata),this._setAttributes(e.attributes),e.state===oi.ACTIVE&&(null===(t=this.participantInfo)||void 0===t?void 0:t.state)!==oi.ACTIVE&&this.emit(Ea.Active),e.permission&&this.setPermissions(e.permission),this.participantInfo=e,0))}_setMetadata(e){const t=this.metadata!==e,n=this.metadata;this.metadata=e,t&&this.emit(Ea.ParticipantMetadataChanged,n)}_setName(e){const t=this.name!==e;this.name=e,t&&this.emit(Ea.ParticipantNameChanged,e)}_setAttributes(e){const t=function(e,t){var n;void 0===e&&(e={}),void 0===t&&(t={});const i=[...Object.keys(t),...Object.keys(e)],r={};for(const o of i)e[o]!==t[o]&&(r[o]=null!==(n=t[o])&&void 0!==n?n:"");return r}(this.attributes,e);this._attributes=e,Object.keys(t).length>0&&this.emit(Ea.AttributesChanged,t)}setPermissions(e){var t,n,i,r,o,a;const s=this.permissions,c=e.canPublish!==(null===(t=this.permissions)||void 0===t?void 0:t.canPublish)||e.canSubscribe!==(null===(n=this.permissions)||void 0===n?void 0:n.canSubscribe)||e.canPublishData!==(null===(i=this.permissions)||void 0===i?void 0:i.canPublishData)||e.hidden!==(null===(r=this.permissions)||void 0===r?void 0:r.hidden)||e.recorder!==(null===(o=this.permissions)||void 0===o?void 0:o.recorder)||e.canPublishSources.length!==this.permissions.canPublishSources.length||e.canPublishSources.some(((e,t)=>{var n;return e!==(null===(n=this.permissions)||void 0===n?void 0:n.canPublishSources[t])}))||e.canSubscribeMetrics!==(null===(a=this.permissions)||void 0===a?void 0:a.canSubscribeMetrics);return this.permissions=e,c&&this.emit(Ea.ParticipantPermissionsChanged,s),c}setIsSpeaking(e){e!==this.isSpeaking&&(this.isSpeaking=e,e&&(this.lastSpokeAt=new Date),this.emit(Ea.IsSpeakingChanged,e))}setConnectionQuality(e){const t=this._connectionQuality;this._connectionQuality=function(e){switch(e){case Yn.EXCELLENT:return Cl.Excellent;case Yn.GOOD:return Cl.Good;case Yn.POOR:return Cl.Poor;case Yn.LOST:return Cl.Lost;default:return Cl.Unknown}}(e),t!==this._connectionQuality&&this.emit(Ea.ConnectionQualityChanged,this._connectionQuality)}setDisconnected(){var e,t;this.activeFuture&&(null===(t=(e=this.activeFuture).reject)||void 0===t||t.call(e,new Error("Participant disconnected")),this.activeFuture=void 0)}setAudioContext(e){this.audioContext=e,this.audioTrackPublications.forEach((t=>Bs(t.track)&&t.track.setAudioContext(e)))}addTrackPublication(e){e.on(Pa.Muted,(()=>{this.emit(Ea.TrackMuted,e)})),e.on(Pa.Unmuted,(()=>{this.emit(Ea.TrackUnmuted,e)}));const t=e;switch(t.track&&(t.track.sid=e.trackSid),this.trackPublications.set(e.trackSid,e),e.kind){case Ya.Kind.Audio:this.audioTrackPublications.set(e.trackSid,e);break;case Ya.Kind.Video:this.videoTrackPublications.set(e.trackSid,e)}}}class Kl extends Gl{constructor(e,t,n,i,r,o){super(e,t,void 0,void 0,void 0,{loggerName:i.loggerName,loggerContextCb:()=>this.engine.logContext}),this.pendingPublishing=new Set,this.pendingPublishPromises=new Map,this.participantTrackPermissions=[],this.allParticipantsAllowedToSubscribe=!0,this.encryptionType=ci.NONE,this.enabledPublishVideoCodecs=[],this.pendingAcks=new Map,this.pendingResponses=new Map,this.handleReconnecting=()=>{this.reconnectFuture||(this.reconnectFuture=new Ms)},this.handleReconnected=()=>{var e,t;null===(t=null===(e=this.reconnectFuture)||void 0===e?void 0:e.resolve)||void 0===t||t.call(e),this.reconnectFuture=void 0,this.updateTrackSubscriptionPermissions()},this.handleClosing=()=>{var e,t,n,i,r,o;this.reconnectFuture&&(this.reconnectFuture.promise.catch((e=>this.log.warn(e.message,this.logContext))),null===(t=null===(e=this.reconnectFuture)||void 0===e?void 0:e.reject)||void 0===t||t.call(e,"Got disconnected during reconnection attempt"),this.reconnectFuture=void 0),this.signalConnectedFuture&&(null===(i=(n=this.signalConnectedFuture).reject)||void 0===i||i.call(n,"Got disconnected without signal connected"),this.signalConnectedFuture=void 0),null===(o=null===(r=this.activeAgentFuture)||void 0===r?void 0:r.reject)||void 0===o||o.call(r,"Got disconnected without active agent present"),this.activeAgentFuture=void 0,this.firstActiveAgent=void 0},this.handleSignalConnected=e=>{var t,n;e.participant&&this.updateInfo(e.participant),this.signalConnectedFuture||(this.signalConnectedFuture=new Ms),null===(n=(t=this.signalConnectedFuture).resolve)||void 0===n||n.call(t)},this.handleSignalRequestResponse=e=>{const{requestId:t,reason:n,message:i}=e,r=this.pendingSignalRequests.get(t);r&&(n!==Ur.OK&&r.reject(new Ua(i,n)),this.pendingSignalRequests.delete(t))},this.handleDataPacket=e=>{switch(e.value.case){case"rpcResponse":let t=e.value.value,n=null,i=null;"payload"===t.value.case?n=t.value.value:"error"===t.value.case&&(i=Kc.fromProto(t.value.value)),this.handleIncomingRpcResponse(t.requestId,n,i);break;case"rpcAck":let r=e.value.value;this.handleIncomingRpcAck(r.requestId)}},this.updateTrackSubscriptionPermissions=()=>{this.log.debug("updating track subscription permissions",Object.assign(Object.assign({},this.logContext),{allParticipantsAllowed:this.allParticipantsAllowedToSubscribe,participantTrackPermissions:this.participantTrackPermissions})),this.engine.client.sendUpdateSubscriptionPermissions(this.allParticipantsAllowedToSubscribe,this.participantTrackPermissions.map((e=>function(e){var t,n,i;if(!e.participantSid&&!e.participantIdentity)throw new Error("Invalid track permission, must provide at least one of participantIdentity and participantSid");return new Sr({participantIdentity:null!==(t=e.participantIdentity)&&void 0!==t?t:"",participantSid:null!==(n=e.participantSid)&&void 0!==n?n:"",allTracks:null!==(i=e.allowAll)&&void 0!==i&&i,trackSids:e.allowedTrackSids||[]})}(e))))},this.onTrackUnmuted=e=>{this.onTrackMuted(e,e.isUpstreamPaused)},this.onTrackMuted=(e,t)=>{void 0===t&&(t=!0),e.sid?this.engine.updateMuteStatus(e.sid,t):this.log.error("could not update mute status for unpublished track",Object.assign(Object.assign({},this.logContext),tc(e)))},this.onTrackUpstreamPaused=e=>{this.log.debug("upstream paused",Object.assign(Object.assign({},this.logContext),tc(e))),this.onTrackMuted(e,!0)},this.onTrackUpstreamResumed=e=>{this.log.debug("upstream resumed",Object.assign(Object.assign({},this.logContext),tc(e))),this.onTrackMuted(e,e.isMuted)},this.onTrackFeatureUpdate=e=>{const t=this.audioTrackPublications.get(e.sid);t?this.engine.client.sendUpdateLocalAudioTrack(t.trackSid,t.getTrackFeatures()):this.log.warn("Could not update local audio track settings, missing publication for track ".concat(e.sid),this.logContext)},this.onTrackCpuConstrained=(e,t)=>{this.log.debug("track cpu constrained",Object.assign(Object.assign({},this.logContext),tc(t))),this.emit(Ea.LocalTrackCpuConstrained,e,t)},this.handleSubscribedQualityUpdate=e=>oo(this,void 0,void 0,(function*(){var t,n,i,r,o;if(!(null===(o=this.roomOptions)||void 0===o?void 0:o.dynacast))return;const a=this.videoTrackPublications.get(e.trackSid);if(!a)return void this.log.warn("received subscribed quality update for unknown track",Object.assign(Object.assign({},this.logContext),{trackSid:e.trackSid}));if(!a.videoTrack)return;const s=yield a.videoTrack.setPublishingCodecs(e.subscribedCodecs);try{for(var c,l=!0,d=ao(s);!(t=(c=yield d.next()).done);l=!0){r=c.value,l=!1;const e=r;ts(e)&&(this.log.debug("publish ".concat(e," for ").concat(a.videoTrack.sid),Object.assign(Object.assign({},this.logContext),tc(a))),yield this.publishAdditionalCodecForTrack(a.videoTrack,e,a.options))}}catch(e){n={error:e}}finally{try{l||t||!(i=d.return)||(yield i.call(d))}finally{if(n)throw n.error}}})),this.handleLocalTrackUnpublished=e=>{const t=this.trackPublications.get(e.trackSid);t?this.unpublishTrack(t.track):this.log.warn("received unpublished event for unknown track",Object.assign(Object.assign({},this.logContext),{trackSid:e.trackSid}))},this.handleTrackEnded=e=>oo(this,void 0,void 0,(function*(){if(e.source===Ya.Source.ScreenShare||e.source===Ya.Source.ScreenShareAudio)this.log.debug("unpublishing local track due to TrackEnded",Object.assign(Object.assign({},this.logContext),tc(e))),this.unpublishTrack(e);else if(e.isUserProvided)yield e.mute();else if(Ws(e)||qs(e))try{if(vs())try{const t=yield null===navigator||void 0===navigator?void 0:navigator.permissions.query({name:e.source===Ya.Source.Camera?"camera":"microphone"});if(t&&"denied"===t.state)throw this.log.warn("user has revoked access to ".concat(e.source),Object.assign(Object.assign({},this.logContext),tc(e))),t.onchange=()=>{"denied"!==t.state&&(e.isMuted||e.restartTrack(),t.onchange=null)},new Error("GetUserMedia Permission denied")}catch(e){}e.isMuted||(this.log.debug("track ended, attempting to use a different device",Object.assign(Object.assign({},this.logContext),tc(e))),Ws(e)?yield e.restartTrack({deviceId:"default"}):yield e.restartTrack())}catch(t){this.log.warn("could not restart track, muting instead",Object.assign(Object.assign({},this.logContext),tc(e))),yield e.mute()}})),this.audioTrackPublications=new Map,this.videoTrackPublications=new Map,this.trackPublications=new Map,this.engine=n,this.roomOptions=i,this.setupEngine(n),this.activeDeviceMap=new Map([["audioinput","default"],["videoinput","default"],["audiooutput","default"]]),this.pendingSignalRequests=new Map,this.rpcHandlers=r,this.roomOutgoingDataStreamManager=o}get lastCameraError(){return this.cameraError}get lastMicrophoneError(){return this.microphoneError}get isE2EEEnabled(){return this.encryptionType!==ci.NONE}getTrackPublication(e){const t=super.getTrackPublication(e);if(t)return t}getTrackPublicationByName(e){const t=super.getTrackPublicationByName(e);if(t)return t}setupEngine(e){var t;this.engine=e,this.engine.on(_a.RemoteMute,((e,t)=>{const n=this.trackPublications.get(e);n&&n.track&&(t?n.mute():n.unmute())})),(null===(t=this.signalConnectedFuture)||void 0===t?void 0:t.isResolved)&&(this.signalConnectedFuture=void 0),this.engine.on(_a.Connected,this.handleReconnected).on(_a.SignalConnected,this.handleSignalConnected).on(_a.SignalRestarted,this.handleReconnected).on(_a.SignalResumed,this.handleReconnected).on(_a.Restarting,this.handleReconnecting).on(_a.Resuming,this.handleReconnecting).on(_a.LocalTrackUnpublished,this.handleLocalTrackUnpublished).on(_a.SubscribedQualityUpdate,this.handleSubscribedQualityUpdate).on(_a.Closing,this.handleClosing).on(_a.SignalRequestResponse,this.handleSignalRequestResponse).on(_a.DataPacketReceived,this.handleDataPacket)}setMetadata(e){return oo(this,void 0,void 0,(function*(){yield this.requestMetadataUpdate({metadata:e})}))}setName(e){return oo(this,void 0,void 0,(function*(){yield this.requestMetadataUpdate({name:e})}))}setAttributes(e){return oo(this,void 0,void 0,(function*(){yield this.requestMetadataUpdate({attributes:e})}))}requestMetadataUpdate(e){return oo(this,arguments,void 0,(function(e){var t=this;let{metadata:n,name:i,attributes:r}=e;return function*(){return new Promise(((e,o)=>oo(t,void 0,void 0,(function*(){var t,a;try{let s=!1;const c=yield this.engine.client.sendUpdateLocalMetadata(null!==(t=null!=n?n:this.metadata)&&void 0!==t?t:"",null!==(a=null!=i?i:this.name)&&void 0!==a?a:"",r),l=performance.now();for(this.pendingSignalRequests.set(c,{resolve:e,reject:e=>{o(e),s=!0},values:{name:i,metadata:n,attributes:r}});performance.now()-l<5e3&&!s;){if((!i||this.name===i)&&(!n||this.metadata===n)&&(!r||Object.entries(r).every((e=>{let[t,n]=e;return this.attributes[t]===n||""===n&&!this.attributes[t]}))))return this.pendingSignalRequests.delete(c),void e();yield cs(50)}o(new Ua("Request to update local metadata timed out","TimeoutError"))}catch(e){e instanceof Error&&o(e)}}))))}()}))}setCameraEnabled(e,t,n){return this.setTrackEnabled(Ya.Source.Camera,e,t,n)}setMicrophoneEnabled(e,t,n){return this.setTrackEnabled(Ya.Source.Microphone,e,t,n)}setScreenShareEnabled(e,t,n){return this.setTrackEnabled(Ya.Source.ScreenShare,e,t,n)}setE2EEEnabled(e){return oo(this,void 0,void 0,(function*(){this.encryptionType=e?ci.GCM:ci.NONE,yield this.republishAllTracks(void 0,!1)}))}setTrackEnabled(e,t,n,i){return oo(this,void 0,void 0,(function*(){var r,o;this.log.debug("setTrackEnabled",Object.assign(Object.assign({},this.logContext),{source:e,enabled:t})),this.republishPromise&&(yield this.republishPromise);let a=this.getTrackPublication(e);if(t)if(a)yield a.unmute();else{let t;if(this.pendingPublishing.has(e)){const t=yield this.waitForPendingPublicationOfSource(e);return t||this.log.info("waiting for pending publication promise timed out",Object.assign(Object.assign({},this.logContext),{source:e})),yield null==t?void 0:t.unmute(),t}this.pendingPublishing.add(e);try{switch(e){case Ya.Source.Camera:t=yield this.createTracks({video:null===(r=n)||void 0===r||r});break;case Ya.Source.Microphone:t=yield this.createTracks({audio:null===(o=n)||void 0===o||o});break;case Ya.Source.ScreenShare:t=yield this.createScreenTracks(Object.assign({},n));break;default:throw new Ma(e)}}catch(n){throw null==t||t.forEach((e=>{e.stop()})),n instanceof Error&&this.emit(Ea.MediaDevicesError,n,Qs(e)),this.pendingPublishing.delete(e),n}for(const i of t){const t=Object.assign(Object.assign({},this.roomOptions.publishDefaults),n);e===Ya.Source.Microphone&&Bs(i)&&t.preConnectBuffer&&(this.log.info("starting preconnect buffer for microphone",Object.assign({},this.logContext)),i.startPreConnectBuffer())}try{const e=[];for(const n of t)this.log.info("publishing track",Object.assign(Object.assign({},this.logContext),tc(n))),e.push(this.publishTrack(n,i));const n=yield Promise.all(e);[a]=n}catch(e){throw null==t||t.forEach((e=>{e.stop()})),e}finally{this.pendingPublishing.delete(e)}}else if(!(null==a?void 0:a.track)&&this.pendingPublishing.has(e)&&(a=yield this.waitForPendingPublicationOfSource(e),a||this.log.info("waiting for pending publication promise timed out",Object.assign(Object.assign({},this.logContext),{source:e}))),a&&a.track)if(e===Ya.Source.ScreenShare){a=yield this.unpublishTrack(a.track);const e=this.getTrackPublication(Ya.Source.ScreenShareAudio);e&&e.track&&this.unpublishTrack(e.track)}else yield a.mute();return a}))}enableCameraAndMicrophone(){return oo(this,void 0,void 0,(function*(){if(!this.pendingPublishing.has(Ya.Source.Camera)&&!this.pendingPublishing.has(Ya.Source.Microphone)){this.pendingPublishing.add(Ya.Source.Camera),this.pendingPublishing.add(Ya.Source.Microphone);try{const e=yield this.createTracks({audio:!0,video:!0});yield Promise.all(e.map((e=>this.publishTrack(e))))}finally{this.pendingPublishing.delete(Ya.Source.Camera),this.pendingPublishing.delete(Ya.Source.Microphone)}}}))}createTracks(e){return oo(this,void 0,void 0,(function*(){var t,n;null!=e||(e={});const i=Ks(e,null===(t=this.roomOptions)||void 0===t?void 0:t.audioCaptureDefaults,null===(n=this.roomOptions)||void 0===n?void 0:n.videoCaptureDefaults);try{return(yield zl(i,{loggerName:this.roomOptions.loggerName,loggerContextCb:()=>this.logContext})).map((e=>(Bs(e)&&(this.microphoneError=void 0,e.setAudioContext(this.audioContext),e.source=Ya.Source.Microphone,this.emit(Ea.AudioStreamAcquired)),Vs(e)&&(this.cameraError=void 0,e.source=Ya.Source.Camera),e)))}catch(t){throw t instanceof Error&&(e.audio&&(this.microphoneError=t),e.video&&(this.cameraError=t)),t}}))}createScreenTracks(e){return oo(this,void 0,void 0,(function*(){if(void 0===e&&(e={}),void 0===navigator.mediaDevices.getDisplayMedia)throw new Da("getDisplayMedia not supported");void 0!==e.resolution||function(){const e=qa();return"Safari"===(null==e?void 0:e.name)&&e.version.startsWith("17.")||"iOS"===(null==e?void 0:e.os)&&!!(null==e?void 0:e.osVersion)&&Ts(e.osVersion,"17")>=0}()||(e.resolution=as.h1080fps30.resolution);const t=function(e){var t,n;let i=null===(t=e.video)||void 0===t||t;return e.resolution&&e.resolution.width>0&&e.resolution.height>0&&(i="boolean"==typeof i?{}:i,i=ms()?Object.assign(Object.assign({},i),{width:{max:e.resolution.width},height:{max:e.resolution.height},frameRate:e.resolution.frameRate}):Object.assign(Object.assign({},i),{width:{ideal:e.resolution.width},height:{ideal:e.resolution.height},frameRate:e.resolution.frameRate})),{audio:null!==(n=e.audio)&&void 0!==n&&n,video:i,controller:e.controller,selfBrowserSurface:e.selfBrowserSurface,surfaceSwitching:e.surfaceSwitching,systemAudio:e.systemAudio,preferCurrentTab:e.preferCurrentTab}}(e),n=yield navigator.mediaDevices.getDisplayMedia(t),i=n.getVideoTracks();if(0===i.length)throw new Ma("no video track found");const r=new ml(i[0],void 0,!1,{loggerName:this.roomOptions.loggerName,loggerContextCb:()=>this.logContext});r.source=Ya.Source.ScreenShare,e.contentHint&&(r.mediaStreamTrack.contentHint=e.contentHint);const o=[r];if(n.getAudioTracks().length>0){this.emit(Ea.AudioStreamAcquired);const e=new nl(n.getAudioTracks()[0],void 0,!1,this.audioContext,{loggerName:this.roomOptions.loggerName,loggerContextCb:()=>this.logContext});e.source=Ya.Source.ScreenShareAudio,o.push(e)}return o}))}publishTrack(e,t){return oo(this,void 0,void 0,(function*(){return this.publishOrRepublishTrack(e,t)}))}publishOrRepublishTrack(e,t){return oo(this,arguments,void 0,(function(e,t){var n=this;let i=arguments.length>2&&void 0!==arguments[2]&&arguments[2];return function*(){var r,o,a,s;let c,l;if(Ws(e)&&e.setAudioContext(n.audioContext),yield null===(r=n.reconnectFuture)||void 0===r?void 0:r.promise,n.republishPromise&&!i&&(yield n.republishPromise),Fs(e)&&n.pendingPublishPromises.has(e)&&(yield n.pendingPublishPromises.get(e)),e instanceof MediaStreamTrack)c=e.getConstraints();else{let t;switch(c=e.constraints,e.source){case Ya.Source.Microphone:t="audioinput";break;case Ya.Source.Camera:t="videoinput"}t&&n.activeDeviceMap.has(t)&&(c=Object.assign(Object.assign({},c),{deviceId:n.activeDeviceMap.get(t)}))}if(e instanceof MediaStreamTrack)switch(e.kind){case"audio":e=new nl(e,c,!0,n.audioContext,{loggerName:n.roomOptions.loggerName,loggerContextCb:()=>n.logContext});break;case"video":e=new ml(e,c,!0,{loggerName:n.roomOptions.loggerName,loggerContextCb:()=>n.logContext});break;default:throw new Ma("unsupported MediaStreamTrack kind ".concat(e.kind))}else e.updateLoggerOptions({loggerName:n.roomOptions.loggerName,loggerContextCb:()=>n.logContext});if(n.trackPublications.forEach((t=>{t.track&&t.track===e&&(l=t)})),l)return n.log.warn("track has already been published, skipping",Object.assign(Object.assign({},n.logContext),tc(l))),l;const d=Object.assign(Object.assign({},n.roomOptions.publishDefaults),t),u="channelCount"in e.mediaStreamTrack.getSettings()&&2===e.mediaStreamTrack.getSettings().channelCount||2===e.mediaStreamTrack.getConstraints().channelCount,h=null!==(o=d.forceStereo)&&void 0!==o?o:u;h&&(void 0===d.dtx&&n.log.info("Opus DTX will be disabled for stereo tracks by default. Enable them explicitly to make it work.",Object.assign(Object.assign({},n.logContext),tc(e))),void 0===d.red&&n.log.info("Opus RED will be disabled for stereo tracks by default. Enable them explicitly to make it work."),null!==(a=d.dtx)&&void 0!==a||(d.dtx=!1),null!==(s=d.red)&&void 0!==s||(d.red=!1)),!function(){const e=qa(),t="17.2";if(e)return"Safari"!==e.name&&"iOS"!==e.os||!!("iOS"===e.os&&e.osVersion&&Ts(e.osVersion,t)>=0)||"Safari"===e.name&&Ts(e.version,t)>=0}()&&n.roomOptions.e2ee&&(n.log.info("End-to-end encryption is set up, simulcast publishing will be disabled on Safari versions and iOS browsers running iOS < v17.2",Object.assign({},n.logContext)),d.simulcast=!1),d.source&&(e.source=d.source);const p=new Promise(((t,i)=>oo(n,void 0,void 0,(function*(){try{if(this.engine.client.currentState!==pc.CONNECTED){this.log.debug("deferring track publication until signal is connected",Object.assign(Object.assign({},this.logContext),{track:tc(e)}));const n=setTimeout((()=>{i(new ja("publishing rejected as engine not connected within timeout",408))}),15e3);yield this.waitUntilEngineConnected(),clearTimeout(n);const r=yield this.publish(e,d,h);t(r)}else try{const n=yield this.publish(e,d,h);t(n)}catch(e){i(e)}}catch(e){i(e)}}))));n.pendingPublishPromises.set(e,p);try{return yield p}catch(e){throw e}finally{n.pendingPublishPromises.delete(e)}}()}))}waitUntilEngineConnected(){return this.signalConnectedFuture||(this.signalConnectedFuture=new Ms),this.signalConnectedFuture.promise}hasPermissionsToPublish(e){if(!this.permissions)return this.log.warn("no permissions present for publishing track",Object.assign(Object.assign({},this.logContext),tc(e))),!1;const{canPublish:t,canPublishSources:n}=this.permissions;return!(!t||0!==n.length&&!n.map((e=>function(e){switch(e){case Kn.CAMERA:return Ya.Source.Camera;case Kn.MICROPHONE:return Ya.Source.Microphone;case Kn.SCREEN_SHARE:return Ya.Source.ScreenShare;case Kn.SCREEN_SHARE_AUDIO:return Ya.Source.ScreenShareAudio;default:return Ya.Source.Unknown}}(e))).includes(e.source))||(this.log.warn("insufficient permissions to publish",Object.assign(Object.assign({},this.logContext),tc(e))),!1)}publish(e,t,n){return oo(this,void 0,void 0,(function*(){var i,r,o,a,s,c,l,d,u,h;if(!this.hasPermissionsToPublish(e))throw new ja("failed to publish track, insufficient permissions",403);Array.from(this.trackPublications.values()).find((t=>Fs(e)&&t.source===e.source))&&e.source!==Ya.Source.Unknown&&this.log.info("publishing a second track with the same source: ".concat(e.source),Object.assign(Object.assign({},this.logContext),tc(e))),t.stopMicTrackOnMute&&Bs(e)&&(e.stopOnMute=!0),e.source===Ya.Source.ScreenShare&&ps()&&(t.simulcast=!1),"av1"!==t.videoCodec||function(){if(!("getCapabilities"in RTCRtpSender))return!1;if(ms()||ps())return!1;const e=RTCRtpSender.getCapabilities("video");let t=!1;if(e)for(const n of e.codecs)if("video/av1"===n.mimeType.toLowerCase()){t=!0;break}return t}()||(t.videoCodec=void 0),"vp9"!==t.videoCodec||function(){if(!("getCapabilities"in RTCRtpSender))return!1;if(ps())return!1;if(ms()){const e=qa();if((null==e?void 0:e.version)&&Ts(e.version,"16")<0)return!1;if("iOS"===(null==e?void 0:e.os)&&(null==e?void 0:e.osVersion)&&Ts(e.osVersion,"16")<0)return!1}const e=RTCRtpSender.getCapabilities("video");let t=!1;if(e)for(const n of e.codecs)if("video/vp9"===n.mimeType.toLowerCase()){t=!0;break}return t}()||(t.videoCodec=void 0),void 0===t.videoCodec&&(t.videoCodec=Fc),this.enabledPublishVideoCodecs.length>0&&(this.enabledPublishVideoCodecs.some((e=>t.videoCodec===Zs(e.mime)))||(t.videoCodec=Zs(this.enabledPublishVideoCodecs[0].mime)));const p=t.videoCodec;e.on(Pa.Muted,this.onTrackMuted),e.on(Pa.Unmuted,this.onTrackUnmuted),e.on(Pa.Ended,this.handleTrackEnded),e.on(Pa.UpstreamPaused,this.onTrackUpstreamPaused),e.on(Pa.UpstreamResumed,this.onTrackUpstreamResumed),e.on(Pa.AudioTrackFeatureUpdate,this.onTrackFeatureUpdate);const m=[],f=!(null===(i=t.dtx)||void 0===i||i),g=e.getSourceTrackSettings();g.autoGainControl&&m.push(ei.TF_AUTO_GAIN_CONTROL),g.echoCancellation&&m.push(ei.TF_ECHO_CANCELLATION),g.noiseSuppression&&m.push(ei.TF_NOISE_SUPPRESSION),g.channelCount&&g.channelCount>1&&m.push(ei.TF_STEREO),f&&m.push(ei.TF_NO_DTX),Ws(e)&&e.hasPreConnectBuffer&&m.push(ei.TF_PRECONNECT_BUFFER);const v=new Xi({cid:e.mediaStreamTrack.id,name:t.name,type:Ya.kindToProto(e.kind),muted:e.isMuted,source:Ya.sourceToProto(e.source),disableDtx:f,encryption:this.encryptionType,stereo:n,disableRed:this.isE2EEEnabled||!(null===(r=t.red)||void 0===r||r),stream:null==t?void 0:t.stream,backupCodecPolicy:null==t?void 0:t.backupCodecPolicy,audioFeatures:m});let b;if(e.kind===Ya.Kind.Video){let n={width:0,height:0};try{n=yield e.waitForDimensions()}catch(t){const i=null!==(a=null===(o=this.roomOptions.videoCaptureDefaults)||void 0===o?void 0:o.resolution)&&void 0!==a?a:rs.h720.resolution;n={width:i.width,height:i.height},this.log.error("could not determine track dimensions, using defaults",Object.assign(Object.assign(Object.assign({},this.logContext),tc(e)),{dims:n}))}v.width=n.width,v.height=n.height,qs(e)&&(us(p)&&(e.source===Ya.Source.ScreenShare&&(t.scalabilityMode="L1T3","contentHint"in e.mediaStreamTrack&&(e.mediaStreamTrack.contentHint="motion",this.log.info("forcing contentHint to motion for screenshare with SVC codecs",Object.assign(Object.assign({},this.logContext),tc(e))))),t.scalabilityMode=null!==(s=t.scalabilityMode)&&void 0!==s?s:"L3T3_KEY"),v.simulcastCodecs=[new Yi({codec:p,cid:e.mediaStreamTrack.id})],!0===t.backupCodec&&(t.backupCodec={codec:Fc}),t.backupCodec&&p!==t.backupCodec.codec&&v.encryption===ci.NONE&&(this.roomOptions.dynacast||(this.roomOptions.dynacast=!0),v.simulcastCodecs.push(new Yi({codec:t.backupCodec.codec,cid:""})))),b=ll(e.source===Ya.Source.ScreenShare,v.width,v.height,t),v.layers=vl(v.width,v.height,b,us(t.videoCodec))}else e.kind===Ya.Kind.Audio&&(b=[{maxBitrate:null===(c=t.audioPreset)||void 0===c?void 0:c.maxBitrate,priority:null!==(d=null===(l=t.audioPreset)||void 0===l?void 0:l.priority)&&void 0!==d?d:"high",networkPriority:null!==(h=null===(u=t.audioPreset)||void 0===u?void 0:u.priority)&&void 0!==h?h:"high"}]);if(!this.engine||this.engine.isClosed)throw new Na("cannot publish track when not connected");const y=()=>oo(this,void 0,void 0,(function*(){var n,i,r;if(!this.engine.pcManager)throw new Na("pcManager is not ready");if(e.sender=yield this.engine.createSender(e,t,b),this.emit(Ea.LocalSenderCreated,e.sender,e),qs(e)&&(null!==(n=t.degradationPreference)&&void 0!==n||(t.degradationPreference=function(e){return e.source===Ya.Source.ScreenShare||e.constraints.height&&As(e.constraints.height)>=1080?"maintain-resolution":"balanced"}(e)),e.setDegradationPreference(t.degradationPreference)),b)if(ps()&&e.kind===Ya.Kind.Audio){let t;for(const n of this.engine.pcManager.publisher.getTransceivers())if(n.sender===e.sender){t=n;break}t&&this.engine.pcManager.publisher.setTrackCodecBitrate({transceiver:t,codec:"opus",maxbr:(null===(i=b[0])||void 0===i?void 0:i.maxBitrate)?b[0].maxBitrate/1e3:0})}else e.codec&&us(e.codec)&&(null===(r=b[0])||void 0===r?void 0:r.maxBitrate)&&this.engine.pcManager.publisher.setTrackCodecBitrate({cid:v.cid,codec:e.codec,maxbr:b[0].maxBitrate/1e3});yield this.engine.negotiate()}));let k;const w=new Promise(((t,n)=>oo(this,void 0,void 0,(function*(){var i;try{k=yield this.engine.addTrack(v),t(k)}catch(t){e.sender&&(null===(i=this.engine.pcManager)||void 0===i?void 0:i.publisher)&&(this.engine.pcManager.publisher.removeTrack(e.sender),yield this.engine.negotiate().catch((t=>{this.log.error("failed to negotiate after removing track due to failed add track request",Object.assign(Object.assign(Object.assign({},this.logContext),tc(e)),{error:t}))}))),n(t)}}))));if(this.enabledPublishVideoCodecs.length>0){const e=yield Promise.all([w,y()]);k=e[0]}else{let n;if(k=yield w,k.codecs.forEach((e=>{void 0===n&&(n=e.mimeType)})),n&&e.kind===Ya.Kind.Video){const i=Zs(n);i!==p&&(this.log.debug("falling back to server selected codec",Object.assign(Object.assign(Object.assign({},this.logContext),tc(e)),{codec:i})),t.videoCodec=i,b=ll(e.source===Ya.Source.ScreenShare,v.width,v.height,t))}yield y()}const C=new Hl(e.kind,k,e,{loggerName:this.roomOptions.loggerName,loggerContextCb:()=>this.logContext});if(C.on(Pa.CpuConstrained,(e=>this.onTrackCpuConstrained(e,C))),C.options=t,e.sid=k.sid,this.log.debug("publishing ".concat(e.kind," with encodings"),Object.assign(Object.assign({},this.logContext),{encodings:b,trackInfo:k})),qs(e)?e.startMonitor(this.engine.client):Ws(e)&&e.startMonitor(),this.addTrackPublication(C),this.emit(Ea.LocalTrackPublished,C),Ws(e)&&k.audioFeatures.includes(ei.TF_PRECONNECT_BUFFER)){const t=e.getPreConnectBuffer(),n=e.getPreConnectBufferMimeType();if(this.on(Ea.LocalTrackSubscribed,(t=>{if(t.trackSid===k.sid){if(!e.hasPreConnectBuffer)return void this.log.warn("subscribe event came to late, buffer already closed",this.logContext);this.log.debug("finished recording preconnect buffer",Object.assign(Object.assign({},this.logContext),tc(e))),e.stopPreConnectBuffer()}})),t){const i=new Promise(((i,r)=>oo(this,void 0,void 0,(function*(){var o,a,s,c,l,d;try{this.log.debug("waiting for agent",Object.assign(Object.assign({},this.logContext),tc(e)));const m=setTimeout((()=>{r(new Error("agent not active within 10 seconds"))}),1e4),f=yield this.waitUntilActiveAgentPresent();clearTimeout(m),this.log.debug("sending preconnect buffer",Object.assign(Object.assign({},this.logContext),tc(e)));const v=yield this.streamBytes({name:"preconnect-buffer",mimeType:n,topic:"lk.agent.pre-connect-audio-buffer",destinationIdentities:[f.identity],attributes:{trackId:C.trackSid,sampleRate:String(null!==(l=g.sampleRate)&&void 0!==l?l:"48000"),channels:String(null!==(d=g.channelCount)&&void 0!==d?d:"1")}});try{for(var u,h=!0,p=ao(t);!(o=(u=yield p.next()).done);h=!0){c=u.value,h=!1;const e=c;yield v.write(e)}}catch(e){a={error:e}}finally{try{h||o||!(s=p.return)||(yield s.call(p))}finally{if(a)throw a.error}}yield v.close(),i()}catch(e){r(e)}}))));i.then((()=>{this.log.debug("preconnect buffer sent successfully",Object.assign(Object.assign({},this.logContext),tc(e)))})).catch((t=>{this.log.error("error sending preconnect buffer",Object.assign(Object.assign(Object.assign({},this.logContext),tc(e)),{error:t}))}))}}return C}))}get isLocal(){return!0}publishAdditionalCodecForTrack(e,t,n){return oo(this,void 0,void 0,(function*(){var i;if(this.encryptionType!==ci.NONE)return;let r;if(this.trackPublications.forEach((t=>{t.track&&t.track===e&&(r=t)})),!r)throw new Ma("track is not published");if(!qs(e))throw new Ma("track is not a video track");const o=Object.assign(Object.assign({},null===(i=this.roomOptions)||void 0===i?void 0:i.publishDefaults),n),a=function(e,t,n){var i,r,o,a;if(!n.backupCodec||!0===n.backupCodec||n.backupCodec.codec===n.videoCodec)return;t!==n.backupCodec.codec&&eo.warn("requested a different codec than specified as backup",{serverRequested:t,backup:n.backupCodec.codec}),n.videoCodec=t,n.videoEncoding=n.backupCodec.encoding;const s=e.mediaStreamTrack.getSettings(),c=null!==(i=s.width)&&void 0!==i?i:null===(r=e.dimensions)||void 0===r?void 0:r.width,l=null!==(o=s.height)&&void 0!==o?o:null===(a=e.dimensions)||void 0===a?void 0:a.height;return e.source===Ya.Source.ScreenShare&&n.simulcast&&(n.simulcast=!1),ll(e.source===Ya.Source.ScreenShare,c,l,n)}(e,t,o);if(!a)return void this.log.info("backup codec has been disabled, ignoring request to add additional codec for track",Object.assign(Object.assign({},this.logContext),tc(e)));const s=e.addSimulcastTrack(t,a);if(!s)return;const c=new Xi({cid:s.mediaStreamTrack.id,type:Ya.kindToProto(e.kind),muted:e.isMuted,source:Ya.sourceToProto(e.source),sid:e.sid,simulcastCodecs:[{codec:o.videoCodec,cid:s.mediaStreamTrack.id}]});if(c.layers=vl(c.width,c.height,a),!this.engine||this.engine.isClosed)throw new Na("cannot publish track when not connected");const l=(yield Promise.all([this.engine.addTrack(c),(()=>oo(this,void 0,void 0,(function*(){yield this.engine.createSimulcastSender(e,s,o,a),yield this.engine.negotiate()})))()]))[0];this.log.debug("published ".concat(t," for track ").concat(e.sid),Object.assign(Object.assign({},this.logContext),{encodings:a,trackInfo:l}))}))}unpublishTrack(e,t){return oo(this,void 0,void 0,(function*(){var n,i;if(Fs(e)){const t=this.pendingPublishPromises.get(e);t&&(this.log.info("awaiting publish promise before attempting to unpublish",Object.assign(Object.assign({},this.logContext),tc(e))),yield t)}const r=this.getPublicationForTrack(e),o=r?tc(r):void 0;if(this.log.debug("unpublishing track",Object.assign(Object.assign({},this.logContext),o)),!r||!r.track)return void this.log.warn("track was not unpublished because no publication was found",Object.assign(Object.assign({},this.logContext),o));(e=r.track).off(Pa.Muted,this.onTrackMuted),e.off(Pa.Unmuted,this.onTrackUnmuted),e.off(Pa.Ended,this.handleTrackEnded),e.off(Pa.UpstreamPaused,this.onTrackUpstreamPaused),e.off(Pa.UpstreamResumed,this.onTrackUpstreamResumed),e.off(Pa.AudioTrackFeatureUpdate,this.onTrackFeatureUpdate),void 0===t&&(t=null===(i=null===(n=this.roomOptions)||void 0===n?void 0:n.stopLocalTrackOnUnpublish)||void 0===i||i),t?e.stop():e.stopMonitor();let a=!1;const s=e.sender;if(e.sender=void 0,this.engine.pcManager&&this.engine.pcManager.currentState<zc.FAILED&&s)try{for(const e of this.engine.pcManager.publisher.getTransceivers())e.sender===s&&(e.direction="inactive",a=!0);if(this.engine.removeTrack(s)&&(a=!0),qs(e)){for(const[,t]of e.simulcastCodecs)t.sender&&(this.engine.removeTrack(t.sender)&&(a=!0),t.sender=void 0);e.simulcastCodecs.clear()}}catch(e){this.log.warn("failed to unpublish track",Object.assign(Object.assign(Object.assign({},this.logContext),o),{error:e}))}switch(this.trackPublications.delete(r.trackSid),r.kind){case Ya.Kind.Audio:this.audioTrackPublications.delete(r.trackSid);break;case Ya.Kind.Video:this.videoTrackPublications.delete(r.trackSid)}return this.emit(Ea.LocalTrackUnpublished,r),r.setTrack(void 0),a&&(yield this.engine.negotiate()),r}))}unpublishTracks(e){return oo(this,void 0,void 0,(function*(){return(yield Promise.all(e.map((e=>this.unpublishTrack(e))))).filter((e=>!!e))}))}republishAllTracks(e){return oo(this,arguments,void 0,(function(e){var t=this;let n=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];return function*(){t.republishPromise&&(yield t.republishPromise),t.republishPromise=new Promise(((i,r)=>oo(t,void 0,void 0,(function*(){try{const t=[];this.trackPublications.forEach((n=>{n.track&&(e&&(n.options=Object.assign(Object.assign({},n.options),e)),t.push(n))})),yield Promise.all(t.map((e=>oo(this,void 0,void 0,(function*(){const t=e.track;yield this.unpublishTrack(t,!1),!n||t.isMuted||t.source===Ya.Source.ScreenShare||t.source===Ya.Source.ScreenShareAudio||!Ws(t)&&!qs(t)||t.isUserProvided||(this.log.debug("restarting existing track",Object.assign(Object.assign({},this.logContext),{track:e.trackSid})),yield t.restartTrack()),yield this.publishOrRepublishTrack(t,e.options,!0)}))))),i()}catch(e){r(e)}finally{this.republishPromise=void 0}})))),yield t.republishPromise}()}))}publishData(e){return oo(this,arguments,void 0,(function(e){var t=this;let n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return function*(){const i=n.reliable?mi.RELIABLE:mi.LOSSY,r=n.destinationIdentities,o=n.topic;let a=new yi({participantIdentity:t.identity,payload:e,destinationIdentities:r,topic:o});const s=new pi({kind:i,value:{case:"user",value:a}});yield t.engine.sendDataPacket(s,i)}()}))}publishDtmf(e,t){return oo(this,void 0,void 0,(function*(){const n=new pi({kind:mi.RELIABLE,value:{case:"sipDtmf",value:new ki({code:e,digit:t})}});yield this.engine.sendDataPacket(n,mi.RELIABLE)}))}sendChatMessage(e,t){return oo(this,void 0,void 0,(function*(){const n={id:crypto.randomUUID(),message:e,timestamp:Date.now(),attachedFiles:null==t?void 0:t.attachments},i=new pi({value:{case:"chatMessage",value:new Ti(Object.assign(Object.assign({},n),{timestamp:Dt.parse(n.timestamp)}))}});return yield this.engine.sendDataPacket(i,mi.RELIABLE),this.emit(Ea.ChatMessage,n),n}))}editChatMessage(e,t){return oo(this,void 0,void 0,(function*(){const n=Object.assign(Object.assign({},t),{message:e,editTimestamp:Date.now()}),i=new pi({value:{case:"chatMessage",value:new Ti(Object.assign(Object.assign({},n),{timestamp:Dt.parse(n.timestamp),editTimestamp:Dt.parse(n.editTimestamp)}))}});return yield this.engine.sendDataPacket(i,mi.RELIABLE),this.emit(Ea.ChatMessage,n),n}))}sendText(e,t){return oo(this,void 0,void 0,(function*(){return this.roomOutgoingDataStreamManager.sendText(e,t)}))}streamText(e){return oo(this,void 0,void 0,(function*(){return this.roomOutgoingDataStreamManager.streamText(e)}))}sendFile(e,t){return oo(this,void 0,void 0,(function*(){return this.roomOutgoingDataStreamManager.sendFile(e,t)}))}streamBytes(e){return oo(this,void 0,void 0,(function*(){return this.roomOutgoingDataStreamManager.streamBytes(e)}))}performRpc(e){return oo(this,arguments,void 0,(function(e){var t=this;let{destinationIdentity:n,method:i,payload:r,responseTimeout:o=15e3}=e;return function*(){return new Promise(((e,a)=>oo(t,void 0,void 0,(function*(){var t,s,c,l;if(Jc(r)>15360)return void a(Kc.builtIn("REQUEST_PAYLOAD_TOO_LARGE"));if((null===(s=null===(t=this.engine.latestJoinResponse)||void 0===t?void 0:t.serverInfo)||void 0===s?void 0:s.version)&&Ts(null===(l=null===(c=this.engine.latestJoinResponse)||void 0===c?void 0:c.serverInfo)||void 0===l?void 0:l.version,"1.8.0")<0)return void a(Kc.builtIn("UNSUPPORTED_SERVER"));const d=Math.max(o,8e3),u=crypto.randomUUID();yield this.publishRpcRequest(n,u,i,r,d);const h=setTimeout((()=>{this.pendingAcks.delete(u),a(Kc.builtIn("CONNECTION_TIMEOUT")),this.pendingResponses.delete(u),clearTimeout(p)}),7e3);this.pendingAcks.set(u,{resolve:()=>{clearTimeout(h)},participantIdentity:n});const p=setTimeout((()=>{this.pendingResponses.delete(u),a(Kc.builtIn("RESPONSE_TIMEOUT"))}),o);this.pendingResponses.set(u,{resolve:(t,n)=>{clearTimeout(p),this.pendingAcks.has(u)&&(console.warn("RPC response received before ack",u),this.pendingAcks.delete(u),clearTimeout(h)),n?a(n):e(null!=t?t:"")},participantIdentity:n})}))))}()}))}registerRpcMethod(e,t){this.rpcHandlers.has(e)&&this.log.warn("you're overriding the RPC handler for method ".concat(e,", in the future this will throw an error")),this.rpcHandlers.set(e,t)}unregisterRpcMethod(e){this.rpcHandlers.delete(e)}setTrackSubscriptionPermissions(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[];this.participantTrackPermissions=t,this.allParticipantsAllowedToSubscribe=e,this.engine.client.isDisconnected||this.updateTrackSubscriptionPermissions()}handleIncomingRpcAck(e){const t=this.pendingAcks.get(e);t?(t.resolve(),this.pendingAcks.delete(e)):console.error("Ack received for unexpected RPC request",e)}handleIncomingRpcResponse(e,t,n){const i=this.pendingResponses.get(e);i?(i.resolve(t,n),this.pendingResponses.delete(e)):console.error("Response received for unexpected RPC request",e)}publishRpcRequest(e,t,n,i,r){return oo(this,void 0,void 0,(function*(){const o=new pi({destinationIdentities:[e],kind:mi.RELIABLE,value:{case:"rpcRequest",value:new Si({id:t,method:n,payload:i,responseTimeoutMs:r,version:1})}});yield this.engine.sendDataPacket(o,mi.RELIABLE)}))}handleParticipantDisconnected(e){for(const[t,{participantIdentity:n}]of this.pendingAcks)n===e&&this.pendingAcks.delete(t);for(const[t,{participantIdentity:n,resolve:i}]of this.pendingResponses)n===e&&(i(null,Kc.builtIn("RECIPIENT_DISCONNECTED")),this.pendingResponses.delete(t))}setEnabledPublishCodecs(e){this.enabledPublishVideoCodecs=e.filter((e=>"video"===e.mime.split("/")[0].toLowerCase()))}updateInfo(e){return!!super.updateInfo(e)&&(e.tracks.forEach((e=>{var t,n;const i=this.trackPublications.get(e.sid);if(i){const r=i.isMuted||null!==(n=null===(t=i.track)||void 0===t?void 0:t.isUpstreamPaused)&&void 0!==n&&n;r!==e.muted&&(this.log.debug("updating server mute state after reconcile",Object.assign(Object.assign(Object.assign({},this.logContext),tc(i)),{mutedOnServer:r})),this.engine.client.sendMuteTrack(e.sid,r))}})),!0)}setActiveAgent(e){var t,n,i,r;this.firstActiveAgent=e,e&&!this.firstActiveAgent&&(this.firstActiveAgent=e),e?null===(n=null===(t=this.activeAgentFuture)||void 0===t?void 0:t.resolve)||void 0===n||n.call(t,e):null===(r=null===(i=this.activeAgentFuture)||void 0===i?void 0:i.reject)||void 0===r||r.call(i,"Agent disconnected"),this.activeAgentFuture=void 0}waitUntilActiveAgentPresent(){return this.firstActiveAgent?Promise.resolve(this.firstActiveAgent):(this.activeAgentFuture||(this.activeAgentFuture=new Ms),this.activeAgentFuture.promise)}getPublicationForTrack(e){let t;return this.trackPublications.forEach((n=>{const i=n.track;i&&(e instanceof MediaStreamTrack?(Ws(i)||qs(i))&&i.mediaStreamTrack===e&&(t=n):e===i&&(t=n))})),t}waitForPendingPublicationOfSource(e){return oo(this,void 0,void 0,(function*(){const t=Date.now();for(;Date.now()<t+1e4;){const t=Array.from(this.pendingPublishPromises.entries()).find((t=>{let[n]=t;return n.source===e}));if(t)return t[1];yield cs(20)}}))}}class Jl extends Wl{constructor(e,t,n,i){super(e,t.sid,t.name,i),this.track=void 0,this.allowed=!0,this.requestedDisabled=void 0,this.visible=!0,this.handleEnded=e=>{this.setTrack(void 0),this.emit(Pa.Ended,e)},this.handleVisibilityChange=e=>{this.log.debug("adaptivestream video visibility ".concat(this.trackSid,", visible=").concat(e),this.logContext),this.visible=e,this.emitTrackUpdate()},this.handleVideoDimensionsChange=e=>{this.log.debug("adaptivestream video dimensions ".concat(e.width,"x").concat(e.height),this.logContext),this.videoDimensionsAdaptiveStream=e,this.emitTrackUpdate()},this.subscribed=n,this.updateInfo(t)}setSubscribed(e){const t=this.subscriptionStatus,n=this.permissionStatus;this.subscribed=e,e&&(this.allowed=!0);const i=new or({trackSids:[this.trackSid],subscribe:this.subscribed,participantTracks:[new Pi({participantSid:"",trackSids:[this.trackSid]})]});this.emit(Pa.UpdateSubscription,i),this.emitSubscriptionUpdateIfChanged(t),this.emitPermissionUpdateIfChanged(n)}get subscriptionStatus(){return!1===this.subscribed?Wl.SubscriptionStatus.Unsubscribed:super.isSubscribed?Wl.SubscriptionStatus.Subscribed:Wl.SubscriptionStatus.Desired}get permissionStatus(){return this.allowed?Wl.PermissionStatus.Allowed:Wl.PermissionStatus.NotAllowed}get isSubscribed(){return!1!==this.subscribed&&super.isSubscribed}get isDesired(){return!1!==this.subscribed}get isEnabled(){return void 0!==this.requestedDisabled?!this.requestedDisabled:!this.isAdaptiveStream||this.visible}get isLocal(){return!1}setEnabled(e){this.isManualOperationAllowed()&&this.requestedDisabled!==!e&&(this.requestedDisabled=!e,this.emitTrackUpdate())}setVideoQuality(e){this.isManualOperationAllowed()&&this.requestedMaxQuality!==e&&(this.requestedMaxQuality=e,this.requestedVideoDimensions=void 0,this.emitTrackUpdate())}setVideoDimensions(e){var t,n;this.isManualOperationAllowed()&&((null===(t=this.requestedVideoDimensions)||void 0===t?void 0:t.width)===e.width&&(null===(n=this.requestedVideoDimensions)||void 0===n?void 0:n.height)===e.height||(Gs(this.track)&&(this.requestedVideoDimensions=e),this.requestedMaxQuality=void 0,this.emitTrackUpdate()))}setVideoFPS(e){this.isManualOperationAllowed()&&Gs(this.track)&&this.fps!==e&&(this.fps=e,this.emitTrackUpdate())}get videoQuality(){var e;return null!==(e=this.requestedMaxQuality)&&void 0!==e?e:Ja.HIGH}setTrack(e){const t=this.subscriptionStatus,n=this.permissionStatus,i=this.track;i!==e&&(i&&(i.off(Pa.VideoDimensionsChanged,this.handleVideoDimensionsChange),i.off(Pa.VisibilityChanged,this.handleVisibilityChange),i.off(Pa.Ended,this.handleEnded),i.detach(),i.stopMonitor(),this.emit(Pa.Unsubscribed,i)),super.setTrack(e),e&&(e.sid=this.trackSid,e.on(Pa.VideoDimensionsChanged,this.handleVideoDimensionsChange),e.on(Pa.VisibilityChanged,this.handleVisibilityChange),e.on(Pa.Ended,this.handleEnded),this.emit(Pa.Subscribed,e)),this.emitPermissionUpdateIfChanged(n),this.emitSubscriptionUpdateIfChanged(t))}setAllowed(e){const t=this.subscriptionStatus,n=this.permissionStatus;this.allowed=e,this.emitPermissionUpdateIfChanged(n),this.emitSubscriptionUpdateIfChanged(t)}setSubscriptionError(e){this.emit(Pa.SubscriptionFailed,e)}updateInfo(e){super.updateInfo(e);const t=this.metadataMuted;this.metadataMuted=e.muted,this.track?this.track.setMuted(e.muted):t!==e.muted&&this.emit(e.muted?Pa.Muted:Pa.Unmuted)}emitSubscriptionUpdateIfChanged(e){const t=this.subscriptionStatus;e!==t&&this.emit(Pa.SubscriptionStatusChanged,t,e)}emitPermissionUpdateIfChanged(e){this.permissionStatus!==e&&this.emit(Pa.SubscriptionPermissionChanged,this.permissionStatus,e)}isManualOperationAllowed(){return!!this.isDesired||(this.log.warn("cannot update track settings when not subscribed",this.logContext),!1)}get isAdaptiveStream(){return Gs(this.track)&&this.track.isAdaptiveStream}emitTrackUpdate(){const e=new ar({trackSids:[this.trackSid],disabled:!this.isEnabled,fps:this.fps});if(this.kind===Ya.Kind.Video){let r=this.requestedVideoDimensions;if(void 0!==this.videoDimensionsAdaptiveStream)if(r)ic(this.videoDimensionsAdaptiveStream,r)&&(this.log.debug("using adaptive stream dimensions instead of requested",Object.assign(Object.assign({},this.logContext),this.videoDimensionsAdaptiveStream)),r=this.videoDimensionsAdaptiveStream);else if(void 0!==this.requestedMaxQuality&&this.trackInfo){const e=(t=this.trackInfo,n=this.requestedMaxQuality,null===(i=t.layers)||void 0===i?void 0:i.find((e=>e.quality===n)));e&&ic(this.videoDimensionsAdaptiveStream,e)&&(this.log.debug("using adaptive stream dimensions instead of max quality layer",Object.assign(Object.assign({},this.logContext),this.videoDimensionsAdaptiveStream)),r=this.videoDimensionsAdaptiveStream)}else this.log.debug("using adaptive stream dimensions",Object.assign(Object.assign({},this.logContext),this.videoDimensionsAdaptiveStream)),r=this.videoDimensionsAdaptiveStream;r?(e.width=Math.ceil(r.width),e.height=Math.ceil(r.height)):void 0!==this.requestedMaxQuality?(this.log.debug("using requested max quality",Object.assign(Object.assign({},this.logContext),{quality:this.requestedMaxQuality})),e.quality=this.requestedMaxQuality):(this.log.debug("using default quality",Object.assign(Object.assign({},this.logContext),{quality:Ja.HIGH})),e.quality=Ja.HIGH)}var t,n,i;this.emit(Pa.UpdateSettings,e)}}class Yl extends Gl{static fromParticipantInfo(e,t,n){return new Yl(e,t.sid,t.identity,t.name,t.metadata,t.attributes,n,t.kind)}get logContext(){return Object.assign(Object.assign({},super.logContext),{rpID:this.sid,remoteParticipant:this.identity})}constructor(e,t,n,i,r,o,a){super(t,n||"",i,r,o,a,arguments.length>7&&void 0!==arguments[7]?arguments[7]:ai.STANDARD),this.signalClient=e,this.trackPublications=new Map,this.audioTrackPublications=new Map,this.videoTrackPublications=new Map,this.volumeMap=new Map}addTrackPublication(e){super.addTrackPublication(e),e.on(Pa.UpdateSettings,(t=>{this.log.debug("send update settings",Object.assign(Object.assign(Object.assign({},this.logContext),tc(e)),{settings:t})),this.signalClient.sendUpdateTrackSettings(t)})),e.on(Pa.UpdateSubscription,(e=>{e.participantTracks.forEach((e=>{e.participantSid=this.sid})),this.signalClient.sendUpdateSubscription(e)})),e.on(Pa.SubscriptionPermissionChanged,(t=>{this.emit(Ea.TrackSubscriptionPermissionChanged,e,t)})),e.on(Pa.SubscriptionStatusChanged,(t=>{this.emit(Ea.TrackSubscriptionStatusChanged,e,t)})),e.on(Pa.Subscribed,(t=>{this.emit(Ea.TrackSubscribed,t,e)})),e.on(Pa.Unsubscribed,(t=>{this.emit(Ea.TrackUnsubscribed,t,e)})),e.on(Pa.SubscriptionFailed,(t=>{this.emit(Ea.TrackSubscriptionFailed,e.trackSid,t)}))}getTrackPublication(e){const t=super.getTrackPublication(e);if(t)return t}getTrackPublicationByName(e){const t=super.getTrackPublicationByName(e);if(t)return t}setVolume(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:Ya.Source.Microphone;this.volumeMap.set(t,e);const n=this.getTrackPublication(t);n&&n.track&&n.track.setVolume(e)}getVolume(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:Ya.Source.Microphone;const t=this.getTrackPublication(e);return t&&t.track?t.track.getVolume():this.volumeMap.get(e)}addSubscribedMediaTrack(e,t,n,i,r,o){let a,s=this.getTrackPublicationBySid(t);return s||t.startsWith("TR")||this.trackPublications.forEach((t=>{s||e.kind!==t.kind.toString()||(s=t)})),s?"ended"===e.readyState?(this.log.error("unable to subscribe because MediaStreamTrack is ended. Do not call MediaStreamTrack.stop()",Object.assign(Object.assign({},this.logContext),tc(s))),void this.emit(Ea.TrackSubscriptionFailed,t)):(a="video"===e.kind?new Fl(e,t,i,r):new Ul(e,t,i,this.audioContext,this.audioOutput),a.source=s.source,a.isMuted=s.isMuted,a.setMediaStream(n),a.start(),s.setTrack(a),this.volumeMap.has(s.source)&&Hs(a)&&Bs(a)&&a.setVolume(this.volumeMap.get(s.source)),s):0===o?(this.log.error("could not find published track",Object.assign(Object.assign({},this.logContext),{trackSid:t})),void this.emit(Ea.TrackSubscriptionFailed,t)):(void 0===o&&(o=20),void setTimeout((()=>{this.addSubscribedMediaTrack(e,t,n,i,r,o-1)}),150))}get hasMetadata(){return!!this.participantInfo}getTrackPublicationBySid(e){return this.trackPublications.get(e)}updateInfo(e){if(!super.updateInfo(e))return!1;const t=new Map,n=new Map;return e.tracks.forEach((e=>{var i,r;let o=this.getTrackPublicationBySid(e.sid);if(o)o.updateInfo(e);else{const t=Ya.kindFromProto(e.type);if(!t)return;o=new Jl(t,e,null===(i=this.signalClient.connectOptions)||void 0===i?void 0:i.autoSubscribe,{loggerContextCb:()=>this.logContext,loggerName:null===(r=this.loggerOptions)||void 0===r?void 0:r.loggerName}),o.updateInfo(e),n.set(e.sid,o);const a=Array.from(this.trackPublications.values()).find((e=>e.source===(null==o?void 0:o.source)));a&&o.source!==Ya.Source.Unknown&&this.log.debug("received a second track publication for ".concat(this.identity," with the same source: ").concat(o.source),Object.assign(Object.assign({},this.logContext),{oldTrack:tc(a),newTrack:tc(o)})),this.addTrackPublication(o)}t.set(e.sid,o)})),this.trackPublications.forEach((e=>{t.has(e.trackSid)||(this.log.trace("detected removed track on remote participant, unpublishing",Object.assign(Object.assign({},this.logContext),tc(e))),this.unpublishTrack(e.trackSid,!0))})),n.forEach((e=>{this.emit(Ea.TrackPublished,e)})),!0}unpublishTrack(e,t){const n=this.trackPublications.get(e);if(!n)return;const{track:i}=n;switch(i&&(i.stop(),n.setTrack(void 0)),this.trackPublications.delete(e),n.kind){case Ya.Kind.Audio:this.audioTrackPublications.delete(e);break;case Ya.Kind.Video:this.videoTrackPublications.delete(e)}t&&this.emit(Ea.TrackUnpublished,n)}setAudioOutput(e){return oo(this,void 0,void 0,(function*(){this.audioOutput=e;const t=[];this.audioTrackPublications.forEach((n=>{var i;Bs(n.track)&&Hs(n.track)&&t.push(n.track.setSinkId(null!==(i=e.deviceId)&&void 0!==i?i:"default"))})),yield Promise.all(t)}))}emit(e){for(var t=arguments.length,n=new Array(t>1?t-1:0),i=1;i<t;i++)n[i-1]=arguments[i];return this.log.trace("participant event",Object.assign(Object.assign({},this.logContext),{event:e,args:n})),super.emit(e,...n)}}!function(e){e.Disconnected="disconnected",e.Connecting="connecting",e.Connected="connected",e.Reconnecting="reconnecting",e.SignalReconnecting="signalReconnecting"}(Tl||(Tl={}));class Xl extends lo.EventEmitter{get hasE2EESetup(){return void 0!==this.e2eeManager}constructor(e){var t,n,i,r;if(super(),t=this,this.state=Tl.Disconnected,this.activeSpeakers=[],this.isE2EEEnabled=!1,this.audioEnabled=!0,this.isVideoPlaybackBlocked=!1,this.log=eo,this.bufferedEvents=[],this.isResuming=!1,this.rpcHandlers=new Map,this.connect=(e,t,n)=>oo(this,void 0,void 0,(function*(){var i;if("undefined"==typeof RTCPeerConnection||!ls()&&!ds())throw bs()?Error("WebRTC isn't detected, have you called registerGlobals?"):Error("LiveKit doesn't seem to be supported on this browser. Try to update your browser and make sure no browser extensions are disabling webRTC.");const r=yield this.disconnectLock.lock();if(this.state===Tl.Connected)return this.log.info("already connected to room ".concat(this.name),this.logContext),r(),Promise.resolve();if(this.connectFuture)return r(),this.connectFuture.promise;this.setAndEmitConnectionState(Tl.Connecting),(null===(i=this.regionUrlProvider)||void 0===i?void 0:i.getServerUrl().toString())!==e&&(this.regionUrl=void 0,this.regionUrlProvider=void 0),ys(new URL(e))&&(void 0===this.regionUrlProvider?this.regionUrlProvider=new Pl(e,t):this.regionUrlProvider.updateToken(t),this.regionUrlProvider.fetchRegionSettings().then((e=>{var t;null===(t=this.regionUrlProvider)||void 0===t||t.setServerReportedRegions(e)})).catch((e=>{this.log.warn("could not fetch region settings",Object.assign(Object.assign({},this.logContext),{error:e}))})));const o=(i,a,s)=>oo(this,void 0,void 0,(function*(){var c,l;this.abortController&&this.abortController.abort();const d=new AbortController;this.abortController=d,null==r||r();try{yield this.attemptConnection(null!=s?s:e,t,n,d),this.abortController=void 0,i()}catch(e){if(this.regionUrlProvider&&e instanceof Oa&&e.reason!==wa.Cancelled&&e.reason!==wa.NotAllowed){let t=null;try{t=yield this.regionUrlProvider.getNextBestRegionUrl(null===(c=this.abortController)||void 0===c?void 0:c.signal)}catch(e){if(e instanceof Oa&&(401===e.status||e.reason===wa.Cancelled))return this.handleDisconnect(this.options.stopLocalTrackOnUnpublish),void a(e)}t&&!(null===(l=this.abortController)||void 0===l?void 0:l.signal.aborted)?(this.log.info("Initial connection failed with ConnectionError: ".concat(e.message,". Retrying with another region: ").concat(t),this.logContext),this.recreateEngine(),yield o(i,a,t)):(this.handleDisconnect(this.options.stopLocalTrackOnUnpublish,Ls(e)),a(e))}else{let t=$n.UNKNOWN_REASON;e instanceof Oa&&(t=Ls(e)),this.handleDisconnect(this.options.stopLocalTrackOnUnpublish,t),a(e)}}})),a=this.regionUrl;return this.regionUrl=void 0,this.connectFuture=new Ms(((e,t)=>{o(e,t,a)}),(()=>{this.clearConnectionFutures()})),this.connectFuture.promise})),this.connectSignal=(e,t,n,i,r,o)=>oo(this,void 0,void 0,(function*(){var a,s,c;const l=yield n.join(e,t,{autoSubscribe:i.autoSubscribe,adaptiveStream:"object"==typeof r.adaptiveStream||r.adaptiveStream,maxRetries:i.maxRetries,e2eeEnabled:!!this.e2eeManager,websocketTimeout:i.websocketTimeout,singlePeerConnection:r.singlePeerConnection},o.signal);let d=l.serverInfo;if(d||(d={version:l.serverVersion,region:l.serverRegion}),this.serverInfo=d,this.log.debug("connected to Livekit Server ".concat(Object.entries(d).map((e=>{let[t,n]=e;return"".concat(t,": ").concat(n)})).join(", ")),{room:null===(a=l.room)||void 0===a?void 0:a.name,roomSid:null===(s=l.room)||void 0===s?void 0:s.sid,identity:null===(c=l.participant)||void 0===c?void 0:c.identity}),!d.version)throw new Aa("unknown server version");return"0.15.1"===d.version&&this.options.dynacast&&(this.log.debug("disabling dynacast due to server version",this.logContext),r.dynacast=!1),l})),this.applyJoinResponse=e=>{const t=e.participant;if(this.localParticipant.sid=t.sid,this.localParticipant.identity=t.identity,this.localParticipant.setEnabledPublishCodecs(e.enabledPublishCodecs),this.e2eeManager)try{this.e2eeManager.setSifTrailer(e.sifTrailer)}catch(e){this.log.error(e instanceof Error?e.message:"Could not set SifTrailer",Object.assign(Object.assign({},this.logContext),{error:e}))}this.handleParticipantUpdates([t,...e.otherParticipants]),e.room&&this.handleRoomUpdate(e.room)},this.attemptConnection=(e,t,n,i)=>oo(this,void 0,void 0,(function*(){var r,o;this.state===Tl.Reconnecting||this.isResuming||(null===(r=this.engine)||void 0===r?void 0:r.pendingReconnect)?(this.log.info("Reconnection attempt replaced by new connection attempt",this.logContext),this.recreateEngine()):this.maybeCreateEngine(),(null===(o=this.regionUrlProvider)||void 0===o?void 0:o.isCloud())&&this.engine.setRegionUrlProvider(this.regionUrlProvider),this.acquireAudioContext(),this.connOptions=Object.assign(Object.assign({},Hc),n),this.connOptions.rtcConfig&&(this.engine.rtcConfig=this.connOptions.rtcConfig),this.connOptions.peerConnectionTimeout&&(this.engine.peerConnectionTimeout=this.connOptions.peerConnectionTimeout);try{const n=yield this.connectSignal(e,t,this.engine,this.connOptions,this.options,i);this.applyJoinResponse(n),this.setupLocalParticipantEvents(),this.emit(xa.SignalConnected)}catch(e){yield this.engine.close(),this.recreateEngine();const t=new Oa("could not establish signal connection",wa.ServerUnreachable);throw e instanceof Error&&(t.message="".concat(t.message,": ").concat(e.message)),e instanceof Oa&&(t.reason=e.reason,t.status=e.status),this.log.debug("error trying to establish signal connection",Object.assign(Object.assign({},this.logContext),{error:e})),t}if(i.signal.aborted)throw yield this.engine.close(),this.recreateEngine(),new Oa("Connection attempt aborted",wa.Cancelled);try{yield this.engine.waitForPCInitialConnection(this.connOptions.peerConnectionTimeout,i)}catch(e){throw yield this.engine.close(),this.recreateEngine(),e}vs()&&this.options.disconnectOnPageLeave&&(window.addEventListener("pagehide",this.onPageLeave),window.addEventListener("beforeunload",this.onPageLeave)),vs()&&document.addEventListener("freeze",this.onPageLeave),this.setAndEmitConnectionState(Tl.Connected),this.emit(xa.Connected),this.registerConnectionReconcile()})),this.disconnect=function(){for(var e=arguments.length,n=new Array(e),i=0;i<e;i++)n[i]=arguments[i];return oo(t,[...n],void 0,(function(){var e=this;let t=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];return function*(){var n,i,r,o;const a=yield e.disconnectLock.lock();try{if(e.state===Tl.Disconnected)return void e.log.debug("already disconnected",e.logContext);if(e.log.info("disconnect from room",Object.assign({},e.logContext)),e.state===Tl.Connecting||e.state===Tl.Reconnecting||e.isResuming){const t="Abort connection attempt due to user initiated disconnect";e.log.warn(t,e.logContext),null===(n=e.abortController)||void 0===n||n.abort(t),null===(r=null===(i=e.connectFuture)||void 0===i?void 0:i.reject)||void 0===r||r.call(i,new Oa("Client initiated disconnect",wa.Cancelled)),e.connectFuture=void 0}(null===(o=e.engine)||void 0===o?void 0:o.client.isDisconnected)||(yield e.engine.client.sendLeave()),e.engine&&(yield e.engine.close()),e.handleDisconnect(t,$n.CLIENT_INITIATED),e.engine=void 0}finally{a()}}()}))},this.onPageLeave=()=>oo(this,void 0,void 0,(function*(){this.log.info("Page leave detected, disconnecting",this.logContext),yield this.disconnect()})),this.startAudio=()=>oo(this,void 0,void 0,(function*(){const e=[],t=qa();if(t&&"iOS"===t.os){const t="livekit-dummy-audio-el";let n=document.getElementById(t);if(!n){n=document.createElement("audio"),n.id=t,n.autoplay=!0,n.hidden=!0;const e=Ds();e.enabled=!0;const i=new MediaStream([e]);n.srcObject=i,document.addEventListener("visibilitychange",(()=>{n&&(n.srcObject=document.hidden?null:i,document.hidden||(this.log.debug("page visible again, triggering startAudio to resume playback and update playback status",this.logContext),this.startAudio()))})),document.body.append(n),this.once(xa.Disconnected,(()=>{null==n||n.remove(),n=null}))}e.push(n)}this.remoteParticipants.forEach((t=>{t.audioTrackPublications.forEach((t=>{t.track&&t.track.attachedElements.forEach((t=>{e.push(t)}))}))}));try{yield Promise.all([this.acquireAudioContext(),...e.map((e=>(e.muted=!1,e.play())))]),this.handleAudioPlaybackStarted()}catch(e){throw this.handleAudioPlaybackFailed(e),e}})),this.startVideo=()=>oo(this,void 0,void 0,(function*(){const e=[];for(const t of this.remoteParticipants.values())t.videoTrackPublications.forEach((t=>{var n;null===(n=t.track)||void 0===n||n.attachedElements.forEach((t=>{e.includes(t)||e.push(t)}))}));yield Promise.all(e.map((e=>e.play()))).then((()=>{this.handleVideoPlaybackStarted()})).catch((e=>{"NotAllowedError"===e.name?this.handleVideoPlaybackFailed():this.log.warn("Resuming video playback failed, make sure you call `startVideo` directly in a user gesture handler",this.logContext)}))})),this.handleRestarting=()=>{this.clearConnectionReconcile(),this.isResuming=!1;for(const e of this.remoteParticipants.values())this.handleParticipantDisconnected(e.identity,e);this.setAndEmitConnectionState(Tl.Reconnecting)&&this.emit(xa.Reconnecting)},this.handleSignalRestarted=e=>oo(this,void 0,void 0,(function*(){this.log.debug("signal reconnected to server, region ".concat(e.serverRegion),Object.assign(Object.assign({},this.logContext),{region:e.serverRegion})),this.bufferedEvents=[],this.applyJoinResponse(e);try{yield this.localParticipant.republishAllTracks(void 0,!0)}catch(e){this.log.error("error trying to re-publish tracks after reconnection",Object.assign(Object.assign({},this.logContext),{error:e}))}try{yield this.engine.waitForRestarted(),this.log.debug("fully reconnected to server",Object.assign(Object.assign({},this.logContext),{region:e.serverRegion}))}catch(e){return}this.setAndEmitConnectionState(Tl.Connected),this.emit(xa.Reconnected),this.registerConnectionReconcile(),this.emitBufferedEvents()})),this.handleParticipantUpdates=e=>{e.forEach((e=>{var t;if(e.identity===this.localParticipant.identity)return void this.localParticipant.updateInfo(e);""===e.identity&&(e.identity=null!==(t=this.sidToIdentity.get(e.sid))&&void 0!==t?t:"");let n=this.remoteParticipants.get(e.identity);e.state===oi.DISCONNECTED?this.handleParticipantDisconnected(e.identity,n):n=this.getOrCreateParticipant(e.identity,e)}))},this.handleActiveSpeakersUpdate=e=>{const t=[],n={};e.forEach((e=>{if(n[e.sid]=!0,e.sid===this.localParticipant.sid)this.localParticipant.audioLevel=e.level,this.localParticipant.setIsSpeaking(!0),t.push(this.localParticipant);else{const n=this.getRemoteParticipantBySid(e.sid);n&&(n.audioLevel=e.level,n.setIsSpeaking(!0),t.push(n))}})),n[this.localParticipant.sid]||(this.localParticipant.audioLevel=0,this.localParticipant.setIsSpeaking(!1)),this.remoteParticipants.forEach((e=>{n[e.sid]||(e.audioLevel=0,e.setIsSpeaking(!1))})),this.activeSpeakers=t,this.emitWhenConnected(xa.ActiveSpeakersChanged,t)},this.handleSpeakersChanged=e=>{const t=new Map;this.activeSpeakers.forEach((e=>{const n=this.remoteParticipants.get(e.identity);n&&n.sid!==e.sid||t.set(e.sid,e)})),e.forEach((e=>{let n=this.getRemoteParticipantBySid(e.sid);e.sid===this.localParticipant.sid&&(n=this.localParticipant),n&&(n.audioLevel=e.level,n.setIsSpeaking(e.active),e.active?t.set(e.sid,n):t.delete(e.sid))}));const n=Array.from(t.values());n.sort(((e,t)=>t.audioLevel-e.audioLevel)),this.activeSpeakers=n,this.emitWhenConnected(xa.ActiveSpeakersChanged,n)},this.handleStreamStateUpdate=e=>{e.streamStates.forEach((e=>{const t=this.getRemoteParticipantBySid(e.participantSid);if(!t)return;const n=t.getTrackPublicationBySid(e.trackSid);if(!n||!n.track)return;const i=Ya.streamStateFromProto(e.state);n.track.setStreamState(i),i!==n.track.streamState&&(t.emit(Ea.TrackStreamStateChanged,n,n.track.streamState),this.emitWhenConnected(xa.TrackStreamStateChanged,n,n.track.streamState,t))}))},this.handleSubscriptionPermissionUpdate=e=>{const t=this.getRemoteParticipantBySid(e.participantSid);if(!t)return;const n=t.getTrackPublicationBySid(e.trackSid);n&&n.setAllowed(e.allowed)},this.handleSubscriptionError=e=>{const t=Array.from(this.remoteParticipants.values()).find((t=>t.trackPublications.has(e.trackSid)));if(!t)return;const n=t.getTrackPublicationBySid(e.trackSid);n&&n.setSubscriptionError(e.err)},this.handleDataPacket=(e,t)=>{const n=this.remoteParticipants.get(e.participantIdentity);if("user"===e.value.case)this.handleUserPacket(n,e.value.value,e.kind,t);else if("transcription"===e.value.case)this.handleTranscription(n,e.value.value);else if("sipDtmf"===e.value.case)this.handleSipDtmf(n,e.value.value);else if("chatMessage"===e.value.case)this.handleChatMessage(n,e.value.value);else if("metrics"===e.value.case)this.handleMetrics(e.value.value,n);else if("streamHeader"===e.value.case||"streamChunk"===e.value.case||"streamTrailer"===e.value.case)this.handleDataStream(e,t);else if("rpcRequest"===e.value.case){const t=e.value.value;this.handleIncomingRpcRequest(e.participantIdentity,t.id,t.method,t.payload,t.responseTimeoutMs,t.version)}},this.handleUserPacket=(e,t,n,i)=>{this.emit(xa.DataReceived,t.payload,e,n,t.topic,i),null==e||e.emit(Ea.DataReceived,t.payload,n,i)},this.handleSipDtmf=(e,t)=>{this.emit(xa.SipDTMFReceived,t,e),null==e||e.emit(Ea.SipDTMFReceived,t)},this.handleTranscription=(e,t)=>{const n=t.transcribedParticipantIdentity===this.localParticipant.identity?this.localParticipant:this.getParticipantByIdentity(t.transcribedParticipantIdentity),i=null==n?void 0:n.trackPublications.get(t.trackId),r=function(e,t){return e.segments.map((e=>{let{id:n,text:i,language:r,startTime:o,endTime:a,final:s}=e;var c;const l=null!==(c=t.get(n))&&void 0!==c?c:Date.now(),d=Date.now();return s?t.delete(n):t.set(n,l),{id:n,text:i,startTime:Number.parseInt(o.toString()),endTime:Number.parseInt(a.toString()),final:s,language:r,firstReceivedTime:l,lastReceivedTime:d}}))}(t,this.transcriptionReceivedTimes);null==i||i.emit(Pa.TranscriptionReceived,r),null==n||n.emit(Ea.TranscriptionReceived,r,i),this.emit(xa.TranscriptionReceived,r,n,i)},this.handleChatMessage=(e,t)=>{const n=function(e){const{id:t,timestamp:n,message:i,editTimestamp:r}=e;return{id:t,timestamp:Number.parseInt(n.toString()),editTimestamp:r?Number.parseInt(r.toString()):void 0,message:i}}(t);this.emit(xa.ChatMessage,n,e)},this.handleMetrics=(e,t)=>{this.emit(xa.MetricsReceived,e,t)},this.handleDataStream=(e,t)=>{this.incomingDataStreamManager.handleDataStreamPacket(e,t)},this.bufferedSegments=new Map,this.handleAudioPlaybackStarted=()=>{this.canPlaybackAudio||(this.audioEnabled=!0,this.emit(xa.AudioPlaybackStatusChanged,!0))},this.handleAudioPlaybackFailed=e=>{this.log.warn("could not playback audio",Object.assign(Object.assign({},this.logContext),{error:e})),this.canPlaybackAudio&&(this.audioEnabled=!1,this.emit(xa.AudioPlaybackStatusChanged,!1))},this.handleVideoPlaybackStarted=()=>{this.isVideoPlaybackBlocked&&(this.isVideoPlaybackBlocked=!1,this.emit(xa.VideoPlaybackStatusChanged,!0))},this.handleVideoPlaybackFailed=()=>{this.isVideoPlaybackBlocked||(this.isVideoPlaybackBlocked=!0,this.emit(xa.VideoPlaybackStatusChanged,!1))},this.handleDeviceChange=()=>oo(this,void 0,void 0,(function*(){var e;"iOS"!==(null===(e=qa())||void 0===e?void 0:e.os)&&(yield this.selectDefaultDevices()),this.emit(xa.MediaDevicesChanged)})),this.handleRoomUpdate=e=>{const t=this.roomInfo;this.roomInfo=e,t&&t.metadata!==e.metadata&&this.emitWhenConnected(xa.RoomMetadataChanged,e.metadata),(null==t?void 0:t.activeRecording)!==e.activeRecording&&this.emitWhenConnected(xa.RecordingStatusChanged,e.activeRecording)},this.handleConnectionQualityUpdate=e=>{e.updates.forEach((e=>{if(e.participantSid===this.localParticipant.sid)return void this.localParticipant.setConnectionQuality(e.quality);const t=this.getRemoteParticipantBySid(e.participantSid);t&&t.setConnectionQuality(e.quality)}))},this.onLocalParticipantMetadataChanged=e=>{this.emit(xa.ParticipantMetadataChanged,e,this.localParticipant)},this.onLocalParticipantNameChanged=e=>{this.emit(xa.ParticipantNameChanged,e,this.localParticipant)},this.onLocalAttributesChanged=e=>{this.emit(xa.ParticipantAttributesChanged,e,this.localParticipant)},this.onLocalTrackMuted=e=>{this.emit(xa.TrackMuted,e,this.localParticipant)},this.onLocalTrackUnmuted=e=>{this.emit(xa.TrackUnmuted,e,this.localParticipant)},this.onTrackProcessorUpdate=e=>{var t;null===(t=null==e?void 0:e.onPublish)||void 0===t||t.call(e,this)},this.onLocalTrackPublished=e=>oo(this,void 0,void 0,(function*(){var t,n,i,r,o,a;null===(t=e.track)||void 0===t||t.on(Pa.TrackProcessorUpdate,this.onTrackProcessorUpdate),null===(n=e.track)||void 0===n||n.on(Pa.Restarted,this.onLocalTrackRestarted),null===(o=null===(r=null===(i=e.track)||void 0===i?void 0:i.getProcessor())||void 0===r?void 0:r.onPublish)||void 0===o||o.call(r,this),this.emit(xa.LocalTrackPublished,e,this.localParticipant),Ws(e.track)&&(yield e.track.checkForSilence())&&this.emit(xa.LocalAudioSilenceDetected,e);const s=yield null===(a=e.track)||void 0===a?void 0:a.getDeviceId(!1),c=Qs(e.source);c&&s&&s!==this.localParticipant.activeDeviceMap.get(c)&&(this.localParticipant.activeDeviceMap.set(c,s),this.emit(xa.ActiveDeviceChanged,c,s))})),this.onLocalTrackUnpublished=e=>{var t,n;null===(t=e.track)||void 0===t||t.off(Pa.TrackProcessorUpdate,this.onTrackProcessorUpdate),null===(n=e.track)||void 0===n||n.off(Pa.Restarted,this.onLocalTrackRestarted),this.emit(xa.LocalTrackUnpublished,e,this.localParticipant)},this.onLocalTrackRestarted=e=>oo(this,void 0,void 0,(function*(){const t=yield e.getDeviceId(!1),n=Qs(e.source);n&&t&&t!==this.localParticipant.activeDeviceMap.get(n)&&(this.log.debug("local track restarted, setting ".concat(n," ").concat(t," active"),this.logContext),this.localParticipant.activeDeviceMap.set(n,t),this.emit(xa.ActiveDeviceChanged,n,t))})),this.onLocalConnectionQualityChanged=e=>{this.emit(xa.ConnectionQualityChanged,e,this.localParticipant)},this.onMediaDevicesError=(e,t)=>{this.emit(xa.MediaDevicesError,e,t)},this.onLocalParticipantPermissionsChanged=e=>{this.emit(xa.ParticipantPermissionsChanged,e,this.localParticipant)},this.onLocalChatMessageSent=e=>{this.emit(xa.ChatMessage,e,this.localParticipant)},this.setMaxListeners(100),this.remoteParticipants=new Map,this.sidToIdentity=new Map,this.options=Object.assign(Object.assign({},Wc),e),this.log=to(null!==(n=this.options.loggerName)&&void 0!==n?n:$r.Room),this.transcriptionReceivedTimes=new Map,this.options.audioCaptureDefaults=Object.assign(Object.assign({},Vc),null==e?void 0:e.audioCaptureDefaults),this.options.videoCaptureDefaults=Object.assign(Object.assign({},qc),null==e?void 0:e.videoCaptureDefaults),this.options.publishDefaults=Object.assign(Object.assign({},Bc),null==e?void 0:e.publishDefaults),this.maybeCreateEngine(),this.incomingDataStreamManager=new Dl,this.outgoingDataStreamManager=new Ll(this.engine,this.log),this.disconnectLock=new ht,this.localParticipant=new Kl("","",this.engine,this.options,this.rpcHandlers,this.outgoingDataStreamManager),(this.options.e2ee||this.options.encryption)&&this.setupE2EE(),this.engine.e2eeManager=this.e2eeManager,this.options.videoCaptureDefaults.deviceId&&this.localParticipant.activeDeviceMap.set("videoinput",As(this.options.videoCaptureDefaults.deviceId)),this.options.audioCaptureDefaults.deviceId&&this.localParticipant.activeDeviceMap.set("audioinput",As(this.options.audioCaptureDefaults.deviceId)),(null===(i=this.options.audioOutput)||void 0===i?void 0:i.deviceId)&&this.switchActiveDevice("audiooutput",As(this.options.audioOutput.deviceId)).catch((e=>this.log.warn("Could not set audio output: ".concat(e.message),this.logContext))),vs()){const e=new AbortController;null===(r=navigator.mediaDevices)||void 0===r||r.addEventListener("devicechange",this.handleDeviceChange,{signal:e.signal}),Xl.cleanupRegistry&&Xl.cleanupRegistry.register(this,(()=>{e.abort()}))}}registerTextStreamHandler(e,t){return this.incomingDataStreamManager.registerTextStreamHandler(e,t)}unregisterTextStreamHandler(e){return this.incomingDataStreamManager.unregisterTextStreamHandler(e)}registerByteStreamHandler(e,t){return this.incomingDataStreamManager.registerByteStreamHandler(e,t)}unregisterByteStreamHandler(e){return this.incomingDataStreamManager.unregisterByteStreamHandler(e)}registerRpcMethod(e,t){if(this.rpcHandlers.has(e))throw Error("RPC handler already registered for method ".concat(e,", unregisterRpcMethod before trying to register again"));this.rpcHandlers.set(e,t)}unregisterRpcMethod(e){this.rpcHandlers.delete(e)}setE2EEEnabled(e){return oo(this,void 0,void 0,(function*(){if(!this.e2eeManager)throw Error("e2ee not configured, please set e2ee settings within the room options");yield Promise.all([this.localParticipant.setE2EEEnabled(e)]),""!==this.localParticipant.identity&&this.e2eeManager.setParticipantCryptorEnabled(e,this.localParticipant.identity)}))}setupE2EE(){var e;const t=!!this.options.encryption,n=this.options.encryption||this.options.e2ee;n&&("e2eeManager"in n?(this.e2eeManager=n.e2eeManager,this.e2eeManager.isDataChannelEncryptionEnabled=t):this.e2eeManager=new rc(n,t),this.e2eeManager.on(ya.ParticipantEncryptionStatusChanged,((e,t)=>{(function(e){return e.isLocal})(t)&&(this.isE2EEEnabled=e),this.emit(xa.ParticipantEncryptionStatusChanged,e,t)})),this.e2eeManager.on(ya.EncryptionError,(e=>this.emit(xa.EncryptionError,e))),null===(e=this.e2eeManager)||void 0===e||e.setup(this))}get logContext(){var e;return{room:this.name,roomID:null===(e=this.roomInfo)||void 0===e?void 0:e.sid,participant:this.localParticipant.identity,pID:this.localParticipant.sid}}get isRecording(){var e,t;return null!==(t=null===(e=this.roomInfo)||void 0===e?void 0:e.activeRecording)&&void 0!==t&&t}getSid(){return oo(this,void 0,void 0,(function*(){return this.state===Tl.Disconnected?"":this.roomInfo&&""!==this.roomInfo.sid?this.roomInfo.sid:new Promise(((e,t)=>{const n=t=>{""!==t.sid&&(this.engine.off(_a.RoomUpdate,n),e(t.sid))};this.engine.on(_a.RoomUpdate,n),this.once(xa.Disconnected,(()=>{this.engine.off(_a.RoomUpdate,n),t("Room disconnected before room server id was available")}))}))}))}get name(){var e,t;return null!==(t=null===(e=this.roomInfo)||void 0===e?void 0:e.name)&&void 0!==t?t:""}get metadata(){var e;return null===(e=this.roomInfo)||void 0===e?void 0:e.metadata}get numParticipants(){var e,t;return null!==(t=null===(e=this.roomInfo)||void 0===e?void 0:e.numParticipants)&&void 0!==t?t:0}get numPublishers(){var e,t;return null!==(t=null===(e=this.roomInfo)||void 0===e?void 0:e.numPublishers)&&void 0!==t?t:0}maybeCreateEngine(){this.engine&&!this.engine.isClosed||(this.engine=new xl(this.options),this.engine.e2eeManager=this.e2eeManager,this.engine.on(_a.ParticipantUpdate,this.handleParticipantUpdates).on(_a.RoomUpdate,this.handleRoomUpdate).on(_a.SpeakersChanged,this.handleSpeakersChanged).on(_a.StreamStateChanged,this.handleStreamStateUpdate).on(_a.ConnectionQualityUpdate,this.handleConnectionQualityUpdate).on(_a.SubscriptionError,this.handleSubscriptionError).on(_a.SubscriptionPermissionUpdate,this.handleSubscriptionPermissionUpdate).on(_a.MediaTrackAdded,((e,t,n)=>{this.onTrackAdded(e,t,n)})).on(_a.Disconnected,(e=>{this.handleDisconnect(this.options.stopLocalTrackOnUnpublish,e)})).on(_a.ActiveSpeakersUpdate,this.handleActiveSpeakersUpdate).on(_a.DataPacketReceived,this.handleDataPacket).on(_a.Resuming,(()=>{this.clearConnectionReconcile(),this.isResuming=!0,this.log.info("Resuming signal connection",this.logContext),this.setAndEmitConnectionState(Tl.SignalReconnecting)&&this.emit(xa.SignalReconnecting)})).on(_a.Resumed,(()=>{this.registerConnectionReconcile(),this.isResuming=!1,this.log.info("Resumed signal connection",this.logContext),this.updateSubscriptions(),this.emitBufferedEvents(),this.setAndEmitConnectionState(Tl.Connected)&&this.emit(xa.Reconnected)})).on(_a.SignalResumed,(()=>{this.bufferedEvents=[],(this.state===Tl.Reconnecting||this.isResuming)&&this.sendSyncState()})).on(_a.Restarting,this.handleRestarting).on(_a.SignalRestarted,this.handleSignalRestarted).on(_a.Offline,(()=>{this.setAndEmitConnectionState(Tl.Reconnecting)&&this.emit(xa.Reconnecting)})).on(_a.DCBufferStatusChanged,((e,t)=>{this.emit(xa.DCBufferStatusChanged,e,t)})).on(_a.LocalTrackSubscribed,(e=>{const t=this.localParticipant.getTrackPublications().find((t=>{let{trackSid:n}=t;return n===e}));t?(this.localParticipant.emit(Ea.LocalTrackSubscribed,t),this.emitWhenConnected(xa.LocalTrackSubscribed,t,this.localParticipant)):this.log.warn("could not find local track subscription for subscribed event",this.logContext)})).on(_a.RoomMoved,(e=>{this.log.debug("room moved",e),e.room&&this.handleRoomUpdate(e.room),this.remoteParticipants.forEach(((e,t)=>{this.handleParticipantDisconnected(t,e)})),this.emit(xa.Moved,e.room.name),e.participant?this.handleParticipantUpdates([e.participant,...e.otherParticipants]):this.handleParticipantUpdates(e.otherParticipants)})),this.localParticipant&&this.localParticipant.setupEngine(this.engine),this.e2eeManager&&this.e2eeManager.setupEngine(this.engine),this.outgoingDataStreamManager&&this.outgoingDataStreamManager.setupEngine(this.engine))}static getLocalDevices(e){let t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];return ac.getInstance().getDevices(e,t)}prepareConnection(e,t){return oo(this,void 0,void 0,(function*(){if(this.state===Tl.Disconnected){this.log.debug("prepareConnection to ".concat(e),this.logContext);try{if(ys(new URL(e))&&t){this.regionUrlProvider=new Pl(e,t);const n=yield this.regionUrlProvider.getNextBestRegionUrl();n&&this.state===Tl.Disconnected&&(this.regionUrl=n,yield fetch(Ns(n),{method:"HEAD"}),this.log.debug("prepared connection to ".concat(n),this.logContext))}else yield fetch(Ns(e),{method:"HEAD"})}catch(e){this.log.warn("could not prepare connection",Object.assign(Object.assign({},this.logContext),{error:e}))}}}))}getParticipantByIdentity(e){return this.localParticipant.identity===e?this.localParticipant:this.remoteParticipants.get(e)}clearConnectionFutures(){this.connectFuture=void 0}simulateScenario(e,t){return oo(this,void 0,void 0,(function*(){let n,i=()=>oo(this,void 0,void 0,(function*(){}));switch(e){case"signal-reconnect":yield this.engine.client.handleOnClose("simulate disconnect");break;case"speaker":n=new Or({scenario:{case:"speakerUpdate",value:3}});break;case"node-failure":n=new Or({scenario:{case:"nodeFailure",value:!0}});break;case"server-leave":n=new Or({scenario:{case:"serverLeave",value:!0}});break;case"migration":n=new Or({scenario:{case:"migration",value:!0}});break;case"resume-reconnect":this.engine.failNext(),yield this.engine.client.handleOnClose("simulate resume-disconnect");break;case"disconnect-signal-on-resume":i=()=>oo(this,void 0,void 0,(function*(){yield this.engine.client.handleOnClose("simulate resume-disconnect")})),n=new Or({scenario:{case:"disconnectSignalOnResume",value:!0}});break;case"disconnect-signal-on-resume-no-messages":i=()=>oo(this,void 0,void 0,(function*(){yield this.engine.client.handleOnClose("simulate resume-disconnect")})),n=new Or({scenario:{case:"disconnectSignalOnResumeNoMessages",value:!0}});break;case"full-reconnect":this.engine.fullReconnectOnNext=!0,yield this.engine.client.handleOnClose("simulate full-reconnect");break;case"force-tcp":case"force-tls":n=new Or({scenario:{case:"switchCandidateProtocol",value:"force-tls"===e?2:1}}),i=()=>oo(this,void 0,void 0,(function*(){const e=this.engine.client.onLeave;e&&e(new lr({reason:$n.CLIENT_INITIATED,action:dr.RECONNECT}))}));break;case"subscriber-bandwidth":if(void 0===t||"number"!=typeof t)throw new Error("subscriber-bandwidth requires a number as argument");n=new Or({scenario:{case:"subscriberBandwidth",value:Us(t)}});break;case"leave-full-reconnect":n=new Or({scenario:{case:"leaveRequestFullReconnect",value:!0}})}n&&(yield this.engine.client.sendSimulateScenario(n),yield i())}))}get canPlaybackAudio(){return this.audioEnabled}get canPlaybackVideo(){return!this.isVideoPlaybackBlocked}getActiveDevice(e){return this.localParticipant.activeDeviceMap.get(e)}switchActiveDevice(e,t){return oo(this,arguments,void 0,(function(e,t){var n=this;let i=!(arguments.length>2&&void 0!==arguments[2])||arguments[2];return function*(){var r,o,a,s,c,l,d;let u=!0,h=!1;const p=i?{exact:t}:t;if("audioinput"===e){h=0===n.localParticipant.audioTrackPublications.size;const t=null!==(r=n.getActiveDevice(e))&&void 0!==r?r:n.options.audioCaptureDefaults.deviceId;n.options.audioCaptureDefaults.deviceId=p;const i=Array.from(n.localParticipant.audioTrackPublications.values()).filter((e=>e.source===Ya.Source.Microphone));try{u=(yield Promise.all(i.map((e=>{var t;return null===(t=e.audioTrack)||void 0===t?void 0:t.setDeviceId(p)})))).every((e=>!0===e))}catch(e){throw n.options.audioCaptureDefaults.deviceId=t,e}const o=i.some((e=>{var t,n;return null!==(n=null===(t=e.track)||void 0===t?void 0:t.isMuted)&&void 0!==n&&n}));u&&o&&(h=!0)}else if("videoinput"===e){h=0===n.localParticipant.videoTrackPublications.size;const t=null!==(o=n.getActiveDevice(e))&&void 0!==o?o:n.options.videoCaptureDefaults.deviceId;n.options.videoCaptureDefaults.deviceId=p;const i=Array.from(n.localParticipant.videoTrackPublications.values()).filter((e=>e.source===Ya.Source.Camera));try{u=(yield Promise.all(i.map((e=>{var t;return null===(t=e.videoTrack)||void 0===t?void 0:t.setDeviceId(p)})))).every((e=>!0===e))}catch(e){throw n.options.videoCaptureDefaults.deviceId=t,e}const r=i.some((e=>{var t,n;return null!==(n=null===(t=e.track)||void 0===t?void 0:t.isMuted)&&void 0!==n&&n}));u&&r&&(h=!0)}else if("audiooutput"===e){if(h=!0,!hs()&&!n.options.webAudioMix||n.options.webAudioMix&&n.audioContext&&!("setSinkId"in n.audioContext))throw new Error("cannot switch audio output, the current browser does not support it");n.options.webAudioMix&&(t=null!==(a=yield ac.getInstance().normalizeDeviceId("audiooutput",t))&&void 0!==a?a:""),null!==(s=(d=n.options).audioOutput)&&void 0!==s||(d.audioOutput={});const i=null!==(c=n.getActiveDevice(e))&&void 0!==c?c:n.options.audioOutput.deviceId;n.options.audioOutput.deviceId=t;try{n.options.webAudioMix&&(null===(l=n.audioContext)||void 0===l||l.setSinkId(t)),yield Promise.all(Array.from(n.remoteParticipants.values()).map((e=>e.setAudioOutput({deviceId:t}))))}catch(e){throw n.options.audioOutput.deviceId=i,e}}return h&&(n.localParticipant.activeDeviceMap.set(e,t),n.emit(xa.ActiveDeviceChanged,e,t)),u}()}))}setupLocalParticipantEvents(){this.localParticipant.on(Ea.ParticipantMetadataChanged,this.onLocalParticipantMetadataChanged).on(Ea.ParticipantNameChanged,this.onLocalParticipantNameChanged).on(Ea.AttributesChanged,this.onLocalAttributesChanged).on(Ea.TrackMuted,this.onLocalTrackMuted).on(Ea.TrackUnmuted,this.onLocalTrackUnmuted).on(Ea.LocalTrackPublished,this.onLocalTrackPublished).on(Ea.LocalTrackUnpublished,this.onLocalTrackUnpublished).on(Ea.ConnectionQualityChanged,this.onLocalConnectionQualityChanged).on(Ea.MediaDevicesError,this.onMediaDevicesError).on(Ea.AudioStreamAcquired,this.startAudio).on(Ea.ChatMessage,this.onLocalChatMessageSent).on(Ea.ParticipantPermissionsChanged,this.onLocalParticipantPermissionsChanged)}recreateEngine(){var e;null===(e=this.engine)||void 0===e||e.close(),this.engine=void 0,this.isResuming=!1,this.remoteParticipants.clear(),this.sidToIdentity.clear(),this.bufferedEvents=[],this.maybeCreateEngine()}onTrackAdded(e,t,n){if(this.state===Tl.Connecting||this.state===Tl.Reconnecting){const i=()=>{this.log.debug("deferring on track for later",{mediaTrackId:e.id,mediaStreamId:t.id,tracksInStream:t.getTracks().map((e=>e.id))}),this.onTrackAdded(e,t,n),r()},r=()=>{this.off(xa.Reconnected,i),this.off(xa.Connected,i),this.off(xa.Disconnected,r)};return this.once(xa.Reconnected,i),this.once(xa.Connected,i),void this.once(xa.Disconnected,r)}if(this.state===Tl.Disconnected)return void this.log.warn("skipping incoming track after Room disconnected",this.logContext);if("ended"===e.readyState)return void this.log.info("skipping incoming track as it already ended",this.logContext);const i=function(e){const t=e.split("|");return t.length>1?[t[0],e.substr(t[0].length+1)]:[e,""]}(t.id),r=i[0];let o=i[1],a=e.id;if(o&&o.startsWith("TR")&&(a=o),r===this.localParticipant.sid)return void this.log.warn("tried to create RemoteParticipant for local participant",this.logContext);const s=Array.from(this.remoteParticipants.values()).find((e=>e.sid===r));if(!s)return void this.log.error("Tried to add a track for a participant, that's not present. Sid: ".concat(r),this.logContext);if(!a.startsWith("TR")){const e=this.engine.getTrackIdForReceiver(n);if(!e)return void this.log.error("Tried to add a track whose 'sid' could not be found for a participant, that's not present. Sid: ".concat(r),this.logContext);a=e}let c;a.startsWith("TR")||this.log.warn("Tried to add a track whose 'sid' could not be determined for a participant, that's not present. Sid: ".concat(r,", streamId: ").concat(o,", trackId: ").concat(a),Object.assign(Object.assign({},this.logContext),{rpID:r,streamId:o,trackId:a})),this.options.adaptiveStream&&(c="object"==typeof this.options.adaptiveStream?this.options.adaptiveStream:{});const l=s.addSubscribedMediaTrack(e,a,t,n,c);(null==l?void 0:l.isEncrypted)&&!this.e2eeManager&&this.emit(xa.EncryptionError,new Error("Encrypted ".concat(l.source," track received from participant ").concat(s.sid,", but room does not have encryption enabled!")))}handleDisconnect(){let e=!(arguments.length>0&&void 0!==arguments[0])||arguments[0],t=arguments.length>1?arguments[1]:void 0;var n;if(this.clearConnectionReconcile(),this.isResuming=!1,this.bufferedEvents=[],this.transcriptionReceivedTimes.clear(),this.incomingDataStreamManager.clearHandlersAndControllers(),this.state!==Tl.Disconnected){this.regionUrl=void 0;try{this.remoteParticipants.forEach((e=>{e.trackPublications.forEach((t=>{e.unpublishTrack(t.trackSid)}))})),this.localParticipant.trackPublications.forEach((t=>{var n,i,r;t.track&&this.localParticipant.unpublishTrack(t.track,e),e?(null===(n=t.track)||void 0===n||n.detach(),null===(i=t.track)||void 0===i||i.stop()):null===(r=t.track)||void 0===r||r.stopMonitor()})),this.localParticipant.off(Ea.ParticipantMetadataChanged,this.onLocalParticipantMetadataChanged).off(Ea.ParticipantNameChanged,this.onLocalParticipantNameChanged).off(Ea.AttributesChanged,this.onLocalAttributesChanged).off(Ea.TrackMuted,this.onLocalTrackMuted).off(Ea.TrackUnmuted,this.onLocalTrackUnmuted).off(Ea.LocalTrackPublished,this.onLocalTrackPublished).off(Ea.LocalTrackUnpublished,this.onLocalTrackUnpublished).off(Ea.ConnectionQualityChanged,this.onLocalConnectionQualityChanged).off(Ea.MediaDevicesError,this.onMediaDevicesError).off(Ea.AudioStreamAcquired,this.startAudio).off(Ea.ChatMessage,this.onLocalChatMessageSent).off(Ea.ParticipantPermissionsChanged,this.onLocalParticipantPermissionsChanged),this.localParticipant.trackPublications.clear(),this.localParticipant.videoTrackPublications.clear(),this.localParticipant.audioTrackPublications.clear(),this.remoteParticipants.clear(),this.sidToIdentity.clear(),this.activeSpeakers=[],this.audioContext&&"boolean"==typeof this.options.webAudioMix&&(this.audioContext.close(),this.audioContext=void 0),vs()&&(window.removeEventListener("beforeunload",this.onPageLeave),window.removeEventListener("pagehide",this.onPageLeave),window.removeEventListener("freeze",this.onPageLeave),null===(n=navigator.mediaDevices)||void 0===n||n.removeEventListener("devicechange",this.handleDeviceChange))}finally{this.setAndEmitConnectionState(Tl.Disconnected),this.emit(xa.Disconnected,t)}}}handleParticipantDisconnected(e,t){var n;this.remoteParticipants.delete(e),t&&(this.incomingDataStreamManager.validateParticipantHasNoActiveDataStreams(e),t.trackPublications.forEach((e=>{t.unpublishTrack(e.trackSid,!0)})),this.emit(xa.ParticipantDisconnected,t),t.setDisconnected(),null===(n=this.localParticipant)||void 0===n||n.handleParticipantDisconnected(t.identity))}handleIncomingRpcRequest(e,t,n,i,r,o){return oo(this,void 0,void 0,(function*(){if(yield this.engine.publishRpcAck(e,t),1!==o)return void(yield this.engine.publishRpcResponse(e,t,null,Kc.builtIn("UNSUPPORTED_VERSION")));const a=this.rpcHandlers.get(n);if(!a)return void(yield this.engine.publishRpcResponse(e,t,null,Kc.builtIn("UNSUPPORTED_METHOD")));let s=null,c=null;try{const o=yield a({requestId:t,callerIdentity:e,payload:i,responseTimeout:r});Jc(o)>15360?(s=Kc.builtIn("RESPONSE_PAYLOAD_TOO_LARGE"),console.warn("RPC Response payload too large for ".concat(n))):c=o}catch(e){e instanceof Kc?s=e:(console.warn("Uncaught error returned by RPC handler for ".concat(n,". Returning APPLICATION_ERROR instead."),e),s=Kc.builtIn("APPLICATION_ERROR"))}yield this.engine.publishRpcResponse(e,t,c,s)}))}selectDefaultDevices(){return oo(this,void 0,void 0,(function*(){var e,t,n;const i=ac.getInstance().previousDevices,r=yield ac.getInstance().getDevices(void 0,!1),o=qa();if("Chrome"===(null==o?void 0:o.name)&&"iOS"!==o.os)for(let e of r){const t=i.find((t=>t.deviceId===e.deviceId));t&&""!==t.label&&t.kind===e.kind&&t.label!==e.label&&"default"===this.getActiveDevice(e.kind)&&this.emit(xa.ActiveDeviceChanged,e.kind,e.deviceId)}const a=["audiooutput","audioinput","videoinput"];for(let o of a){const a=$s(o),s=this.localParticipant.getTrackPublication(a);if(s&&(null===(e=s.track)||void 0===e?void 0:e.isUserProvided))continue;const c=r.filter((e=>e.kind===o)),l=this.getActiveDevice(o);l===(null===(t=i.filter((e=>e.kind===o))[0])||void 0===t?void 0:t.deviceId)&&c.length>0&&(null===(n=c[0])||void 0===n?void 0:n.deviceId)!==l?yield this.switchActiveDevice(o,c[0].deviceId):"audioinput"===o&&!fs()||"videoinput"===o||!(c.length>0)||c.find((e=>e.deviceId===this.getActiveDevice(o)))||"audiooutput"===o&&fs()||(yield this.switchActiveDevice(o,c[0].deviceId))}}))}acquireAudioContext(){return oo(this,void 0,void 0,(function*(){var e,t;if("boolean"!=typeof this.options.webAudioMix&&this.options.webAudioMix.audioContext?this.audioContext=this.options.webAudioMix.audioContext:this.audioContext&&"closed"!==this.audioContext.state||(this.audioContext=null!==(e=Xs())&&void 0!==e?e:void 0),this.options.webAudioMix&&this.remoteParticipants.forEach((e=>e.setAudioContext(this.audioContext))),this.localParticipant.setAudioContext(this.audioContext),this.audioContext&&"suspended"===this.audioContext.state)try{yield Promise.race([this.audioContext.resume(),cs(200)])}catch(e){this.log.warn("Could not resume audio context",Object.assign(Object.assign({},this.logContext),{error:e}))}const n="running"===(null===(t=this.audioContext)||void 0===t?void 0:t.state);n!==this.canPlaybackAudio&&(this.audioEnabled=n,this.emit(xa.AudioPlaybackStatusChanged,n))}))}createParticipant(e,t){var n;let i;return i=t?Yl.fromParticipantInfo(this.engine.client,t,{loggerContextCb:()=>this.logContext,loggerName:this.options.loggerName}):new Yl(this.engine.client,"",e,void 0,void 0,void 0,{loggerContextCb:()=>this.logContext,loggerName:this.options.loggerName}),this.options.webAudioMix&&i.setAudioContext(this.audioContext),(null===(n=this.options.audioOutput)||void 0===n?void 0:n.deviceId)&&i.setAudioOutput(this.options.audioOutput).catch((e=>this.log.warn("Could not set audio output: ".concat(e.message),this.logContext))),i}getOrCreateParticipant(e,t){if(this.remoteParticipants.has(e)){const n=this.remoteParticipants.get(e);return t&&n.updateInfo(t)&&this.sidToIdentity.set(t.sid,t.identity),n}const n=this.createParticipant(e,t);return this.remoteParticipants.set(e,n),this.sidToIdentity.set(t.sid,t.identity),this.emitWhenConnected(xa.ParticipantConnected,n),n.on(Ea.TrackPublished,(e=>{this.emitWhenConnected(xa.TrackPublished,e,n)})).on(Ea.TrackSubscribed,((e,t)=>{e.kind===Ya.Kind.Audio?(e.on(Pa.AudioPlaybackStarted,this.handleAudioPlaybackStarted),e.on(Pa.AudioPlaybackFailed,this.handleAudioPlaybackFailed)):e.kind===Ya.Kind.Video&&(e.on(Pa.VideoPlaybackFailed,this.handleVideoPlaybackFailed),e.on(Pa.VideoPlaybackStarted,this.handleVideoPlaybackStarted)),this.emit(xa.TrackSubscribed,e,t,n)})).on(Ea.TrackUnpublished,(e=>{this.emit(xa.TrackUnpublished,e,n)})).on(Ea.TrackUnsubscribed,((e,t)=>{this.emit(xa.TrackUnsubscribed,e,t,n)})).on(Ea.TrackMuted,(e=>{this.emitWhenConnected(xa.TrackMuted,e,n)})).on(Ea.TrackUnmuted,(e=>{this.emitWhenConnected(xa.TrackUnmuted,e,n)})).on(Ea.ParticipantMetadataChanged,(e=>{this.emitWhenConnected(xa.ParticipantMetadataChanged,e,n)})).on(Ea.ParticipantNameChanged,(e=>{this.emitWhenConnected(xa.ParticipantNameChanged,e,n)})).on(Ea.AttributesChanged,(e=>{this.emitWhenConnected(xa.ParticipantAttributesChanged,e,n)})).on(Ea.ConnectionQualityChanged,(e=>{this.emitWhenConnected(xa.ConnectionQualityChanged,e,n)})).on(Ea.ParticipantPermissionsChanged,(e=>{this.emitWhenConnected(xa.ParticipantPermissionsChanged,e,n)})).on(Ea.TrackSubscriptionStatusChanged,((e,t)=>{this.emitWhenConnected(xa.TrackSubscriptionStatusChanged,e,t,n)})).on(Ea.TrackSubscriptionFailed,((e,t)=>{this.emit(xa.TrackSubscriptionFailed,e,n,t)})).on(Ea.TrackSubscriptionPermissionChanged,((e,t)=>{this.emitWhenConnected(xa.TrackSubscriptionPermissionChanged,e,t,n)})).on(Ea.Active,(()=>{this.emitWhenConnected(xa.ParticipantActive,n),n.kind===ai.AGENT&&this.localParticipant.setActiveAgent(n)})),t&&n.updateInfo(t),n}sendSyncState(){const e=Array.from(this.remoteParticipants.values()).reduce(((e,t)=>(e.push(...t.getTrackPublications()),e)),[]),t=this.localParticipant.getTrackPublications();this.engine.sendSyncState(e,t)}updateSubscriptions(){for(const e of this.remoteParticipants.values())for(const t of e.videoTrackPublications.values())t.isSubscribed&&zs(t)&&t.emitTrackUpdate()}getRemoteParticipantBySid(e){const t=this.sidToIdentity.get(e);if(t)return this.remoteParticipants.get(t)}registerConnectionReconcile(){this.clearConnectionReconcile();let e=0;this.connectionReconcileInterval=Ga.setInterval((()=>{this.engine&&!this.engine.isClosed&&this.engine.verifyTransport()?e=0:(e++,this.log.warn("detected connection state mismatch",Object.assign(Object.assign({},this.logContext),{numFailures:e,engine:this.engine?{closed:this.engine.isClosed,transportsConnected:this.engine.verifyTransport()}:void 0})),e>=3&&(this.recreateEngine(),this.handleDisconnect(this.options.stopLocalTrackOnUnpublish,$n.STATE_MISMATCH)))}),4e3)}clearConnectionReconcile(){this.connectionReconcileInterval&&Ga.clearInterval(this.connectionReconcileInterval)}setAndEmitConnectionState(e){return e!==this.state&&(this.state=e,this.emit(xa.ConnectionStateChanged,this.state),!0)}emitBufferedEvents(){this.bufferedEvents.forEach((e=>{let[t,n]=e;this.emit(t,...n)})),this.bufferedEvents=[]}emitWhenConnected(e){for(var t=arguments.length,n=new Array(t>1?t-1:0),i=1;i<t;i++)n[i-1]=arguments[i];if(this.state===Tl.Reconnecting||this.isResuming||!this.engine||this.engine.pendingReconnect)this.bufferedEvents.push([e,n]);else if(this.state===Tl.Connected)return this.emit(e,...n);return!1}simulateParticipants(e){return oo(this,void 0,void 0,(function*(){var t,n;const i=Object.assign({audio:!0,video:!0,useRealTracks:!1},e.publish),r=Object.assign({count:9,audio:!1,video:!0,aspectRatios:[1.66,1.7,1.3]},e.participants);if(this.handleDisconnect(),this.roomInfo=new ti({sid:"RM_SIMULATED",name:"simulated-room",emptyTimeout:0,maxParticipants:0,creationTime:Dt.parse((new Date).getTime()),metadata:"",numParticipants:1,numPublishers:1,turnPassword:"",enabledCodecs:[],activeRecording:!1}),this.localParticipant.updateInfo(new ri({identity:"simulated-local",name:"local-name"})),this.setupLocalParticipantEvents(),this.emit(xa.SignalConnected),this.emit(xa.Connected),this.setAndEmitConnectionState(Tl.Connected),i.video){const e=new Hl(Ya.Kind.Video,new di({source:Kn.CAMERA,sid:Math.floor(1e4*Math.random()).toString(),type:Gn.AUDIO,name:"video-dummy"}),new ml(i.useRealTracks?(yield window.navigator.mediaDevices.getUserMedia({video:!0})).getVideoTracks()[0]:Os(160*(null!==(t=r.aspectRatios[0])&&void 0!==t?t:1),160,!0,!0),void 0,!1,{loggerName:this.options.loggerName,loggerContextCb:()=>this.logContext}),{loggerName:this.options.loggerName,loggerContextCb:()=>this.logContext});this.localParticipant.addTrackPublication(e),this.localParticipant.emit(Ea.LocalTrackPublished,e)}if(i.audio){const e=new Hl(Ya.Kind.Audio,new di({source:Kn.MICROPHONE,sid:Math.floor(1e4*Math.random()).toString(),type:Gn.AUDIO}),new nl(i.useRealTracks?(yield navigator.mediaDevices.getUserMedia({audio:!0})).getAudioTracks()[0]:Ds(),void 0,!1,this.audioContext,{loggerName:this.options.loggerName,loggerContextCb:()=>this.logContext}),{loggerName:this.options.loggerName,loggerContextCb:()=>this.logContext});this.localParticipant.addTrackPublication(e),this.localParticipant.emit(Ea.LocalTrackPublished,e)}for(let e=0;e<r.count-1;e+=1){let t=new ri({sid:Math.floor(1e4*Math.random()).toString(),identity:"simulated-".concat(e),state:oi.ACTIVE,tracks:[],joinedAt:Dt.parse(Date.now())});const i=this.getOrCreateParticipant(t.identity,t);if(r.video){const o=Os(160*(null!==(n=r.aspectRatios[e%r.aspectRatios.length])&&void 0!==n?n:1),160,!1,!0),a=new di({source:Kn.CAMERA,sid:Math.floor(1e4*Math.random()).toString(),type:Gn.AUDIO});i.addSubscribedMediaTrack(o,a.sid,new MediaStream([o]),new RTCRtpReceiver),t.tracks=[...t.tracks,a]}if(r.audio){const e=Ds(),n=new di({source:Kn.MICROPHONE,sid:Math.floor(1e4*Math.random()).toString(),type:Gn.AUDIO});i.addSubscribedMediaTrack(e,n.sid,new MediaStream([e]),new RTCRtpReceiver),t.tracks=[...t.tracks,n]}i.updateInfo(t)}}))}emit(e){for(var t=arguments.length,n=new Array(t>1?t-1:0),i=1;i<t;i++)n[i-1]=arguments[i];if(e!==xa.ActiveSpeakersChanged&&e!==xa.TranscriptionReceived){const t=$l(n).filter((e=>void 0!==e));e!==xa.TrackSubscribed&&e!==xa.TrackUnsubscribed||this.log.trace("subscribe trace: ".concat(e),Object.assign(Object.assign({},this.logContext),{event:e,args:t})),this.log.debug("room event ".concat(e),Object.assign(Object.assign({},this.logContext),{event:e,args:t}))}return super.emit(e,...n)}}function $l(e){return e.map((e=>{if(e)return Array.isArray(e)?$l(e):"object"==typeof e?"logContext"in e?e.logContext:void 0:e}))}function Ql(e,t,n){return(t=function(e){var t=function(e,t){if("object"!=typeof e||!e)return e;var n=e[Symbol.toPrimitive];if(void 0!==n){var i=n.call(e,t);if("object"!=typeof i)return i;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(e)}(e,"string");return"symbol"==typeof t?t:t+""}(t))in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}Xl.cleanupRegistry="undefined"!=typeof FinalizationRegistry&&new FinalizationRegistry((e=>{e()})),function(e){e[e.IDLE=0]="IDLE",e[e.RUNNING=1]="RUNNING",e[e.SKIPPED=2]="SKIPPED",e[e.SUCCESS=3]="SUCCESS",e[e.FAILED=4]="FAILED"}(Sl||(Sl={})),lo.EventEmitter,lo.EventEmitter,new TextEncoder,new TextDecoder;class Zl extends Error{constructor(e,t){var n;super(e,t),Ql(this,"code","ERR_JOSE_GENERIC"),this.name=this.constructor.name,null===(n=Error.captureStackTrace)||void 0===n||n.call(Error,this,this.constructor)}}Ql(Zl,"code","ERR_JOSE_GENERIC"),Ql(class extends Zl{constructor(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"unspecified",i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:"unspecified";super(e,{cause:{claim:n,reason:i,payload:t}}),Ql(this,"code","ERR_JWT_CLAIM_VALIDATION_FAILED"),Ql(this,"claim",void 0),Ql(this,"reason",void 0),Ql(this,"payload",void 0),this.claim=n,this.reason=i,this.payload=t}},"code","ERR_JWT_CLAIM_VALIDATION_FAILED"),Ql(class extends Zl{constructor(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"unspecified",i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:"unspecified";super(e,{cause:{claim:n,reason:i,payload:t}}),Ql(this,"code","ERR_JWT_EXPIRED"),Ql(this,"claim",void 0),Ql(this,"reason",void 0),Ql(this,"payload",void 0),this.claim=n,this.reason=i,this.payload=t}},"code","ERR_JWT_EXPIRED"),Ql(class extends Zl{constructor(){super(...arguments),Ql(this,"code","ERR_JOSE_ALG_NOT_ALLOWED")}},"code","ERR_JOSE_ALG_NOT_ALLOWED"),Ql(class extends Zl{constructor(){super(...arguments),Ql(this,"code","ERR_JOSE_NOT_SUPPORTED")}},"code","ERR_JOSE_NOT_SUPPORTED"),Ql(class extends Zl{constructor(){super(arguments.length>0&&void 0!==arguments[0]?arguments[0]:"decryption operation failed",arguments.length>1?arguments[1]:void 0),Ql(this,"code","ERR_JWE_DECRYPTION_FAILED")}},"code","ERR_JWE_DECRYPTION_FAILED"),Ql(class extends Zl{constructor(){super(...arguments),Ql(this,"code","ERR_JWE_INVALID")}},"code","ERR_JWE_INVALID"),Ql(class extends Zl{constructor(){super(...arguments),Ql(this,"code","ERR_JWS_INVALID")}},"code","ERR_JWS_INVALID");function ed(){return ed=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var i in n)({}).hasOwnProperty.call(n,i)&&(e[i]=n[i])}return e},ed.apply(null,arguments)}Ql(class extends Zl{constructor(){super(...arguments),Ql(this,"code","ERR_JWT_INVALID")}},"code","ERR_JWT_INVALID"),Ql(class extends Zl{constructor(){super(...arguments),Ql(this,"code","ERR_JWK_INVALID")}},"code","ERR_JWK_INVALID"),Ql(class extends Zl{constructor(){super(...arguments),Ql(this,"code","ERR_JWKS_INVALID")}},"code","ERR_JWKS_INVALID"),Ql(class extends Zl{constructor(){super(arguments.length>0&&void 0!==arguments[0]?arguments[0]:"no applicable key found in the JSON Web Key Set",arguments.length>1?arguments[1]:void 0),Ql(this,"code","ERR_JWKS_NO_MATCHING_KEY")}},"code","ERR_JWKS_NO_MATCHING_KEY"),Ql(class extends Zl{constructor(){super(arguments.length>0&&void 0!==arguments[0]?arguments[0]:"multiple matching keys found in the JSON Web Key Set",arguments.length>1?arguments[1]:void 0),Ql(this,Symbol.asyncIterator,void 0),Ql(this,"code","ERR_JWKS_MULTIPLE_MATCHING_KEYS")}},"code","ERR_JWKS_MULTIPLE_MATCHING_KEYS"),Ql(class extends Zl{constructor(){super(arguments.length>0&&void 0!==arguments[0]?arguments[0]:"request timed out",arguments.length>1?arguments[1]:void 0),Ql(this,"code","ERR_JWKS_TIMEOUT")}},"code","ERR_JWKS_TIMEOUT"),Ql(class extends Zl{constructor(){super(arguments.length>0&&void 0!==arguments[0]?arguments[0]:"signature verification failed",arguments.length>1?arguments[1]:void 0),Ql(this,"code","ERR_JWS_SIGNATURE_VERIFICATION_FAILED")}},"code","ERR_JWS_SIGNATURE_VERIFICATION_FAILED"),new Map([["obs virtual camera",{facingMode:"environment",confidence:"medium"}]]),new Map([["iphone",{facingMode:"environment",confidence:"medium"}],["ipad",{facingMode:"environment",confidence:"medium"}]]);const td=new Uint8Array(0);class nd{static getFullOptions(e){return ed({clientTools:{},onConnect:()=>{},onDebug:()=>{},onDisconnect:()=>{},onError:()=>{},onMessage:()=>{},onAudio:()=>{},onModeChange:()=>{},onStatusChange:()=>{},onCanSendFeedbackChange:()=>{},onInterruption:()=>{}},e)}constructor(e,t){var n=this;this.options=void 0,this.connection=void 0,this.lastInterruptTimestamp=0,this.mode="listening",this.status="connecting",this.volume=1,this.currentEventId=1,this.lastFeedbackEventId=0,this.canSendFeedback=!1,this.endSessionWithDetails=async function(e){"connected"!==n.status&&"connecting"!==n.status||(n.updateStatus("disconnecting"),await n.handleEndSession(),n.updateStatus("disconnected"),n.options.onDisconnect&&n.options.onDisconnect(e))},this.onMessage=async function(e){switch(e.type){case"interruption":return void n.handleInterruption(e);case"agent_response":return void n.handleAgentResponse(e);case"user_transcript":return void n.handleUserTranscript(e);case"internal_tentative_agent_response":return void n.handleTentativeAgentResponse(e);case"client_tool_call":try{await n.handleClientToolCall(e)}catch(t){n.onError(`Unexpected error in client tool call handling: ${t instanceof Error?t.message:String(t)}`,{clientToolName:e.client_tool_call.tool_name,toolCallId:e.client_tool_call.tool_call_id})}return;case"audio":return void n.handleAudio(e);case"vad_score":return void n.handleVadScore(e);case"ping":return void n.connection.sendMessage({type:"pong",event_id:e.ping_event.event_id});case"mcp_tool_call":return void n.handleMCPToolCall(e);case"mcp_connection_status":return void n.handleMCPConnectionStatus(e);case"agent_tool_response":return void n.handleAgentToolResponse(e);case"conversation_initiation_metadata":return void n.handleConversationMetadata(e);case"asr_initiation_metadata":return void n.handleAsrInitiationMetadata(e);default:return void(n.options.onDebug&&n.options.onDebug(e))}},this.setVolume=({volume:e})=>{this.volume=e},this.options=e,this.connection=t,this.options.onConnect&&this.options.onConnect({conversationId:t.conversationId}),this.connection.onMessage(this.onMessage),this.connection.onDisconnect(this.endSessionWithDetails),this.connection.onModeChange((e=>this.updateMode(e))),this.updateStatus("connected")}endSession(){return this.endSessionWithDetails({reason:"user"})}async handleEndSession(){this.connection.close()}updateMode(e){e!==this.mode&&(this.mode=e,this.options.onModeChange&&this.options.onModeChange({mode:e}))}updateStatus(e){e!==this.status&&(this.status=e,this.options.onStatusChange&&this.options.onStatusChange({status:e}))}updateCanSendFeedback(){const e=this.currentEventId!==this.lastFeedbackEventId;this.canSendFeedback!==e&&(this.canSendFeedback=e,this.options.onCanSendFeedbackChange&&this.options.onCanSendFeedbackChange({canSendFeedback:e}))}handleInterruption(e){e.interruption_event&&(this.lastInterruptTimestamp=e.interruption_event.event_id,this.options.onInterruption&&this.options.onInterruption({event_id:e.interruption_event.event_id}))}handleAgentResponse(e){this.options.onMessage&&this.options.onMessage({source:"ai",message:e.agent_response_event.agent_response})}handleUserTranscript(e){this.options.onMessage&&this.options.onMessage({source:"user",message:e.user_transcription_event.user_transcript})}handleTentativeAgentResponse(e){this.options.onDebug&&this.options.onDebug({type:"tentative_agent_response",response:e.tentative_agent_response_internal_event.tentative_agent_response})}handleVadScore(e){this.options.onVadScore&&this.options.onVadScore({vadScore:e.vad_score_event.vad_score})}async handleClientToolCall(e){if(Object.prototype.hasOwnProperty.call(this.options.clientTools,e.client_tool_call.tool_name))try{var t;const n=null!=(t=await this.options.clientTools[e.client_tool_call.tool_name](e.client_tool_call.parameters))?t:"Client tool execution successful.",i="object"==typeof n?JSON.stringify(n):String(n);this.connection.sendMessage({type:"client_tool_result",tool_call_id:e.client_tool_call.tool_call_id,result:i,is_error:!1})}catch(t){this.onError(`Client tool execution failed with following error: ${null==t?void 0:t.message}`,{clientToolName:e.client_tool_call.tool_name}),this.connection.sendMessage({type:"client_tool_result",tool_call_id:e.client_tool_call.tool_call_id,result:`Client tool execution failed: ${null==t?void 0:t.message}`,is_error:!0})}else{if(this.options.onUnhandledClientToolCall)return void this.options.onUnhandledClientToolCall(e.client_tool_call);this.onError(`Client tool with name ${e.client_tool_call.tool_name} is not defined on client`,{clientToolName:e.client_tool_call.tool_name}),this.connection.sendMessage({type:"client_tool_result",tool_call_id:e.client_tool_call.tool_call_id,result:`Client tool with name ${e.client_tool_call.tool_name} is not defined on client`,is_error:!0})}}handleAudio(e){}handleMCPToolCall(e){this.options.onMCPToolCall&&this.options.onMCPToolCall(e.mcp_tool_call)}handleMCPConnectionStatus(e){this.options.onMCPConnectionStatus&&this.options.onMCPConnectionStatus(e.mcp_connection_status)}handleAgentToolResponse(e){this.options.onAgentToolResponse&&this.options.onAgentToolResponse(e.agent_tool_response)}handleConversationMetadata(e){this.options.onConversationMetadata&&this.options.onConversationMetadata(e.conversation_initiation_metadata_event)}handleAsrInitiationMetadata(e){this.options.onAsrInitiationMetadata&&this.options.onAsrInitiationMetadata(e.asr_initiation_metadata_event)}onError(e,t){console.error(e,t),this.options.onError&&this.options.onError(e,t)}getId(){return this.connection.conversationId}isOpen(){return"connected"===this.status}setMicMuted(e){this.connection.setMicMuted(e)}getInputByteFrequencyData(){return td}getOutputByteFrequencyData(){return td}getInputVolume(){return 0}getOutputVolume(){return 0}sendFeedback(e){this.canSendFeedback?(this.connection.sendMessage({type:"feedback",score:e?"like":"dislike",event_id:this.currentEventId}),this.lastFeedbackEventId=this.currentEventId,this.updateCanSendFeedback()):console.warn(0===this.lastFeedbackEventId?"Cannot send feedback: the conversation has not started yet.":"Cannot send feedback: feedback has already been sent for the current response.")}sendContextualUpdate(e){this.connection.sendMessage({type:"contextual_update",text:e})}sendUserMessage(e){this.connection.sendMessage({type:"user_message",text:e})}sendUserActivity(){this.connection.sendMessage({type:"user_activity"})}sendMCPToolApprovalResult(e,t){this.connection.sendMessage({type:"mcp_tool_approval_result",tool_call_id:e,is_approved:t})}}class id{constructor(e={}){this.queue=[],this.disconnectionDetails=null,this.onDisconnectCallback=null,this.onMessageCallback=null,this.onModeChangeCallback=null,this.onDebug=void 0,this.onDebug=e.onDebug}debug(e){this.onDebug&&this.onDebug(e)}onMessage(e){this.onMessageCallback=e;const t=this.queue;this.queue=[],t.length>0&&queueMicrotask((()=>{t.forEach(e)}))}onDisconnect(e){this.onDisconnectCallback=e;const t=this.disconnectionDetails;t&&queueMicrotask((()=>{e(t)}))}onModeChange(e){this.onModeChangeCallback=e}updateMode(e){var t;null==(t=this.onModeChangeCallback)||t.call(this,e)}disconnect(e){var t;this.disconnectionDetails||(this.disconnectionDetails=e,null==(t=this.onDisconnectCallback)||t.call(this,e))}handleMessage(e){this.onMessageCallback?this.onMessageCallback(e):this.queue.push(e)}}function rd(e){const[t,n]=e.split("_");if(!["pcm","ulaw"].includes(t))throw new Error(`Invalid format: ${e}`);const i=Number.parseInt(n);if(Number.isNaN(i))throw new Error(`Invalid sample rate: ${n}`);return{format:t,sampleRate:i}}const od="0.7.1";function ad(e){return!!e.type}const sd="conversation_initiation_client_data";function cd(e){var t;const n={type:sd};var i,r,o,a,s;return e.overrides&&(n.conversation_config_override={agent:{prompt:null==(i=e.overrides.agent)?void 0:i.prompt,first_message:null==(r=e.overrides.agent)?void 0:r.firstMessage,language:null==(o=e.overrides.agent)?void 0:o.language},tts:{voice_id:null==(a=e.overrides.tts)?void 0:a.voiceId},conversation:{text_only:null==(s=e.overrides.conversation)?void 0:s.textOnly}}),e.customLlmExtraBody&&(n.custom_llm_extra_body=e.customLlmExtraBody),e.dynamicVariables&&(n.dynamic_variables=e.dynamicVariables),e.userId&&(n.user_id=e.userId),null!=(t=e.overrides)&&t.client&&(n.source_info={source:e.overrides.client.source,version:e.overrides.client.version}),n}class ld extends id{constructor(e,t,n,i){super(),this.socket=void 0,this.conversationId=void 0,this.inputFormat=void 0,this.outputFormat=void 0,this.socket=e,this.conversationId=t,this.inputFormat=n,this.outputFormat=i,this.socket.addEventListener("error",(e=>{setTimeout((()=>this.disconnect({reason:"error",message:"The connection was closed due to a socket error.",context:e})),0)})),this.socket.addEventListener("close",(e=>{this.disconnect(1e3===e.code?{reason:"agent",context:e}:{reason:"error",message:e.reason||"The connection was closed by the server.",context:e})})),this.socket.addEventListener("message",(e=>{try{const t=JSON.parse(e.data);if(!ad(t))return void this.debug({type:"invalid_event",message:"Received invalid socket event",data:e.data});this.handleMessage(t)}catch(t){this.debug({type:"parsing_error",message:"Failed to parse socket message",error:t instanceof Error?t.message:String(t),data:e.data})}}))}static async create(e){let t=null;try{var n,i,r;const o=null!=(n=e.origin)?n:"wss://api.elevenlabs.io";let a;const s=(null==(i=e.overrides)||null==(i=i.client)?void 0:i.version)||od,c=(null==(r=e.overrides)||null==(r=r.client)?void 0:r.source)||"js_sdk";if(e.signedUrl){const t=e.signedUrl.includes("?")?"&":"?";a=`${e.signedUrl}${t}source=${c}&version=${s}`}else a=`${o}/v1/convai/conversation?agent_id=${e.agentId}&source=${c}&version=${s}`;const l=["convai"];e.authorization&&l.push(`bearer.${e.authorization}`),t=new WebSocket(a,l);const d=await new Promise(((n,i)=>{t.addEventListener("open",(()=>{var n;const i=cd(e);null==(n=t)||n.send(JSON.stringify(i))}),{once:!0}),t.addEventListener("error",(e=>{setTimeout((()=>i(e)),0)})),t.addEventListener("close",i),t.addEventListener("message",(e=>{const t=JSON.parse(e.data);ad(t)&&("conversation_initiation_metadata"===t.type?n(t.conversation_initiation_metadata_event):console.warn("First received message is not conversation metadata."))}),{once:!0})})),{conversation_id:u,agent_output_audio_format:h,user_input_audio_format:p}=d,m=rd(null!=p?p:"pcm_16000"),f=rd(h);return new ld(t,u,m,f)}catch(e){var o;throw null==(o=t)||o.close(),e}}close(){this.socket.close()}sendMessage(e){this.socket.send(JSON.stringify(e))}async setMicMuted(e){console.warn(`WebSocket connection setMicMuted called with ${e}, but this is handled by VoiceConversation`)}}function dd(e){const t=new Uint8Array(e);return window.btoa(String.fromCharCode(...t))}function ud(e){const t=window.atob(e),n=t.length,i=new Uint8Array(n);for(let e=0;e<n;e++)i[e]=t.charCodeAt(e);return i.buffer}const hd=new Map;function pd(e,t){return async(n,i)=>{const r=hd.get(e);if(r)return n.addModule(r);if(i)try{return await n.addModule(i),void hd.set(e,i)}catch(t){throw new Error(`Failed to load the ${e} worklet module from path: ${i}. Error: ${t}`)}const o=new Blob([t],{type:"application/javascript"}),a=URL.createObjectURL(o);try{return await n.addModule(a),void hd.set(e,a)}catch(e){URL.revokeObjectURL(a)}try{const i=`data:application/javascript;base64,${btoa(t)}`;await n.addModule(i),hd.set(e,i)}catch(t){throw new Error(`Failed to load the ${e} worklet module. Make sure the browser supports AudioWorklets. If you are using a strict CSP, you may need to self-host the worklet files.`)}}}const md=pd("rawAudioProcessor",'/*\n * ulaw encoding logic taken from the wavefile library\n * https://github.com/rochars/wavefile/blob/master/lib/codecs/mulaw.js\n * USED BY @elevenlabs/client\n */\n\nconst BIAS = 0x84;\nconst CLIP = 32635;\nconst encodeTable = [\n  0,0,1,1,2,2,2,2,3,3,3,3,3,3,3,3,\n  4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,\n  5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,\n  5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,\n  6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,\n  6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,\n  6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,\n  6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,\n  7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,\n  7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,\n  7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,\n  7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,\n  7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,\n  7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,\n  7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,\n  7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7\n];\n\nfunction encodeSample(sample) {\n  let sign;\n  let exponent;\n  let mantissa;\n  let muLawSample;\n  sign = (sample >> 8) & 0x80;\n  if (sign !== 0) sample = -sample;\n  sample = sample + BIAS;\n  if (sample > CLIP) sample = CLIP;\n  exponent = encodeTable[(sample>>7) & 0xFF];\n  mantissa = (sample >> (exponent+3)) & 0x0F;\n  muLawSample = ~(sign | (exponent << 4) | mantissa);\n  \n  return muLawSample;\n}\n\nclass RawAudioProcessor extends AudioWorkletProcessor {\n  constructor() {\n    super();\n              \n    this.port.onmessage = ({ data }) => {\n      switch (data.type) {\n        case "setFormat":\n          this.isMuted = false;\n          this.buffer = []; // Initialize an empty buffer\n          this.bufferSize = data.sampleRate / 4;\n          this.format = data.format;\n\n          if (globalThis.LibSampleRate && sampleRate !== data.sampleRate) {\n            globalThis.LibSampleRate.create(1, sampleRate, data.sampleRate).then(resampler => {\n              this.resampler = resampler;\n            });\n          }\n          break;\n        case "setMuted":\n          this.isMuted = data.isMuted;\n          break;\n      }\n    };\n  }\n  process(inputs) {\n    if (!this.buffer) {\n      return true;\n    }\n    \n    const input = inputs[0]; // Get the first input node\n    if (input.length > 0) {\n      let channelData = input[0]; // Get the first channel\'s data\n\n      // Resample the audio if necessary\n      if (this.resampler) {\n        channelData = this.resampler.full(channelData);\n      }\n\n      // Add channel data to the buffer\n      this.buffer.push(...channelData);\n      // Get max volume \n      let sum = 0.0;\n      for (let i = 0; i < channelData.length; i++) {\n        sum += channelData[i] * channelData[i];\n      }\n      const maxVolume = Math.sqrt(sum / channelData.length);\n      // Check if buffer size has reached or exceeded the threshold\n      if (this.buffer.length >= this.bufferSize) {\n        const float32Array = this.isMuted \n          ? new Float32Array(this.buffer.length)\n          : new Float32Array(this.buffer);\n\n        let encodedArray = this.format === "ulaw"\n          ? new Uint8Array(float32Array.length)\n          : new Int16Array(float32Array.length);\n\n        // Iterate through the Float32Array and convert each sample to PCM16\n        for (let i = 0; i < float32Array.length; i++) {\n          // Clamp the value to the range [-1, 1]\n          let sample = Math.max(-1, Math.min(1, float32Array[i]));\n\n          // Scale the sample to the range [-32768, 32767]\n          let value = sample < 0 ? sample * 32768 : sample * 32767;\n          if (this.format === "ulaw") {\n            value = encodeSample(Math.round(value));\n          }\n\n          encodedArray[i] = value;\n        }\n\n        // Send the buffered data to the main script\n        this.port.postMessage([encodedArray, maxVolume]);\n\n        // Clear the buffer after sending\n        this.buffer = [];\n      }\n    }\n    return true; // Continue processing\n  }\n}\nregisterProcessor("rawAudioProcessor", RawAudioProcessor);\n');class fd extends id{constructor(e,t,n,i,r={}){super(r),this.conversationId=void 0,this.inputFormat=void 0,this.outputFormat=void 0,this.room=void 0,this.isConnected=!1,this.audioEventId=1,this.audioCaptureContext=null,this.audioElements=[],this.outputDeviceId=null,this.outputAnalyser=null,this.outputFrequencyData=null,this.room=e,this.conversationId=t,this.inputFormat=n,this.outputFormat=i,this.setupRoomEventListeners()}static async create(e){let t;if("conversationToken"in e&&e.conversationToken)t=e.conversationToken;else{if(!("agentId"in e)||!e.agentId)throw new Error("Either conversationToken or agentId is required for WebRTC connection");try{var n,i,r;const a=(null==(n=e.overrides)||null==(n=n.client)?void 0:n.version)||od,s=(null==(i=e.overrides)||null==(i=i.client)?void 0:i.source)||"js_sdk",c=`${o=null!=(r=e.origin)?r:"https://api.elevenlabs.io",o.replace(/^wss:\/\//,"https://")}/v1/convai/conversation/token?agent_id=${e.agentId}&source=${s}&version=${a}`,l=await fetch(c);if(!l.ok)throw new Error(`ElevenLabs API returned ${l.status} ${l.statusText}`);if(t=(await l.json()).token,!t)throw new Error("No conversation token received from API")}catch(t){let n=t instanceof Error?t.message:String(t);throw t instanceof Error&&t.message.includes("401")&&(n="Your agent has authentication enabled, but no signed URL or conversation token was provided."),new Error(`Failed to fetch conversation token for agent ${e.agentId}: ${n}`)}}var o;const a=new Xl;try{const n=`room_${Date.now()}`,i=rd("pcm_48000"),r=rd("pcm_48000"),o=new fd(a,n,i,r,e),c=e.livekitUrl||"wss://livekit.rtc.elevenlabs.io";var s;await a.connect(c,t),await new Promise((e=>{if(o.isConnected)e();else{const t=()=>{a.off(xa.Connected,t),e()};a.on(xa.Connected,t)}})),a.name&&(o.conversationId=(null==(s=a.name.match(/(conv_[a-zA-Z0-9]+)/))?void 0:s[0])||a.name),await a.localParticipant.setMicrophoneEnabled(!0);const l=cd(e);return o.debug({type:sd,message:l}),await o.sendMessage(l),o}catch(e){throw await a.disconnect(),e}}setupRoomEventListeners(){var e=this;this.room.on(xa.Connected,(async function(){e.isConnected=!0,console.info("WebRTC room connected")})),this.room.on(xa.Disconnected,(e=>{this.isConnected=!1,this.disconnect({reason:"agent",context:new CloseEvent("close",{reason:null==e?void 0:e.toString()})})})),this.room.on(xa.ConnectionStateChanged,(e=>{e===Tl.Disconnected&&(this.isConnected=!1,this.disconnect({reason:"error",message:`LiveKit connection state changed to ${e}`,context:new Event("connection_state_changed")}))})),this.room.on(xa.DataReceived,((e,t)=>{try{const t=JSON.parse((new TextDecoder).decode(e));if("audio"===t.type)return;ad(t)?this.handleMessage(t):console.warn("Invalid socket event received:",t)}catch(t){console.warn("Failed to parse incoming data message:",t),console.warn("Raw payload:",(new TextDecoder).decode(e))}})),this.room.on(xa.TrackSubscribed,(async function(t,n,i){if(t.kind===Ya.Kind.Audio&&i.identity.includes("agent")){const n=t,i=n.attach();if(i.autoplay=!0,i.controls=!1,e.outputDeviceId&&i.setSinkId)try{await i.setSinkId(e.outputDeviceId)}catch(e){console.warn("Failed to set output device for new audio element:",e)}i.style.display="none",document.body.appendChild(i),e.audioElements.push(i),1===e.audioElements.length&&(null==e.onDebug||e.onDebug({type:"audio_element_ready"})),await e.setupAudioCapture(n)}})),this.room.on(xa.ActiveSpeakersChanged,(async function(t){e.updateMode(t.length>0&&t[0].identity.startsWith("agent")?"speaking":"listening")}))}close(){if(this.isConnected){try{this.room.localParticipant.audioTrackPublications.forEach((e=>{e.track&&e.track.stop()}))}catch(e){console.warn("Error stopping local tracks:",e)}this.audioCaptureContext&&(this.audioCaptureContext.close().catch((e=>{console.warn("Error closing audio capture context:",e)})),this.audioCaptureContext=null),this.audioElements.forEach((e=>{e.parentNode&&e.parentNode.removeChild(e)})),this.audioElements=[],this.room.disconnect()}}async sendMessage(e){if(this.isConnected&&this.room.localParticipant){if(!("user_audio_chunk"in e))try{const t=(new TextEncoder).encode(JSON.stringify(e));await this.room.localParticipant.publishData(t,{reliable:!0})}catch(t){this.debug({type:"send_message_error",message:{message:e,error:t}}),console.error("Failed to send message via WebRTC:",t)}}else console.warn("Cannot send message: room not connected or no local participant")}getRoom(){return this.room}async setMicMuted(e){if(!this.isConnected||!this.room.localParticipant)return void console.warn("Cannot set microphone muted: room not connected or no local participant");const t=this.room.localParticipant.getTrackPublication(Ya.Source.Microphone);if(null!=t&&t.track)try{e?await t.track.mute():await t.track.unmute()}catch(t){await this.room.localParticipant.setMicrophoneEnabled(!e)}else await this.room.localParticipant.setMicrophoneEnabled(!e)}async setupAudioCapture(e){try{const t=new AudioContext;this.audioCaptureContext=t,this.outputAnalyser=t.createAnalyser(),this.outputAnalyser.fftSize=2048,this.outputAnalyser.smoothingTimeConstant=.8;const n=new MediaStream([e.mediaStreamTrack]),i=t.createMediaStreamSource(n);i.connect(this.outputAnalyser),await md(t.audioWorklet);const r=new AudioWorkletNode(t,"rawAudioProcessor");this.outputAnalyser.connect(r),r.port.postMessage({type:"setFormat",format:this.outputFormat.format,sampleRate:this.outputFormat.sampleRate}),r.port.onmessage=e=>{const[t,n]=e.data;if(n>.01){const e=dd(t.buffer),n=this.audioEventId++;this.handleMessage({type:"audio",audio_event:{audio_base_64:e,event_id:n}})}},i.connect(r)}catch(e){console.warn("Failed to set up audio capture:",e)}}setAudioVolume(e){this.audioElements.forEach((t=>{t.volume=e}))}async setAudioOutputDevice(e){if(!("setSinkId"in HTMLAudioElement.prototype))throw new Error("setSinkId is not supported in this browser");const t=this.audioElements.map((async function(t){try{await t.setSinkId(e)}catch(e){throw console.error("Failed to set sink ID for audio element:",e),e}}));await Promise.all(t),this.outputDeviceId=e}async setAudioInputDevice(e){if(!this.isConnected||!this.room.localParticipant)throw new Error("Cannot change input device: room not connected or no local participant");try{const t=this.room.localParticipant.getTrackPublication(Ya.Source.Microphone);null!=t&&t.track&&(await t.track.stop(),await this.room.localParticipant.unpublishTrack(t.track));const n={deviceId:{exact:e},echoCancellation:!0,noiseSuppression:!0,autoGainControl:!0,channelCount:{ideal:1}},i=await function(e){return oo(this,void 0,void 0,(function*(){return(yield zl({audio:null==e||e,video:!1}))[0]}))}(n);await this.room.localParticipant.publishTrack(i,{name:"microphone",source:Ya.Source.Microphone})}catch(e){console.error("Failed to change input device:",e);try{await this.room.localParticipant.setMicrophoneEnabled(!0)}catch(e){console.error("Failed to recover microphone after device switch error:",e)}throw e}}getOutputByteFrequencyData(){return this.outputAnalyser?(null!=this.outputFrequencyData||(this.outputFrequencyData=new Uint8Array(this.outputAnalyser.frequencyBinCount)),this.outputAnalyser.getByteFrequencyData(this.outputFrequencyData),this.outputFrequencyData):null}}async function gd(e){const t=function(e){return e.connectionType?e.connectionType:"conversationToken"in e&&e.conversationToken?"webrtc":"websocket"}(e);switch(t){case"websocket":return ld.create(e);case"webrtc":return fd.create(e);default:throw new Error(`Unknown connection type: ${t}`)}}function vd(){return["iPad Simulator","iPhone Simulator","iPod Simulator","iPad","iPhone","iPod"].includes(navigator.platform)||navigator.userAgent.includes("Mac")&&"ontouchend"in document}async function bd(e={default:0,android:3e3}){let t=e.default;var n;if(/android/i.test(navigator.userAgent))t=null!=(n=e.android)?n:t;else if(vd()){var i;t=null!=(i=e.ios)?i:t}t>0&&await new Promise((e=>setTimeout(e,t)))}class yd extends nd{static async startSession(e){const t=nd.getFullOptions(e);t.onStatusChange&&t.onStatusChange({status:"connecting"}),t.onCanSendFeedbackChange&&t.onCanSendFeedbackChange({canSendFeedback:!1}),t.onModeChange&&t.onModeChange({mode:"listening"}),t.onCanSendFeedbackChange&&t.onCanSendFeedbackChange({canSendFeedback:!1});let n=null;try{return await bd(t.connectionDelay),n=await gd(e),new yd(t,n)}catch(e){var i;throw t.onStatusChange&&t.onStatusChange({status:"disconnected"}),null==(i=n)||i.close(),e}}}const kd={echoCancellation:!0,noiseSuppression:!0,autoGainControl:!0,channelCount:{ideal:1}};class wd{static async create({sampleRate:e,format:t,preferHeadphonesForIosDevices:n,inputDeviceId:i,workletPaths:r,libsampleratePath:o}){let a=null,s=null;try{const c=ed({sampleRate:{ideal:e}},kd);if(vd()&&n){const e=(await window.navigator.mediaDevices.enumerateDevices()).find((e=>"audioinput"===e.kind&&["airpod","headphone","earphone"].find((t=>e.label.toLowerCase().includes(t)))));e&&(c.deviceId={ideal:e.deviceId})}i&&(c.deviceId={exact:i});const l=navigator.mediaDevices.getSupportedConstraints().sampleRate;a=new window.AudioContext(l?{sampleRate:e}:{});const d=a.createAnalyser();if(!l){const e=o||"https://cdn.jsdelivr.net/npm/@alexanderolsen/libsamplerate-js@2.1.2/dist/libsamplerate.worklet.js";await a.audioWorklet.addModule(e)}await md(a.audioWorklet,null==r?void 0:r.rawAudioProcessor);const u=ed({voiceIsolation:!0},c);s=await navigator.mediaDevices.getUserMedia({audio:u});const h=a.createMediaStreamSource(s),p=new AudioWorkletNode(a,"rawAudioProcessor");return p.port.postMessage({type:"setFormat",format:t,sampleRate:e}),h.connect(d),d.connect(p),await a.resume(),new wd(a,d,p,s,h)}catch(e){var c,l;throw null==(c=s)||c.getTracks().forEach((e=>{e.stop()})),null==(l=a)||l.close(),e}}constructor(e,t,n,i,r){this.context=void 0,this.analyser=void 0,this.worklet=void 0,this.inputStream=void 0,this.mediaStreamSource=void 0,this.context=e,this.analyser=t,this.worklet=n,this.inputStream=i,this.mediaStreamSource=r}async close(){this.inputStream.getTracks().forEach((e=>{e.stop()})),this.mediaStreamSource.disconnect(),await this.context.close()}setMuted(e){this.worklet.port.postMessage({type:"setMuted",isMuted:e})}async setInputDevice(e){try{const t=ed({},kd);e&&(t.deviceId={exact:e});const n=ed({voiceIsolation:!0},t),i=await navigator.mediaDevices.getUserMedia({audio:n});this.inputStream.getTracks().forEach((e=>{e.stop()})),this.mediaStreamSource.disconnect(),this.inputStream=i,this.mediaStreamSource=this.context.createMediaStreamSource(i),this.mediaStreamSource.connect(this.analyser)}catch(e){throw console.error("Failed to switch input device:",e),e}}}const Cd=pd("audioConcatProcessor",'/*\n * ulaw decoding logic taken from the wavefile library\n * https://github.com/rochars/wavefile/blob/master/lib/codecs/mulaw.js\n * USED BY @elevenlabs/client\n */\n\nconst decodeTable = [0,132,396,924,1980,4092,8316,16764];\n\nfunction decodeSample(muLawSample) {\n  let sign;\n  let exponent;\n  let mantissa;\n  let sample;\n  muLawSample = ~muLawSample;\n  sign = (muLawSample & 0x80);\n  exponent = (muLawSample >> 4) & 0x07;\n  mantissa = muLawSample & 0x0F;\n  sample = decodeTable[exponent] + (mantissa << (exponent+3));\n  if (sign !== 0) sample = -sample;\n\n  return sample;\n}\n\nclass AudioConcatProcessor extends AudioWorkletProcessor {\n  constructor() {\n    super();\n    this.buffers = []; // Initialize an empty buffer\n    this.cursor = 0;\n    this.currentBuffer = null;\n    this.wasInterrupted = false;\n    this.finished = false;\n    \n    this.port.onmessage = ({ data }) => {\n      switch (data.type) {\n        case "setFormat":\n          this.format = data.format;\n          break;\n        case "buffer":\n          this.wasInterrupted = false;\n          this.buffers.push(\n            this.format === "ulaw"\n              ? new Uint8Array(data.buffer)\n              : new Int16Array(data.buffer)\n          );\n          break;\n        case "interrupt":\n          this.wasInterrupted = true;\n          break;\n        case "clearInterrupted":\n          if (this.wasInterrupted) {\n            this.wasInterrupted = false;\n            this.buffers = [];\n            this.currentBuffer = null;\n          }\n      }\n    };\n  }\n  process(_, outputs) {\n    let finished = false;\n    const output = outputs[0][0];\n    for (let i = 0; i < output.length; i++) {\n      if (!this.currentBuffer) {\n        if (this.buffers.length === 0) {\n          finished = true;\n          break;\n        }\n        this.currentBuffer = this.buffers.shift();\n        this.cursor = 0;\n      }\n\n      let value = this.currentBuffer[this.cursor];\n      if (this.format === "ulaw") {\n        value = decodeSample(value);\n      }\n      output[i] = value / 32768;\n      this.cursor++;\n\n      if (this.cursor >= this.currentBuffer.length) {\n        this.currentBuffer = null;\n      }\n    }\n\n    if (this.finished !== finished) {\n      this.finished = finished;\n      this.port.postMessage({ type: "process", finished });\n    }\n\n    return true; // Continue processing\n  }\n}\n\nregisterProcessor("audioConcatProcessor", AudioConcatProcessor);\n');class Td{static async create({sampleRate:e,format:t,outputDeviceId:n,workletPaths:i}){let r=null,o=null;try{r=new AudioContext({sampleRate:e});const a=r.createAnalyser(),s=r.createGain();o=new Audio,o.src="",o.load(),o.autoplay=!0,o.style.display="none",document.body.appendChild(o);const c=r.createMediaStreamDestination();o.srcObject=c.stream,s.connect(a),a.connect(c),await Cd(r.audioWorklet,null==i?void 0:i.audioConcatProcessor);const l=new AudioWorkletNode(r,"audioConcatProcessor");return l.port.postMessage({type:"setFormat",format:t}),l.connect(s),await r.resume(),n&&o.setSinkId&&await o.setSinkId(n),new Td(r,a,s,l,o)}catch(e){var a,s;throw null!=(a=o)&&a.parentNode&&o.parentNode.removeChild(o),null==(s=o)||s.pause(),r&&"closed"!==r.state&&await r.close(),e}}constructor(e,t,n,i,r){this.context=void 0,this.analyser=void 0,this.gain=void 0,this.worklet=void 0,this.audioElement=void 0,this.context=e,this.analyser=t,this.gain=n,this.worklet=i,this.audioElement=r}async setOutputDevice(e){if(!("setSinkId"in HTMLAudioElement.prototype))throw new Error("setSinkId is not supported in this browser");await this.audioElement.setSinkId(e||"")}async close(){this.audioElement.parentNode&&this.audioElement.parentNode.removeChild(this.audioElement),this.audioElement.pause(),await this.context.close()}}class Sd extends nd{static async startSession(e){var t;const n=nd.getFullOptions(e);n.onStatusChange&&n.onStatusChange({status:"connecting"}),n.onCanSendFeedbackChange&&n.onCanSendFeedbackChange({canSendFeedback:!1});let i=null,r=null,o=null,a=null,s=null;if(null==(t=e.useWakeLock)||t)try{s=await navigator.wakeLock.request("screen")}catch(e){}try{var c;return a=await navigator.mediaDevices.getUserMedia({audio:!0}),await bd(n.connectionDelay),r=await gd(e),[i,o]=await Promise.all([wd.create(ed({},r.inputFormat,{preferHeadphonesForIosDevices:e.preferHeadphonesForIosDevices,inputDeviceId:e.inputDeviceId,workletPaths:e.workletPaths,libsampleratePath:e.libsampleratePath})),Td.create(ed({},r.outputFormat,{outputDeviceId:e.outputDeviceId,workletPaths:e.workletPaths}))]),null==(c=a)||c.getTracks().forEach((e=>{e.stop()})),a=null,new Sd(n,r,i,o,s)}catch(e){var l,d,u,h;n.onStatusChange&&n.onStatusChange({status:"disconnected"}),null==(l=a)||l.getTracks().forEach((e=>{e.stop()})),null==(d=r)||d.close(),await(null==(u=i)?void 0:u.close()),await(null==(h=o)?void 0:h.close());try{var p;await(null==(p=s)?void 0:p.release()),s=null}catch(e){}throw e}}constructor(e,t,n,i,r){super(e,t),this.input=void 0,this.output=void 0,this.wakeLock=void 0,this.inputFrequencyData=void 0,this.outputFrequencyData=void 0,this.onInputWorkletMessage=e=>{"connected"===this.status&&this.connection.sendMessage({user_audio_chunk:dd(e.data[0].buffer)})},this.onOutputWorkletMessage=({data:e})=>{"process"===e.type&&this.updateMode(e.finished?"listening":"speaking")},this.addAudioBase64Chunk=e=>{this.output.gain.gain.value=this.volume,this.output.worklet.port.postMessage({type:"clearInterrupted"}),this.output.worklet.port.postMessage({type:"buffer",buffer:ud(e)})},this.fadeOutAudio=()=>{this.updateMode("listening"),this.output.worklet.port.postMessage({type:"interrupt"}),this.output.gain.gain.exponentialRampToValueAtTime(1e-4,this.output.context.currentTime+2),setTimeout((()=>{this.output.gain.gain.value=this.volume,this.output.worklet.port.postMessage({type:"clearInterrupted"})}),2e3)},this.calculateVolume=e=>{if(0===e.length)return 0;let t=0;for(let n=0;n<e.length;n++)t+=e[n]/255;return t/=e.length,t<0?0:t>1?1:t},this.setVolume=({volume:e})=>{const t=Number.isFinite(e)?Math.min(1,Math.max(0,e)):1;this.volume=t,this.connection instanceof fd?this.connection.setAudioVolume(t):this.output.gain.gain.value=t},this.input=n,this.output=i,this.wakeLock=r,this.input.worklet.port.onmessage=this.onInputWorkletMessage,this.output.worklet.port.onmessage=this.onOutputWorkletMessage}async handleEndSession(){await super.handleEndSession();try{var e;await(null==(e=this.wakeLock)?void 0:e.release()),this.wakeLock=null}catch(e){}await this.input.close(),await this.output.close()}handleInterruption(e){super.handleInterruption(e),this.fadeOutAudio()}handleAudio(e){var t,n;this.lastInterruptTimestamp<=e.audio_event.event_id&&(null==(t=(n=this.options).onAudio)||t.call(n,e.audio_event.audio_base_64),this.connection instanceof fd||this.addAudioBase64Chunk(e.audio_event.audio_base_64),this.currentEventId=e.audio_event.event_id,this.updateCanSendFeedback(),this.updateMode("speaking"))}setMicMuted(e){this.connection instanceof fd?this.connection.setMicMuted(e):this.input.setMuted(e)}getInputByteFrequencyData(){return null!=this.inputFrequencyData||(this.inputFrequencyData=new Uint8Array(this.input.analyser.frequencyBinCount)),this.input.analyser.getByteFrequencyData(this.inputFrequencyData),this.inputFrequencyData}getOutputByteFrequencyData(){return this.connection instanceof fd?this.connection.getOutputByteFrequencyData()||new Uint8Array(1024):(null!=this.outputFrequencyData||(this.outputFrequencyData=new Uint8Array(this.output.analyser.frequencyBinCount)),this.output.analyser.getByteFrequencyData(this.outputFrequencyData),this.outputFrequencyData)}getInputVolume(){return this.calculateVolume(this.getInputByteFrequencyData())}getOutputVolume(){return this.calculateVolume(this.getOutputByteFrequencyData())}async changeInputDevice({sampleRate:e,format:t,preferHeadphonesForIosDevices:n,inputDeviceId:i}){try{if(this.connection instanceof ld)try{return await this.input.setInputDevice(i),this.input}catch(e){console.warn("Failed to change device on existing input, recreating:",e)}this.connection instanceof fd&&await this.connection.setAudioInputDevice(i||""),await this.input.close();const r=await wd.create({sampleRate:null!=e?e:this.connection.inputFormat.sampleRate,format:null!=t?t:this.connection.inputFormat.format,preferHeadphonesForIosDevices:n,inputDeviceId:i,workletPaths:this.options.workletPaths,libsampleratePath:this.options.libsampleratePath});return this.input=r,this.input.worklet.port.onmessage=this.onInputWorkletMessage,this.input}catch(e){throw console.error("Error changing input device",e),e}}async changeOutputDevice({sampleRate:e,format:t,outputDeviceId:n}){try{if(this.connection instanceof ld)try{return await this.output.setOutputDevice(n),this.output}catch(e){console.warn("Failed to change device on existing output, recreating:",e)}this.connection instanceof fd&&await this.connection.setAudioOutputDevice(n||""),await this.output.close();const i=await Td.create({sampleRate:null!=e?e:this.connection.outputFormat.sampleRate,format:null!=t?t:this.connection.outputFormat.format,outputDeviceId:n,workletPaths:this.options.workletPaths});return this.output=i,this.output}catch(e){throw console.error("Error changing output device",e),e}}}class xd extends nd{static startSession(e){return e.textOnly?yd.startSession(e):Sd.startSession(e)}}function Ed(e){var t,n,i="";if("string"==typeof e||"number"==typeof e)i+=e;else if("object"==typeof e)if(Array.isArray(e)){var r=e.length;for(t=0;t<r;t++)e[t]&&(n=Ed(e[t]))&&(i&&(i+=" "),i+=n)}else for(n in e)e[n]&&(i&&(i+=" "),i+=n);return i}function _d(){for(var e,t,n=0,i="",r=arguments.length;n<r;n++)(e=arguments[n])&&(t=Ed(e))&&(i&&(i+=" "),i+=t);return i}const Pd=["children"],Rd=["children"],Id=["children"],Od=["active"],Dd=["active","initial"],Md=["visible","className","grow","dep"],Ad=["visible","children","className","grow","dep"],Nd=["variant","children","icon","className","iconClassName","truncate"],Ld=["className"],jd=["scope","children"],Ud=["scope","children"],Fd=["asChild"],Bd=["disableOutsidePointerEvents","onEscapeKeyDown","onPointerDownOutside","onFocusOutside","onInteractOutside","onDismiss"],Vd=["loop","trapped","onMountAutoFocus","onUnmountAutoFocus"],qd=["mainAxis","crossAxis","fallbackPlacements","fallbackStrategy","fallbackAxisSideDirection","flipAlignment"],Wd=["strategy"],Hd=["mainAxis","crossAxis","limiter"],zd=["apply"],Gd=["children","width","height"],Kd=["__scopePopper","virtualRef"],Jd=["__scopePopper","side","sideOffset","align","alignOffset","arrowPadding","avoidCollisions","collisionBoundary","collisionPadding","sticky","hideWhenDetached","updatePositionStrategy","onPlaced"],Yd=["__scopePopper"],Xd=["container"],$d=["__scopeSelect","disabled"],Qd=["__scopeSelect","className","style","children","placeholder"],Zd=["__scopeSelect","children"],eu=["__scopeSelect","position","onCloseAutoFocus","onEscapeKeyDown","onPointerDownOutside","side","sideOffset","align","alignOffset","arrowPadding","collisionBoundary","collisionPadding","sticky","hideWhenDetached","avoidCollisions"],tu=["__scopeSelect","onPlaced"],nu=["__scopeSelect","align","collisionPadding"],iu=["__scopeSelect","nonce"],ru=["__scopeSelect"],ou=["__scopeSelect"],au=["__scopeSelect","value","disabled","textValue"],su=["__scopeSelect","className","style"],cu=["__scopeSelect"],lu=["__scopeSelect","onAutoScroll"],du=["__scopeSelect"],uu=["__scopeSelect"],hu=["__scopeSelect","value"],pu=["size","flagCode","className"],mu=["children"],fu=["className"],gu=["className"],vu=["visible"],bu=["iconOnly","isDisconnected","children"],yu=["expanded","className"],ku=["expanded","className"],wu=["visible","className"],Cu=["className"],Tu=["className"];function Su(e,t){if(null==e)return{};var n,i,r=function(e,t){if(null==e)return{};var n={};for(var i in e)if({}.hasOwnProperty.call(e,i)){if(-1!==t.indexOf(i))continue;n[i]=e[i]}return n}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(i=0;i<o.length;i++)n=o[i],-1===t.indexOf(n)&&{}.propertyIsEnumerable.call(e,n)&&(r[n]=e[n])}return r}function xu(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function Eu(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?xu(Object(n),!0).forEach((function(t){_u(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):xu(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function _u(e,t,n){return(t=function(e){var t=function(e){if("object"!=typeof e||!e)return e;var t=e[Symbol.toPrimitive];if(void 0!==t){var n=t.call(e,"string");if("object"!=typeof n)return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(e)}(e);return"symbol"==typeof t?t:t+""}(t))in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var Pu=Object.defineProperty,Ru=(e,t,n)=>((e,t,n)=>t in e?Pu(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n)(e,"symbol"!=typeof t?t+"":t,n);function Iu(e){return e?"true"===e||"false"!==e&&null:null}function Ou(e){if(!e)return null;try{return JSON.parse(e)}catch(e){console.error("Failed to parse JSON attribute",e)}return null}const Du=["variant","placement","override-config","avatar-image-url","avatar-orb-color-1","avatar-orb-color-2","agent-id","signed-url","terms-key","server-location","language","dynamic-variables","show-avatar-when-collapsed","override-prompt","override-first-message","override-language","override-voice-id","override-text-only","mic-muting","transcript","transcript-entries","text-input","text-contents","default-expanded","always-expanded","user-id","use-rtc","auto-resume"],Mu=["tiny","compact","full"];function Au(e){return Mu.includes(e)?e:Mu[0]}const Nu=["top-left","top","top-right","bottom-left","bottom","bottom-right"];function Lu(e){return Nu.includes(e)?e:"bottom-right"}const ju={main_label:"Need help?",start_call:"Start a call",start_chat:"Start a chat",send_message:"Send",new_call:"New call",end_call:"End",mute_microphone:"Mute microphone",change_language:"Change language",collapse:"Collapse",expand:"Expand",copied:"Copied!",accept_terms:"Accept",dismiss_terms:"Cancel",listening_status:"Listening",speaking_status:"Talk to interrupt",connecting_status:"Connecting",chatting_status:"Chatting with AI Agent",input_label:"Text message input",input_placeholder:"Send a message",input_placeholder_text_only:"Send a message",input_placeholder_new_conversation:"Start a new conversation",user_ended_conversation:"You ended the conversation",agent_ended_conversation:"The agent ended the conversation",conversation_id:"ID",error_occurred:"An error occurred",copy_id:"Copy ID"},Uu=Object.keys(ju),Fu={base:"#ffffff",base_hover:"#f9fafb",base_active:"#f3f4f6",base_border:"#e5e7eb",base_subtle:"#6b7280",base_primary:"#000000",base_error:"#ef4444",accent:"#000000",accent_hover:"#1f2937",accent_active:"#374151",accent_border:"#4b5563",accent_subtle:"#6b7280",accent_primary:"#ffffff",overlay_padding:32,button_radius:18,input_radius:10,bubble_radius:15,sheet_radius:"calc(var(--el-button-radius) + 6px)",compact_sheet_radius:"calc(var(--el-button-radius) + 12px)",dropdown_sheet_radius:"calc(var(--el-input-radius) + 6px)"},Bu=Object.keys(Fu);function Vu(e){const t=(0,b.useContext)(e);if(null==t)throw new Error("".concat(e.displayName," cannot be used outside of provider"));return t}const qu=(0,r.createContext)(null);function Wu(e){let{value:t,children:n}=e;const i=(0,b.useMemo)((()=>Object.fromEntries(Du.map((e=>[e,Ae(t[e])])))),[]);return Du.forEach((e=>{i[e].value=t[e]})),(0,v.jsx)(qu.Provider,{value:i,children:n})}function Hu(e){return Vu(qu)[e]}const zu=(0,r.createContext)(null);function Gu(e){let{children:t}=e;const n=Hu("server-location"),i=(0,b.useMemo)((()=>{const e=Fe((()=>function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"us";switch(e){case"eu-residency":case"in-residency":case"us":case"global":return e;default:return console.warn("[ConversationalAI] Invalid server-location: ".concat(e,'. Defaulting to "us"')),"us"}}(n.value))),t={us:"https://api.us.elevenlabs.io","eu-residency":"https://api.eu.residency.elevenlabs.io","in-residency":"https://api.in.residency.elevenlabs.io",global:"https://api.elevenlabs.io"},i={us:"wss://api.us.elevenlabs.io","eu-residency":"wss://api.eu.residency.elevenlabs.io","in-residency":"wss://api.in.residency.elevenlabs.io",global:"wss://api.elevenlabs.io"};return{location:e,serverUrl:Fe((()=>t[e.value])),webSocketUrl:Fe((()=>i[e.value]))}}),[]);return(0,v.jsx)(zu.Provider,{value:i,children:t})}function Ku(){return Vu(zu)}const Ju={en:{name:"English",flagCode:"us",languageCode:"en"},zh:{name:"",flagCode:"cn",languageCode:"zh"},es:{name:"Espaol",flagCode:"es",languageCode:"es"},hi:{name:"",flagCode:"in",languageCode:"hi"},pt:{name:"Portugus (Portugal)",flagCode:"pt",languageCode:"pt"},"pt-br":{name:"Portugus (Brasil)",flagCode:"br",languageCode:"pt-br"},fr:{name:"Franais",flagCode:"fr",languageCode:"fr"},de:{name:"Deutsch",flagCode:"de",languageCode:"de"},ja:{name:"",flagCode:"jp",languageCode:"ja"},ar:{name:"",flagCode:"ae",languageCode:"ar"},ru:{name:"",flagCode:"ru",languageCode:"ru"},ko:{name:"",flagCode:"kr",languageCode:"ko"},id:{name:"Bahasa Indonesia",flagCode:"id",languageCode:"id"},it:{name:"Italiano",flagCode:"it",languageCode:"it"},nl:{name:"Nederlands",flagCode:"nl",languageCode:"nl"},tr:{name:"Trke",flagCode:"tr",languageCode:"tr"},pl:{name:"Polski",flagCode:"pl",languageCode:"pl"},sv:{name:"Svenska",flagCode:"se",languageCode:"sv"},ms:{name:"Bahasa Melayu",flagCode:"my",languageCode:"ms"},ro:{name:"Romn",flagCode:"ro",languageCode:"ro"},uk:{name:"",flagCode:"ua",languageCode:"uk"},el:{name:"",flagCode:"gr",languageCode:"el"},cs:{name:"etina",flagCode:"cz",languageCode:"cs"},da:{name:"Dansk",flagCode:"dk",languageCode:"da"},fi:{name:"Suomi",flagCode:"fi",languageCode:"fi"},bg:{name:"",flagCode:"bg",languageCode:"bg"},hr:{name:"Hrvatski",flagCode:"hr",languageCode:"hr"},sk:{name:"Slovenina",flagCode:"sk",languageCode:"sk"},ta:{name:"",flagCode:"in",languageCode:"ta"},hu:{name:"Magyar",flagCode:"hu",languageCode:"hu"},no:{name:"Norsk",flagCode:"no",languageCode:"no"},vi:{name:"Ting Vit",flagCode:"vn",languageCode:"vi"},tl:{name:"Filipino",flagCode:"ph",languageCode:"tl"}};function Yu(e){return Object.keys(Ju).includes(null!=e?e:"")}const Xu=(0,r.createContext)(null);function $u(e){var t;let{children:n}=e;const i=mh(),r=Hu("language"),o=Hu("override-language"),a=et(null!==(t=r.peek())&&void 0!==t?t:i.peek().language),s=tt((()=>{var e;return(null!==(e=i.value.supported_language_overrides)&&void 0!==e?e:[]).filter(Yu)})),c=tt((()=>s.value.map((e=>Ju[e])).sort(((e,t)=>e.name.localeCompare(t.name))))),l=(0,b.useMemo)((()=>({language:Fe((()=>Yu(o.value)?Ju[o.value]:Yu(a.value)&&s.value.includes(a.value)?Ju[a.value]:Ju[i.value.language])),setLanguage:e=>{a.value=e},options:c,showPicker:Fe((()=>c.value.length>0))})),[]);return(0,v.jsx)(Xu.Provider,{value:l,children:n})}function Qu(){return Vu(Xu)}const Zu="0.4.0-cobrowse.2",eh=(0,r.createContext)(null);function th(e){var t;let{children:n}=e;var i;const r=mh(),o=tt((()=>{var e;return null!==(e=r.value.mic_muting_enabled)&&void 0!==e&&e})),a=et(null!==(t=null==(i=r.peek().auto_resume)?void 0:i.micMuted)&&void 0!==t&&t),s=(0,b.useMemo)((()=>({isMuted:Fe((()=>!!o.value&&a.value)),setIsMuted:e=>{a.value=e},isMutingEnabled:o})),[]);return(0,v.jsx)(eh.Provider,{value:s,children:n})}function nh(){return Vu(eh)}const ih=(0,r.createContext)(null);function rh(e){let{children:t}=e;const{language:n}=Qu(),i=Hu("override-prompt"),r=Hu("override-first-message"),o=Hu("override-voice-id"),a=Hu("override-text-only"),s=Hu("user-id"),c=tt((()=>{var e;return{agent:{prompt:{prompt:i.value},firstMessage:r.value,language:n.value.languageCode},tts:{voiceId:o.value},conversation:{textOnly:null!==(e=Iu(a.value))&&void 0!==e?e:void 0}}})),l=Hu("dynamic-variables"),d=tt((()=>{if(l.value)try{return JSON.parse(l.value)}catch(e){console.error("[ConversationalAI] Cannot parse dynamic-variables: ".concat(null==e?void 0:e.message))}})),{webSocketUrl:u}=Ku(),h=Hu("agent-id"),p=Hu("signed-url"),m=fh(),f=function(){const e=mh();return tt((()=>{var t;return null!==(t=e.value.use_rtc)&&void 0!==t&&t}))}(),g=tt((()=>{const e=f.value,t={dynamicVariables:d.value,overrides:c.value,connectionDelay:{default:300},textOnly:m.value,userId:s.value||void 0};return h.value?Eu(e?{agentId:h.value,origin:u.value,connectionType:"webrtc"}:{agentId:h.value,origin:u.value,connectionType:"websocket"},t):p.value?Eu({signedUrl:p.value,connectionType:"websocket"},t):(console.error("[ConversationalAI] Either agent-id or signed-url is required"),null)}));return g.value?(0,v.jsx)(ih.Provider,{value:g,children:t}):null}const oh=(0,r.createContext)(null);function ah(e){let{children:t}=e;const n=mh(),i=(0,b.useMemo)((()=>{const e=n.peek().terms_key,t=!!e&&!!localStorage.getItem(e),i=Ae(!1),r=Ae(t),o=Fe((()=>!n.value.terms_html||r.value));let a=[];return{termsShown:i,termsAccepted:o,dismissTerms:()=>{i.value=!1,a.forEach((e=>e.reject())),a=[]},acceptTerms:()=>{r.value=!0,i.value=!1;const e=n.peek().terms_key;e&&localStorage.setItem(e,"true"),a.forEach((e=>e.resolve())),a=[]},requestTerms:async()=>{o.peek()||(i.value=!0,await new Promise(((e,t)=>{a.push({resolve:e,reject:t})})))}}}),[]);return(0,v.jsx)(oh.Provider,{value:i,children:t})}function sh(){return Vu(oh)}function ch(e){const t=(0,b.useRef)(e);return(0,b.useLayoutEffect)((()=>{t.current=e}),[e]),(0,b.useCallback)((function(){return t.current(...arguments)}),[])}const lh=(0,r.createContext)(null);function dh(e){let{children:t}=e;const n=function(){const e=(0,b.useRef)(null),t=(0,b.useRef)(null),n=(0,b.useRef)(!1),i=(0,b.useRef)(null),r=mh();vh();const o=sh(),a=Vu(ih),{isMuted:s}=nh(),{subscribe:c,publish:l}=function(){const e=(0,b.useRef)([]),t=(0,b.useCallback)((t=>(e.current=[...e.current,t],()=>{e.current=e.current.filter((e=>e!==t))})),[]),n=(0,b.useCallback)((function(){for(const t of e.current)t(...arguments)}),[]);return{subscribe:t,publish:n}}(),d=function(){const e=et(!1),t=ch((()=>{e.value=!0}));return(0,b.useEffect)((()=>(window.addEventListener("beforeunload",t),()=>{window.removeEventListener("beforeunload",t)})),[t]),e}();return ct((()=>{var t;const n=s.value;null==(t=null==e?void 0:e.current)||t.setMicMuted(n)})),(0,b.useEffect)((()=>()=>{var t;null==(t=e.current)||t.endSession()}),[]),(0,b.useMemo)((()=>{var u;const h=Ae("disconnected"),p=Ae(!1),m=Fe((()=>p.value?"connecting":h.value)),f=Fe((()=>"disconnected"===m.value)),g=Ae("listening"),v=Fe((()=>"speaking"===g.value)),b=Ae(null),y=Ae(null),k=Ae(!1),w=Ae(null!==(u=r.value.transcript_entries)&&void 0!==u?u:[]),C=Ae(0),T=Ae(null);return{status:m,isSpeaking:v,mode:g,isDisconnected:f,lastId:y,error:b,canSendFeedback:k,conversationIndex:C,conversationTextOnly:T,transcript:w,startSession:async function(c){var u,m,f;let v=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};var S,x,E,_,P,R,I,O,D;const M=v.resume?"/* ".concat("continue"," */"):v.initialMessage;if(await o.requestTerms(),null!=(S=e.current)&&S.isOpen())return e.current.getId();if(t.current)return(await t.current).getId();let A=structuredClone(a.peek());(null!=(x=v.resume)&&x.textOnly||v.initialMessage)&&r.value.supports_text_only&&(A.textOnly=!0,r.value.text_only||(null!==(u=A.overrides)&&void 0!==u||(A.overrides={}),null!==(m=(E=A.overrides).conversation)&&void 0!==m||(E.conversation={}),A.overrides.conversation.textOnly=!0));try{A=function(e,t,n){try{const i=new CustomEvent("elevenlabs-convai:call",{bubbles:!0,composed:!0,detail:Eu({config:t},n)});return e.dispatchEvent(i),i.detail.config}catch(e){return console.error("[ConversationalAI] Could not trigger call event:",e),t}}(c,A,{micMuted:s.peek(),setExpanded:e=>l(e)})}catch(e){console.error("[ConversationalAI] Error triggering call event:",e)}i.current=A,T.value=null!==(f=A.textOnly)&&void 0!==f&&f,v.initialMessage&&(w.value=[{type:"message",role:"user",message:v.initialMessage,isText:!0,conversationIndex:C.peek()}],null==(_=A.onSendUserMessage)||_.call(A,v.initialMessage));try{if(t.current=function(e){let{signal:t,tries:n=5}=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return async function(){t&&(t.value=!0);try{for(let t=1;t<=n;t++)try{return await e(...arguments)}catch(e){if(t===n)throw e;await new Promise((e=>setTimeout(e,1e3)))}}finally{t&&(t.value=!1)}}}(xd.startSession,{signal:p})(Eu(Eu({},A),{},{overrides:Eu(Eu({},A.overrides),{},{client:Eu(Eu({},null==(P=A.overrides)?void 0:P.client),{},{source:(null==(I=null==(R=A.overrides)?void 0:R.client)?void 0:I.source)||"widget",version:(null==(D=null==(O=A.overrides)?void 0:O.client)?void 0:D.version)||Zu})}),onModeChange:e=>{d.peek()||(g.value=e.mode)},onStatusChange:e=>{d.peek()||(h.value=e.status)},onCanSendFeedbackChange:e=>{d.peek()||(k.value=e.canSendFeedback)},onMessage:e=>{var t;const{source:i,message:r}=e;!0!==T.peek()||"ai"!==i||n.current?("ai"===i&&(n.current=!0),w.value=[...w.value,{type:"message",role:i,message:r,isText:!1,conversationIndex:C.peek()}],null==(t=A.onMessage)||t.call(A,e)):n.current=!0},onDisconnect:e=>{var t;n.current=!1,!d.peek()&&(T.value=null,w.value=[...w.value,"error"===e.reason?{type:"error",message:e.message,conversationIndex:C.peek()}:{type:"disconnection",role:"user"===e.reason?"user":"ai",conversationIndex:C.peek()}],C.value++,"error"===e.reason&&(b.value=e.message,console.error("[ConversationalAI] Disconnected due to an error:",e.message)),null==(t=A.onDisconnect)||t.call(A,e))}})),e.current=await t.current,e.current.setMicMuted(s.peek()),M){const t=e.current;setTimeout((()=>t.sendUserMessage(M)),100)}const i=e.current.getId();return y.value=i,b.value=null,i}catch(e){let t="Could not start a conversation.";e instanceof CloseEvent?t=e.reason||t:e instanceof Error&&(t=e.message||t),b.value=t,w.value=[...w.value,{type:"error",message:t,conversationIndex:C.peek()}]}finally{t.current=null}},endSession:async()=>{const t=e.current;e.current=null,await(null==t?void 0:t.endSession())},getInputVolume:()=>{var t,n;return null!==(t=null==(n=e.current)?void 0:n.getInputVolume())&&void 0!==t?t:0},getOutputVolume:()=>{var t,n;return null!==(t=null==(n=e.current)?void 0:n.getOutputVolume())&&void 0!==t?t:0},sendFeedback:t=>{var n;null==(n=e.current)||n.sendFeedback(t)},sendUserMessage:t=>{var n,r,o;null==(n=e.current)||n.sendUserMessage(t),w.value=[...w.value,{type:"message",role:"user",message:t,isText:!0,conversationIndex:C.peek()}],!function(e){return e.startsWith("/* ")&&e.endsWith(" */")}(t)&&(null==(o=null==(r=i.current)?void 0:r.onSendUserMessage)||o.call(r,t))},sendUserActivity:()=>{var t;null==(t=e.current)||t.sendUserActivity()},subscribeOnSetExpanded:c}}),[a,s])}();return ct((()=>{if(!0===n.conversationTextOnly.value){n.transcript.value;const e=setTimeout((()=>{n.endSession()}),6e5);return()=>{clearTimeout(e)}}})),(0,v.jsx)(lh.Provider,{value:n,children:t})}function uh(){return Vu(lh)}const hh=(0,r.createContext)(null);function ph(e){let{children:t}=e;const{serverUrl:n}=Ku(),i=Hu("agent-id"),r=Hu("override-config"),o=Hu("signed-url"),a=et(null);ct((()=>{if(r.value)try{const e=JSON.parse(r.value);if(e)return void(a.value=e)}catch(e){console.error("[ConversationalAI] Cannot parse override-config: ".concat(null==e?void 0:e.message))}let e,t=i.value;if(o.value){var s,c;const n=new URL(o.value).searchParams;t=null!==(s=n.get("agent_id"))&&void 0!==s?s:i.value,e=null!==(c=n.get("conversation_signature"))&&void 0!==c?c:void 0}if(!t)return void(a.value=null);const l=new AbortController;return async function(e,t,n,i){const r=await(await fetch("".concat(t,"/v1/convai/agents/").concat(e,"/widget").concat(i?"?conversation_signature=".concat(encodeURIComponent(i)):""),{signal:n})).json();if(!r.widget_config)throw new Error("Response does not contain widget_config");return r.widget_config}(t,n.value,l.signal,e).then((e=>{l.signal.aborted||(a.value=e)})).catch((e=>{console.error("[ConversationalAI] Cannot fetch config for agent ".concat(i.value,": ").concat(null==e?void 0:e.message)),l.signal.aborted||(a.value=null)})),()=>{l.abort()}}));const s=Hu("variant"),c=Hu("placement"),l=Hu("terms-key"),d=Hu("mic-muting"),u=Hu("transcript"),h=Hu("transcript-entries"),p=Hu("text-input"),m=Hu("default-expanded"),f=Hu("always-expanded"),g=Hu("override-text-only"),b=Hu("use-rtc"),y=Hu("auto-resume"),k=tt((()=>{var e,t,n,i,r,o,v,k,w,C,T,S,x,E,_,P;if(!a.value)return null;const R=null!==(e=s.value)&&void 0!==e?e:a.value.variant,I=null!==(t=c.value)&&void 0!==t?t:a.value.placement,O=null!==(n=l.value)&&void 0!==n?n:a.value.terms_key,D=null!==(i=null!==(r=Iu(g.value))&&void 0!==r?r:a.value.text_only)&&void 0!==i&&i,M=null!==(o=Iu(d.value))&&void 0!==o?o:a.value.mic_muting_enabled,A=null!==(v=Iu(u.value))&&void 0!==v?v:a.value.transcript_enabled,N=null!==(k=Iu(p.value))&&void 0!==k?k:a.value.text_input_enabled,L=null!==(w=null!==(C=Iu(f.value))&&void 0!==C?C:a.value.always_expanded)&&void 0!==w&&w,j=null!==(T=null!==(S=Iu(m.value))&&void 0!==S?S:a.value.default_expanded)&&void 0!==T&&T,U=null!==(x=null!==(E=Iu(b.value))&&void 0!==E?E:a.value.use_rtc)&&void 0!==x&&x,F=null!==(_=Ou(y.value))&&void 0!==_?_:void 0,B=null!==(P=Ou(h.value))&&void 0!==P?P:[];return Eu(Eu({},a.value),{},{variant:Au(R),placement:Lu(I),terms_key:O,mic_muting_enabled:!D&&M,transcript_enabled:D||A,transcript_entries:B,text_input_enabled:D||N,always_expanded:L,default_expanded:j,use_rtc:U,auto_resume:F})}));return k.value?(0,v.jsx)(hh.Provider,{value:k,children:t}):null}function mh(){return Vu(hh)}function fh(){const e=Hu("override-text-only"),t=mh();return tt((()=>{var n,i;return null!==(n=null!==(i=Iu(e.value))&&void 0!==i?i:t.value.text_only)&&void 0!==n&&n}))}function gh(){const e=fh(),{conversationTextOnly:t}=uh();return tt((()=>{var n;return null!==(n=t.value)&&void 0!==n?n:e.value}))}function vh(){const e=Hu("override-first-message"),t=mh(),{language:n}=Qu();return tt((()=>{var i,r,o,a,s;return null!==(i=null!==(r=null!==(o=e.value)&&void 0!==o?o:null==(s=null==(a=t.value.language_presets)?void 0:a[n.value.languageCode])?void 0:s.first_message)&&void 0!==r?r:t.value.first_message)&&void 0!==i?i:null}))}const bh=P((function(){const e=mh(),t=tt((()=>{const t=e.value.styles;return":host, :root {\n".concat(Bu.map((e=>{var n;return"".concat(function(e){return"--el-".concat(e.replace(/_/g,"-"))}(e),": ").concat(function(e){return"number"==typeof e?"".concat(e,"px"):e}(null!==(n=null==t?void 0:t[e])&&void 0!==n?n:Fu[e]),";")})).join("\n"),"\n}")}));return(0,v.jsxs)("style",{children:[t,'@import"https://fonts.googleapis.com/css2?family=Inter:wght@400,500&display=swap";*,:before,:after{--tw-border-spacing-x: 0;--tw-border-spacing-y: 0;--tw-translate-x: 0;--tw-translate-y: 0;--tw-rotate: 0;--tw-skew-x: 0;--tw-skew-y: 0;--tw-scale-x: 1;--tw-scale-y: 1;--tw-pan-x: ;--tw-pan-y: ;--tw-pinch-zoom: ;--tw-scroll-snap-strictness: proximity;--tw-gradient-from-position: ;--tw-gradient-via-position: ;--tw-gradient-to-position: ;--tw-ordinal: ;--tw-slashed-zero: ;--tw-numeric-figure: ;--tw-numeric-spacing: ;--tw-numeric-fraction: ;--tw-ring-inset: ;--tw-ring-offset-width: 0px;--tw-ring-offset-color: #fff;--tw-ring-color: rgb(59 130 246 / .5);--tw-ring-offset-shadow: 0 0 #0000;--tw-ring-shadow: 0 0 #0000;--tw-shadow: 0 0 #0000;--tw-shadow-colored: 0 0 #0000;--tw-blur: ;--tw-brightness: ;--tw-contrast: ;--tw-grayscale: ;--tw-hue-rotate: ;--tw-invert: ;--tw-saturate: ;--tw-sepia: ;--tw-drop-shadow: ;--tw-backdrop-blur: ;--tw-backdrop-brightness: ;--tw-backdrop-contrast: ;--tw-backdrop-grayscale: ;--tw-backdrop-hue-rotate: ;--tw-backdrop-invert: ;--tw-backdrop-opacity: ;--tw-backdrop-saturate: ;--tw-backdrop-sepia: ;--tw-contain-size: ;--tw-contain-layout: ;--tw-contain-paint: ;--tw-contain-style: }::backdrop{--tw-border-spacing-x: 0;--tw-border-spacing-y: 0;--tw-translate-x: 0;--tw-translate-y: 0;--tw-rotate: 0;--tw-skew-x: 0;--tw-skew-y: 0;--tw-scale-x: 1;--tw-scale-y: 1;--tw-pan-x: ;--tw-pan-y: ;--tw-pinch-zoom: ;--tw-scroll-snap-strictness: proximity;--tw-gradient-from-position: ;--tw-gradient-via-position: ;--tw-gradient-to-position: ;--tw-ordinal: ;--tw-slashed-zero: ;--tw-numeric-figure: ;--tw-numeric-spacing: ;--tw-numeric-fraction: ;--tw-ring-inset: ;--tw-ring-offset-width: 0px;--tw-ring-offset-color: #fff;--tw-ring-color: rgb(59 130 246 / .5);--tw-ring-offset-shadow: 0 0 #0000;--tw-ring-shadow: 0 0 #0000;--tw-shadow: 0 0 #0000;--tw-shadow-colored: 0 0 #0000;--tw-blur: ;--tw-brightness: ;--tw-contrast: ;--tw-grayscale: ;--tw-hue-rotate: ;--tw-invert: ;--tw-saturate: ;--tw-sepia: ;--tw-drop-shadow: ;--tw-backdrop-blur: ;--tw-backdrop-brightness: ;--tw-backdrop-contrast: ;--tw-backdrop-grayscale: ;--tw-backdrop-hue-rotate: ;--tw-backdrop-invert: ;--tw-backdrop-opacity: ;--tw-backdrop-saturate: ;--tw-backdrop-sepia: ;--tw-contain-size: ;--tw-contain-layout: ;--tw-contain-paint: ;--tw-contain-style: }*,:before,:after{box-sizing:border-box;border-width:0;border-style:solid;border-color:currentColor}:before,:after{--tw-content: ""}html,:host{line-height:1.5;-webkit-text-size-adjust:100%;-moz-tab-size:4;-o-tab-size:4;tab-size:4;font-family:ui-sans-serif,system-ui,sans-serif,"Apple Color Emoji","Segoe UI Emoji",Segoe UI Symbol,"Noto Color Emoji";font-feature-settings:normal;font-variation-settings:normal;-webkit-tap-highlight-color:transparent}body{margin:0;line-height:inherit}hr{height:0;color:inherit;border-top-width:1px}abbr:where([title]){-webkit-text-decoration:underline dotted;text-decoration:underline dotted}h1,h2,h3,h4,h5,h6{font-size:inherit;font-weight:inherit}a{color:inherit;text-decoration:inherit}b,strong{font-weight:bolder}code,kbd,samp,pre{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,Liberation Mono,Courier New,monospace;font-feature-settings:normal;font-variation-settings:normal;font-size:1em}small{font-size:80%}sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}table{text-indent:0;border-color:inherit;border-collapse:collapse}button,input,optgroup,select,textarea{font-family:inherit;font-feature-settings:inherit;font-variation-settings:inherit;font-size:100%;font-weight:inherit;line-height:inherit;letter-spacing:inherit;color:inherit;margin:0;padding:0}button,select{text-transform:none}button,input:where([type=button]),input:where([type=reset]),input:where([type=submit]){-webkit-appearance:button;background-color:transparent;background-image:none}:-moz-focusring{outline:auto}:-moz-ui-invalid{box-shadow:none}progress{vertical-align:baseline}::-webkit-inner-spin-button,::-webkit-outer-spin-button{height:auto}[type=search]{-webkit-appearance:textfield;outline-offset:-2px}::-webkit-search-decoration{-webkit-appearance:none}::-webkit-file-upload-button{-webkit-appearance:button;font:inherit}summary{display:list-item}blockquote,dl,dd,h1,h2,h3,h4,h5,h6,hr,figure,p,pre{margin:0}fieldset{margin:0;padding:0}legend{padding:0}ol,ul,menu{list-style:none;margin:0;padding:0}dialog{padding:0}textarea{resize:vertical}input::-moz-placeholder,textarea::-moz-placeholder{opacity:1;color:#9ca3af}input::placeholder,textarea::placeholder{opacity:1;color:#9ca3af}button,[role=button]{cursor:pointer}:disabled{cursor:default}img,svg,video,canvas,audio,iframe,embed,object{display:block;vertical-align:middle}img,video{max-width:100%;height:auto}[hidden]:where(:not([hidden=until-found])){display:none}.container{width:100%}@media (min-width: 640px){.container{max-width:640px}}@media (min-width: 768px){.container{max-width:768px}}@media (min-width: 1024px){.container{max-width:1024px}}@media (min-width: 1280px){.container{max-width:1280px}}@media (min-width: 1536px){.container{max-width:1536px}}.pointer-events-auto{pointer-events:auto}.\\!visible{visibility:visible!important}.visible{visibility:visible}.collapse{visibility:collapse}.static{position:static}.fixed{position:fixed}.absolute{position:absolute}.relative{position:relative}.inset-0{top:0;right:0;bottom:0;left:0}.-bottom-3{bottom:-12px}.bottom-0{bottom:0}.bottom-1{bottom:4px}.bottom-20{bottom:80px}.left-0{left:0}.left-1\\/2{left:50%}.left-4{left:16px}.right-0{right:0}.right-1{right:4px}.top-0{top:0}.top-1\\/2{top:50%}.top-20{top:80px}.top-4{top:16px}.z-1{z-index:1}.z-10{z-index:10}.m-1{margin:4px}.-mx-0\\.5{margin-left:-2px;margin-right:-2px}.mx-1{margin-left:4px;margin-right:4px}.-mr-1\\.5{margin-right:-6px}.ml-auto{margin-left:auto}.mt-2{margin-top:8px}.block{display:block}.inline{display:inline}.\\!flex{display:flex!important}.flex{display:flex}.inline-flex{display:inline-flex}.contents{display:contents}.hidden{display:none}.h-11{height:44px}.h-16{height:64px}.h-4{height:16px}.h-48{height:192px}.h-5{height:20px}.h-6{height:24px}.h-7{height:28px}.h-9{height:36px}.h-\\[calc\\(100\\%-80px\\)\\]{height:calc(100% - 80px)}.h-full{height:100%}.h-screen{height:100vh}.max-h-\\[550px\\]{max-height:550px}.max-h-\\[8lh\\]{max-height:8lh}.max-h-\\[min\\(384px\\,var\\(--radix-select-content-available-height\\)\\)\\]{max-height:min(384px,var(--radix-select-content-available-height))}.min-h-min{min-height:-moz-min-content;min-height:min-content}.w-16{width:64px}.w-4{width:16px}.w-48{width:192px}.w-5{width:20px}.w-6{width:24px}.w-64{width:256px}.w-7{width:28px}.w-9{width:36px}.w-full{width:100%}.w-screen{width:100vw}.\\!min-w-60{min-width:240px!important}.min-w-0{min-width:0px}.min-w-60{min-width:240px}.min-w-9{min-width:36px}.min-w-\\[var\\(--radix-select-trigger-width\\)\\]{min-width:var(--radix-select-trigger-width)}.min-w-max{min-width:-moz-max-content;min-width:max-content}.min-w-min{min-width:-moz-min-content;min-width:min-content}.max-w-64{max-width:256px}.max-w-\\[400px\\]{max-width:400px}.shrink-0{flex-shrink:0}.grow{flex-grow:1}.origin-bottom{transform-origin:bottom}.origin-bottom-left{transform-origin:bottom left}.origin-bottom-right{transform-origin:bottom right}.origin-top{transform-origin:top}.origin-top-left{transform-origin:top left}.origin-top-right{transform-origin:top right}.-translate-x-1\\/2{--tw-translate-x: -50%;transform:translate(var(--tw-translate-x),var(--tw-translate-y)) rotate(var(--tw-rotate)) skew(var(--tw-skew-x)) skewY(var(--tw-skew-y)) scaleX(var(--tw-scale-x)) scaleY(var(--tw-scale-y))}.-translate-y-1\\/2{--tw-translate-y: -50%;transform:translate(var(--tw-translate-x),var(--tw-translate-y)) rotate(var(--tw-rotate)) skew(var(--tw-skew-x)) skewY(var(--tw-skew-y)) scaleX(var(--tw-scale-x)) scaleY(var(--tw-scale-y))}.-translate-y-\\[calc\\(var\\(--el-overlay-padding\\)\\)\\]{--tw-translate-y: calc(calc(var(--el-overlay-padding)) * -1);transform:translate(var(--tw-translate-x),var(--tw-translate-y)) rotate(var(--tw-rotate)) skew(var(--tw-skew-x)) skewY(var(--tw-skew-y)) scaleX(var(--tw-scale-x)) scaleY(var(--tw-scale-y))}.translate-y-1\\/2{--tw-translate-y: 50%;transform:translate(var(--tw-translate-x),var(--tw-translate-y)) rotate(var(--tw-rotate)) skew(var(--tw-skew-x)) skewY(var(--tw-skew-y)) scaleX(var(--tw-scale-x)) scaleY(var(--tw-scale-y))}.translate-y-\\[calc\\(var\\(--el-overlay-padding\\)\\)\\]{--tw-translate-y: calc(var(--el-overlay-padding));transform:translate(var(--tw-translate-x),var(--tw-translate-y)) rotate(var(--tw-rotate)) skew(var(--tw-skew-x)) skewY(var(--tw-skew-y)) scaleX(var(--tw-scale-x)) scaleY(var(--tw-scale-y))}.translate-y-full{--tw-translate-y: 100%;transform:translate(var(--tw-translate-x),var(--tw-translate-y)) rotate(var(--tw-rotate)) skew(var(--tw-skew-x)) skewY(var(--tw-skew-y)) scaleX(var(--tw-scale-x)) scaleY(var(--tw-scale-y))}.-rotate-180{--tw-rotate: -180deg;transform:translate(var(--tw-translate-x),var(--tw-translate-y)) rotate(var(--tw-rotate)) skew(var(--tw-skew-x)) skewY(var(--tw-skew-y)) scaleX(var(--tw-scale-x)) scaleY(var(--tw-scale-y))}.scale-100{--tw-scale-x: 1;--tw-scale-y: 1;transform:translate(var(--tw-translate-x),var(--tw-translate-y)) rotate(var(--tw-rotate)) skew(var(--tw-skew-x)) skewY(var(--tw-skew-y)) scaleX(var(--tw-scale-x)) scaleY(var(--tw-scale-y))}.scale-150{--tw-scale-x: 1.5;--tw-scale-y: 1.5;transform:translate(var(--tw-translate-x),var(--tw-translate-y)) rotate(var(--tw-rotate)) skew(var(--tw-skew-x)) skewY(var(--tw-skew-y)) scaleX(var(--tw-scale-x)) scaleY(var(--tw-scale-y))}.scale-75{--tw-scale-x: .75;--tw-scale-y: .75;transform:translate(var(--tw-translate-x),var(--tw-translate-y)) rotate(var(--tw-rotate)) skew(var(--tw-skew-x)) skewY(var(--tw-skew-y)) scaleX(var(--tw-scale-x)) scaleY(var(--tw-scale-y))}.scale-90{--tw-scale-x: .9;--tw-scale-y: .9;transform:translate(var(--tw-translate-x),var(--tw-translate-y)) rotate(var(--tw-rotate)) skew(var(--tw-skew-x)) skewY(var(--tw-skew-y)) scaleX(var(--tw-scale-x)) scaleY(var(--tw-scale-y))}.scale-\\[0\\.333\\]{--tw-scale-x: .333;--tw-scale-y: .333;transform:translate(var(--tw-translate-x),var(--tw-translate-y)) rotate(var(--tw-rotate)) skew(var(--tw-skew-x)) skewY(var(--tw-skew-y)) scaleX(var(--tw-scale-x)) scaleY(var(--tw-scale-y))}.transform{transform:translate(var(--tw-translate-x),var(--tw-translate-y)) rotate(var(--tw-rotate)) skew(var(--tw-skew-x)) skewY(var(--tw-skew-y)) scaleX(var(--tw-scale-x)) scaleY(var(--tw-scale-y))}.cursor-default{cursor:default}.cursor-pointer{cursor:pointer}.select-none{-webkit-user-select:none;-moz-user-select:none;user-select:none}.resize-none{resize:none}.flex-col{flex-direction:column}.flex-col-reverse{flex-direction:column-reverse}.items-start{align-items:flex-start}.items-end{align-items:flex-end}.items-center{align-items:center}.justify-end{justify-content:flex-end}.justify-center{justify-content:center}.gap-1{gap:4px}.gap-2{gap:8px}.gap-2\\.5{gap:10px}.gap-3{gap:12px}.overflow-hidden{overflow:hidden}.overflow-y-auto{overflow-y:auto}.overflow-x-hidden{overflow-x:hidden}.truncate{overflow:hidden;text-overflow:ellipsis;white-space:nowrap}.whitespace-nowrap{white-space:nowrap}.break-all{word-break:break-all}.rounded-\\[calc\\(var\\(--el-button-radius\\)\\+4px\\)\\]{border-radius:calc(var(--el-button-radius) + 4px)}.rounded-bubble{border-radius:var(--el-bubble-radius)}.rounded-button{border-radius:var(--el-button-radius)}.rounded-compact-sheet{border-radius:var(--el-compact-sheet-radius)}.rounded-dropdown-sheet{border-radius:var(--el-dropdown-sheet-radius)}.rounded-full{border-radius:9999px}.rounded-input{border-radius:var(--el-input-radius)}.rounded-sheet{border-radius:var(--el-sheet-radius)}.rounded-bl-\\[calc\\(var\\(--el-bubble-radius\\)\\/3\\)\\]{border-bottom-left-radius:calc(var(--el-bubble-radius) / 3)}.border{border-width:1px}.border-accent{border-color:var(--el-accent)}.border-base-border{border-color:var(--el-base-border)}.bg-accent{background-color:var(--el-accent)}.bg-base{background-color:var(--el-base)}.bg-base-active{background-color:var(--el-base-active)}.bg-base-border{background-color:var(--el-base-border)}.bg-base-hover{background-color:var(--el-base-hover)}.bg-cover{background-size:cover}.object-cover{-o-object-fit:cover;object-fit:cover}.p-1{padding:4px}.p-1\\.5{padding:6px}.p-2{padding:8px}.p-3{padding:12px}.p-4{padding:16px}.px-1{padding-left:4px;padding-right:4px}.px-1\\.5{padding-left:6px;padding-right:6px}.px-2{padding-left:8px;padding-right:8px}.px-2\\.5{padding-left:10px;padding-right:10px}.px-3{padding-left:12px;padding-right:12px}.px-4{padding-left:16px;padding-right:16px}.px-8{padding-left:32px;padding-right:32px}.py-1\\.5{padding-top:6px;padding-bottom:6px}.py-2\\.5{padding-top:10px;padding-bottom:10px}.py-\\[calc\\(theme\\(spacing\\.2\\)-1px\\)\\]{padding-top:7px;padding-bottom:7px}.pb-1{padding-bottom:4px}.pb-3{padding-bottom:12px}.pl-16{padding-left:64px}.pr-16{padding-right:64px}.pr-3{padding-right:12px}.pr-9{padding-right:36px}.pt-1{padding-top:4px}.text-center{text-align:center}.text-\\[10px\\]{font-size:10px}.text-lg{font-size:18px;line-height:26px}.text-md{font-size:16px;line-height:24px}.text-sm{font-size:14px;line-height:20px}.text-xs{font-size:12px;line-height:16px}.font-medium{font-weight:500}.text-accent-primary{color:var(--el-accent-primary)}.text-base-error{color:var(--el-base-error)}.text-base-primary{color:var(--el-base-primary)}.text-base-subtle{color:var(--el-base-subtle)}.underline{text-decoration-line:underline}.opacity-0{opacity:0}.opacity-30{opacity:.3}.shadow-lg{--tw-shadow: 0 2px 40px 1px rgba(0, 0, 0, .12);--tw-shadow-colored: 0 2px 40px 1px var(--tw-shadow-color);box-shadow:var(--tw-ring-offset-shadow, 0 0 #0000),var(--tw-ring-shadow, 0 0 #0000),var(--tw-shadow)}.shadow-md{--tw-shadow: 0 2px 24px 1px rgba(0, 0, 0, .16);--tw-shadow-colored: 0 2px 24px 1px var(--tw-shadow-color);box-shadow:var(--tw-ring-offset-shadow, 0 0 #0000),var(--tw-ring-shadow, 0 0 #0000),var(--tw-shadow)}.filter{filter:var(--tw-blur) var(--tw-brightness) var(--tw-contrast) var(--tw-grayscale) var(--tw-hue-rotate) var(--tw-invert) var(--tw-saturate) var(--tw-sepia) var(--tw-drop-shadow)}.transition{transition-property:color,background-color,border-color,text-decoration-color,fill,stroke,opacity,box-shadow,transform,filter,backdrop-filter;transition-timing-function:cubic-bezier(.4,0,.2,1);transition-duration:.15s}.transition-\\[border-radius\\]{transition-property:border-radius;transition-timing-function:cubic-bezier(.4,0,.2,1);transition-duration:.15s}.transition-\\[margin\\]{transition-property:margin;transition-timing-function:cubic-bezier(.4,0,.2,1);transition-duration:.15s}.transition-\\[opacity\\,transform\\]{transition-property:opacity,transform;transition-timing-function:cubic-bezier(.4,0,.2,1);transition-duration:.15s}.transition-\\[opacity\\,width\\,height\\,transform\\,flex-grow\\]{transition-property:opacity,width,height,transform,flex-grow;transition-timing-function:cubic-bezier(.4,0,.2,1);transition-duration:.15s}.transition-\\[transform\\,left\\,top\\]{transition-property:transform,left,top;transition-timing-function:cubic-bezier(.4,0,.2,1);transition-duration:.15s}.transition-\\[transform\\,opacity\\]{transition-property:transform,opacity;transition-timing-function:cubic-bezier(.4,0,.2,1);transition-duration:.15s}.transition-colors{transition-property:color,background-color,border-color,text-decoration-color,fill,stroke;transition-timing-function:cubic-bezier(.4,0,.2,1);transition-duration:.15s}.transition-opacity{transition-property:opacity;transition-timing-function:cubic-bezier(.4,0,.2,1);transition-duration:.15s}.transition-transform{transition-property:transform;transition-timing-function:cubic-bezier(.4,0,.2,1);transition-duration:.15s}.duration-200{transition-duration:.2s}.ease-out{transition-timing-function:cubic-bezier(0,0,.2,1)}.overlay{position:absolute;inset:var(--el-overlay-padding);right:calc(var(--el-overlay-padding) + var(--removed-body-scroll-bar-size, 0px))}.focus-ring{--tw-ring-color: var(--el-accent);--tw-ring-offset-width: 2px;--tw-ring-offset-color: var(--el-base)}.focus-ring:focus-visible{outline:2px solid transparent;outline-offset:2px;--tw-ring-offset-shadow: var(--tw-ring-inset) 0 0 0 var(--tw-ring-offset-width) var(--tw-ring-offset-color);--tw-ring-shadow: var(--tw-ring-inset) 0 0 0 calc(2px + var(--tw-ring-offset-width)) var(--tw-ring-color);box-shadow:var(--tw-ring-offset-shadow),var(--tw-ring-shadow),var(--tw-shadow, 0 0 #0000)}.animate-text{background-image:linear-gradient(75deg,var(--el-base-primary),var(--el-base-subtle),var(--el-base-primary),var(--el-base-subtle));background-size:300% 100%;-webkit-background-clip:text;background-clip:text;color:transparent;animation:TextAnimation 2s linear infinite}@keyframes TextAnimation{0%{background-position:0 0}to{background-position:100% 0}}.\\!terms h6,.terms h6{font-size:12px;line-height:16px;font-weight:500;color:var(--el-base-primary)}.\\!terms h5,.terms h5{font-size:14px;line-height:20px;font-weight:500;color:var(--el-base-primary)}.\\!terms h4,.terms h4{font-size:16px;line-height:24px;font-weight:500;color:var(--el-base-primary)}.\\!terms h3,.terms h3{font-size:18px;line-height:26px;font-weight:500;color:var(--el-base-primary)}.\\!terms h2,.terms h2{font-size:20px;line-height:28px;font-weight:500;color:var(--el-base-primary)}.\\!terms h2,.terms h2{font-size:24px;line-height:30px;font-weight:500;color:var(--el-base-primary)}.\\[field-sizing\\:content\\]{field-sizing:content}.\\[line-height\\:var\\(--el-overlay-padding\\)\\]{line-height:var(--el-overlay-padding)}.\\[overflow-wrap\\:break-word\\]{overflow-wrap:break-word}.dev-host,:host{pointer-events:none;position:fixed;top:0;right:0;bottom:0;left:0;z-index:1000;font-size:16px;line-height:24px;color:var(--el-base-primary);font-family:Inter,-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen,Ubuntu,Cantarell,Fira Sans,Droid Sans,Helvetica Neue,sans-serif;scrollbar-color:#e5e7eb transparent}.placeholder\\:text-base-subtle::-moz-placeholder{color:var(--el-base-subtle)}.placeholder\\:text-base-subtle::placeholder{color:var(--el-base-subtle)}.hover\\:border-accent-hover:hover{border-color:var(--el-accent-hover)}.hover\\:bg-accent-hover:hover{background-color:var(--el-accent-hover)}.hover\\:bg-base-hover:hover{background-color:var(--el-base-hover)}.hover\\:opacity-50:hover{opacity:.5}.focus-visible\\:underline-offset-2:focus-visible{text-underline-offset:2px}.focus-visible\\:opacity-100:focus-visible{opacity:1}.focus-visible\\:outline-none:focus-visible{outline:2px solid transparent;outline-offset:2px}.active\\:border-accent-active:active{border-color:var(--el-accent-active)}.active\\:bg-accent-active:active{background-color:var(--el-accent-active)}.active\\:bg-base-active:active{background-color:var(--el-base-active)}.data-hidden\\:-translate-y-4[data-shown=false]{--tw-translate-y: -16px;transform:translate(var(--tw-translate-x),var(--tw-translate-y)) rotate(var(--tw-rotate)) skew(var(--tw-skew-x)) skewY(var(--tw-skew-y)) scaleX(var(--tw-scale-x)) scaleY(var(--tw-scale-y))}.data-hidden\\:translate-y-2[data-shown=false]{--tw-translate-y: 8px;transform:translate(var(--tw-translate-x),var(--tw-translate-y)) rotate(var(--tw-rotate)) skew(var(--tw-skew-x)) skewY(var(--tw-skew-y)) scaleX(var(--tw-scale-x)) scaleY(var(--tw-scale-y))}.data-hidden\\:scale-100[data-shown=false]{--tw-scale-x: 1;--tw-scale-y: 1;transform:translate(var(--tw-translate-x),var(--tw-translate-y)) rotate(var(--tw-rotate)) skew(var(--tw-skew-x)) skewY(var(--tw-skew-y)) scaleX(var(--tw-scale-x)) scaleY(var(--tw-scale-y))}.data-hidden\\:scale-75[data-shown=false]{--tw-scale-x: .75;--tw-scale-y: .75;transform:translate(var(--tw-translate-x),var(--tw-translate-y)) rotate(var(--tw-rotate)) skew(var(--tw-skew-x)) skewY(var(--tw-skew-y)) scaleX(var(--tw-scale-x)) scaleY(var(--tw-scale-y))}.data-hidden\\:scale-90[data-shown=false]{--tw-scale-x: .9;--tw-scale-y: .9;transform:translate(var(--tw-translate-x),var(--tw-translate-y)) rotate(var(--tw-rotate)) skew(var(--tw-skew-x)) skewY(var(--tw-skew-y)) scaleX(var(--tw-scale-x)) scaleY(var(--tw-scale-y))}.data-hidden\\:opacity-0[data-shown=false]{opacity:0}.data-\\[highlighted\\]\\:bg-base-active[data-highlighted]{background-color:var(--el-base-active)}']})})),yh=(0,r.createContext)(null);function kh(e){let{children:t}=e;const n=mh(),{language:i}=Qu(),r=Hu("text-contents"),o=tt((()=>{try{if(r.value){const e=JSON.parse(r.value);if("object"==typeof e)return e}}catch(e){console.error("[ConversationalAI] Cannot parse text-contents:",e)}return{}})),a=(0,b.useMemo)((()=>Object.fromEntries(Uu.map((e=>[e,Fe((()=>{var t,r,a,s,c,l,d;return null!==(t=null!==(r=null!==(a=o.value[e])&&void 0!==a?a:null==(l=null==(c=null==(s=n.value.language_presets)?void 0:s[i.value.languageCode])?void 0:c.text_contents)?void 0:l[e])&&void 0!==r?r:null==(d=n.value.text_contents)?void 0:d[e])&&void 0!==t?t:ju[e]}))])))),[]);return(0,v.jsx)(yh.Provider,{value:a,children:t})}function wh(){return Vu(yh)}const Ch=(0,r.createContext)(null);function Th(e){let{children:t}=e;const n=mh(),i=Hu("avatar-image-url"),r=Hu("avatar-orb-color-1"),o=Hu("avatar-orb-color-2"),a=et(""),s=tt((()=>i.value?{type:"image",url:i.value}:r.value&&o.value?{type:"orb",color_1:r.value,color_2:o.value}:n.value.avatar)),c=tt((()=>{switch(s.value.type){case"url":return s.value.custom_url;case"orb":return a.value;case"image":return s.value.url}})),l=(0,b.useMemo)((()=>({config:s,previewUrl:c,canvasUrl:a})),[]);return(0,v.jsx)(Ch.Provider,{value:l,children:t})}function Sh(){return Vu(Ch)}const xh=(0,r.createContext)(null);function Eh(e){let{children:t}=e,n=Su(e,Pd);const[i,r]=(0,b.useState)(null);return(0,v.jsx)("div",Eu(Eu({ref:r},n),{},{children:i&&(0,v.jsx)(xh.Provider,{value:i,children:t})}))}function _h(){return Vu(xh)}function Ph(e){return e&&"object"==typeof e&&"peek"in e}function Rh(e){return Ph(e)?e.value:e}function Ih(e,t){if("function"==typeof e)return e(t);null!=e&&(e.current=t)}function Oh(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];return e=>{let n=!1;const i=t.map((t=>{const i=Ih(t,e);return!n&&"function"==typeof i&&(n=!0),i}));if(n)return()=>{for(let e=0;e<i.length;e++){const n=i[e];"function"==typeof n?n():Ih(t[e],null)}}}}function Dh(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];return b.useCallback(Oh(...t),t)}function Mh(e){const t=Nh(e),n=O(((e,n)=>{const{children:i}=e,r=Su(e,Rd),o=M.toArray(i),a=o.find(jh);if(a){const e=a.props.children,i=o.map((t=>t===a?M.count(e)>1?M.only(null):he(e)?e.props.children:null:t));return(0,v.jsx)(t,Eu(Eu({},r),{},{ref:n,children:he(e)?fe(e,void 0,i):null}))}return(0,v.jsx)(t,Eu(Eu({},r),{},{ref:n,children:i}))}));return n.displayName="".concat(e,".Slot"),n}var Ah=Mh("Slot");function Nh(e){const t=O(((e,t)=>{const{children:n}=e,i=Su(e,Id);if(he(n)){const e=function(e){var t,n;let i=null==(t=Object.getOwnPropertyDescriptor(e.props,"ref"))?void 0:t.get,r=i&&"isReactWarning"in i&&i.isReactWarning;return r?e.ref:(i=null==(n=Object.getOwnPropertyDescriptor(e,"ref"))?void 0:n.get,r=i&&"isReactWarning"in i&&i.isReactWarning,r?e.props.ref:e.props.ref||e.ref)}(n),o=function(e,t){const n=Eu({},t);for(const i in t){const r=e[i],o=t[i];/^on[A-Z]/.test(i)?r&&o?n[i]=function(){const e=o(...arguments);return r(...arguments),e}:r&&(n[i]=r):"style"===i?n[i]=Eu(Eu({},r),o):"className"===i&&(n[i]=[r,o].filter(Boolean).join(" "))}return Eu(Eu({},e),n)}(i,n.props);return n.type!==r.Fragment&&(o.ref=t?Oh(t,e):e),fe(n,o)}return M.count(n)>1?M.only(null):null}));return t.displayName="".concat(e,".SlotClone"),t}var Lh=Symbol("radix.slottable");function jh(e){return he(e)&&"function"==typeof e.type&&"__radixId"in e.type&&e.type.__radixId===Lh}const Uh=window.matchMedia("(prefers-reduced-motion: reduce)");function Fh(){const e=et(Uh.matches);return(0,b.useEffect)((()=>{const t=t=>{e.value=t.matches};return Uh.addEventListener("change",t),()=>Uh.removeEventListener("change",t)}),[]),e}function Bh(e){var t;let{onStart:n,onEnd:i}=e;const r=(0,b.useRef)();null!==(t=r.current)&&void 0!==t||(r.current=new Set);const o=(0,b.useRef)(n);o.current=n;const a=(0,b.useRef)(i);a.current=i;const s=et(!1),c=(0,b.useCallback)((e=>{var t,n;e.target===e.currentTarget&&(null==(t=r.current)||t.add(e.propertyName),s.peek()||(s.value=!0,null==(n=o.current)||n.call(o)))}),[]),l=(0,b.useCallback)((e=>{var t,n,i;e.target===e.currentTarget&&(null==(t=r.current)||t.delete(e.propertyName),null!=(n=r.current)&&n.size||(s.value=!1,null==(i=a.current)||i.call(a)))}),[]);return{transitioning:s,handlers:{onTransitionStart:c,onTransitionEnd:l}}}function Vh(e){const t=Fh().value?qh:Wh;return(0,v.jsx)(t,Eu({},e))}function qh(e){let{active:t}=e,n=Su(e,Od);return Rh(t)?(0,v.jsx)(Ah,Eu({"data-shown":!0},n)):null}function Wh(e){let{active:t,initial:n=t}=e,i=Su(e,Dd);const r=function(e){const t=Ph(e),n=et(t?e.peek():e);return t?e:(n.value=e,n)}(t),o=et(function(e){return Ph(e)?e.peek():e}(n));ct((()=>{r.value&&(o.value=r.value)}));const{handlers:a}=Bh({onEnd:()=>{o.value=r.value}});return r.value||o.value?(0,v.jsx)(Ah,Eu(Eu({"data-shown":r.value&&o.value},a),i)):null}const Hh=new Float32Array([-1,1,-1,-1,1,1,1,-1]),zh=class e{constructor(t){Ru(this,"gl"),Ru(this,"program"),Ru(this,"startTime"),Ru(this,"targetSpeed",0),Ru(this,"speed",.5),Ru(this,"rafId",null),Ru(this,"resizeObserver"),Ru(this,"colorA",[0,0,0]),Ru(this,"colorB",[0,0,0]),Ru(this,"offsets",new Float32Array(7).map((()=>Math.random()*Math.PI*2))),Ru(this,"copyNoiseImage",(()=>{this.gl&&(this.gl.texImage2D(this.gl.TEXTURE_2D,0,this.gl.RGBA,this.gl.RGBA,this.gl.UNSIGNED_BYTE,e.noiseImage),this.gl.generateMipmap(this.gl.TEXTURE_2D))})),Ru(this,"toDataURL",(()=>this.gl.canvas.toDataURL("image/png"))),Ru(this,"render",(()=>{if(!this.gl)return void(this.rafId=null);const e=(performance.now()-this.startTime)/1e3;this.gl.uniform1f(this.gl.getUniformLocation(this.program,"uTime"),e),this.gl.drawArrays(this.gl.TRIANGLE_STRIP,0,4),this.rafId=requestAnimationFrame(this.render)}));const n=t.getContext("webgl2",{depth:!1,stencil:!1});this.gl=n,this.program=this.setupProgram("#version 300 es\nprecision highp float;\n\nuniform float uTime;\nuniform float uOffsets[7];\nuniform vec3 uColor1;\nuniform vec3 uColor2;\nuniform sampler2D uPerlinTexture;\n\nin vec2 vUv;\n\nout vec4 outColor;\n\nconst float PI = 3.14159265358979323846;\n\n// Draw a single oval with soft edges and calculate its gradient color\nbool drawOval(vec2 polarUv, vec2 polarCenter, float a, float b, bool reverseGradient, float softness, out vec4 color) {\n    vec2 p = polarUv - polarCenter;\n    float oval = (p.x * p.x) / (a * a) + (p.y * p.y) / (b * b);\n    \n    float edge = smoothstep(1.0, 1.0 - softness, oval);\n    \n    if (edge > 0.0) {\n        float gradient = reverseGradient ? (1.0 - (p.x / a + 1.0) / 2.0) : ((p.x / a + 1.0) / 2.0);\n        color = vec4(vec3(gradient), 0.8 * edge);\n        return true;\n    }\n    return false;\n}\n\n// Map grayscale value to a 4-color ramp (color1, color2, color3, color4)\nvec3 colorRamp(float grayscale, vec3 color1, vec3 color2, vec3 color3, vec3 color4) {\n    if (grayscale < 0.33) {\n        return mix(color1, color2, grayscale * 3.0);\n    } else if (grayscale < 0.66) {\n        return mix(color2, color3, (grayscale - 0.33) * 3.0);\n    } else {\n        return mix(color3, color4, (grayscale - 0.66) * 3.0);\n    }\n}\n\nvec2 hash2(vec2 p) {\n    return fract(sin(vec2(dot(p, vec2(127.1, 311.7)), dot(p, vec2(269.5, 183.3)))) * 43758.5453);\n}\n\n// 2D noise for the ring\nfloat noise2D(vec2 p) {\n    vec2 i = floor(p);\n    vec2 f = fract(p);\n    \n    vec2 u = f * f * (3.0 - 2.0 * f);\n    float n = mix(\n        mix(dot(hash2(i + vec2(0.0, 0.0)), f - vec2(0.0, 0.0)),\n            dot(hash2(i + vec2(1.0, 0.0)), f - vec2(1.0, 0.0)), u.x),\n        mix(dot(hash2(i + vec2(0.0, 1.0)), f - vec2(0.0, 1.0)),\n            dot(hash2(i + vec2(1.0, 1.0)), f - vec2(1.0, 1.0)), u.x),\n        u.y\n    );\n\n    return 0.5 + 0.5 * n;\n}\n\nfloat sharpRing(vec2 uv, float theta, float time) {\n    float ringStart = 1.0;\n    float ringWidth = 0.5;\n    float noiseScale = 5.0;\n    \n    vec2 noiseCoord = vec2(theta / (2.0 * PI), time * 0.1);\n    noiseCoord *= noiseScale;\n    \n    float noise = noise2D(noiseCoord);\n    noise = (noise - 0.5) * 4.0;\n    \n    return ringStart + noise * ringWidth * 1.5;\n}\n\nfloat smoothRing(vec2 uv, float time) {\n    float angle = atan(uv.y, uv.x);\n    if (angle < 0.0) angle += 2.0 * PI;\n    \n    vec2 noiseCoord = vec2(angle / (2.0 * PI), time * 0.1);\n    noiseCoord *= 6.0;\n    \n    float noise = noise2D(noiseCoord);\n    noise = (noise - 0.5) * 8.0;\n    \n    float ringStart = 0.9;\n    float ringWidth = 0.3;\n    \n    return ringStart + noise * ringWidth;\n}\n\nvoid main() {\n    // Normalize vUv to be centered around (0.0, 0.0)\n    vec2 uv = vUv * 2.0 - 1.0;\n\n    // Convert uv to polar coordinates\n    float radius = length(uv);\n    float theta = atan(uv.y, uv.x);\n    if (theta < 0.0) theta += 2.0 * PI; // Normalize theta to [0, 2*PI]\n\n    // Initialize the base color to white\n    vec4 color = vec4(1.0, 1.0, 1.0, 1.0);\n\n    // Original parameters for the ovals in polar coordinates\n    float originalCenters[7] = float[7](0.0, 0.5 * PI, 1.0 * PI, 1.5 * PI, 2.0 * PI, 2.5 * PI, 3.0 * PI);\n\n    // Parameters for the animated centers in polar coordinates\n    float centers[7];\n    for (int i = 0; i < 7; i++) {\n        centers[i] = originalCenters[i] + 0.5 * sin(uTime / 20.0 + uOffsets[i]);\n    }\n\n    float a, b;\n    vec4 ovalColor;\n\n    // Check if the pixel is inside any of the ovals\n    for (int i = 0; i < 7; i++) {\n        float noise = texture(uPerlinTexture, vec2(mod(centers[i] + uTime * 0.05, 1.0), 0.5)).r;\n        a = noise * 1.5; // Increased variance: goes from 0.0 to 1.0\n        b = noise * 4.5; // Tall semi-minor axis\n        bool reverseGradient = (i % 2 == 1); // Reverse gradient for every second oval\n\n        // Calculate the distance in polar coordinates\n        float distTheta = abs(theta - centers[i]);\n        if (distTheta > PI) distTheta = 2.0 * PI - distTheta; // Shortest distance on circle\n        float distRadius = radius;\n\n        float softness = 0.4; // Controls edge softness (e.g. how much blur is applied to the ovals)\n\n        // Check if the pixel is inside the oval in polar coordinates\n        if (drawOval(vec2(distTheta, distRadius), vec2(0.0, 0.0), a, b, reverseGradient, softness, ovalColor)) {\n            // Blend the oval color with the existing color\n            color.rgb = mix(color.rgb, ovalColor.rgb, ovalColor.a);\n            color.a = max(color.a, ovalColor.a); // Max alpha\n        }\n    }\n    \n    // Calculate both noisy rings\n    float ringRadius1 = sharpRing(uv, theta, uTime);\n    float ringRadius2 = smoothRing(uv, uTime);\n    \n    // Blend both rings\n    float ringAlpha1 = (radius >= ringRadius1) ? 0.3 : 0.0;\n    float ringAlpha2 = smoothstep(ringRadius2 - 0.05, ringRadius2 + 0.05, radius) * 0.25;\n    \n    float totalRingAlpha = max(ringAlpha1, ringAlpha2);\n    \n    // Apply screen blend mode for combined rings\n    vec3 ringColor = vec3(1.0); // White ring color\n    color.rgb = 1.0 - (1.0 - color.rgb) * (1.0 - ringColor * totalRingAlpha);\n\n    // Define colours to ramp against greyscale (could increase the amount of colours in the ramp)\n    vec3 color1 = vec3(0.0, 0.0, 0.0); // Black\n    vec3 color2 = uColor1; // Darker Color\n    vec3 color3 = uColor2; // Lighter Color\n    vec3 color4 = vec3(1.0, 1.0, 1.0); // White\n\n    // Convert grayscale color to the color ramp\n    float luminance = color.r; \n    color.rgb = colorRamp(luminance, color1, color2, color3, color4); // Apply the color ramp\n\n    outColor = color;\n}\n","#version 300 es\nprecision highp float;\n\nin vec2 position;\n\nout vec2 vUv;\n\nvoid main() {\n  vUv = position * 0.5 + 0.5;\n  gl_Position = vec4(position, 0, 1);\n}\n");const i=n.createTexture();n.bindTexture(n.TEXTURE_2D,i),n.texImage2D(n.TEXTURE_2D,0,n.RGBA,1,1,0,n.RGBA,n.UNSIGNED_BYTE,new Uint8Array([128,128,128,255])),e.noiseImage||(e.noiseImage=new Image,e.noiseImage.crossOrigin="anonymous",e.noiseImage.src="https://storage.googleapis.com/eleven-public-cdn/images/perlin-noise.png"),e.noiseImage.complete?this.copyNoiseImage():e.noiseImage.addEventListener("load",this.copyNoiseImage);const r=n.createBuffer();n.bindBuffer(n.ARRAY_BUFFER,r),n.bufferData(n.ARRAY_BUFFER,Hh,n.STATIC_DRAW),n.vertexAttribPointer(0,2,n.FLOAT,!1,0,0),n.enableVertexAttribArray(0),this.updateColors("#2792DC","#9CE6E6"),this.resizeObserver=new ResizeObserver((e=>{const n=e[0],i=n.devicePixelContentBoxSize?n.devicePixelContentBoxSize[0]:n.contentBoxSize[0];t.width=Math.min(512,i.inlineSize),t.height=Math.min(512,i.blockSize),this.updateViewport()}));const o=t.parentElement;if(o)try{this.resizeObserver.observe(o,{box:"device-pixel-content-box"})}catch(e){this.resizeObserver.observe(o)}this.startTime=performance.now(),this.rafId=requestAnimationFrame(this.render)}dispose(){var e;null!==this.rafId&&cancelAnimationFrame(this.rafId),null==(e=this.resizeObserver)||e.disconnect(),this.gl=null,this.program=null}updateViewport(){this.gl.viewport(0,0,this.gl.canvas.width,this.gl.canvas.height)}updateColors(e,t){var n,i;this.gl&&(this.colorA=null!==(n=this.updateColor("uColor1",e))&&void 0!==n?n:this.colorA,this.colorB=null!==(i=this.updateColor("uColor2",t))&&void 0!==i?i:this.colorB)}updateVolume(e,t){this.targetSpeed=.2+1.8*(1-Math.pow(t-1,2)),this.targetSpeed>this.speed&&(this.speed=this.targetSpeed),this.gl.uniform1f(this.gl.getUniformLocation(this.program,"uInputVolume"),e),this.gl.uniform1f(this.gl.getUniformLocation(this.program,"uOutputVolume"),t)}updateColor(e,t){try{const n=parseInt(t.slice(1,3),16)/255,i=parseInt(t.slice(3,5),16)/255,r=parseInt(t.slice(5,7),16)/255,o=[Math.pow(n,2.2),Math.pow(i,2.2),Math.pow(r,2.2)];return this.gl.uniform3fv(this.gl.getUniformLocation(this.program,e),o),o}catch(e){console.error("[ConversationalAI] Failed to parse ".concat(t," as color:"),e)}}setupProgram(e,t){const n=this.getShader(this.gl.FRAGMENT_SHADER,e),i=this.getShader(this.gl.VERTEX_SHADER,t);if(!n||!i)throw new Error("Failed to compile shaders");if(this.program=this.gl.createProgram(),this.gl.attachShader(this.program,n),this.gl.attachShader(this.program,i),this.gl.linkProgram(this.program),!this.gl.getProgramParameter(this.program,this.gl.LINK_STATUS))throw new Error("Failed to link program");return this.gl.useProgram(this.program),this.gl.uniform1i(this.gl.getUniformLocation(this.program,"uPerlinTexture"),0),this.gl.uniform1fv(this.gl.getUniformLocation(this.program,"uOffsets"),this.offsets),this.gl.uniform3fv(this.gl.getUniformLocation(this.program,"uColor1"),this.colorA),this.gl.uniform3fv(this.gl.getUniformLocation(this.program,"uColor2"),this.colorB),this.program}getShader(e,t){const n=this.gl.createShader(e);return this.gl.shaderSource(n,t),this.gl.compileShader(n),this.gl.getShaderParameter(n,this.gl.COMPILE_STATUS)?n:(this.gl.deleteShader(n),null)}};Ru(zh,"noiseImage");let Gh=zh;const Kh={sm:"w-9 h-9",lg:"w-48 h-48"};function Jh(e){let{size:t="sm",className:n}=e;const{getInputVolume:i,getOutputVolume:r,isSpeaking:o,isDisconnected:a}=uh(),{config:s}=Sh(),c=(0,b.useRef)(null),l=(0,b.useRef)(null);ct((()=>{if(a.value)return c.current.style.transform="",void(l.current.style.transform="");let e;return function t(){const n=i(),a=r(),s=o.peek()?1:1-.4*n,d=o.peek()?1+.4*a:1;c.current.style.transform="scale(".concat(d,")"),l.current.style.transform="scale(".concat(s,")"),e=requestAnimationFrame(t)}(),()=>{cancelAnimationFrame(e)}}));const d=tt((()=>({backgroundImage:"image"===s.value.type?"url(".concat(s.value.url,")"):"url"===s.value.type?"url(".concat(s.value.custom_url,")"):void 0})));return(0,v.jsxs)("div",{className:_d("relative shrink-0",Kh[t],n),children:[(0,v.jsx)("div",{ref:c,className:"absolute inset-0 rounded-full bg-base-border"}),(0,v.jsx)("div",{ref:l,style:d,className:"absolute inset-0 rounded-full overflow-hidden bg-base bg-cover",children:"orb"===s.value.type&&(0,v.jsx)(Yh,{color1:s.value.color_1,color2:s.value.color_2})})]})}function Yh(e){let{color1:t,color2:n}=e;const{canvasUrl:i}=Sh(),[r,o]=(0,b.useState)(null);(0,b.useEffect)((()=>{r&&(r.updateColors(t,n),r.render(),i.value=r.toDataURL())}),[r,t,n]);const a=(0,b.useCallback)((e=>{if(e){const t=new Gh(e);return o(t),()=>t.dispose()}o(null)}),[o]);return(0,v.jsx)("canvas",{className:"w-full h-full",ref:a})}const Xh={phone:function(e){return(0,v.jsx)("svg",Eu(Eu({height:"1em",width:"1em",viewBox:"0 0 18 18",fill:"currentColor",xmlns:"http://www.w3.org/2000/svg"},e),{},{children:(0,v.jsx)("path",{d:"M3.7489 2.25C2.93286 2.25 2.21942 2.92142 2.27338 3.7963C2.6686 10.2041 7.79483 15.3303 14.2026 15.7255C15.0775 15.7795 15.7489 15.066 15.7489 14.25V11.958C15.7489 11.2956 15.3144 10.7116 14.6799 10.5213L12.6435 9.91035C12.1149 9.75179 11.542 9.89623 11.1518 10.2864L10.5901 10.8482C9.15291 10.0389 7.95998 8.84599 7.15074 7.40881L7.71246 6.84709C8.10266 6.45689 8.24711 5.88396 8.08854 5.35541L7.47761 3.31898C7.28727 2.6845 6.70329 2.25 6.04087 2.25H3.7489Z"})}))},"phone-off":function(e){return(0,v.jsxs)("svg",Eu(Eu({height:"1em",width:"1em",viewBox:"0 0 19 18",fill:"currentColor",xmlns:"http://www.w3.org/2000/svg"},e),{},{children:[(0,v.jsx)("path",{d:"M16.0303 3.53033C16.3232 3.23744 16.3232 2.76256 16.0303 2.46967C15.7374 2.17678 15.2626 2.17678 14.9697 2.46967L8.6271 8.81224C8.25925 8.3778 7.93185 7.90804 7.65074 7.40881L8.21246 6.84709C8.60266 6.45689 8.74711 5.88396 8.58854 5.35541L7.97761 3.31898C7.78727 2.6845 7.20329 2.25 6.54087 2.25H4.2489C3.43286 2.25 2.71942 2.92142 2.77338 3.7963C2.95462 6.73468 4.13069 9.40357 5.96899 11.4703L2.96967 14.4697C2.67678 14.7626 2.67678 15.2374 2.96967 15.5303C3.26256 15.8232 3.73744 15.8232 4.03033 15.5303L16.0303 3.53033Z"}),(0,v.jsx)("path",{d:"M14.7026 15.7255C12.2994 15.5773 10.0765 14.7636 8.21584 13.4665L10.9278 10.7545C10.9815 10.7863 11.0356 10.8175 11.0901 10.8482L11.6518 10.2864C12.042 9.89623 12.6149 9.75179 13.1435 9.91035L15.1799 10.5213C15.8144 10.7116 16.2489 11.2956 16.2489 11.958V14.25C16.2489 15.066 15.5775 15.7795 14.7026 15.7255Z"})]}))},chat:function(e){return(0,v.jsx)("svg",Eu(Eu({height:"1em",width:"1em",viewBox:"0 0 19 18",fill:"currentColor",xmlns:"http://www.w3.org/2000/svg"},e),{},{children:(0,v.jsx)("path",{"fill-rule":"evenodd","clip-rule":"evenodd",d:"M1.5 6.75C1.5 4.26472 3.51472 2.25 6 2.25H12C14.4853 2.25 16.5 4.26472 16.5 6.75V11.25C16.5 13.7353 14.4853 15.75 12 15.75H2.25C1.83579 15.75 1.5 15.4142 1.5 15V6.75ZM6 9.9375C5.48223 9.9375 5.0625 9.51777 5.0625 9C5.0625 8.48223 5.48223 8.0625 6 8.0625C6.51777 8.0625 6.9375 8.48223 6.9375 9C6.9375 9.51777 6.51777 9.9375 6 9.9375ZM9 9.9375C8.48223 9.9375 8.0625 9.51777 8.0625 9C8.0625 8.48223 8.48223 8.0625 9 8.0625C9.51777 8.0625 9.9375 8.48223 9.9375 9C9.9375 9.51777 9.51777 9.9375 9 9.9375ZM11.0625 9C11.0625 9.51777 11.4822 9.9375 12 9.9375C12.5178 9.9375 12.9375 9.51777 12.9375 9C12.9375 8.48223 12.5178 8.0625 12 8.0625C11.4822 8.0625 11.0625 8.48223 11.0625 9Z"})}))},mic:function(e){return(0,v.jsxs)("svg",Eu(Eu({height:"1em",width:"1em",viewBox:"0 0 19 18",fill:"currentColor",xmlns:"http://www.w3.org/2000/svg"},e),{},{children:[(0,v.jsx)("path",{d:"M9.50008 1.5C7.42901 1.5 5.75008 3.17893 5.75008 5.25V8.25C5.75008 10.3211 7.42901 12 9.50008 12C11.5712 12 13.2501 10.3211 13.2501 8.25V5.25C13.2501 3.17893 11.5712 1.5 9.50008 1.5Z"}),(0,v.jsx)("path",{d:"M4.88997 10.8417C4.66448 10.4943 4.20002 10.3954 3.85256 10.6209C3.50509 10.8463 3.40621 11.3108 3.63169 11.6583C4.47442 12.9569 6.08493 14.6838 8.75008 14.9616V15.75C8.75008 16.1642 9.08587 16.5 9.50008 16.5C9.9143 16.5 10.2501 16.1642 10.2501 15.75V14.9616C12.9152 14.6838 14.5257 12.9569 15.3685 11.6583C15.594 11.3108 15.4951 10.8463 15.1476 10.6209C14.8001 10.3954 14.3357 10.4943 14.1102 10.8417C13.3305 12.0432 11.9002 13.5 9.50008 13.5C7.1 13.5 5.66968 12.0432 4.88997 10.8417Z"})]}))},"mic-off":function(e){return(0,v.jsxs)("svg",Eu(Eu({height:"1em",width:"1em",viewBox:"0 0 19 18",fill:"currentColor",xmlns:"http://www.w3.org/2000/svg"},e),{},{children:[(0,v.jsx)("path",{d:"M13.25 8.25C13.25 8.64791 13.188 9.03135 13.0732 9.39119L6.57947 2.8975C7.26687 2.04521 8.31974 1.5 9.49995 1.5C11.571 1.5 13.25 3.17893 13.25 5.25V8.25Z"}),(0,v.jsx)("path",{d:"M2.21967 1.71967C2.51256 1.42678 2.98744 1.42678 3.28033 1.71967L16.7803 15.2197C17.0732 15.5126 17.0732 15.9874 16.7803 16.2803C16.4874 16.5732 16.0126 16.5732 15.7197 16.2803L13.2828 13.8435C12.4719 14.4022 11.4678 14.8338 10.25 14.9614V15.75C10.25 16.1642 9.91422 16.5 9.50001 16.5C9.08579 16.5 8.75001 16.1642 8.75001 15.75V14.9616C6.08485 14.6838 4.47434 12.9569 3.63162 11.6583C3.40614 11.3108 3.50502 10.8463 3.85248 10.6209C4.19995 10.3954 4.66441 10.4943 4.88989 10.8417C5.6696 12.0432 7.09993 13.5 9.50001 13.5C10.5978 13.5 11.4845 13.1981 12.1992 12.7598L11.0875 11.6482C10.605 11.8739 10.0667 12 9.50001 12C7.42894 12 5.75001 10.3211 5.75001 8.25V6.31067L2.21967 2.78033C1.92678 2.48744 1.92678 2.01256 2.21967 1.71967Z"})]}))},check:function(e){return(0,v.jsx)("svg",Eu(Eu({xmlns:"http://www.w3.org/2000/svg",height:"1em",width:"1em",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2","stroke-linecap":"round","stroke-linejoin":"round"},e),{},{children:(0,v.jsx)("path",{d:"M20 6 9 17l-5-5"})}))},"chevron-down":function(e){return(0,v.jsx)("svg",Eu(Eu({xmlns:"http://www.w3.org/2000/svg",height:"1em",width:"1em",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2","stroke-linecap":"round","stroke-linejoin":"round"},e),{},{children:(0,v.jsx)("path",{d:"m6 9 6 6 6-6"})}))},"chevron-up":function(e){return(0,v.jsx)("svg",Eu(Eu({xmlns:"http://www.w3.org/2000/svg",height:"1em",width:"1em",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2","stroke-linecap":"round","stroke-linejoin":"round"},e),{},{children:(0,v.jsx)("path",{d:"m18 15-6-6-6 6"})}))},send:function(e){return(0,v.jsx)("svg",Eu(Eu({xmlns:"http://www.w3.org/2000/svg",height:"1em",width:"1em",viewBox:"0 0 20 20",fill:"currentColor"},e),{},{children:(0,v.jsx)("path",{d:"M2.59413 5.1485C2.04 3.39377 3.86657 1.83482 5.51245 2.65776L16.47 8.13653C18.0055 8.90429 18.0055 11.0955 16.47 11.8633L5.51245 17.3421C3.86656 18.165 2.04 16.6061 2.59413 14.8513L3.86297 10.8333H7.50006C7.9603 10.8333 8.33339 10.4602 8.33339 10C8.33339 9.53976 7.9603 9.16667 7.50006 9.16667H3.86302L2.59413 5.1485Z",fill:"black"})}))}},$h={sm:"text-xs",md:"text-lg"};function Qh(e){let{name:t,size:n="md",className:i}=e;const r=Xh[t];return(0,v.jsx)("slot",{name:"icon-".concat(t),className:_d("flex",$h[n],i),"aria-hidden":!0,children:(0,v.jsx)(r,{})})}function Zh(e){const t=Fh().value?ep:tp;return(0,v.jsx)(t,Eu({},e))}function ep(e){let{visible:t,className:n,grow:i,dep:r}=e,o=Su(e,Md);return t?(0,v.jsx)("div",Eu({className:_d(i&&"grow",n)},o)):null}function tp(e){let{visible:t,children:n,className:i,grow:r,dep:o}=e,a=Su(e,Ad);const[s,c]=(0,b.useState)(t),[l,d]=(0,b.useState)(null),[u,h]=(0,b.useState)(null),p=(0,b.useRef)(n);t&&(p.current=n);const m=(0,b.useCallback)((e=>{d(e),e&&!t&&(e.style.width="0px",e.style.height="0px")}),[]);(0,b.useEffect)((()=>{u&&(u.style.transition="none",u.style.opacity="0",u.offsetWidth,u.style.transition="",u.style.opacity="")}),[o]),(0,b.useMemo)((()=>{l&&(l.style.width="".concat(l.offsetWidth,"px"),l.style.height="".concat(l.offsetHeight,"px"))}),[l,t,o]),(0,b.useEffect)((()=>{if(!l||!u)return;t&&c(!0);const e=t?u.offsetWidth:0,n=t?u.offsetHeight:0;l.style.width=t&&l.offsetWidth===e?"":"".concat(e,"px"),l.style.height=t&&l.offsetHeight===n?"":"".concat(n,"px")}),[l,u,t,o]);const{transitioning:f,handlers:g}=Bh({onEnd:()=>{t?(l.style.width="",l.style.height=""):c(!1)}});return(0,v.jsx)("div",Eu(Eu({ref:m,className:_d("relative inline-flex shrink-0 justify-center items-center transition-[opacity,width,height,transform,flex-grow] duration-200 min-w-0",!t&&"opacity-0 scale-75",t&&r&&"grow",t&&s&&!f.value&&"z-1")},g),{},{children:(0,v.jsx)("div",Eu(Eu({ref:h,className:_d("shrink-0 min-h-min min-w-min transition-opacity duration-200",r&&"grow",i)},a),{},{children:(t||s)&&p.current}))}))}const np={primary:"text-accent-primary border border-accent bg-accent hover:border-accent-hover hover:bg-accent-hover active:border-accent-active active:bg-accent-active",secondary:"text-base-primary border border-base-border bg-base hover:bg-base-hover active:bg-base-active"},ip=O((function(e,t){let{variant:n="secondary",children:i,icon:r,className:o,iconClassName:a,truncate:s=!0}=e,c=Su(e,Nd);const l=!!r&&!i;return(0,v.jsxs)("button",Eu(Eu({ref:t,className:_d("h-9 flex px-2.5 text-sm items-center transition-colors justify-center rounded-button duration-200 focus-ring overflow-hidden select-none",np[n],l&&"min-w-9",o),type:"button"},c),{},{children:[r&&(0,v.jsx)(Qh,{className:_d("transition-[margin] duration-200",l&&"-mx-0.5",a),name:r}),(0,v.jsx)(Zh,{visible:!!i,dep:i,children:(0,v.jsx)("span",{className:"block whitespace-nowrap max-w-64 truncate px-1.5",children:i})})]}))}));function rp(e){let{className:t}=e,n=Su(e,Ld);const{status:i,isSpeaking:r}=uh(),o=gh(),a=wh(),s=tt((()=>"connected"!==i.value?a.connecting_status.value:o.value?a.chatting_status.value:r.value?a.speaking_status.value:a.listening_status.value)),[c,l]=(0,b.useState)(s.peek());return ct((()=>{const e=s.value;if("connected"!==i.value||!r.value){const t=setTimeout((()=>{l(e)}),500);return()=>clearTimeout(t)}l(e)})),(0,v.jsx)("div",Eu(Eu({className:_d("py-1.5 px-3 bg-base-active overflow-hidden rounded-bubble text-sm",t)},n),{},{children:(0,v.jsx)(Vh,{initial:!1,active:!0,children:(0,v.jsx)("div",{className:"animate-text whitespace-nowrap transition-[opacity,transform] ease-out duration-200 data-hidden:opacity-0 transform data-hidden:translate-y-2",children:c})},c)}))}function op(e,t){let[n,i]=t;return Math.min(i,Math.max(n,e))}function ap(e,t){let{checkForDefaultPrevented:n=!0}=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};return function(i){if(null==e||e(i),!1===n||!i.defaultPrevented)return null==t?void 0:t(i)}}function sp(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[],n=[];const i=()=>{const t=n.map((e=>r.createContext(e)));return function(n){const i=(null==n?void 0:n[e])||t;return b.useMemo((()=>({["__scope".concat(e)]:Eu(Eu({},n),{},{[e]:i})})),[n,i])}};return i.scopeName=e,[function(t,i){const o=r.createContext(i),a=n.length;n=[...n,i];const s=t=>{var n;const{scope:i,children:r}=t,s=Su(t,jd),c=(null==(n=null==i?void 0:i[e])?void 0:n[a])||o,l=b.useMemo((()=>s),Object.values(s));return(0,v.jsx)(c.Provider,{value:l,children:r})};return s.displayName=t+"Provider",[s,function(n,r){var s;const c=(null==(s=null==r?void 0:r[e])?void 0:s[a])||o,l=b.useContext(c);if(l)return l;if(void 0!==i)return i;throw new Error("`".concat(n,"` must be used within `").concat(t,"`"))}]},cp(i,...t)]}function cp(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];const i=t[0];if(1===t.length)return i;const r=()=>{const e=t.map((e=>({useScope:e(),scopeName:e.scopeName})));return function(t){const n=e.reduce(((e,n)=>{let{useScope:i,scopeName:r}=n;const o=i(t)["__scope".concat(r)];return Eu(Eu({},e),o)}),{});return b.useMemo((()=>({["__scope".concat(i.scopeName)]:n})),[n])}};return r.scopeName=i.scopeName,r}var lp=r.createContext(void 0),dp=["a","button","div","form","h2","h3","img","input","label","li","nav","ol","p","select","span","svg","ul"].reduce(((e,t)=>{const n=Mh("Primitive.".concat(t)),i=O(((e,i)=>{const{asChild:r}=e,o=Su(e,Fd),a=r?n:t;return typeof window<"u"&&(window[Symbol.for("radix-ui")]=!0),(0,v.jsx)(a,Eu(Eu({},o),{},{ref:i}))}));return i.displayName="Primitive.".concat(t),Eu(Eu({},e),{},{[t]:i})}),{});function up(e){const t=b.useRef(e);return b.useEffect((()=>{t.current=e})),b.useMemo((()=>function(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return null==(e=t.current)?void 0:e.call(t,...i)}),[])}var hp,pp="dismissableLayer.update",mp=r.createContext({layers:new Set,layersWithOutsidePointerEventsDisabled:new Set,branches:new Set}),fp=O(((e,t)=>{var n;const{disableOutsidePointerEvents:i=!1,onEscapeKeyDown:r,onPointerDownOutside:o,onFocusOutside:a,onInteractOutside:s,onDismiss:c}=e,l=Su(e,Bd),d=b.useContext(mp),[u,h]=b.useState(null),p=null!==(n=null==u?void 0:u.ownerDocument)&&void 0!==n?n:null==globalThis?void 0:globalThis.document,[,m]=b.useState({}),f=Dh(t,(e=>h(e))),g=Array.from(d.layers),[y]=[...d.layersWithOutsidePointerEventsDisabled].slice(-1),k=g.indexOf(y),w=u?g.indexOf(u):-1,C=d.layersWithOutsidePointerEventsDisabled.size>0,T=w>=k,S=function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null==globalThis?void 0:globalThis.document;const n=up(e),i=b.useRef(!1),r=b.useRef((()=>{}));return b.useEffect((()=>{const e=e=>{if(e.target&&!i.current){let i=function(){bp("dismissableLayer.pointerDownOutside",n,o,{discrete:!0})};const o={originalEvent:e};"touch"===e.pointerType?(t.removeEventListener("click",r.current),r.current=i,t.addEventListener("click",r.current,{once:!0})):i()}else t.removeEventListener("click",r.current);i.current=!1},o=window.setTimeout((()=>{t.addEventListener("pointerdown",e)}),0);return()=>{window.clearTimeout(o),t.removeEventListener("pointerdown",e),t.removeEventListener("click",r.current)}}),[t,n]),{onPointerDownCapture:()=>i.current=!0}}((e=>{const t=e.target,n=[...d.branches].some((e=>e.contains(t)));!T||n||(null==o||o(e),null==s||s(e),e.defaultPrevented||null==c||c())}),p),x=function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null==globalThis?void 0:globalThis.document;const n=up(e),i=b.useRef(!1);return b.useEffect((()=>{const e=e=>{e.target&&!i.current&&bp("dismissableLayer.focusOutside",n,{originalEvent:e},{discrete:!1})};return t.addEventListener("focusin",e),()=>t.removeEventListener("focusin",e)}),[t,n]),{onFocusCapture:()=>i.current=!0,onBlurCapture:()=>i.current=!1}}((e=>{const t=e.target;[...d.branches].some((e=>e.contains(t)))||(null==a||a(e),null==s||s(e),e.defaultPrevented||null==c||c())}),p);return function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null==globalThis?void 0:globalThis.document;const n=up(e);b.useEffect((()=>{const e=e=>{"Escape"===e.key&&n(e)};return t.addEventListener("keydown",e,{capture:!0}),()=>t.removeEventListener("keydown",e,{capture:!0})}),[n,t])}((e=>{w===d.layers.size-1&&(null==r||r(e),!e.defaultPrevented&&c&&(e.preventDefault(),c()))}),p),b.useEffect((()=>{if(u)return i&&(0===d.layersWithOutsidePointerEventsDisabled.size&&(hp=p.body.style.pointerEvents,p.body.style.pointerEvents="none"),d.layersWithOutsidePointerEventsDisabled.add(u)),d.layers.add(u),vp(),()=>{i&&1===d.layersWithOutsidePointerEventsDisabled.size&&(p.body.style.pointerEvents=hp)}}),[u,p,i,d]),b.useEffect((()=>()=>{u&&(d.layers.delete(u),d.layersWithOutsidePointerEventsDisabled.delete(u),vp())}),[u,d]),b.useEffect((()=>{const e=()=>m({});return document.addEventListener(pp,e),()=>document.removeEventListener(pp,e)}),[]),(0,v.jsx)(dp.div,Eu(Eu({},l),{},{ref:f,style:Eu({pointerEvents:C?T?"auto":"none":void 0},e.style),onFocusCapture:ap(e.onFocusCapture,x.onFocusCapture),onBlurCapture:ap(e.onBlurCapture,x.onBlurCapture),onPointerDownCapture:ap(e.onPointerDownCapture,S.onPointerDownCapture)}))}));fp.displayName="DismissableLayer";var gp=O(((e,t)=>{const n=b.useContext(mp),i=b.useRef(null),r=Dh(t,i);return b.useEffect((()=>{const e=i.current;if(e)return n.branches.add(e),()=>{n.branches.delete(e)}}),[n.branches]),(0,v.jsx)(dp.div,Eu(Eu({},e),{},{ref:r}))}));function vp(){const e=new CustomEvent(pp);document.dispatchEvent(e)}function bp(e,t,n,i){let{discrete:r}=i;const o=n.originalEvent.target,a=new CustomEvent(e,{bubbles:!1,cancelable:!0,detail:n});t&&o.addEventListener(e,t,{once:!0}),r?function(e,t){e&&ye((()=>e.dispatchEvent(t)))}(o,a):o.dispatchEvent(a)}gp.displayName="DismissableLayerBranch";var yp=0;function kp(){const e=document.createElement("span");return e.setAttribute("data-radix-focus-guard",""),e.tabIndex=0,e.style.outline="none",e.style.opacity="0",e.style.position="fixed",e.style.pointerEvents="none",e}var wp="focusScope.autoFocusOnMount",Cp="focusScope.autoFocusOnUnmount",Tp={bubbles:!1,cancelable:!0},Sp=O(((e,t)=>{const{loop:n=!1,trapped:i=!1,onMountAutoFocus:r,onUnmountAutoFocus:o}=e,a=Su(e,Vd),[s,c]=b.useState(null),l=up(r),d=up(o),u=b.useRef(null),h=Dh(t,(e=>c(e))),p=b.useRef({paused:!1,pause(){this.paused=!0},resume(){this.paused=!1}}).current;b.useEffect((()=>{if(i){let e=function(e){if(p.paused||!s)return;const t=e.target;s.contains(t)?u.current=t:Pp(u.current,{select:!0})},t=function(e){if(p.paused||!s)return;const t=e.relatedTarget;null!==t&&(s.contains(t)||Pp(u.current,{select:!0}))},n=function(e){if(document.activeElement===document.body)for(const t of e)t.removedNodes.length>0&&Pp(s)};document.addEventListener("focusin",e),document.addEventListener("focusout",t);const i=new MutationObserver(n);return s&&i.observe(s,{childList:!0,subtree:!0}),()=>{document.removeEventListener("focusin",e),document.removeEventListener("focusout",t),i.disconnect()}}}),[i,s,p.paused]),b.useEffect((()=>{if(s){Rp.add(p);const e=document.activeElement;if(!s.contains(e)){const t=new CustomEvent(wp,Tp);s.addEventListener(wp,l),s.dispatchEvent(t),t.defaultPrevented||(function(e){let{select:t=!1}=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};const n=document.activeElement;for(const i of e)if(Pp(i,{select:t}),document.activeElement!==n)return}(function(e){return e.filter((e=>"A"!==e.tagName))}(xp(s)),{select:!0}),document.activeElement===e&&Pp(s))}return()=>{s.removeEventListener(wp,l),setTimeout((()=>{const t=new CustomEvent(Cp,Tp);s.addEventListener(Cp,d),s.dispatchEvent(t),t.defaultPrevented||Pp(null!=e?e:document.body,{select:!0}),s.removeEventListener(Cp,d),Rp.remove(p)}),0)}}}),[s,l,d,p]);const m=b.useCallback((e=>{if(!n&&!i||p.paused)return;const t="Tab"===e.key&&!e.altKey&&!e.ctrlKey&&!e.metaKey,r=document.activeElement;if(t&&r){const t=e.currentTarget,[i,o]=function(e){const t=xp(e);return[Ep(t,e),Ep(t.reverse(),e)]}(t);i&&o?e.shiftKey||r!==o?e.shiftKey&&r===i&&(e.preventDefault(),n&&Pp(o,{select:!0})):(e.preventDefault(),n&&Pp(i,{select:!0})):r===t&&e.preventDefault()}}),[n,i,p.paused]);return(0,v.jsx)(dp.div,Eu(Eu({tabIndex:-1},a),{},{ref:h,onKeyDown:m}))}));function xp(e){const t=[],n=document.createTreeWalker(e,NodeFilter.SHOW_ELEMENT,{acceptNode:e=>{const t="INPUT"===e.tagName&&"hidden"===e.type;return e.disabled||e.hidden||t?NodeFilter.FILTER_SKIP:e.tabIndex>=0?NodeFilter.FILTER_ACCEPT:NodeFilter.FILTER_SKIP}});for(;n.nextNode();)t.push(n.currentNode);return t}function Ep(e,t){for(const n of e)if(!_p(n,{upTo:t}))return n}function _p(e,t){let{upTo:n}=t;if("hidden"===getComputedStyle(e).visibility)return!0;for(;e;){if(void 0!==n&&e===n)return!1;if("none"===getComputedStyle(e).display)return!0;e=e.parentElement}return!1}function Pp(e){let{select:t=!1}=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};if(e&&e.focus){const n=document.activeElement;e.focus({preventScroll:!0}),e!==n&&function(e){return e instanceof HTMLInputElement&&"select"in e}(e)&&t&&e.select()}}Sp.displayName="FocusScope";var Rp=function(){let e=[];return{add(t){const n=e[0];t!==n&&(null==n||n.pause()),e=Ip(e,t),e.unshift(t)},remove(t){var n;e=Ip(e,t),null==(n=e[0])||n.resume()}}}();function Ip(e,t){const n=[...e],i=n.indexOf(t);return-1!==i&&n.splice(i,1),n}var Op=null!=globalThis&&globalThis.document?b.useLayoutEffect:()=>{},Dp=i[" useId ".trim().toString()]||(()=>{}),Mp=0;function Ap(e){const[t,n]=b.useState(Dp());return Op((()=>{n((e=>null!=e?e:String(Mp++)))}),[e]),e||(t?"radix-".concat(t):"")}const Np=["top","right","bottom","left"],Lp=Math.min,jp=Math.max,Up=Math.round,Fp=Math.floor,Bp=e=>({x:e,y:e}),Vp={left:"right",right:"left",bottom:"top",top:"bottom"},qp={start:"end",end:"start"};function Wp(e,t,n){return jp(e,Lp(t,n))}function Hp(e,t){return"function"==typeof e?e(t):e}function zp(e){return e.split("-")[0]}function Gp(e){return e.split("-")[1]}function Kp(e){return"x"===e?"y":"x"}function Jp(e){return"y"===e?"height":"width"}const Yp=new Set(["top","bottom"]);function Xp(e){return Yp.has(zp(e))?"y":"x"}function $p(e){return Kp(Xp(e))}function Qp(e){return e.replace(/start|end/g,(e=>qp[e]))}const Zp=["left","right"],em=["right","left"],tm=["top","bottom"],nm=["bottom","top"];function im(e){return e.replace(/left|right|bottom|top/g,(e=>Vp[e]))}function rm(e){return"number"!=typeof e?function(e){return Eu({top:0,right:0,bottom:0,left:0},e)}(e):{top:e,right:e,bottom:e,left:e}}function om(e){const{x:t,y:n,width:i,height:r}=e;return{width:i,height:r,top:n,left:t,right:t+i,bottom:n+r,x:t,y:n}}function am(e,t,n){let{reference:i,floating:r}=e;const o=Xp(t),a=$p(t),s=Jp(a),c=zp(t),l="y"===o,d=i.x+i.width/2-r.width/2,u=i.y+i.height/2-r.height/2,h=i[s]/2-r[s]/2;let p;switch(c){case"top":p={x:d,y:i.y-r.height};break;case"bottom":p={x:d,y:i.y+i.height};break;case"right":p={x:i.x+i.width,y:u};break;case"left":p={x:i.x-r.width,y:u};break;default:p={x:i.x,y:i.y}}switch(Gp(t)){case"start":p[a]-=h*(n&&l?-1:1);break;case"end":p[a]+=h*(n&&l?-1:1)}return p}async function sm(e,t){var n;void 0===t&&(t={});const{x:i,y:r,platform:o,rects:a,elements:s,strategy:c}=e,{boundary:l="clippingAncestors",rootBoundary:d="viewport",elementContext:u="floating",altBoundary:h=!1,padding:p=0}=Hp(t,e),m=rm(p),f=s[h?"floating"===u?"reference":"floating":u],g=om(await o.getClippingRect({element:null==(n=await(null==o.isElement?void 0:o.isElement(f)))||n?f:f.contextElement||await(null==o.getDocumentElement?void 0:o.getDocumentElement(s.floating)),boundary:l,rootBoundary:d,strategy:c})),v="floating"===u?{x:i,y:r,width:a.floating.width,height:a.floating.height}:a.reference,b=await(null==o.getOffsetParent?void 0:o.getOffsetParent(s.floating)),y=await(null==o.isElement?void 0:o.isElement(b))&&await(null==o.getScale?void 0:o.getScale(b))||{x:1,y:1},k=om(o.convertOffsetParentRelativeRectToViewportRelativeRect?await o.convertOffsetParentRelativeRectToViewportRelativeRect({elements:s,rect:v,offsetParent:b,strategy:c}):v);return{top:(g.top-k.top+m.top)/y.y,bottom:(k.bottom-g.bottom+m.bottom)/y.y,left:(g.left-k.left+m.left)/y.x,right:(k.right-g.right+m.right)/y.x}}function cm(e,t){return{top:e.top-t.height,right:e.right-t.width,bottom:e.bottom-t.height,left:e.left-t.width}}function lm(e){return Np.some((t=>e[t]>=0))}const dm=new Set(["left","top"]);function um(){return typeof window<"u"}function hm(e){return fm(e)?(e.nodeName||"").toLowerCase():"#document"}function pm(e){var t;return(null==e||null==(t=e.ownerDocument)?void 0:t.defaultView)||window}function mm(e){var t;return null==(t=(fm(e)?e.ownerDocument:e.document)||window.document)?void 0:t.documentElement}function fm(e){return!!um()&&(e instanceof Node||e instanceof pm(e).Node)}function gm(e){return!!um()&&(e instanceof Element||e instanceof pm(e).Element)}function vm(e){return!!um()&&(e instanceof HTMLElement||e instanceof pm(e).HTMLElement)}function bm(e){return!(!um()||typeof ShadowRoot>"u")&&(e instanceof ShadowRoot||e instanceof pm(e).ShadowRoot)}const ym=new Set(["inline","contents"]);function km(e){const{overflow:t,overflowX:n,overflowY:i,display:r}=Dm(e);return/auto|scroll|overlay|hidden|clip/.test(t+i+n)&&!ym.has(r)}const wm=new Set(["table","td","th"]);function Cm(e){return wm.has(hm(e))}const Tm=[":popover-open",":modal"];function Sm(e){return Tm.some((t=>{try{return e.matches(t)}catch(e){return!1}}))}const xm=["transform","translate","scale","rotate","perspective"],Em=["transform","translate","scale","rotate","perspective","filter"],_m=["paint","layout","strict","content"];function Pm(e){const t=Rm(),n=gm(e)?Dm(e):e;return xm.some((e=>!!n[e]&&"none"!==n[e]))||!!n.containerType&&"normal"!==n.containerType||!t&&!!n.backdropFilter&&"none"!==n.backdropFilter||!t&&!!n.filter&&"none"!==n.filter||Em.some((e=>(n.willChange||"").includes(e)))||_m.some((e=>(n.contain||"").includes(e)))}function Rm(){return!(typeof CSS>"u"||!CSS.supports)&&CSS.supports("-webkit-backdrop-filter","none")}const Im=new Set(["html","body","#document"]);function Om(e){return Im.has(hm(e))}function Dm(e){return pm(e).getComputedStyle(e)}function Mm(e){return gm(e)?{scrollLeft:e.scrollLeft,scrollTop:e.scrollTop}:{scrollLeft:e.scrollX,scrollTop:e.scrollY}}function Am(e){if("html"===hm(e))return e;const t=e.assignedSlot||e.parentNode||bm(e)&&e.host||mm(e);return bm(t)?t.host:t}function Nm(e){const t=Am(e);return Om(t)?e.ownerDocument?e.ownerDocument.body:e.body:vm(t)&&km(t)?t:Nm(t)}function Lm(e,t,n){var i;void 0===t&&(t=[]),void 0===n&&(n=!0);const r=Nm(e),o=r===(null==(i=e.ownerDocument)?void 0:i.body),a=pm(r);if(o){const e=jm(a);return t.concat(a,a.visualViewport||[],km(r)?r:[],e&&n?Lm(e):[])}return t.concat(r,Lm(r,[],n))}function jm(e){return e.parent&&Object.getPrototypeOf(e.parent)?e.frameElement:null}function Um(e){const t=Dm(e);let n=parseFloat(t.width)||0,i=parseFloat(t.height)||0;const r=vm(e),o=r?e.offsetWidth:n,a=r?e.offsetHeight:i,s=Up(n)!==o||Up(i)!==a;return s&&(n=o,i=a),{width:n,height:i,$:s}}function Fm(e){return gm(e)?e:e.contextElement}function Bm(e){const t=Fm(e);if(!vm(t))return Bp(1);const n=t.getBoundingClientRect(),{width:i,height:r,$:o}=Um(t);let a=(o?Up(n.width):n.width)/i,s=(o?Up(n.height):n.height)/r;return(!a||!Number.isFinite(a))&&(a=1),(!s||!Number.isFinite(s))&&(s=1),{x:a,y:s}}const Vm=Bp(0);function qm(e){const t=pm(e);return Rm()&&t.visualViewport?{x:t.visualViewport.offsetLeft,y:t.visualViewport.offsetTop}:Vm}function Wm(e,t,n,i){void 0===t&&(t=!1),void 0===n&&(n=!1);const r=e.getBoundingClientRect(),o=Fm(e);let a=Bp(1);t&&(i?gm(i)&&(a=Bm(i)):a=Bm(e));const s=function(e,t,n){return void 0===t&&(t=!1),!(!n||t&&n!==pm(e))&&t}(o,n,i)?qm(o):Bp(0);let c=(r.left+s.x)/a.x,l=(r.top+s.y)/a.y,d=r.width/a.x,u=r.height/a.y;if(o){const e=pm(o),t=i&&gm(i)?pm(i):i;let n=e,r=jm(n);for(;r&&i&&t!==n;){const e=Bm(r),t=r.getBoundingClientRect(),i=Dm(r),o=t.left+(r.clientLeft+parseFloat(i.paddingLeft))*e.x,a=t.top+(r.clientTop+parseFloat(i.paddingTop))*e.y;c*=e.x,l*=e.y,d*=e.x,u*=e.y,c+=o,l+=a,n=pm(r),r=jm(n)}}return om({width:d,height:u,x:c,y:l})}function Hm(e,t){const n=Mm(e).scrollLeft;return t?t.left+n:Wm(mm(e)).left+n}function zm(e,t,n){void 0===n&&(n=!1);const i=e.getBoundingClientRect();return{x:i.left+t.scrollLeft-(n?0:Hm(e,i)),y:i.top+t.scrollTop}}const Gm=new Set(["absolute","fixed"]);function Km(e,t,n){let i;if("viewport"===t)i=function(e,t){const n=pm(e),i=mm(e),r=n.visualViewport;let o=i.clientWidth,a=i.clientHeight,s=0,c=0;if(r){o=r.width,a=r.height;const e=Rm();(!e||e&&"fixed"===t)&&(s=r.offsetLeft,c=r.offsetTop)}return{width:o,height:a,x:s,y:c}}(e,n);else if("document"===t)i=function(e){const t=mm(e),n=Mm(e),i=e.ownerDocument.body,r=jp(t.scrollWidth,t.clientWidth,i.scrollWidth,i.clientWidth),o=jp(t.scrollHeight,t.clientHeight,i.scrollHeight,i.clientHeight);let a=-n.scrollLeft+Hm(e);const s=-n.scrollTop;return"rtl"===Dm(i).direction&&(a+=jp(t.clientWidth,i.clientWidth)-r),{width:r,height:o,x:a,y:s}}(mm(e));else if(gm(t))i=function(e,t){const n=Wm(e,!0,"fixed"===t),i=n.top+e.clientTop,r=n.left+e.clientLeft,o=vm(e)?Bm(e):Bp(1);return{width:e.clientWidth*o.x,height:e.clientHeight*o.y,x:r*o.x,y:i*o.y}}(t,n);else{const n=qm(e);i={x:t.x-n.x,y:t.y-n.y,width:t.width,height:t.height}}return om(i)}function Jm(e,t){const n=Am(e);return!(n===t||!gm(n)||Om(n))&&("fixed"===Dm(n).position||Jm(n,t))}function Ym(e,t){const n=t.get(e);if(n)return n;let i=Lm(e,[],!1).filter((e=>gm(e)&&"body"!==hm(e))),r=null;const o="fixed"===Dm(e).position;let a=o?Am(e):e;for(;gm(a)&&!Om(a);){const t=Dm(a),n=Pm(a);!n&&"fixed"===t.position&&(r=null),(o?!n&&!r:!n&&"static"===t.position&&r&&Gm.has(r.position)||km(a)&&!n&&Jm(e,a))?i=i.filter((e=>e!==a)):r=t,a=Am(a)}return t.set(e,i),i}function Xm(e,t,n){const i=vm(t),r=mm(t),o="fixed"===n,a=Wm(e,!0,o,t);let s={scrollLeft:0,scrollTop:0};const c=Bp(0);function l(){c.x=Hm(r)}if(i||!i&&!o)if(("body"!==hm(t)||km(r))&&(s=Mm(t)),i){const e=Wm(t,!0,o,t);c.x=e.x+t.clientLeft,c.y=e.y+t.clientTop}else r&&l();o&&!i&&r&&l();const d=!r||i||o?Bp(0):zm(r,s);return{x:a.left+s.scrollLeft-c.x-d.x,y:a.top+s.scrollTop-c.y-d.y,width:a.width,height:a.height}}function $m(e){return"static"===Dm(e).position}function Qm(e,t){if(!vm(e)||"fixed"===Dm(e).position)return null;if(t)return t(e);let n=e.offsetParent;return mm(e)===n&&(n=n.ownerDocument.body),n}function Zm(e,t){const n=pm(e);if(Sm(e))return n;if(!vm(e)){let t=Am(e);for(;t&&!Om(t);){if(gm(t)&&!$m(t))return t;t=Am(t)}return n}let i=Qm(e,t);for(;i&&Cm(i)&&$m(i);)i=Qm(i,t);return i&&Om(i)&&$m(i)&&!Pm(i)?n:i||function(e){let t=Am(e);for(;vm(t)&&!Om(t);){if(Pm(t))return t;if(Sm(t))return null;t=Am(t)}return null}(e)||n}const ef={convertOffsetParentRelativeRectToViewportRelativeRect:function(e){let{elements:t,rect:n,offsetParent:i,strategy:r}=e;const o="fixed"===r,a=mm(i),s=!!t&&Sm(t.floating);if(i===a||s&&o)return n;let c={scrollLeft:0,scrollTop:0},l=Bp(1);const d=Bp(0),u=vm(i);if((u||!u&&!o)&&(("body"!==hm(i)||km(a))&&(c=Mm(i)),vm(i))){const e=Wm(i);l=Bm(i),d.x=e.x+i.clientLeft,d.y=e.y+i.clientTop}const h=!a||u||o?Bp(0):zm(a,c,!0);return{width:n.width*l.x,height:n.height*l.y,x:n.x*l.x-c.scrollLeft*l.x+d.x+h.x,y:n.y*l.y-c.scrollTop*l.y+d.y+h.y}},getDocumentElement:mm,getClippingRect:function(e){let{element:t,boundary:n,rootBoundary:i,strategy:r}=e;const o=[..."clippingAncestors"===n?Sm(t)?[]:Ym(t,this._c):[].concat(n),i],a=o[0],s=o.reduce(((e,n)=>{const i=Km(t,n,r);return e.top=jp(i.top,e.top),e.right=Lp(i.right,e.right),e.bottom=Lp(i.bottom,e.bottom),e.left=jp(i.left,e.left),e}),Km(t,a,r));return{width:s.right-s.left,height:s.bottom-s.top,x:s.left,y:s.top}},getOffsetParent:Zm,getElementRects:async function(e){const t=this.getOffsetParent||Zm,n=this.getDimensions,i=await n(e.floating);return{reference:Xm(e.reference,await t(e.floating),e.strategy),floating:{x:0,y:0,width:i.width,height:i.height}}},getClientRects:function(e){return Array.from(e.getClientRects())},getDimensions:function(e){const{width:t,height:n}=Um(e);return{width:t,height:n}},getScale:Bm,isElement:gm,isRTL:function(e){return"rtl"===Dm(e).direction}};function tf(e,t){return e.x===t.x&&e.y===t.y&&e.width===t.width&&e.height===t.height}const nf=function(e){return void 0===e&&(e={}),{name:"flip",options:e,async fn(t){var n,i;const{placement:r,middlewareData:o,rects:a,initialPlacement:s,platform:c,elements:l}=t,d=Hp(e,t),{mainAxis:u=!0,crossAxis:h=!0,fallbackPlacements:p,fallbackStrategy:m="bestFit",fallbackAxisSideDirection:f="none",flipAlignment:g=!0}=d,v=Su(d,qd);if(null!=(n=o.arrow)&&n.alignmentOffset)return{};const b=zp(r),y=Xp(s),k=zp(s)===s,w=await(null==c.isRTL?void 0:c.isRTL(l.floating)),C=p||(k||!g?[im(s)]:function(e){const t=im(e);return[Qp(e),t,Qp(t)]}(s)),T="none"!==f;!p&&T&&C.push(...function(e,t,n,i){const r=Gp(e);let o=function(e,t,n){switch(e){case"top":case"bottom":return n?t?em:Zp:t?Zp:em;case"left":case"right":return t?tm:nm;default:return[]}}(zp(e),"start"===n,i);return r&&(o=o.map((e=>e+"-"+r)),t&&(o=o.concat(o.map(Qp)))),o}(s,g,f,w));const S=[s,...C],x=await sm(t,v),E=[];let _=(null==(i=o.flip)?void 0:i.overflows)||[];if(u&&E.push(x[b]),h){const e=function(e,t,n){void 0===n&&(n=!1);const i=Gp(e),r=$p(e),o=Jp(r);let a="x"===r?i===(n?"end":"start")?"right":"left":"start"===i?"bottom":"top";return t.reference[o]>t.floating[o]&&(a=im(a)),[a,im(a)]}(r,a,w);E.push(x[e[0]],x[e[1]])}if(_=[..._,{placement:r,overflows:E}],!E.every((e=>e<=0))){var P,R;const e=((null==(P=o.flip)?void 0:P.index)||0)+1,t=S[e];if(t&&("alignment"!==h||y===Xp(t)||_.every((e=>Xp(e.placement)!==y||e.overflows[0]>0))))return{data:{index:e,overflows:_},reset:{placement:t}};let n=null==(R=_.filter((e=>e.overflows[0]<=0)).sort(((e,t)=>e.overflows[1]-t.overflows[1]))[0])?void 0:R.placement;if(!n)switch(m){case"bestFit":{var I;const e=null==(I=_.filter((e=>{if(T){const t=Xp(e.placement);return t===y||"y"===t}return!0})).map((e=>[e.placement,e.overflows.filter((e=>e>0)).reduce(((e,t)=>e+t),0)])).sort(((e,t)=>e[1]-t[1]))[0])?void 0:I[0];e&&(n=e);break}case"initialPlacement":n=s}if(r!==n)return{reset:{placement:n}}}return{}}}},rf=e=>({name:"arrow",options:e,async fn(t){const{x:n,y:i,placement:r,rects:o,platform:a,elements:s,middlewareData:c}=t,{element:l,padding:d=0}=Hp(e,t)||{};if(null==l)return{};const u=rm(d),h={x:n,y:i},p=$p(r),m=Jp(p),f=await a.getDimensions(l),g="y"===p,v=g?"top":"left",b=g?"bottom":"right",y=g?"clientHeight":"clientWidth",k=o.reference[m]+o.reference[p]-h[p]-o.floating[m],w=h[p]-o.reference[p],C=await(null==a.getOffsetParent?void 0:a.getOffsetParent(l));let T=C?C[y]:0;(!T||!await(null==a.isElement?void 0:a.isElement(C)))&&(T=s.floating[y]||o.floating[m]);const S=k/2-w/2,x=T/2-f[m]/2-1,E=Lp(u[v],x),_=Lp(u[b],x),P=E,R=T-f[m]-_,I=T/2-f[m]/2+S,O=Wp(P,I,R),D=!c.arrow&&null!=Gp(r)&&I!==O&&o.reference[m]/2-(I<P?E:_)-f[m]/2<0,M=D?I<P?I-P:I-R:0;return{[p]:h[p]+M,data:Eu({[p]:O,centerOffset:I-O-M},D&&{alignmentOffset:M}),reset:D}}});var of=typeof document<"u"?b.useLayoutEffect:function(){};function af(e,t){if(e===t)return!0;if(typeof e!=typeof t)return!1;if("function"==typeof e&&e.toString()===t.toString())return!0;let n,i,r;if(e&&t&&"object"==typeof e){if(Array.isArray(e)){if(n=e.length,n!==t.length)return!1;for(i=n;0!=i--;)if(!af(e[i],t[i]))return!1;return!0}if(r=Object.keys(e),n=r.length,n!==Object.keys(t).length)return!1;for(i=n;0!=i--;)if(!{}.hasOwnProperty.call(t,r[i]))return!1;for(i=n;0!=i--;){const n=r[i];if(!("_owner"===n&&e.$$typeof||af(e[n],t[n])))return!1}return!0}return e!=e&&t!=t}function sf(e){return typeof window>"u"?1:(e.ownerDocument.defaultView||window).devicePixelRatio||1}function cf(e,t){const n=sf(e);return Math.round(t*n)/n}function lf(e){const t=b.useRef(e);return of((()=>{t.current=e})),t}const df=(e,t)=>Eu(Eu({},function(e){return void 0===e&&(e=0),{name:"offset",options:e,async fn(t){var n,i;const{x:r,y:o,placement:a,middlewareData:s}=t,c=await async function(e,t){const{placement:n,platform:i,elements:r}=e,o=await(null==i.isRTL?void 0:i.isRTL(r.floating)),a=zp(n),s=Gp(n),c="y"===Xp(n),l=dm.has(a)?-1:1,d=o&&c?-1:1,u=Hp(t,e);let{mainAxis:h,crossAxis:p,alignmentAxis:m}="number"==typeof u?{mainAxis:u,crossAxis:0,alignmentAxis:null}:{mainAxis:u.mainAxis||0,crossAxis:u.crossAxis||0,alignmentAxis:u.alignmentAxis};return s&&"number"==typeof m&&(p="end"===s?-1*m:m),c?{x:p*d,y:h*l}:{x:h*l,y:p*d}}(t,e);return a===(null==(n=s.offset)?void 0:n.placement)&&null!=(i=s.arrow)&&i.alignmentOffset?{}:{x:r+c.x,y:o+c.y,data:Eu(Eu({},c),{},{placement:a})}}}}(e)),{},{options:[e,t]}),uf=(e,t)=>Eu(Eu({},function(e){return void 0===e&&(e={}),{name:"shift",options:e,async fn(t){const{x:n,y:i,placement:r}=t,o=Hp(e,t),{mainAxis:a=!0,crossAxis:s=!1,limiter:c={fn:e=>{let{x:t,y:n}=e;return{x:t,y:n}}}}=o,l=Su(o,Hd),d={x:n,y:i},u=await sm(t,l),h=Xp(zp(r)),p=Kp(h);let m=d[p],f=d[h];if(a){const e="y"===p?"bottom":"right";m=Wp(m+u["y"===p?"top":"left"],m,m-u[e])}if(s){const e="y"===h?"bottom":"right";f=Wp(f+u["y"===h?"top":"left"],f,f-u[e])}const g=c.fn(Eu(Eu({},t),{},{[p]:m,[h]:f}));return Eu(Eu({},g),{},{data:{x:g.x-n,y:g.y-i,enabled:{[p]:a,[h]:s}}})}}}(e)),{},{options:[e,t]}),hf=(e,t)=>Eu(Eu({},function(e){return void 0===e&&(e={}),{options:e,fn(t){const{x:n,y:i,placement:r,rects:o,middlewareData:a}=t,{offset:s=0,mainAxis:c=!0,crossAxis:l=!0}=Hp(e,t),d={x:n,y:i},u=Xp(r),h=Kp(u);let p=d[h],m=d[u];const f=Hp(s,t),g="number"==typeof f?{mainAxis:f,crossAxis:0}:Eu({mainAxis:0,crossAxis:0},f);if(c){const e="y"===h?"height":"width",t=o.reference[h]-o.floating[e]+g.mainAxis,n=o.reference[h]+o.reference[e]-g.mainAxis;p<t?p=t:p>n&&(p=n)}if(l){var v,b;const e="y"===h?"width":"height",t=dm.has(zp(r)),n=o.reference[u]-o.floating[e]+(t&&(null==(v=a.offset)?void 0:v[u])||0)+(t?0:g.crossAxis),i=o.reference[u]+o.reference[e]+(t?0:(null==(b=a.offset)?void 0:b[u])||0)-(t?g.crossAxis:0);m<n?m=n:m>i&&(m=i)}return{[h]:p,[u]:m}}}}(e)),{},{options:[e,t]}),pf=(e,t)=>Eu(Eu({},nf(e)),{},{options:[e,t]}),mf=(e,t)=>Eu(Eu({},function(e){return void 0===e&&(e={}),{name:"size",options:e,async fn(t){var n,i;const{placement:r,rects:o,platform:a,elements:s}=t,c=Hp(e,t),{apply:l=()=>{}}=c,d=Su(c,zd),u=await sm(t,d),h=zp(r),p=Gp(r),m="y"===Xp(r),{width:f,height:g}=o.floating;let v,b;"top"===h||"bottom"===h?(v=h,b=p===(await(null==a.isRTL?void 0:a.isRTL(s.floating))?"start":"end")?"left":"right"):(b=h,v="end"===p?"top":"bottom");const y=g-u.top-u.bottom,k=f-u.left-u.right,w=Lp(g-u[v],y),C=Lp(f-u[b],k),T=!t.middlewareData.shift;let S=w,x=C;if(null!=(n=t.middlewareData.shift)&&n.enabled.x&&(x=k),null!=(i=t.middlewareData.shift)&&i.enabled.y&&(S=y),T&&!p){const e=jp(u.left,0),t=jp(u.right,0),n=jp(u.top,0),i=jp(u.bottom,0);m?x=f-2*(0!==e||0!==t?e+t:jp(u.left,u.right)):S=g-2*(0!==n||0!==i?n+i:jp(u.top,u.bottom))}await l(Eu(Eu({},t),{},{availableWidth:x,availableHeight:S}));const E=await a.getDimensions(s.floating);return f!==E.width||g!==E.height?{reset:{rects:!0}}:{}}}}(e)),{},{options:[e,t]}),ff=(e,t)=>Eu(Eu({},function(e){return void 0===e&&(e={}),{name:"hide",options:e,async fn(t){const{rects:n}=t,i=Hp(e,t),{strategy:r="referenceHidden"}=i,o=Su(i,Wd);switch(r){case"referenceHidden":{const e=cm(await sm(t,Eu(Eu({},o),{},{elementContext:"reference"})),n.reference);return{data:{referenceHiddenOffsets:e,referenceHidden:lm(e)}}}case"escaped":{const e=cm(await sm(t,Eu(Eu({},o),{},{altBoundary:!0})),n.floating);return{data:{escapedOffsets:e,escaped:lm(e)}}}default:return{}}}}}(e)),{},{options:[e,t]}),gf=(e,t)=>Eu(Eu({},(e=>({name:"arrow",options:e,fn(t){const{element:n,padding:i}="function"==typeof e?e(t):e;return n&&function(e){return{}.hasOwnProperty.call(e,"current")}(n)?null!=n.current?rf({element:n.current,padding:i}).fn(t):{}:n?rf({element:n,padding:i}).fn(t):{}}}))(e)),{},{options:[e,t]});var vf=O(((e,t)=>{const{children:n,width:i=10,height:r=5}=e,o=Su(e,Gd);return(0,v.jsx)(dp.svg,Eu(Eu({},o),{},{ref:t,width:i,height:r,viewBox:"0 0 30 10",preserveAspectRatio:"none",children:e.asChild?n:(0,v.jsx)("polygon",{points:"0,0 30,0 15,10"})}))}));vf.displayName="Arrow";var bf=vf,yf="Popper",[kf,wf]=sp(yf),[Cf,Tf]=kf(yf),Sf=e=>{const{__scopePopper:t,children:n}=e,[i,r]=b.useState(null);return(0,v.jsx)(Cf,{scope:t,anchor:i,onAnchorChange:r,children:n})};Sf.displayName=yf;var xf="PopperAnchor",Ef=O(((e,t)=>{const{__scopePopper:n,virtualRef:i}=e,r=Su(e,Kd),o=Tf(xf,n),a=b.useRef(null),s=Dh(t,a),c=b.useRef(null);return b.useEffect((()=>{const e=c.current;c.current=(null==i?void 0:i.current)||a.current,e!==c.current&&o.onAnchorChange(c.current)})),i?null:(0,v.jsx)(dp.div,Eu(Eu({},r),{},{ref:s}))}));Ef.displayName=xf;var _f="PopperContent",[Pf,Rf]=kf(_f),If=O(((e,t)=>{var n,i,r,o,a,s,c,l;const{__scopePopper:d,side:u="bottom",sideOffset:h=0,align:p="center",alignOffset:m=0,arrowPadding:f=0,avoidCollisions:g=!0,collisionBoundary:y=[],collisionPadding:k=0,sticky:w="partial",hideWhenDetached:C=!1,updatePositionStrategy:T="optimized",onPlaced:S}=e,x=Su(e,Jd),E=Tf(_f,d),[_,P]=b.useState(null),R=Dh(t,(e=>P(e))),[I,O]=b.useState(null),D=function(e){const[t,n]=b.useState(void 0);return Op((()=>{if(e){n({width:e.offsetWidth,height:e.offsetHeight});const t=new ResizeObserver((t=>{if(!Array.isArray(t)||!t.length)return;const i=t[0];let r,o;if("borderBoxSize"in i){const e=i.borderBoxSize,t=Array.isArray(e)?e[0]:e;r=t.inlineSize,o=t.blockSize}else r=e.offsetWidth,o=e.offsetHeight;n({width:r,height:o})}));return t.observe(e,{box:"border-box"}),()=>t.unobserve(e)}n(void 0)}),[e]),t}(I),M=null!==(n=null==D?void 0:D.width)&&void 0!==n?n:0,A=null!==(i=null==D?void 0:D.height)&&void 0!==i?i:0,N=u+("center"!==p?"-"+p:""),L="number"==typeof k?k:Eu({top:0,right:0,bottom:0,left:0},k),j=Array.isArray(y)?y:[y],U=j.length>0,F={padding:L,boundary:j.filter(Af),altBoundary:U},{refs:B,floatingStyles:V,placement:q,isPositioned:W,middlewareData:H}=function(e){void 0===e&&(e={});const{placement:t="bottom",strategy:n="absolute",middleware:i=[],platform:r,elements:{reference:o,floating:a}={},transform:s=!0,whileElementsMounted:c,open:l}=e,[d,u]=b.useState({x:0,y:0,strategy:n,placement:t,middlewareData:{},isPositioned:!1}),[h,p]=b.useState(i);af(h,i)||p(i);const[m,f]=b.useState(null),[g,v]=b.useState(null),y=b.useCallback((e=>{e!==T.current&&(T.current=e,f(e))}),[]),k=b.useCallback((e=>{e!==S.current&&(S.current=e,v(e))}),[]),w=o||m,C=a||g,T=b.useRef(null),S=b.useRef(null),x=b.useRef(d),E=null!=c,_=lf(c),P=lf(r),R=lf(l),I=b.useCallback((()=>{if(!T.current||!S.current)return;const e={placement:t,strategy:n,middleware:h};P.current&&(e.platform=P.current),((e,t,n)=>{const i=new Map,r=Eu({platform:ef},n),o=Eu(Eu({},r.platform),{},{_c:i});return(async(e,t,n)=>{const{placement:i="bottom",strategy:r="absolute",middleware:o=[],platform:a}=n,s=o.filter(Boolean),c=await(null==a.isRTL?void 0:a.isRTL(t));let l=await a.getElementRects({reference:e,floating:t,strategy:r}),{x:d,y:u}=am(l,i,c),h=i,p={},m=0;for(let n=0;n<s.length;n++){const{name:o,fn:f}=s[n],{x:g,y:v,data:b,reset:y}=await f({x:d,y:u,initialPlacement:i,placement:h,strategy:r,middlewareData:p,rects:l,platform:a,elements:{reference:e,floating:t}});d=null!=g?g:d,u=null!=v?v:u,p=Eu(Eu({},p),{},{[o]:Eu(Eu({},p[o]),b)}),y&&m<=50&&(m++,"object"==typeof y&&(y.placement&&(h=y.placement),y.rects&&(l=!0===y.rects?await a.getElementRects({reference:e,floating:t,strategy:r}):y.rects),({x:d,y:u}=am(l,h,c))),n=-1)}return{x:d,y:u,placement:h,strategy:r,middlewareData:p}})(e,t,Eu(Eu({},r),{},{platform:o}))})(T.current,S.current,e).then((e=>{const t=Eu(Eu({},e),{},{isPositioned:!1!==R.current});O.current&&!af(x.current,t)&&(x.current=t,ye((()=>{u(t)})))}))}),[h,t,n,P,R]);of((()=>{!1===l&&x.current.isPositioned&&(x.current.isPositioned=!1,u((e=>Eu(Eu({},e),{},{isPositioned:!1}))))}),[l]);const O=b.useRef(!1);of((()=>(O.current=!0,()=>{O.current=!1})),[]),of((()=>{if(w&&(T.current=w),C&&(S.current=C),w&&C){if(_.current)return _.current(w,C,I);I()}}),[w,C,I,_,E]);const D=b.useMemo((()=>({reference:T,floating:S,setReference:y,setFloating:k})),[y,k]),M=b.useMemo((()=>({reference:w,floating:C})),[w,C]),A=b.useMemo((()=>{const e={position:n,left:0,top:0};if(!M.floating)return e;const t=cf(M.floating,d.x),i=cf(M.floating,d.y);return s?Eu(Eu({},e),{},{transform:"translate("+t+"px, "+i+"px)"},sf(M.floating)>=1.5&&{willChange:"transform"}):{position:n,left:t,top:i}}),[n,s,M.floating,d.x,d.y]);return b.useMemo((()=>Eu(Eu({},d),{},{update:I,refs:D,elements:M,floatingStyles:A})),[d,I,D,M,A])}({strategy:"fixed",placement:N,whileElementsMounted:function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];return function(e,t,n,i){void 0===i&&(i={});const{ancestorScroll:r=!0,ancestorResize:o=!0,elementResize:a="function"==typeof ResizeObserver,layoutShift:s="function"==typeof IntersectionObserver,animationFrame:c=!1}=i,l=Fm(e),d=r||o?[...l?Lm(l):[],...Lm(t)]:[];d.forEach((e=>{r&&e.addEventListener("scroll",n,{passive:!0}),o&&e.addEventListener("resize",n)}));const u=l&&s?function(e,t){let n,i=null;const r=mm(e);function o(){var e;clearTimeout(n),null==(e=i)||e.disconnect(),i=null}return function a(s,c){void 0===s&&(s=!1),void 0===c&&(c=1),o();const l=e.getBoundingClientRect(),{left:d,top:u,width:h,height:p}=l;if(s||t(),!h||!p)return;const m={rootMargin:-Fp(u)+"px "+-Fp(r.clientWidth-(d+h))+"px "+-Fp(r.clientHeight-(u+p))+"px "+-Fp(d)+"px",threshold:jp(0,Lp(1,c))||1};let f=!0;function g(t){const i=t[0].intersectionRatio;if(i!==c){if(!f)return a();i?a(!1,i):n=setTimeout((()=>{a(!1,1e-7)}),1e3)}1===i&&!tf(l,e.getBoundingClientRect())&&a(),f=!1}try{i=new IntersectionObserver(g,Eu(Eu({},m),{},{root:r.ownerDocument}))}catch(e){i=new IntersectionObserver(g,m)}i.observe(e)}(!0),o}(l,n):null;let h=-1,p=null;a&&(p=new ResizeObserver((e=>{let[i]=e;i&&i.target===l&&p&&(p.unobserve(t),cancelAnimationFrame(h),h=requestAnimationFrame((()=>{var e;null==(e=p)||e.observe(t)}))),n()})),l&&!c&&p.observe(l),p.observe(t));let m,f=c?Wm(e):null;return c&&function t(){const i=Wm(e);f&&!tf(f,i)&&n(),f=i,m=requestAnimationFrame(t)}(),n(),()=>{var e;d.forEach((e=>{r&&e.removeEventListener("scroll",n),o&&e.removeEventListener("resize",n)})),null==u||u(),null==(e=p)||e.disconnect(),p=null,c&&cancelAnimationFrame(m)}}(...t,{animationFrame:"always"===T})},elements:{reference:E.anchor},middleware:[df({mainAxis:h+A,alignmentAxis:m}),g&&uf(Eu({mainAxis:!0,crossAxis:!1,limiter:"partial"===w?hf():void 0},F)),g&&pf(Eu({},F)),mf(Eu(Eu({},F),{},{apply:e=>{let{elements:t,rects:n,availableWidth:i,availableHeight:r}=e;const{width:o,height:a}=n.reference,s=t.floating.style;s.setProperty("--radix-popper-available-width","".concat(i,"px")),s.setProperty("--radix-popper-available-height","".concat(r,"px")),s.setProperty("--radix-popper-anchor-width","".concat(o,"px")),s.setProperty("--radix-popper-anchor-height","".concat(a,"px"))}})),I&&gf({element:I,padding:f}),Nf({arrowWidth:M,arrowHeight:A}),C&&ff(Eu({strategy:"referenceHidden"},F))]}),[z,G]=Lf(q),K=up(S);Op((()=>{W&&(null==K||K())}),[W,K]);const J=null==(r=H.arrow)?void 0:r.x,Y=null==(o=H.arrow)?void 0:o.y,X=0!==(null==(a=H.arrow)?void 0:a.centerOffset),[$,Q]=b.useState();return Op((()=>{_&&Q(window.getComputedStyle(_).zIndex)}),[_]),(0,v.jsx)("div",{ref:B.setFloating,"data-radix-popper-content-wrapper":"",style:Eu(Eu({},V),{},{transform:W?V.transform:"translate(0, -200%)",minWidth:"max-content",zIndex:$,"--radix-popper-transform-origin":[null==(s=H.transformOrigin)?void 0:s.x,null==(c=H.transformOrigin)?void 0:c.y].join(" ")},(null==(l=H.hide)?void 0:l.referenceHidden)&&{visibility:"hidden",pointerEvents:"none"}),dir:e.dir,children:(0,v.jsx)(Pf,{scope:d,placedSide:z,onArrowChange:O,arrowX:J,arrowY:Y,shouldHideArrow:X,children:(0,v.jsx)(dp.div,Eu(Eu({"data-side":z,"data-align":G},x),{},{ref:R,style:Eu(Eu({},x.style),{},{animation:W?void 0:"none"})}))})})}));If.displayName=_f;var Of="PopperArrow",Df={top:"bottom",right:"left",bottom:"top",left:"right"},Mf=O((function(e,t){const{__scopePopper:n}=e,i=Su(e,Yd),r=Rf(Of,n),o=Df[r.placedSide];return(0,v.jsx)("span",{ref:r.onArrowChange,style:{position:"absolute",left:r.arrowX,top:r.arrowY,[o]:0,transformOrigin:{top:"",right:"0 0",bottom:"center 0",left:"100% 0"}[r.placedSide],transform:{top:"translateY(100%)",right:"translateY(50%) rotate(90deg) translateX(-50%)",bottom:"rotate(180deg)",left:"translateY(50%) rotate(-90deg) translateX(50%)"}[r.placedSide],visibility:r.shouldHideArrow?"hidden":void 0},children:(0,v.jsx)(bf,Eu(Eu({},i),{},{ref:t,style:Eu(Eu({},i.style),{},{display:"block"})}))})}));function Af(e){return null!==e}Mf.displayName=Of;var Nf=e=>({name:"transformOrigin",options:e,fn(t){var n,i,r,o,a;const{placement:s,rects:c,middlewareData:l}=t,d=0!==(null==(r=l.arrow)?void 0:r.centerOffset),u=d?0:e.arrowWidth,h=d?0:e.arrowHeight,[p,m]=Lf(s),f={start:"0%",center:"50%",end:"100%"}[m],g=(null!==(n=null==(o=l.arrow)?void 0:o.x)&&void 0!==n?n:0)+u/2,v=(null!==(i=null==(a=l.arrow)?void 0:a.y)&&void 0!==i?i:0)+h/2;let b="",y="";return"bottom"===p?(b=d?f:"".concat(g,"px"),y="".concat(-h,"px")):"top"===p?(b=d?f:"".concat(g,"px"),y="".concat(c.floating.height+h,"px")):"right"===p?(b="".concat(-h,"px"),y=d?f:"".concat(v,"px")):"left"===p&&(b="".concat(c.floating.width+h,"px"),y=d?f:"".concat(v,"px")),{data:{x:b,y}}}});function Lf(e){const[t,n="center"]=e.split("-");return[t,n]}var jf=Sf,Uf=Ef,Ff=If,Bf=Mf,Vf=O(((e,t)=>{var n;const{container:i}=e,r=Su(e,Xd),[o,a]=b.useState(!1);Op((()=>a(!0)),[]);const s=i||o&&(null==(n=null==globalThis?void 0:globalThis.document)?void 0:n.body);return s?Ce.createPortal((0,v.jsx)(dp.div,Eu(Eu({},r),{},{ref:t})),s):null}));Vf.displayName="Portal";var qf=i[" useInsertionEffect ".trim().toString()]||Op;function Wf(e){let{prop:t,defaultProp:n,onChange:i=()=>{},caller:r}=e;const[o,a,s]=function(e){let{defaultProp:t,onChange:n}=e;const[i,r]=b.useState(t),o=b.useRef(i),a=b.useRef(n);return qf((()=>{a.current=n}),[n]),b.useEffect((()=>{var e;o.current!==i&&(null==(e=a.current)||e.call(a,i),o.current=i)}),[i,o]),[i,r,a]}({defaultProp:n,onChange:i}),c=void 0!==t,l=c?t:o;{const e=b.useRef(void 0!==t);b.useEffect((()=>{const t=e.current;t!==c&&console.warn("".concat(r," is changing from ").concat(t?"controlled":"uncontrolled"," to ").concat(c?"controlled":"uncontrolled",". Components should not switch from controlled to uncontrolled (or vice versa). Decide between using a controlled or uncontrolled value for the lifetime of the component.")),e.current=c}),[c,r])}const d=b.useCallback((e=>{var n;if(c){const i=function(e){return"function"==typeof e}(e)?e(t):e;i!==t&&(null==(n=s.current)||n.call(s,i))}else a(e)}),[c,t,a,s]);return[l,d]}var Hf=Object.freeze({position:"absolute",border:0,width:1,height:1,padding:0,margin:-1,overflow:"hidden",clip:"rect(0, 0, 0, 0)",whiteSpace:"nowrap",wordWrap:"normal"}),zf=O(((e,t)=>(0,v.jsx)(dp.span,Eu(Eu({},e),{},{ref:t,style:Eu(Eu({},Hf),e.style)}))));zf.displayName="VisuallyHidden";var Gf=new WeakMap,Kf=new WeakMap,Jf={},Yf=0,Xf=function(e){return e&&(e.host||Xf(e.parentNode))},$f=function(e,t,n){void 0===n&&(n="data-aria-hidden");var i=Array.from(Array.isArray(e)?e:[e]),r=function(e){return typeof document>"u"?null:(Array.isArray(e)?e[0]:e).ownerDocument.body}(e);return r?(i.push.apply(i,Array.from(r.querySelectorAll("[aria-live], script"))),function(e,t,n,i){var r=function(e,t){return t.map((function(t){if(e.contains(t))return t;var n=Xf(t);return n&&e.contains(n)?n:(console.error("aria-hidden",t,"in not contained inside",e,". Doing nothing"),null)})).filter((function(e){return!!e}))}(t,Array.isArray(e)?e:[e]);Jf[n]||(Jf[n]=new WeakMap);var o=Jf[n],a=[],s=new Set,c=new Set(r),l=function(e){!e||s.has(e)||(s.add(e),l(e.parentNode))};r.forEach(l);var d=function(e){!e||c.has(e)||Array.prototype.forEach.call(e.children,(function(e){if(s.has(e))d(e);else try{var t=e.getAttribute(i),r=null!==t&&"false"!==t,c=(Gf.get(e)||0)+1,l=(o.get(e)||0)+1;Gf.set(e,c),o.set(e,l),a.push(e),1===c&&r&&Kf.set(e,!0),1===l&&e.setAttribute(n,"true"),r||e.setAttribute(i,"true")}catch(t){console.error("aria-hidden: cannot operate on ",e,t)}}))};return d(t),s.clear(),Yf++,function(){a.forEach((function(e){var t=Gf.get(e)-1,r=o.get(e)-1;Gf.set(e,t),o.set(e,r),t||(Kf.has(e)||e.removeAttribute(i),Kf.delete(e)),r||e.removeAttribute(n)})),--Yf||(Gf=new WeakMap,Gf=new WeakMap,Kf=new WeakMap,Jf={})}}(i,r,n,"aria-hidden")):function(){return null}},Qf=function(){return Qf=Object.assign||function(e){for(var t,n=1,i=arguments.length;n<i;n++)for(var r in t=arguments[n])Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r]);return e},Qf.apply(this,arguments)};function Zf(e,t){var n={};for(var i in e)Object.prototype.hasOwnProperty.call(e,i)&&t.indexOf(i)<0&&(n[i]=e[i]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var r=0;for(i=Object.getOwnPropertySymbols(e);r<i.length;r++)t.indexOf(i[r])<0&&Object.prototype.propertyIsEnumerable.call(e,i[r])&&(n[i[r]]=e[i[r]])}return n}var eg="right-scroll-bar-position",tg="width-before-scroll-bar";function ng(e,t){return"function"==typeof e?e(t):e&&(e.current=t),e}var ig=typeof window<"u"?b.useLayoutEffect:b.useEffect,rg=new WeakMap;function og(e){return e}var ag=function(e){var t=e.sideCar,n=Zf(e,["sideCar"]);if(!t)throw new Error("Sidecar: please provide `sideCar` property to import the right car");var i=t.read();if(!i)throw new Error("Sidecar medium not found");return r.createElement(i,Qf({},n))};ag.isSideCarExport=!0;var sg=function(e){void 0===e&&(e={});var t=function(e,t){void 0===t&&(t=og);var n=[],i=!1,r={read:function(){if(i)throw new Error("Sidecar: could not `read` from an `assigned` medium. `read` could be used only with `useMedium`.");return n.length?n[n.length-1]:null},useMedium:function(e){var r=t(e,i);return n.push(r),function(){n=n.filter((function(e){return e!==r}))}},assignSyncMedium:function(e){for(i=!0;n.length;){var t=n;n=[],t.forEach(e)}n={push:function(t){return e(t)},filter:function(){return n}}},assignMedium:function(e){i=!0;var t=[];if(n.length){var r=n;n=[],r.forEach(e),t=n}var o=function(){var n=t;t=[],n.forEach(e)},a=function(){return Promise.resolve().then(o)};a(),n={push:function(e){t.push(e),a()},filter:function(e){return t=t.filter(e),n}}}};return r}();return t.options=Qf({async:!0,ssr:!1},e),t}(),cg=function(){},lg=O((function(e,t){var n=b.useRef(null),i=b.useState({onScrollCapture:cg,onWheelCapture:cg,onTouchMoveCapture:cg}),o=i[0],a=i[1],s=e.forwardProps,c=e.children,l=e.className,d=e.removeScrollBar,u=e.enabled,h=e.shards,p=e.sideCar,m=e.noRelative,f=e.noIsolation,g=e.inert,v=e.allowPinchZoom,y=e.as,k=void 0===y?"div":y,w=e.gapMode,C=Zf(e,["forwardProps","children","className","removeScrollBar","enabled","shards","sideCar","noRelative","noIsolation","inert","allowPinchZoom","as","gapMode"]),T=p,S=function(e){var t=function(e,t){var n=(0,b.useState)((function(){return{value:null,callback:t,facade:{get current(){return n.value},set current(e){var t=n.value;t!==e&&(n.value=e,n.callback(e,t))}}}}))[0];return n.callback=t,n.facade}(0,(function(t){return e.forEach((function(e){return ng(e,t)}))}));return ig((function(){var n=rg.get(t);if(n){var i=new Set(n),r=new Set(e),o=t.current;i.forEach((function(e){r.has(e)||ng(e,null)})),r.forEach((function(e){i.has(e)||ng(e,o)}))}rg.set(t,e)}),[e]),t}([n,t]),x=Qf(Qf({},C),o);return r.createElement(r.Fragment,null,u&&r.createElement(T,{sideCar:sg,removeScrollBar:d,shards:h,noRelative:m,noIsolation:f,inert:g,setCallbacks:a,allowPinchZoom:!!v,lockRef:n,gapMode:w}),s?fe(M.only(c),Qf(Qf({},x),{ref:S})):r.createElement(k,Qf({},x,{className:l,ref:S}),c))}));lg.defaultProps={enabled:!0,removeScrollBar:!0,inert:!1},lg.classNames={fullWidth:tg,zeroRight:eg};var dg=function(){var e=0,t=null;return{add:function(i){0==e&&(t=function(){if(!document)return null;var e=document.createElement("style");e.type="text/css";var t=n.nc;return t&&e.setAttribute("nonce",t),e}())&&(function(e,t){e.styleSheet?e.styleSheet.cssText=t:e.appendChild(document.createTextNode(t))}(t,i),function(e){(document.head||document.getElementsByTagName("head")[0]).appendChild(e)}(t)),e++},remove:function(){! --e&&t&&(t.parentNode&&t.parentNode.removeChild(t),t=null)}}},ug=function(){var e=function(){var e=dg();return function(t,n){b.useEffect((function(){return e.add(t),function(){e.remove()}}),[t&&n])}}();return function(t){var n=t.styles,i=t.dynamic;return e(n,i),null}},hg={left:0,top:0,right:0,gap:0},pg=function(e){return parseInt(e||"",10)||0},mg=ug(),fg="data-scroll-locked",gg=function(e,t,n,i){var r=e.left,o=e.top,a=e.right,s=e.gap;return void 0===n&&(n="margin"),"\n  .".concat("with-scroll-bars-hidden"," {\n   overflow: hidden ").concat(i,";\n   padding-right: ").concat(s,"px ").concat(i,";\n  }\n  body[").concat(fg,"] {\n    overflow: hidden ").concat(i,";\n    overscroll-behavior: contain;\n    ").concat([t&&"position: relative ".concat(i,";"),"margin"===n&&"\n    padding-left: ".concat(r,"px;\n    padding-top: ").concat(o,"px;\n    padding-right: ").concat(a,"px;\n    margin-left:0;\n    margin-top:0;\n    margin-right: ").concat(s,"px ").concat(i,";\n    "),"padding"===n&&"padding-right: ".concat(s,"px ").concat(i,";")].filter(Boolean).join(""),"\n  }\n  \n  .").concat(eg," {\n    right: ").concat(s,"px ").concat(i,";\n  }\n  \n  .").concat(tg," {\n    margin-right: ").concat(s,"px ").concat(i,";\n  }\n  \n  .").concat(eg," .").concat(eg," {\n    right: 0 ").concat(i,";\n  }\n  \n  .").concat(tg," .").concat(tg," {\n    margin-right: 0 ").concat(i,";\n  }\n  \n  body[").concat(fg,"] {\n    ").concat("--removed-body-scroll-bar-size",": ").concat(s,"px;\n  }\n")},vg=function(){var e=parseInt(document.body.getAttribute(fg)||"0",10);return isFinite(e)?e:0},bg=function(e){var t=e.noRelative,n=e.noImportant,i=e.gapMode,o=void 0===i?"margin":i;b.useEffect((function(){return document.body.setAttribute(fg,(vg()+1).toString()),function(){var e=vg()-1;e<=0?document.body.removeAttribute(fg):document.body.setAttribute(fg,e.toString())}}),[]);var a=b.useMemo((function(){return function(e){if(void 0===e&&(e="margin"),typeof window>"u")return hg;var t=function(e){var t=window.getComputedStyle(document.body),n=t["padding"===e?"paddingLeft":"marginLeft"],i=t["padding"===e?"paddingTop":"marginTop"],r=t["padding"===e?"paddingRight":"marginRight"];return[pg(n),pg(i),pg(r)]}(e),n=document.documentElement.clientWidth,i=window.innerWidth;return{left:t[0],top:t[1],right:t[2],gap:Math.max(0,i-n+t[2]-t[0])}}(o)}),[o]);return r.createElement(mg,{styles:gg(a,!t,o,n?"":"!important")})},yg=!1;if(typeof window<"u")try{var kg=Object.defineProperty({},"passive",{get:function(){return yg=!0,!0}});window.addEventListener("test",kg,kg),window.removeEventListener("test",kg,kg)}catch(e){yg=!1}var wg=!!yg&&{passive:!1},Cg=function(e,t){if(!(e instanceof Element))return!1;var n=window.getComputedStyle(e);return"hidden"!==n[t]&&!(n.overflowY===n.overflowX&&!function(e){return"TEXTAREA"===e.tagName}(e)&&"visible"===n[t])},Tg=function(e,t){var n=t.ownerDocument,i=t;do{if(typeof ShadowRoot<"u"&&i instanceof ShadowRoot&&(i=i.host),Sg(e,i)){var r=xg(e,i);if(r[1]>r[2])return!0}i=i.parentNode}while(i&&i!==n.body);return!1},Sg=function(e,t){return"v"===e?function(e){return Cg(e,"overflowY")}(t):function(e){return Cg(e,"overflowX")}(t)},xg=function(e,t){return"v"===e?function(e){return[e.scrollTop,e.scrollHeight,e.clientHeight]}(t):function(e){return[e.scrollLeft,e.scrollWidth,e.clientWidth]}(t)},Eg=function(e){return"changedTouches"in e?[e.changedTouches[0].clientX,e.changedTouches[0].clientY]:[0,0]},_g=function(e){return[e.deltaX,e.deltaY]},Pg=function(e){return e&&"current"in e?e.current:e},Rg=function(e){return"\n  .block-interactivity-".concat(e," {pointer-events: none;}\n  .allow-interactivity-").concat(e," {pointer-events: all;}\n")},Ig=0,Og=[];function Dg(e){for(var t=null;null!==e;)e instanceof ShadowRoot&&(t=e.host,e=e.host),e=e.parentNode;return t}const Mg=function(e){return e.useMedium((function(e){var t=b.useRef([]),n=b.useRef([0,0]),i=b.useRef(),o=b.useState(Ig++)[0],a=b.useState(ug)[0],s=b.useRef(e);b.useEffect((function(){s.current=e}),[e]),b.useEffect((function(){if(e.inert){document.body.classList.add("block-interactivity-".concat(o));var t=function(e,t,n){if(n||2===arguments.length)for(var i,r=0,o=t.length;r<o;r++)(i||!(r in t))&&(i||(i=Array.prototype.slice.call(t,0,r)),i[r]=t[r]);return e.concat(i||Array.prototype.slice.call(t))}([e.lockRef.current],(e.shards||[]).map(Pg),!0).filter(Boolean);return t.forEach((function(e){return e.classList.add("allow-interactivity-".concat(o))})),function(){document.body.classList.remove("block-interactivity-".concat(o)),t.forEach((function(e){return e.classList.remove("allow-interactivity-".concat(o))}))}}}),[e.inert,e.lockRef.current,e.shards]);var c=b.useCallback((function(e,t){if("touches"in e&&2===e.touches.length||"wheel"===e.type&&e.ctrlKey)return!s.current.allowPinchZoom;var r,o=Eg(e),a=n.current,c="deltaX"in e?e.deltaX:a[0]-o[0],l="deltaY"in e?e.deltaY:a[1]-o[1],d=e.target,u=Math.abs(c)>Math.abs(l)?"h":"v";if("touches"in e&&"h"===u&&"range"===d.type)return!1;var h=Tg(u,d);if(!h)return!0;if(h?r=u:(r="v"===u?"h":"v",h=Tg(u,d)),!h)return!1;if(!i.current&&"changedTouches"in e&&(c||l)&&(i.current=r),!r)return!0;var p=i.current||r;return function(e,t,n,i){var r=function(e,t){return"h"===e&&"rtl"===t?-1:1}(e,window.getComputedStyle(t).direction),o=r*i,a=n.target,s=t.contains(a),c=!1,l=o>0,d=0,u=0;do{if(!a)break;var h=xg(e,a),p=h[0],m=h[1]-h[2]-r*p;(p||m)&&Sg(e,a)&&(d+=m,u+=p);var f=a.parentNode;a=f&&f.nodeType===Node.DOCUMENT_FRAGMENT_NODE?f.host:f}while(!s&&a!==document.body||s&&(t.contains(a)||t===a));return(l&&Math.abs(d)<1||!l&&Math.abs(u)<1)&&(c=!0),c}(p,t,e,"h"===p?c:l)}),[]),l=b.useCallback((function(e){var n=e;if(Og.length&&Og[Og.length-1]===a){var i="deltaY"in n?_g(n):Eg(n),r=t.current.filter((function(e){return e.name===n.type&&(e.target===n.target||n.target===e.shadowParent)&&function(e,t){return e[0]===t[0]&&e[1]===t[1]}(e.delta,i)}))[0];if(r&&r.should)return void(n.cancelable&&n.preventDefault());if(!r){var o=(s.current.shards||[]).map(Pg).filter(Boolean).filter((function(e){return e.contains(n.target)}));(o.length>0?c(n,o[0]):!s.current.noIsolation)&&n.cancelable&&n.preventDefault()}}}),[]),d=b.useCallback((function(e,n,i,r){var o={name:e,delta:n,target:i,should:r,shadowParent:Dg(i)};t.current.push(o),setTimeout((function(){t.current=t.current.filter((function(e){return e!==o}))}),1)}),[]),u=b.useCallback((function(e){n.current=Eg(e),i.current=void 0}),[]),h=b.useCallback((function(t){d(t.type,_g(t),t.target,c(t,e.lockRef.current))}),[]),p=b.useCallback((function(t){d(t.type,Eg(t),t.target,c(t,e.lockRef.current))}),[]);b.useEffect((function(){return Og.push(a),e.setCallbacks({onScrollCapture:h,onWheelCapture:h,onTouchMoveCapture:p}),document.addEventListener("wheel",l,wg),document.addEventListener("touchmove",l,wg),document.addEventListener("touchstart",u,wg),function(){Og=Og.filter((function(e){return e!==a})),document.removeEventListener("wheel",l,wg),document.removeEventListener("touchmove",l,wg),document.removeEventListener("touchstart",u,wg)}}),[]);var m=e.removeScrollBar,f=e.inert;return r.createElement(r.Fragment,null,f?r.createElement(a,{styles:Rg(o)}):null,m?r.createElement(bg,{noRelative:e.noRelative,gapMode:e.gapMode}):null)})),ag}(sg);var Ag=O((function(e,t){return r.createElement(lg,Qf({},e,{ref:t,sideCar:Mg}))}));Ag.classNames=lg.classNames;var Ng=[" ","Enter","ArrowUp","ArrowDown"],Lg=[" ","Enter"],jg="Select",[Ug,Fg,Bg]=function(e){const t=e+"CollectionProvider",[n,i]=sp(t),[r,o]=n(t,{collectionRef:{current:null},itemMap:new Map}),a=e=>{const{scope:t,children:n}=e,i=Ce.useRef(null),o=Ce.useRef(new Map).current;return(0,v.jsx)(r,{scope:t,itemMap:o,collectionRef:i,children:n})};a.displayName=t;const s=e+"CollectionSlot",c=Mh(s),l=Ce.forwardRef(((e,t)=>{const{scope:n,children:i}=e,r=Dh(t,o(s,n).collectionRef);return(0,v.jsx)(c,{ref:r,children:i})}));l.displayName=s;const d=e+"CollectionItemSlot",u="data-radix-collection-item",h=Mh(d),p=Ce.forwardRef(((e,t)=>{const{scope:n,children:i}=e,r=Su(e,Ud),a=Ce.useRef(null),s=Dh(t,a),c=o(d,n);return Ce.useEffect((()=>(c.itemMap.set(a,Eu({ref:a},r)),()=>{c.itemMap.delete(a)}))),(0,v.jsx)(h,{[u]:"",ref:s,children:i})}));return p.displayName=d,[{Provider:a,Slot:l,ItemSlot:p},function(t){const n=o(e+"CollectionConsumer",t);return Ce.useCallback((()=>{const e=n.collectionRef.current;if(!e)return[];const t=Array.from(e.querySelectorAll("[".concat(u,"]")));return Array.from(n.itemMap.values()).sort(((e,n)=>t.indexOf(e.ref.current)-t.indexOf(n.ref.current)))}),[n.collectionRef,n.itemMap])},i]}(jg),[Vg,qg]=sp(jg,[Bg,wf]),Wg=wf(),[Hg,zg]=Vg(jg),[Gg,Kg]=Vg(jg),Jg=e=>{const{__scopeSelect:t,children:n,open:i,defaultOpen:r,onOpenChange:o,value:a,defaultValue:s,onValueChange:c,dir:l,name:d,autoComplete:u,disabled:h,required:p,form:m}=e,f=Wg(t),[g,y]=b.useState(null),[k,w]=b.useState(null),[C,T]=b.useState(!1),S=function(e){const t=b.useContext(lp);return e||t||"ltr"}(l),[x,E]=Wf({prop:i,defaultProp:null!=r&&r,onChange:o,caller:jg}),[_,P]=Wf({prop:a,defaultProp:s,onChange:c,caller:jg}),R=b.useRef(null),I=!g||m||!!g.closest("form"),[O,D]=b.useState(new Set),M=Array.from(O).map((e=>e.props.value)).join(";");return(0,v.jsx)(jf,Eu(Eu({},f),{},{children:(0,v.jsxs)(Hg,{required:p,scope:t,trigger:g,onTriggerChange:y,valueNode:k,onValueNodeChange:w,valueNodeHasChildren:C,onValueNodeHasChildrenChange:T,contentId:Ap(),value:_,onValueChange:P,open:x,onOpenChange:E,dir:S,triggerPointerDownPosRef:R,disabled:h,children:[(0,v.jsx)(Ug.Provider,{scope:t,children:(0,v.jsx)(Gg,{scope:e.__scopeSelect,onNativeOptionAdd:b.useCallback((e=>{D((t=>new Set(t).add(e)))}),[]),onNativeOptionRemove:b.useCallback((e=>{D((t=>{const n=new Set(t);return n.delete(e),n}))}),[]),children:n})}),I?(0,v.jsxs)(Lv,{"aria-hidden":!0,required:p,tabIndex:-1,name:d,autoComplete:u,value:_,onChange:e=>P(e.target.value),disabled:h,form:m,children:[void 0===_?(0,v.jsx)("option",{value:""}):null,Array.from(O)]},M):null]})}))};Jg.displayName=jg;var Yg="SelectTrigger",Xg=O(((e,t)=>{const{__scopeSelect:n,disabled:i=!1}=e,r=Su(e,$d),o=Wg(n),a=zg(Yg,n),s=a.disabled||i,c=Dh(t,a.onTriggerChange),l=Fg(n),d=b.useRef("touch"),[u,h,p]=Uv((e=>{const t=l().filter((e=>!e.disabled)),n=t.find((e=>e.value===a.value)),i=Fv(t,e,n);void 0!==i&&a.onValueChange(i.value)})),m=e=>{s||(a.onOpenChange(!0),p()),e&&(a.triggerPointerDownPosRef.current={x:Math.round(e.pageX),y:Math.round(e.pageY)})};return(0,v.jsx)(Uf,Eu(Eu({asChild:!0},o),{},{children:(0,v.jsx)(dp.button,Eu(Eu({type:"button",role:"combobox","aria-controls":a.contentId,"aria-expanded":a.open,"aria-required":a.required,"aria-autocomplete":"none",dir:a.dir,"data-state":a.open?"open":"closed",disabled:s,"data-disabled":s?"":void 0,"data-placeholder":jv(a.value)?"":void 0},r),{},{ref:c,onClick:ap(r.onClick,(e=>{e.currentTarget.focus(),"mouse"!==d.current&&m(e)})),onPointerDown:ap(r.onPointerDown,(e=>{d.current=e.pointerType;const t=e.target;t.hasPointerCapture(e.pointerId)&&t.releasePointerCapture(e.pointerId),0===e.button&&!1===e.ctrlKey&&"mouse"===e.pointerType&&(m(e),e.preventDefault())})),onKeyDown:ap(r.onKeyDown,(e=>{const t=""!==u.current;!(e.ctrlKey||e.altKey||e.metaKey)&&1===e.key.length&&h(e.key),(!t||" "!==e.key)&&Ng.includes(e.key)&&(m(),e.preventDefault())}))}))}))}));Xg.displayName=Yg;var $g="SelectValue",Qg=O(((e,t)=>{const{__scopeSelect:n,className:i,style:r,children:o,placeholder:a=""}=e,s=Su(e,Qd),c=zg($g,n),{onValueNodeHasChildrenChange:l}=c,d=void 0!==o,u=Dh(t,c.onValueNodeChange);return Op((()=>{l(d)}),[l,d]),(0,v.jsx)(dp.span,Eu(Eu({},s),{},{ref:u,style:{pointerEvents:"none"},children:jv(c.value)?(0,v.jsx)(v.Fragment,{children:a}):o}))}));Qg.displayName=$g;var Zg=O(((e,t)=>{const{__scopeSelect:n,children:i}=e,r=Su(e,Zd);return(0,v.jsx)(dp.span,Eu(Eu({"aria-hidden":!0},r),{},{ref:t,children:i||""}))}));Zg.displayName="SelectIcon";var ev=e=>(0,v.jsx)(Vf,Eu({asChild:!0},e));ev.displayName="SelectPortal";var tv="SelectContent",nv=O(((e,t)=>{const n=zg(tv,e.__scopeSelect),[i,r]=b.useState();if(Op((()=>{r(new DocumentFragment)}),[]),!n.open){const t=i;return t?z((0,v.jsx)(rv,{scope:e.__scopeSelect,children:(0,v.jsx)(Ug.Slot,{scope:e.__scopeSelect,children:(0,v.jsx)("div",{children:e.children})})}),t):null}return(0,v.jsx)(sv,Eu(Eu({},e),{},{ref:t}))}));nv.displayName=tv;var iv=10,[rv,ov]=Vg(tv),av=Mh("SelectContent.RemoveScroll"),sv=O(((e,t)=>{const{__scopeSelect:n,position:i="item-aligned",onCloseAutoFocus:r,onEscapeKeyDown:o,onPointerDownOutside:a,side:s,sideOffset:c,align:l,alignOffset:d,arrowPadding:u,collisionBoundary:h,collisionPadding:p,sticky:m,hideWhenDetached:f,avoidCollisions:g}=e,y=Su(e,eu),k=zg(tv,n),[w,C]=b.useState(null),[T,S]=b.useState(null),x=Dh(t,(e=>C(e))),[E,_]=b.useState(null),[P,R]=b.useState(null),I=Fg(n),[O,D]=b.useState(!1),M=b.useRef(!1);b.useEffect((()=>{if(w)return $f(w)}),[w]),b.useEffect((()=>{var e,t;const n=document.querySelectorAll("[data-radix-focus-guard]");return document.body.insertAdjacentElement("afterbegin",null!==(e=n[0])&&void 0!==e?e:kp()),document.body.insertAdjacentElement("beforeend",null!==(t=n[1])&&void 0!==t?t:kp()),yp++,()=>{1===yp&&document.querySelectorAll("[data-radix-focus-guard]").forEach((e=>e.remove())),yp--}}),[]);const A=b.useCallback((e=>{const[t,...n]=I().map((e=>e.ref.current)),[i]=n.slice(-1),r=document.activeElement;for(const n of e)if(n===r||(null==n||n.scrollIntoView({block:"nearest"}),n===t&&T&&(T.scrollTop=0),n===i&&T&&(T.scrollTop=T.scrollHeight),null==n||n.focus(),document.activeElement!==r))return}),[I,T]),N=b.useCallback((()=>A([E,w])),[A,E,w]);b.useEffect((()=>{O&&N()}),[O,N]);const{onOpenChange:L,triggerPointerDownPosRef:j}=k;b.useEffect((()=>{if(w){let e={x:0,y:0};const t=t=>{var n,i,r,o;e={x:Math.abs(Math.round(t.pageX)-(null!==(n=null==(r=j.current)?void 0:r.x)&&void 0!==n?n:0)),y:Math.abs(Math.round(t.pageY)-(null!==(i=null==(o=j.current)?void 0:o.y)&&void 0!==i?i:0))}},n=n=>{e.x<=10&&e.y<=10?n.preventDefault():w.contains(n.target)||L(!1),document.removeEventListener("pointermove",t),j.current=null};return null!==j.current&&(document.addEventListener("pointermove",t),document.addEventListener("pointerup",n,{capture:!0,once:!0})),()=>{document.removeEventListener("pointermove",t),document.removeEventListener("pointerup",n,{capture:!0})}}}),[w,L,j]),b.useEffect((()=>{const e=()=>L(!1);return window.addEventListener("blur",e),window.addEventListener("resize",e),()=>{window.removeEventListener("blur",e),window.removeEventListener("resize",e)}}),[L]);const[U,F]=Uv((e=>{const t=I().filter((e=>!e.disabled)),n=t.find((e=>e.ref.current===document.activeElement)),i=Fv(t,e,n);i&&setTimeout((()=>i.ref.current.focus()))})),B=b.useCallback(((e,t,n)=>{const i=!M.current&&!n;(void 0!==k.value&&k.value===t||i)&&(_(e),i&&(M.current=!0))}),[k.value]),V=b.useCallback((()=>null==w?void 0:w.focus()),[w]),q=b.useCallback(((e,t,n)=>{const i=!M.current&&!n;(void 0!==k.value&&k.value===t||i)&&R(e)}),[k.value]),W="popper"===i?lv:cv,H=W===lv?{side:s,sideOffset:c,align:l,alignOffset:d,arrowPadding:u,collisionBoundary:h,collisionPadding:p,sticky:m,hideWhenDetached:f,avoidCollisions:g}:{};return(0,v.jsx)(rv,{scope:n,content:w,viewport:T,onViewportChange:S,itemRefCallback:B,selectedItem:E,onItemLeave:V,itemTextRefCallback:q,focusSelectedItem:N,selectedItemText:P,position:i,isPositioned:O,searchRef:U,children:(0,v.jsx)(Ag,{as:av,allowPinchZoom:!0,children:(0,v.jsx)(Sp,{asChild:!0,trapped:k.open,onMountAutoFocus:e=>{e.preventDefault()},onUnmountAutoFocus:ap(r,(e=>{var t;null==(t=k.trigger)||t.focus({preventScroll:!0}),e.preventDefault()})),children:(0,v.jsx)(fp,{asChild:!0,disableOutsidePointerEvents:!0,onEscapeKeyDown:o,onPointerDownOutside:a,onFocusOutside:e=>e.preventDefault(),onDismiss:()=>k.onOpenChange(!1),children:(0,v.jsx)(W,Eu(Eu(Eu({role:"listbox",id:k.contentId,"data-state":k.open?"open":"closed",dir:k.dir,onContextMenu:e=>e.preventDefault()},y),H),{},{onPlaced:()=>D(!0),ref:x,style:Eu({display:"flex",flexDirection:"column",outline:"none"},y.style),onKeyDown:ap(y.onKeyDown,(e=>{const t=e.ctrlKey||e.altKey||e.metaKey;if("Tab"===e.key&&e.preventDefault(),!t&&1===e.key.length&&F(e.key),["ArrowUp","ArrowDown","Home","End"].includes(e.key)){let t=I().filter((e=>!e.disabled)).map((e=>e.ref.current));if(["ArrowUp","End"].includes(e.key)&&(t=t.slice().reverse()),["ArrowUp","ArrowDown"].includes(e.key)){const n=e.target,i=t.indexOf(n);t=t.slice(i+1)}setTimeout((()=>A(t))),e.preventDefault()}}))}))})})})})}));sv.displayName="SelectContentImpl";var cv=O(((e,t)=>{const{__scopeSelect:n,onPlaced:i}=e,r=Su(e,tu),o=zg(tv,n),a=ov(tv,n),[s,c]=b.useState(null),[l,d]=b.useState(null),u=Dh(t,(e=>d(e))),h=Fg(n),p=b.useRef(!1),m=b.useRef(!0),{viewport:f,selectedItem:g,selectedItemText:y,focusSelectedItem:k}=a,w=b.useCallback((()=>{if(o.trigger&&o.valueNode&&s&&l&&f&&g&&y){const e=o.trigger.getBoundingClientRect(),t=l.getBoundingClientRect(),n=o.valueNode.getBoundingClientRect(),r=y.getBoundingClientRect();if("rtl"!==o.dir){const i=r.left-t.left,o=n.left-i,a=e.left-o,c=e.width+a,l=Math.max(c,t.width),d=window.innerWidth-iv,u=op(o,[iv,Math.max(iv,d-l)]);s.style.minWidth=c+"px",s.style.left=u+"px"}else{const i=t.right-r.right,o=window.innerWidth-n.right-i,a=window.innerWidth-e.right-o,c=e.width+a,l=Math.max(c,t.width),d=window.innerWidth-iv,u=op(o,[iv,Math.max(iv,d-l)]);s.style.minWidth=c+"px",s.style.right=u+"px"}const a=h(),c=window.innerHeight-2*iv,d=f.scrollHeight,u=window.getComputedStyle(l),m=parseInt(u.borderTopWidth,10),v=parseInt(u.paddingTop,10),b=parseInt(u.borderBottomWidth,10),k=m+v+d+parseInt(u.paddingBottom,10)+b,w=Math.min(5*g.offsetHeight,k),C=window.getComputedStyle(f),T=parseInt(C.paddingTop,10),S=parseInt(C.paddingBottom,10),x=e.top+e.height/2-iv,E=c-x,_=g.offsetHeight/2,P=m+v+(g.offsetTop+_),R=k-P;if(P<=x){const e=a.length>0&&g===a[a.length-1].ref.current;s.style.bottom="0px";const t=l.clientHeight-f.offsetTop-f.offsetHeight,n=P+Math.max(E,_+(e?S:0)+t+b);s.style.height=n+"px"}else{const e=a.length>0&&g===a[0].ref.current;s.style.top="0px";const t=Math.max(x,m+f.offsetTop+(e?T:0)+_)+R;s.style.height=t+"px",f.scrollTop=P-x+f.offsetTop}s.style.margin="".concat(iv,"px 0"),s.style.minHeight=w+"px",s.style.maxHeight=c+"px",null==i||i(),requestAnimationFrame((()=>p.current=!0))}}),[h,o.trigger,o.valueNode,s,l,f,g,y,o.dir,i]);Op((()=>w()),[w]);const[C,T]=b.useState();Op((()=>{l&&T(window.getComputedStyle(l).zIndex)}),[l]);const S=b.useCallback((e=>{e&&!0===m.current&&(w(),null==k||k(),m.current=!1)}),[w,k]);return(0,v.jsx)(dv,{scope:n,contentWrapper:s,shouldExpandOnScrollRef:p,onScrollButtonChange:S,children:(0,v.jsx)("div",{ref:c,style:{display:"flex",flexDirection:"column",position:"fixed",zIndex:C},children:(0,v.jsx)(dp.div,Eu(Eu({},r),{},{ref:u,style:Eu({boxSizing:"border-box",maxHeight:"100%"},r.style)}))})})}));cv.displayName="SelectItemAlignedPosition";var lv=O(((e,t)=>{const{__scopeSelect:n,align:i="start",collisionPadding:r=iv}=e,o=Su(e,nu),a=Wg(n);return(0,v.jsx)(Ff,Eu(Eu(Eu({},a),o),{},{ref:t,align:i,collisionPadding:r,style:Eu(Eu({boxSizing:"border-box"},o.style),{},{"--radix-select-content-transform-origin":"var(--radix-popper-transform-origin)","--radix-select-content-available-width":"var(--radix-popper-available-width)","--radix-select-content-available-height":"var(--radix-popper-available-height)","--radix-select-trigger-width":"var(--radix-popper-anchor-width)","--radix-select-trigger-height":"var(--radix-popper-anchor-height)"})}))}));lv.displayName="SelectPopperPosition";var[dv,uv]=Vg(tv,{}),hv="SelectViewport",pv=O(((e,t)=>{const{__scopeSelect:n,nonce:i}=e,r=Su(e,iu),o=ov(hv,n),a=uv(hv,n),s=Dh(t,o.onViewportChange),c=b.useRef(0);return(0,v.jsxs)(v.Fragment,{children:[(0,v.jsx)("style",{dangerouslySetInnerHTML:{__html:"[data-radix-select-viewport]{scrollbar-width:none;-ms-overflow-style:none;-webkit-overflow-scrolling:touch;}[data-radix-select-viewport]::-webkit-scrollbar{display:none}"},nonce:i}),(0,v.jsx)(Ug.Slot,{scope:n,children:(0,v.jsx)(dp.div,Eu(Eu({"data-radix-select-viewport":"",role:"presentation"},r),{},{ref:s,style:Eu({position:"relative",flex:1,overflow:"hidden auto"},r.style),onScroll:ap(r.onScroll,(e=>{const t=e.currentTarget,{contentWrapper:n,shouldExpandOnScrollRef:i}=a;if(null!=i&&i.current&&n){const e=Math.abs(c.current-t.scrollTop);if(e>0){const i=window.innerHeight-2*iv,r=parseFloat(n.style.minHeight),o=parseFloat(n.style.height),a=Math.max(r,o);if(a<i){const r=a+e,o=Math.min(i,r),s=r-o;n.style.height=o+"px","0px"===n.style.bottom&&(t.scrollTop=s>0?s:0,n.style.justifyContent="flex-end")}}}c.current=t.scrollTop}))}))})]})}));pv.displayName=hv;var mv="SelectGroup",[fv,gv]=Vg(mv),vv=O(((e,t)=>{const{__scopeSelect:n}=e,i=Su(e,ru),r=Ap();return(0,v.jsx)(fv,{scope:n,id:r,children:(0,v.jsx)(dp.div,Eu(Eu({role:"group","aria-labelledby":r},i),{},{ref:t}))})}));vv.displayName=mv;var bv="SelectLabel",yv=O(((e,t)=>{const{__scopeSelect:n}=e,i=Su(e,ou),r=gv(bv,n);return(0,v.jsx)(dp.div,Eu(Eu({id:r.id},i),{},{ref:t}))}));yv.displayName=bv;var kv="SelectItem",[wv,Cv]=Vg(kv),Tv=O(((e,t)=>{const{__scopeSelect:n,value:i,disabled:r=!1,textValue:o}=e,a=Su(e,au),s=zg(kv,n),c=ov(kv,n),l=s.value===i,[d,u]=b.useState(null!=o?o:""),[h,p]=b.useState(!1),m=Dh(t,(e=>{var t;return null==(t=c.itemRefCallback)?void 0:t.call(c,e,i,r)})),f=Ap(),g=b.useRef("touch"),y=()=>{r||(s.onValueChange(i),s.onOpenChange(!1))};if(""===i)throw new Error("A <Select.Item /> must have a value prop that is not an empty string. This is because the Select value can be set to an empty string to clear the selection and show the placeholder.");return(0,v.jsx)(wv,{scope:n,value:i,disabled:r,textId:f,isSelected:l,onItemTextChange:b.useCallback((e=>{u((t=>{var n;return t||(null!==(n=null==e?void 0:e.textContent)&&void 0!==n?n:"").trim()}))}),[]),children:(0,v.jsx)(Ug.ItemSlot,{scope:n,value:i,disabled:r,textValue:d,children:(0,v.jsx)(dp.div,Eu(Eu({role:"option","aria-labelledby":f,"data-highlighted":h?"":void 0,"aria-selected":l&&h,"data-state":l?"checked":"unchecked","aria-disabled":r||void 0,"data-disabled":r?"":void 0,tabIndex:r?void 0:-1},a),{},{ref:m,onFocus:ap(a.onFocus,(()=>p(!0))),onBlur:ap(a.onBlur,(()=>p(!1))),onClick:ap(a.onClick,(()=>{"mouse"!==g.current&&y()})),onPointerUp:ap(a.onPointerUp,(()=>{"mouse"===g.current&&y()})),onPointerDown:ap(a.onPointerDown,(e=>{g.current=e.pointerType})),onPointerMove:ap(a.onPointerMove,(e=>{var t;g.current=e.pointerType,r?null==(t=c.onItemLeave)||t.call(c):"mouse"===g.current&&e.currentTarget.focus({preventScroll:!0})})),onPointerLeave:ap(a.onPointerLeave,(e=>{var t;e.currentTarget===document.activeElement&&(null==(t=c.onItemLeave)||t.call(c))})),onKeyDown:ap(a.onKeyDown,(e=>{var t;""!==(null==(t=c.searchRef)?void 0:t.current)&&" "===e.key||(Lg.includes(e.key)&&y()," "===e.key&&e.preventDefault())}))}))})})}));Tv.displayName=kv;var Sv="SelectItemText",xv=O(((e,t)=>{const{__scopeSelect:n,className:i,style:r}=e,o=Su(e,su),a=zg(Sv,n),s=ov(Sv,n),c=Cv(Sv,n),l=Kg(Sv,n),[d,u]=b.useState(null),h=Dh(t,(e=>u(e)),c.onItemTextChange,(e=>{var t;return null==(t=s.itemTextRefCallback)?void 0:t.call(s,e,c.value,c.disabled)})),p=null==d?void 0:d.textContent,m=b.useMemo((()=>(0,v.jsx)("option",{value:c.value,disabled:c.disabled,children:p},c.value)),[c.disabled,c.value,p]),{onNativeOptionAdd:f,onNativeOptionRemove:g}=l;return Op((()=>(f(m),()=>g(m))),[f,g,m]),(0,v.jsxs)(v.Fragment,{children:[(0,v.jsx)(dp.span,Eu(Eu({id:c.textId},o),{},{ref:h})),c.isSelected&&a.valueNode&&!a.valueNodeHasChildren?z(o.children,a.valueNode):null]})}));xv.displayName=Sv;var Ev="SelectItemIndicator",_v=O(((e,t)=>{const{__scopeSelect:n}=e,i=Su(e,cu);return Cv(Ev,n).isSelected?(0,v.jsx)(dp.span,Eu(Eu({"aria-hidden":!0},i),{},{ref:t})):null}));_v.displayName=Ev;var Pv="SelectScrollUpButton",Rv=O(((e,t)=>{const n=ov(Pv,e.__scopeSelect),i=uv(Pv,e.__scopeSelect),[r,o]=b.useState(!1),a=Dh(t,i.onScrollButtonChange);return Op((()=>{if(n.viewport&&n.isPositioned){let e=function(){const e=t.scrollTop>0;o(e)};const t=n.viewport;return e(),t.addEventListener("scroll",e),()=>t.removeEventListener("scroll",e)}}),[n.viewport,n.isPositioned]),r?(0,v.jsx)(Dv,Eu(Eu({},e),{},{ref:a,onAutoScroll:()=>{const{viewport:e,selectedItem:t}=n;e&&t&&(e.scrollTop=e.scrollTop-t.offsetHeight)}})):null}));Rv.displayName=Pv;var Iv="SelectScrollDownButton",Ov=O(((e,t)=>{const n=ov(Iv,e.__scopeSelect),i=uv(Iv,e.__scopeSelect),[r,o]=b.useState(!1),a=Dh(t,i.onScrollButtonChange);return Op((()=>{if(n.viewport&&n.isPositioned){let e=function(){const e=t.scrollHeight-t.clientHeight,n=Math.ceil(t.scrollTop)<e;o(n)};const t=n.viewport;return e(),t.addEventListener("scroll",e),()=>t.removeEventListener("scroll",e)}}),[n.viewport,n.isPositioned]),r?(0,v.jsx)(Dv,Eu(Eu({},e),{},{ref:a,onAutoScroll:()=>{const{viewport:e,selectedItem:t}=n;e&&t&&(e.scrollTop=e.scrollTop+t.offsetHeight)}})):null}));Ov.displayName=Iv;var Dv=O(((e,t)=>{const{__scopeSelect:n,onAutoScroll:i}=e,r=Su(e,lu),o=ov("SelectScrollButton",n),a=b.useRef(null),s=Fg(n),c=b.useCallback((()=>{null!==a.current&&(window.clearInterval(a.current),a.current=null)}),[]);return b.useEffect((()=>()=>c()),[c]),Op((()=>{var e;const t=s().find((e=>e.ref.current===document.activeElement));null==(e=null==t?void 0:t.ref.current)||e.scrollIntoView({block:"nearest"})}),[s]),(0,v.jsx)(dp.div,Eu(Eu({"aria-hidden":!0},r),{},{ref:t,style:Eu({flexShrink:0},r.style),onPointerDown:ap(r.onPointerDown,(()=>{null===a.current&&(a.current=window.setInterval(i,50))})),onPointerMove:ap(r.onPointerMove,(()=>{var e;null==(e=o.onItemLeave)||e.call(o),null===a.current&&(a.current=window.setInterval(i,50))})),onPointerLeave:ap(r.onPointerLeave,(()=>{c()}))}))})),Mv=O(((e,t)=>{const{__scopeSelect:n}=e,i=Su(e,du);return(0,v.jsx)(dp.div,Eu(Eu({"aria-hidden":!0},i),{},{ref:t}))}));Mv.displayName="SelectSeparator";var Av="SelectArrow",Nv=O(((e,t)=>{const{__scopeSelect:n}=e,i=Su(e,uu),r=Wg(n),o=zg(Av,n),a=ov(Av,n);return o.open&&"popper"===a.position?(0,v.jsx)(Bf,Eu(Eu(Eu({},r),i),{},{ref:t})):null}));Nv.displayName=Av;var Lv=O(((e,t)=>{let{__scopeSelect:n,value:i}=e,r=Su(e,hu);const o=b.useRef(null),a=Dh(t,o),s=function(e){const t=b.useRef({value:e,previous:e});return b.useMemo((()=>(t.current.value!==e&&(t.current.previous=t.current.value,t.current.value=e),t.current.previous)),[e])}(i);return b.useEffect((()=>{const e=o.current;if(!e)return;const t=window.HTMLSelectElement.prototype,n=Object.getOwnPropertyDescriptor(t,"value").set;if(s!==i&&n){const t=new Event("change",{bubbles:!0});n.call(e,i),e.dispatchEvent(t)}}),[s,i]),(0,v.jsx)(dp.select,Eu(Eu({},r),{},{style:Eu(Eu({},Hf),r.style),ref:a,defaultValue:i}))}));function jv(e){return""===e||void 0===e}function Uv(e){const t=up(e),n=b.useRef(""),i=b.useRef(0),r=b.useCallback((e=>{const r=n.current+e;t(r),function e(t){n.current=t,window.clearTimeout(i.current),""!==t&&(i.current=window.setTimeout((()=>e("")),1e3))}(r)}),[t]),o=b.useCallback((()=>{n.current="",window.clearTimeout(i.current)}),[]);return b.useEffect((()=>()=>window.clearTimeout(i.current)),[]),[n,r,o]}function Fv(e,t,n){const i=t.length>1&&Array.from(t).every((e=>e===t[0]))?t[0]:t,r=n?e.indexOf(n):-1;let o=function(e,t){return e.map(((n,i)=>e[(t+i)%e.length]))}(e,Math.max(r,0));1===i.length&&(o=o.filter((e=>e!==n)));const a=o.find((e=>e.textValue.toLowerCase().startsWith(i.toLowerCase())));return a!==n?a:void 0}Lv.displayName="SelectBubbleInput";var Bv=Jg,Vv=Xg,qv=Zg,Wv=ev,Hv=nv,zv=pv,Gv=Tv,Kv=xv,Jv=_v,Yv=Rv,Xv=Ov;const $v={sm:"w-4 h-4",md:"w-6 h-6"};function Qv(e){let{size:t="md",flagCode:n,className:i}=e,r=Su(e,pu);return(0,v.jsx)("img",Eu({className:_d("rounded-full object-cover",$v[t],i),src:"https://storage.googleapis.com/eleven-public-cdn/images/flags/circle-flags/".concat(n,".svg"),alt:"".concat(n.toUpperCase()," flag")},r))}function Zv(e){let{children:t}=e,n=Su(e,mu);const[i,r]=(0,b.useState)(!1),{language:o,setLanguage:a,options:s}=Qu(),c=_h();return(0,v.jsxs)(Bv,{open:i,value:o.value.languageCode,onValueChange:e=>{a(e),r(!1)},onOpenChange:e=>{e&&r(!0)},children:[t,(0,v.jsx)(Wv,{container:c,children:(0,v.jsxs)(Hv,Eu(Eu({className:"overflow-hidden bg-base border border-base-border rounded-dropdown-sheet max-h-[min(384px,var(--radix-select-content-available-height))] min-w-[var(--radix-select-trigger-width)] z-10",position:"popper",sideOffset:8,align:"end",side:"top",onPointerDownOutside:()=>r(!1),onCloseAutoFocus:()=>r(!1),onEscapeKeyDown:()=>r(!1)},n),{},{children:[(0,v.jsx)(Yv,{className:"flex items-center justify-center h-6 bg-base text-base-subtle cursor-default",children:(0,v.jsx)(Qh,{size:"sm",name:"chevron-up"})}),(0,v.jsx)(zv,{className:"p-1.5",children:s.value.map((e=>(0,v.jsxs)(Gv,{value:e.languageCode,className:"flex select-none items-center p-1.5 pr-3 gap-2 cursor-pointer rounded-input relative focus-visible:outline-none data-[highlighted]:bg-base-active text-sm",children:[(0,v.jsx)(Qv,{flagCode:e.flagCode}),(0,v.jsx)(Kv,{children:e.name}),(0,v.jsx)(Jv,{className:"text-base-primary p-1.5 -mr-1.5 ml-auto",children:(0,v.jsx)(Qh,{size:"sm",name:"check"})})]},e.languageCode)))}),(0,v.jsx)(Xv,{className:"flex items-center justify-center h-6 bg-base text-base-subtle cursor-default",children:(0,v.jsx)(Qh,{size:"sm",name:"chevron-down"})})]}))})]})}function eb(e){let{className:t}=e,n=Su(e,fu);const i=wh(),{language:r,showPicker:o}=Qu();return o.value?(0,v.jsx)(Zv,{align:"center",children:(0,v.jsxs)(Vv,Eu(Eu({className:_d("h-9 min-w-max rounded-button focus-ring px-2 flex gap-2 items-center text-base-primary bg-base hover:bg-base-hover active:bg-base-active font-medium",t),"aria-label":i.change_language},n),{},{children:[(0,v.jsx)(Qv,{size:"sm",flagCode:r.value.flagCode}),r.value.name,(0,v.jsx)(qv,{className:"text-base-subtle",asChild:!0,children:(0,v.jsx)(Qh,{size:"sm",name:"chevron-down"})})]}))}):null}function tb(e){let{className:t}=e,n=Su(e,gu);return(0,v.jsx)("textarea",Eu({className:_d("px-3 py-[calc(theme(spacing.2)-1px)] border text-sm text-base-primary bg-base border-base-border rounded-input focus-ring resize-none [field-sizing:content] placeholder:text-base-subtle",t)},n))}function nb(e,t,n){try{const i=new CustomEvent("elevenlabs-convai:".concat(e),{bubbles:!0,composed:!0,detail:n});t.dispatchEvent(i)}catch(t){console.error("[ConversationalAI] Could not trigger ".concat(e," event:"),t)}}function ib(e,t){return nb("setExpanded",e,t)}function rb(e){let{visible:t}=e,n=Su(e,vu);const i=wh(),{isMuted:r,isMutingEnabled:o,setIsMuted:a}=nh(),s=(0,b.useCallback)((e=>{const t=!r.peek();a(t),nb("setMicMuted",e.currentTarget,{micMuted:t})}),[a]);return o.value?(0,v.jsx)(Zh,{visible:t,className:"p-1",children:(0,v.jsx)(ip,Eu({"aria-label":i.mute_microphone,"aria-pressed":r,icon:r.value?"mic-off":"mic",onClick:s},n))}):null}function ob(e){let{iconOnly:t,isDisconnected:n,children:i}=e,r=Su(e,bu);const{endSession:o,startSession:a}=uh(),s=wh();return(0,v.jsx)(ip,Eu(Eu({variant:n?"primary":"secondary",icon:n?"phone":"phone-off",onClick:n?e=>a(e.currentTarget):o,"aria-label":n?s.start_call:s.end_call},r),{},{children:t?void 0:null!=i?i:n?s.start_call:s.end_call}))}function ab(e){let{showTranscript:t,scrollPinned:n}=e;const i=et(""),r=gh(),{text_input_enabled:o}=mh().value,a=wh(),{isDisconnected:s,status:c,startSession:l,sendUserMessage:d,sendUserActivity:u,conversationIndex:h}=uh(),p=(0,b.useCallback)((async e=>{e.preventDefault();const t=i.value.trim();t&&(n.value=!0,i.value="",s.value?await l(e.currentTarget,{initialMessage:t}):d(t))}),[i,n,s,l,d]),m=(0,b.useCallback)((async e=>{"Enter"===e.key&&!e.shiftKey&&await p(e)}),[p]),f=(0,b.useCallback)((e=>{i.value=e.currentTarget.value}),[i]),g=tt((()=>!!i.value.trim()));return(0,v.jsxs)("div",{className:"shrink-0 overflow-hidden flex p-3 items-end justify-end",children:[o&&(0,v.jsxs)("div",{className:"relative grow min-w-0 flex z-1 m-1",children:[(0,v.jsx)(tb,{rows:1,"aria-label":a.input_label,value:i,onInput:u,onChange:f,onKeyDown:m,className:"min-w-0 w-full max-h-[8lh] pr-9",placeholder:r.value?s.value&&h.value>0?a.input_placeholder_new_conversation:a.input_placeholder_text_only:a.input_placeholder}),(0,v.jsx)(Vh,{active:g,children:(0,v.jsx)("button",{"aria-label":a.send_message,className:"absolute right-1 bottom-1 w-7 h-7 flex items-center justify-center hover:bg-base-hover active:bg-base-active rounded-button focus-ring transition-[transform,opacity] duration-200 data-hidden:opacity-0 data-hidden:scale-90",onClick:p,children:(0,v.jsx)(Qh,{name:"send"})})})]}),(0,v.jsxs)("div",{className:"flex h-11 items-center",children:[(0,v.jsx)(rb,{visible:!r.value&&!s.value}),(0,v.jsx)(Zh,{visible:!s.value||t,className:"p-1",children:(0,v.jsx)(ob,{iconOnly:!s.value,isDisconnected:s.value,disabled:"disconnecting"===c.value||"connecting"===c.value,children:a.new_call})})]})]})}function sb(e){let{entry:t,animateIn:n}=e;const i=wh(),{previewUrl:r}=Sh(),{lastId:o}=uh();return(0,v.jsx)(Vh,{initial:!n,active:!0,children:"message"===t.type?(0,v.jsxs)("div",{className:_d("flex gap-2.5 transition-[opacity,transform] duration-200 data-hidden:opacity-0 data-hidden:scale-75","user"==t.role?"justify-end pl-16 origin-top-right":"pr-16 origin-top-left"),children:["ai"===t.role&&(0,v.jsx)("img",{src:r,alt:"AI agent avatar",className:"bg-base-border shrink-0 w-5 h-5 rounded-full"}),(0,v.jsx)("div",{dir:"auto",className:_d("px-3 py-2.5 rounded-bubble text-sm min-w-0 [overflow-wrap:break-word]","user"===t.role?"bg-accent text-accent-primary":"bg-base-active text-base-primary"),children:t.message})]}):"disconnection"===t.type?(0,v.jsxs)("div",{className:"mt-2 px-8 text-xs text-base-subtle text-center transition-opacity duration-200 data-hidden:opacity-0",children:["user"===t.role?i.user_ended_conversation:i.agent_ended_conversation,(0,v.jsx)("br",{}),o.value&&(0,v.jsxs)("span",{className:"break-all",children:[i.conversation_id,": ",o.value]})]}):(0,v.jsxs)("div",{className:"mt-2 px-8 text-xs text-base-error text-center transition-opacity duration-200 data-hidden:opacity-0",children:[i.error_occurred,(0,v.jsx)("br",{}),t.message,o.value&&(0,v.jsxs)(v.Fragment,{children:[(0,v.jsx)("br",{}),(0,v.jsxs)("span",{className:"text-base-subtle break-all",children:[i.conversation_id,": ",o.value]})]})]})})}function cb(e){let{scrollPinned:t,transcript:n}=e;const i=(0,b.useRef)(null),r=e=>{var t;null==(t=i.current)||t.scrollTo({top:i.current.scrollHeight,behavior:e?"smooth":"instant"})},o=(0,b.useRef)(!0);return(0,b.useEffect)((()=>{o.current=!1,r(!1)}),[]),ct((()=>{n.value,t.peek()&&r(!0)})),(0,v.jsx)("div",{ref:i,onScroll:e=>{t.value=e.currentTarget.scrollTop>=e.currentTarget.scrollHeight-e.currentTarget.clientHeight-16},className:"px-4 pb-3 grow flex flex-col gap-3 overflow-x-hidden overflow-y-auto",children:n.value.map(((e,t)=>(0,v.jsx)(sb,{entry:e,animateIn:!o.current},"".concat(e.message,"-").concat(t,"-").concat(e.conversationIndex))))})}const lb={"top-left":"origin-top-left",top:"origin-top","top-right":"origin-top-right","bottom-left":"origin-bottom-left","bottom-right":"origin-bottom-right",bottom:"origin-bottom"};function db(e){let{open:t}=e;const n=wh(),i=fh(),r=gh(),o=mh(),a=o.value.placement,{isDisconnected:s,startSession:c,transcript:l,conversationIndex:d}=uh(),u=vh(),h=tt((()=>{var e,t;return i.value||r.value?u.value&&i.value?[{type:"message",role:"ai",message:u.value,isText:!0,conversationIndex:null!==(e=null==(t=l.value[0])?void 0:t.conversationIndex)&&void 0!==e?e:d.peek()},...l.value]:l.value:o.value.transcript_enabled?l.value:l.value.filter((e=>"message"!==e.type||e.isText))})),p=h.value.length>0||!s.value&&o.value.transcript_enabled,m=et(!0);return(0,v.jsx)(Vh,{initial:!1,active:t,children:(0,v.jsxs)("div",{className:_d("elevenlabs-widget-sheet","flex flex-col overflow-hidden absolute bg-base shadow-lg pointer-events-auto rounded-sheet w-full max-w-[400px] h-[calc(100%-80px)] max-h-[550px]","transition-[transform,opacity] duration-200 data-hidden:scale-90 data-hidden:opacity-0",lb[a],a.startsWith("top")?o.value.always_expanded?"top-0":"top-20":o.value.always_expanded?"bottom-0":"bottom-20"),children:[(0,v.jsxs)("div",{className:"bg-base shrink-0 flex gap-2 p-4 items-start",children:[(0,v.jsx)("div",{className:"relative w-16 h-16"}),(0,v.jsx)(Vh,{active:p&&!s.value,children:(0,v.jsx)(rp,{className:"rounded-bl-[calc(var(--el-bubble-radius)/3)] transition-opacity data-hidden:opacity-0"})})]}),(0,v.jsx)(cb,{transcript:h,scrollPinned:m}),(0,v.jsx)(ab,{scrollPinned:m,showTranscript:p}),(0,v.jsx)(Vh,{active:!p||s.value,children:(0,v.jsx)("div",{className:"absolute top-0 left-0 right-0 p-4 flex justify-center transition-[opacity,transform] duration-200 data-hidden:opacity-0 data-hidden:-translate-y-4",children:(0,v.jsx)(eb,{})})}),(0,v.jsxs)("div",{className:_d("absolute origin-top-left transition-[transform,left,top] duration-200 z-1",p?"top-4 left-4 scale-[0.333]":"top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 scale-100"),children:[(0,v.jsx)(Jh,{size:"lg"}),(0,v.jsx)(Vh,{active:!p&&s.value&&!i.value,children:(0,v.jsx)("div",{className:"absolute bottom-0 p-1 rounded-[calc(var(--el-button-radius)+4px)] bg-base left-1/2 -translate-x-1/2 translate-y-1/2 transition-[opacity,transform] data-hidden:opacity-0 data-hidden:scale-100 scale-150",children:(0,v.jsx)(ip,{"aria-label":n.start_call,variant:"primary",icon:"phone",onClick:e=>c(e.currentTarget)})})}),(0,v.jsx)(Vh,{active:!p&&!s.value,children:(0,v.jsx)("div",{className:"absolute -bottom-3 left-1/2 -translate-x-1/2 translate-y-full transition-[opacity,transform] data-hidden:opacity-0 data-hidden:scale-75",children:(0,v.jsx)(rp,{})})})]})]})})}function ub(e){let{expanded:t}=e;const n=gh(),i=mh().value.variant,{isDisconnected:r}=uh(),o=wh(),a=_h(),s=(0,b.useCallback)((()=>{const e=!t.value;t.value=e,ib(a,{expanded:e})}),[t,a]);return(0,v.jsxs)(v.Fragment,{children:["full"===i&&(0,v.jsx)(Zh,{visible:!t.value&&!r.value,className:"p-1",children:(0,v.jsx)(Jh,{})}),(0,v.jsx)(Zh,{grow:"tiny"!==i,visible:!n.value&&!t.value&&!r.value,className:"p-1",children:(0,v.jsx)(ob,{iconOnly:!0,isDisconnected:!1})}),(0,v.jsx)(rb,{visible:!n.value&&!t.value&&!r.value}),(0,v.jsx)(Zh,{grow:r.value,visible:!0,className:"p-1",children:(0,v.jsx)(ip,{className:"w-full",variant:"primary",iconClassName:_d((t.value||!r.value)&&"transition-transform duration-200",t.value&&"-rotate-180"),icon:t.value?"chevron-up":r.value?n.value?"chat":"phone":"chevron-up","aria-label":t.value?o.collapse:r.value?n.value?o.start_chat:o.start_call:o.expand,onClick:t.value||r.value?void 0:s,children:!t.value&&r.value&&"tiny"!==i?n.value?o.start_chat:o.start_call:void 0})})]})}function hb(e){let{expanded:t,className:n}=e,i=Su(e,yu);const{isDisconnected:r}=uh(),o=wh();return(0,v.jsxs)("div",Eu(Eu({className:_d("transition-[border-radius] flex flex-col p-2",!t.value&&r.value?"rounded-sheet":"rounded-compact-sheet",n)},i),{},{children:[(0,v.jsx)(Zh,{visible:!t.value&&r.value,className:"p-1 !min-w-60",children:(0,v.jsxs)("div",{className:"flex items-center gap-2",children:[(0,v.jsx)(Jh,{}),(0,v.jsx)("div",{className:"text-sm max-w-64",children:o.main_label})]})}),(0,v.jsx)("div",{className:"flex items-center",children:(0,v.jsx)(ub,{expanded:t})})]}))}function pb(e){let{expanded:t,className:n}=e,i=Su(e,ku);return(0,v.jsxs)("div",Eu(Eu({className:_d("rounded-compact-sheet flex items-center p-2",n)},i),{},{children:[(0,v.jsx)(Zh,{visible:!t.value,className:"p-1",children:(0,v.jsx)(Jh,{})}),(0,v.jsx)(ub,{expanded:t})]}))}function mb(e){let{visible:t,className:n}=e,i=Su(e,wu);const r=wh(),{language:o,showPicker:a}=Qu();return a.value?(0,v.jsx)(Zh,{visible:t,className:"p-1",children:(0,v.jsx)(Zv,{children:(0,v.jsxs)(Vv,Eu(Eu({className:_d("h-9 min-w-max border border-base-border rounded-button focus-ring px-1.5 flex gap-1 items-center transition-colors duration-200 hover:bg-base-hover active:bg-base-active",n),"aria-label":r.change_language},i),{},{children:[(0,v.jsx)(Qv,{flagCode:o.value.flagCode}),(0,v.jsx)(qv,{className:"px-1 text-base-subtle",asChild:!0,children:(0,v.jsx)(Qh,{size:"sm",name:"chevron-down"})})]}))})}):null}function fb(){const e=mh().value.variant,{isDisconnected:t,status:n}=uh();return(0,v.jsxs)(v.Fragment,{children:[(0,v.jsx)(ob,{isDisconnected:t.value,iconOnly:"tiny"===e,className:"w-full m-1 z-1",disabled:"disconnecting"===n.value||"connecting"===n.value}),(0,v.jsx)(mb,{visible:t.value}),(0,v.jsx)(rb,{visible:!t.value})]})}function gb(e){let{className:t}=e,n=Su(e,Cu);const{isDisconnected:i}=uh(),r=wh();return(0,v.jsxs)("div",Eu(Eu({className:_d("flex flex-col p-2 rounded-sheet",t)},n),{},{children:[(0,v.jsxs)("div",{className:"flex items-center p-1 gap-2 min-w-60",children:[(0,v.jsx)(Jh,{}),(0,v.jsxs)("div",{className:"relative text-sm max-w-64",children:[(0,v.jsx)("span",{className:_d("block transition-[transform,opacity] duration-200",!i.value&&"opacity-0 scale-90"),children:r.main_label}),(0,v.jsx)(Vh,{active:!i.value,children:(0,v.jsx)(rp,{className:"absolute top-1/2 -translate-y-1/2 transition-[transform,opacity] duration-200 data-hidden:opacity-0 data-hidden:scale-90"})})]})]}),(0,v.jsx)("div",{className:"flex items-center",children:(0,v.jsx)(fb,{})})]}))}function vb(e){let{className:t}=e,n=Su(e,Tu);return(0,v.jsxs)("div",Eu(Eu({className:_d("rounded-compact-sheet flex items-center p-2",t)},n),{},{children:[(0,v.jsx)(Jh,{className:"mx-1"}),(0,v.jsx)(fb,{})]}))}function bb(e){let{expandable:t,expanded:n}=e;const i=mh().value.variant,r=sh(),{isDisconnected:o}=uh(),a=_h(),s=(0,b.useCallback)((async()=>{await r.requestTerms();const e=!n.peek();n.value=e,ib(a,{expanded:e})}),[n]),c="full"===i;return t?(0,v.jsx)(c?hb:pb,{expanded:n,className:_d("bg-base shadow-md pointer-events-auto overflow-hidden",(o.value||n.value)&&"cursor-pointer"),onClick:o.value||n.value?s:void 0}):(0,v.jsx)(c?gb:vb,{className:"bg-base shadow-md pointer-events-auto overflow-hidden"})}function yb(){var e;const t=wh(),n=mh(),{dismissTerms:i,acceptTerms:r}=sh();return(0,v.jsxs)("div",{className:"max-w-[400px] flex flex-col gap-2 bg-base shadow-md pointer-events-auto rounded-sheet p-3 text-sm",children:[(0,v.jsx)("div",{className:"flex flex-col gap-1 terms p-2 pt-1",dangerouslySetInnerHTML:{__html:null!==(e=n.value.terms_html)&&void 0!==e?e:""}}),(0,v.jsxs)("div",{className:"flex justify-end gap-2",children:[(0,v.jsx)(ip,{onClick:i,children:t.dismiss_terms}),(0,v.jsx)(ip,{onClick:r,variant:"primary",children:t.accept_terms})]})]})}function kb(e){let{copyText:t,children:n}=e;const i=wh(),[r,o]=(0,b.useState)(!1);(0,b.useEffect)((()=>{if(r){const e=setTimeout((()=>{o(!1)}),2e3);return()=>{clearTimeout(e)}}}),[r]);const a=(0,b.useCallback)((()=>{const e=Rh(t);e&&(navigator.clipboard.writeText(e),o(!0))}),[]);return(0,v.jsx)(ip,{onClick:a,children:r?i.copied:n})}function wb(e){let{sawError:t}=e;const n=wh(),{error:i,lastId:r}=uh(),o=(0,b.useCallback)((()=>{t.value=!0}),[]);return(0,v.jsxs)("div",{className:"max-w-[400px] flex flex-col gap-2 bg-base shadow-md pointer-events-auto rounded-sheet p-3 text-sm",children:[(0,v.jsxs)("div",{className:"p-2 pt-1",children:[(0,v.jsx)("h1",{className:"text-md font-medium pb-1",children:n.error_occurred}),i.value,r.value&&(0,v.jsxs)(v.Fragment,{children:[(0,v.jsx)("br",{}),(0,v.jsxs)("span",{className:"text-base-subtle",children:[n.conversation_id,": ",r.value]})]})]}),(0,v.jsxs)("div",{className:"flex justify-end gap-2",children:[(0,v.jsx)(kb,{copyText:r,children:n.copy_id}),(0,v.jsx)(ip,{variant:"primary",onClick:o,children:"Close"})]})]})}function Cb(){const e=mh();return e.value.disable_banner?null:(0,v.jsxs)("p",{className:_d("whitespace-nowrap [line-height:var(--el-overlay-padding)] text-[10px] px-3",e.value.placement.startsWith("top")?"-translate-y-[calc(var(--el-overlay-padding))]":"translate-y-[calc(var(--el-overlay-padding))]"),children:[(0,v.jsx)("span",{className:"opacity-30",children:"Powered by ElevenLabs"})," ",(0,v.jsx)("a",{href:e.value.override_link||"https://elevenlabs.io/conversational-ai",className:"underline cursor-pointer pointer-events-auto focus-visible:outline-none opacity-30 hover:opacity-50 focus-visible:opacity-100 focus-visible:underline-offset-2",target:"_blank",children:"Agents"})]})}function Tb(e){const t=(0,b.useRef)(null),n=mh(),{isDisconnected:i,startSession:r}=uh(),o=ch((()=>{t.current&&r(t.current,{resume:n.value.auto_resume})})),a=ch((()=>{n.value.auto_resume&&i.value&&o()}));return(0,b.useEffect)((()=>{a()}),[a]),(0,v.jsx)("div",Eu({ref:t},e))}const Sb="items-start",xb="items-center",Eb="items-end",_b="flex-col-reverse justify-end",Pb="flex-col justify-end",Rb={"top-left":"".concat(_b," ").concat(Sb),top:"".concat(_b," ").concat(xb),"top-right":"".concat(_b," ").concat(Eb),"bottom-left":"".concat(Pb," ").concat(Sb),bottom:"".concat(Pb," ").concat(xb),"bottom-right":"".concat(Pb," ").concat(Eb)},Ib={display:"none"},Ob=P((function(){const e=mh(),t=et(e.peek().default_expanded),n=et(!1),{error:i,subscribeOnSetExpanded:r}=uh(),o=sh(),a=tt((()=>e.value.transcript_enabled||e.value.text_input_enabled)),s=tt((()=>_d("overlay !flex transition-opacity duration-200 data-hidden:opacity-0",Rb[e.value.placement])));(function(e,t){(0,b.useEffect)((()=>e(t)),[e])})(r,(e=>t.value=e)),ct((()=>{i.value&&(a.value?(n.value=!0,t.value=!0):n.value=!1)})),ct((()=>{const e=e=>{var n,i,r;"expand"===(null==(n=e.detail)?void 0:n.action)?t.value=!0:"collapse"===(null==(i=e.detail)?void 0:i.action)?t.value=!1:"toggle"===(null==(r=e.detail)?void 0:r.action)&&(t.value=!t.value)};return document.addEventListener("elevenlabs-agent:expand",e),()=>{document.removeEventListener("elevenlabs-agent:expand",e)}}));const c=tt((()=>a.value||!i.value||n.value?!o.termsAccepted.value&&o.termsShown.value?"terms":"conversation":"error")),l=tt((()=>"error"===c.value)),d=tt((()=>"terms"===c.value)),u=tt((()=>"conversation"===c.value));return(0,v.jsxs)(Tb,{children:[(0,v.jsx)(Vh,{initial:!1,active:u,children:(0,v.jsx)(Eh,{className:s,style:Ib,children:e.value.always_expanded?(0,v.jsx)(db,{open:!0}):(0,v.jsxs)(v.Fragment,{children:[a.value&&(0,v.jsx)(db,{open:t}),(0,v.jsx)(bb,{expandable:a.value,expanded:t})]})})}),(0,v.jsx)(Vh,{initial:!1,active:d,children:(0,v.jsx)(Eh,{className:s,style:Ib,children:(0,v.jsx)(yb,{})})}),(0,v.jsx)(Vh,{initial:!1,active:l,children:(0,v.jsx)(Eh,{className:s,style:Ib,children:(0,v.jsx)(wb,{sawError:n})})}),(0,v.jsx)(Eh,{className:s,style:Ib,children:(0,v.jsx)(Cb,{})})]})}));function Db(e){return(0,v.jsx)(Wu,{value:e,children:(0,v.jsx)(Gu,{children:(0,v.jsx)(ph,{children:(0,v.jsx)(ah,{children:(0,v.jsx)($u,{children:(0,v.jsx)(th,{children:(0,v.jsx)(rh,{children:(0,v.jsx)(dh,{children:(0,v.jsx)(kh,{children:(0,v.jsxs)(Th,{children:[(0,v.jsx)(bh,{}),(0,v.jsx)(Ob,{})]})})})})})})})})})})}function Mb(){l(Db,arguments.length>0&&void 0!==arguments[0]?arguments[0]:"elevenlabs-convai",[...Du],{shadow:!0,mode:"open"})}}}]);